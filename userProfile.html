<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac Profile</title>
    
    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg: #000;
            --surface: #0a0a0a;
            --accent: #00d2ff;
            --text: #ffffff;
            --dim: #666;
            --border: rgba(255, 255, 255, 0.08);
            --danger: #ff3b30;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; padding-bottom: 100px; }

        /* Skeleton Animation */
        .skeleton {
            position: relative;
            overflow: hidden;
            background: #111 !important;
            border-color: transparent !important;
            color: transparent !important;
        }

        .skeleton::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        #loader { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .spin { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: s 0.6s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        .app { max-width: 450px; margin: 0 auto; padding: 20px; opacity: 0; transition: 0.5s; }
        .app.show { opacity: 1; }

        header { height: 50px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back { font-size: 30px; cursor: pointer; color: var(--accent); }

        /* MUTUAL BADGE STYLE */
        .mutual-badge {
            display: none; /* Hidden by default */
            align-items: center; gap: 6px;
            background: rgba(0, 210, 255, 0.1); 
            border: 1px solid rgba(0, 210, 255, 0.3);
            color: var(--accent);
            padding: 4px 10px; border-radius: 12px;
            font-size: 0.7rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .profile-hero { text-align: center; }
        .pfp-box { width: 110px; height: 110px; border-radius: 35px; margin: 0 auto; position: relative; padding: 3px; background: linear-gradient(var(--accent), transparent); }
        .pfp-img { width: 100%; height: 100%; border-radius: 32px; object-fit: cover; background: #111; border: 3px solid #000; }
        
        .name-row { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 1.6rem; font-weight: 800; margin-top: 15px; min-height: 32px; }
        .v-tick { width: 20px; height: 20px; }
        .handle { color: var(--accent); font-size: 0.9rem; font-weight: 600; min-height: 20px; margin-bottom: 5px; }
        
        .g-num { display: inline-block; background: #111; padding: 5px 15px; border-radius: 20px; color: var(--dim); font-size: 0.75rem; margin-top: 10px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .g-num:active { transform: scale(0.95); opacity: 0.7; }

        .bio { margin: 20px 0; color: #bbb; font-size: 0.95rem; line-height: 1.5; min-height: 40px; }

        .stats { display: flex; gap: 10px; margin-bottom: 25px; }
        .stat-card { flex: 1; background: var(--surface); border: 1px solid var(--border); padding: 15px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.2s; }
        .stat-card:active { background: #151515; transform: scale(0.98); }
        .s-val { display: block; font-size: 1.2rem; font-weight: 800; pointer-events: none; }
        .s-lbl { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; pointer-events: none; }

        .actions { display: flex; gap: 10px; }
        .btn { flex: 1; height: 52px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .btn-msg { background: #fff; color: #000; }
        .btn-f { background: var(--accent); color: #000; }
        .btn-following { background: #1a1a1a; color: #666; border: 1px solid var(--border); }
        .btn:active { transform: scale(0.96); }

        /* Toast Styling */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            color: #000;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 700;
            display: none;
            z-index: 2000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<div id="loader"><div class="spin"></div></div>

<div class="app" id="main">
    <header>
        <span class="back" onclick="history.back()">â€¹</span>
        <div style="display:flex; flex-direction:column; align-items:center;">
            <span style="font-weight: 800; font-size: 0.75rem; letter-spacing: 2px;">USER DOSSIER</span>
            <div id="mutual-badge" class="mutual-badge">
                <svg viewBox="0 0 24 24" style="width:12px; height:12px; fill:currentColor;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-1.07 3.9-2.74 5.08z"/></svg>
                Mutuals
            </div>
        </div>
        <div style="width:30px"></div>
    </header>

    <div class="profile-hero">
        <div class="pfp-box skeleton" id="pfp-wrap">
            <img id="pfp" src="" class="pfp-img" style="opacity:0;">
        </div>

        <div class="name-row">
            <span id="d-name" class="skeleton">User Name Loading</span>
            <img id="res-v" src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="v-tick" style="display:none;">
        </div>
        <div class="handle skeleton" id="d-handle" style="width:100px; margin: 0 auto 10px auto;">@username</div>
        
        <div id="g-num-wrap" class="skeleton" style="border-radius: 20px; display: inline-block;">
             <div class="g-num" onclick="copyID()">ID: <span id="d-gn">----------</span></div>
        </div>

        <div class="bio skeleton" id="d-bio">Bio loading from the Goorac database servers...</div>

        <div class="stats">
            <div class="stat-card" id="go-followers">
                <span class="s-val skeleton" id="c-followers">00</span>
                <span class="s-lbl">Followers</span>
            </div>
            <div class="stat-card" id="go-following">
                <span class="s-val skeleton" id="c-following">00</span>
                <span class="s-lbl">Following</span>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-msg skeleton" id="msg-btn">Message</button>
            <button class="btn btn-f skeleton" id="follow-action-btn">Follow</button>
        </div>
    </div>
</div>

<div id="toast">ID Copied</div>

<script>
    // --- FIREBASE INIT ---
    let fbConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51"
    };

    if (typeof window.CONFIG !== 'undefined' && window.CONFIG.firebase) {
        fbConfig = window.CONFIG.firebase;
    }

    if (!firebase.apps.length) { firebase.initializeApp(fbConfig); }
    const db = firebase.firestore();
    const auth = firebase.auth();

    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');
    const targetUidParam = params.get('uid'); // Support direct UID access too
    
    let currentUserUID = "";
    let targetUserUID = "";
    let isActionLocked = false; 
    let myFollowingList = []; // Array of UIDs
    let theirFollowingList = []; // Array of UIDs

    document.getElementById('main').classList.add('show');
    document.getElementById('loader').style.opacity = '0';
    setTimeout(() => document.getElementById('loader').style.display = 'none', 300);

    auth.onAuthStateChanged(user => {
        if (user) { 
            currentUserUID = user.uid; 
            // Listen to MY data first to handle mutuals logic
            db.collection("users").doc(currentUserUID).onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    const rawList = data.following || [];
                    // Normalize to UIDs
                    myFollowingList = rawList.map(item => typeof item === 'string' ? item : item.uid);
                    checkMutuals();
                    updateFollowButtonState();
                }
            });
            loadProfileData(); 
        } else { 
            window.location.href = 'login.html'; 
        }
    });

    async function loadProfileData() {
        let query;
        if(targetUidParam) {
            query = db.collection("users").doc(targetUidParam);
            // We fetch once to get data, but set listener on snapshot
        } else if (targetUsername) {
            query = db.collection("users").where("username", "==", targetUsername);
        } else {
            return;
        }

        // Handle the query (either DocRef or Query)
        const snapshotHandler = async (snap) => {
            let doc, userData;

            if(targetUidParam) { // Doc Snapshot
                if(!snap.exists) return;
                doc = snap;
                userData = snap.data();
            } else { // Query Snapshot
                if (snap.empty) return;
                doc = snap.docs[0];
                userData = doc.data();
            }
            
            targetUserUID = doc.id;
            
            // Normalize their following list for mutual check
            const rawTheirFollowing = userData.following || [];
            theirFollowingList = rawTheirFollowing.map(item => typeof item === 'string' ? item : item.uid);
            checkMutuals();

            const removeSkeleton = (id) => document.getElementById(id).classList.remove('skeleton');

            const pfp = document.getElementById('pfp');
            const pfpWrap = document.getElementById('pfp-wrap');
            pfp.src = userData.photoURL || 'https://via.placeholder.com/150';
            pfp.onload = () => {
                pfpWrap.classList.remove('skeleton');
                pfp.style.opacity = '1';
            };

            const nameEl = document.getElementById('d-name');
            nameEl.innerText = userData.name || userData.username;
            nameEl.classList.remove('skeleton');

            const handleEl = document.getElementById('d-handle');
            handleEl.innerText = `@${userData.username}`;
            handleEl.classList.remove('skeleton');
            handleEl.style.width = 'auto';

            document.getElementById('d-gn').innerText = userData.gooracNumber || "----------";
            removeSkeleton('g-num-wrap');

            const bioEl = document.getElementById('d-bio');
            bioEl.innerText = userData.bio || "No bio available.";
            bioEl.classList.remove('skeleton');

            if (!isActionLocked) {
                const fers = document.getElementById('c-followers');
                fers.innerText = userData.followerCount || 0;
                fers.classList.remove('skeleton');

                const fing = document.getElementById('c-following');
                fing.innerText = userData.followingCount || 0;
                fing.classList.remove('skeleton');
                
                updateFollowButtonState();
            }

            document.getElementById('res-v').style.display = userData.verified ? 'inline' : 'none';

            removeSkeleton('msg-btn');
            removeSkeleton('follow-action-btn');

            document.getElementById('go-followers').onclick = () => window.location.href = `followers.html?user=${userData.username}`;
            document.getElementById('go-following').onclick = () => window.location.href = `following.html?user=${userData.username}`;
            document.getElementById('msg-btn').onclick = () => window.location.href = `chat.html?user=${userData.username}`;
        };

        if(targetUidParam) {
            db.collection("users").doc(targetUidParam).onSnapshot(snapshotHandler);
        } else {
            db.collection("users").where("username", "==", targetUsername).onSnapshot(snapshotHandler);
        }
    }

    function checkMutuals() {
        if(!targetUserUID || !currentUserUID) return;
        if(targetUserUID === currentUserUID) return;

        const iFollowThem = myFollowingList.includes(targetUserUID);
        const theyFollowMe = theirFollowingList.includes(currentUserUID);

        const badge = document.getElementById('mutual-badge');
        if (iFollowThem && theyFollowMe) {
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }

    function updateFollowButtonState() {
        if (currentUserUID === targetUserUID || !targetUserUID) {
            document.getElementById('follow-action-btn').style.display = "none";
            document.getElementById('msg-btn').style.display = "none"; // Optional: Hide msg button on own profile
            return;
        }

        const btn = document.getElementById('follow-action-btn');

        if (myFollowingList.includes(targetUserUID)) {
            btn.innerText = "Following";
            btn.className = "btn btn-following";
        } else {
            btn.innerText = "Follow";
            btn.className = "btn btn-f";
        }
    }

    document.getElementById('follow-action-btn').onclick = async function() {
        if (isActionLocked || !targetUserUID || currentUserUID === targetUserUID) return;
        
        const btn = this;
        const isCurrentlyFollowing = btn.innerText === "Following";
        
        // Optimistic UI Update
        if (navigator.vibrate) navigator.vibrate(10);
        isActionLocked = true;

        if (!isCurrentlyFollowing) {
            btn.innerText = "Following";
            btn.className = "btn btn-following";
        } else {
            btn.innerText = "Follow";
            btn.className = "btn btn-f";
        }

        // Data Objects with Timestamp
        const timestamp = firebase.firestore.Timestamp.now();
        const dateStr = new Date().toISOString();
        
        const myFollowData = { uid: targetUserUID, timestamp: timestamp, date: dateStr, type: 'following' };
        const theirFollowerData = { uid: currentUserUID, timestamp: timestamp, date: dateStr, type: 'follower' };

        try {
            if (!isCurrentlyFollowing) {
                // FOLLOW Logic (Use Union for objects)
                const batch = db.batch();
                batch.update(db.collection("users").doc(currentUserUID), {
                    following: firebase.firestore.FieldValue.arrayUnion(myFollowData),
                    followingCount: firebase.firestore.FieldValue.increment(1)
                });
                batch.update(db.collection("users").doc(targetUserUID), {
                    followers: firebase.firestore.FieldValue.arrayUnion(theirFollowerData),
                    followerCount: firebase.firestore.FieldValue.increment(1)
                });
                await batch.commit();

            } else {
                // UNFOLLOW Logic (Complex Remove)
                // Since we store objects, arrayRemove only works if we know the Exact Object (including timestamp).
                // We don't know the exact timestamp of when we followed them.
                // So we must Read -> Filter -> Write (Transaction)
                
                await Promise.all([
                    removeFromList(currentUserUID, 'following', targetUserUID),
                    removeFromList(targetUserUID, 'followers', currentUserUID)
                ]);
            }
        } catch (err) {
            console.error("Action failed", err);
            // Revert UI on error (simple reload essentially)
            updateFollowButtonState();
        } finally {
            isActionLocked = false;
        }
    };

    // Helper: Safely remove item from array whether it's stored as String or Object
    async function removeFromList(docUid, field, uidToRemove) {
        const docRef = db.collection("users").doc(docUid);
        try {
            await db.runTransaction(async (t) => {
                const doc = await t.get(docRef);
                if (!doc.exists) return;
                
                const currentArray = doc.data()[field] || [];
                // Filter out the item matching the UID
                const newArray = currentArray.filter(item => {
                    const id = typeof item === 'string' ? item : item.uid;
                    return id !== uidToRemove;
                });
                
                if (newArray.length !== currentArray.length) {
                    const countField = field === 'followers' ? 'followerCount' : 'followingCount';
                    t.update(docRef, { 
                        [field]: newArray,
                        [countField]: newArray.length
                    });
                }
            });
        } catch (e) { console.error("Transaction failed", e); }
    }

    function copyID() {
        if(document.getElementById('g-num-wrap').classList.contains('skeleton')) return;
        const idText = document.getElementById('d-gn').innerText;
        if (idText.includes("-")) return;

        navigator.clipboard.writeText(idText).then(() => {
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            if (navigator.vibrate) navigator.vibrate(50);
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        });
    }
</script>

<script src="components/call-notifier.js" defer></script>
<call-notifier></call-notifier>

</body>
</html>
