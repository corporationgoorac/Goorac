<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac | Quantum Calls</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg: #0b141a;
            --accent: #00d2ff; 
            --border: rgba(255, 255, 255, 0.1);
            --text-dim: #888; 
            --danger: #ff4444; 
            --success: #1ebea5;
            --ig-blue: #0095f6;
        }

        /* Anti-Copy & Layout CSS */
        body {
            background: #000; color: white; margin: 0;
            font-family: -apple-system, system-ui, sans-serif;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        input { -webkit-user-select: text; user-select: text; }

        header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: #000; }
        .header-logo { font-weight: 900; font-size: 1.4rem; color: var(--accent); letter-spacing: 2px; }
        .search-box { padding: 15px; }
        .search-box input { width: 100%; background: #111; border: 1px solid var(--border); padding: 12px; border-radius: 12px; color: white; outline: none; box-sizing: border-box; }
        
        .tabs { display: flex; padding: 0 20px 10px; gap: 20px; border-bottom: 1px solid var(--border); }
        .tab { font-size: 0.8rem; font-weight: 800; color: var(--text-dim); cursor: pointer; padding-bottom: 5px; text-transform: uppercase; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        #list-container { 
            flex: 1; 
            overflow-y: auto; 
            padding-bottom: 80px; 
            -webkit-overflow-scrolling: touch; 
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-item { display: flex; align-items: center; padding: 15px 20px; gap: 15px; }
        .sk-pfp { width: 50px; height: 50px; border-radius: 50%; }
        .sk-text { height: 12px; width: 60%; margin-bottom: 8px; }
        .sk-meta { height: 10px; width: 40%; }

        /* List Items */
        .call-item { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .call-item:active { background: rgba(255,255,255,0.05); }
        .call-pfp { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 1.5px solid var(--border); }
        .call-info { flex: 1; }
        .u-name { font-weight: 700; display: flex; align-items: center; gap: 4px; font-size: 0.95rem; }
        
        .v-badge { 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 15px; height: 15px;
            background-color: var(--ig-blue);
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.5 12.5c0-1.58.8-3.04 2.12-4.03l-1.1-2.48-2.74.05a4.95 4.95 0 0 1-4.04-2.12L14.24 3l-2.47 1.1-1.1-2.48-2.5.78L7.1 5.14a4.95 4.95 0 0 1-4.04 2.12l-2.74-.05-1.1 2.48 2.12 4.03-2.12 4.03 1.1 2.48 2.74-.05a4.95 4.95 0 0 1 4.04 2.12L9.76 21l2.47-1.1 1.1 2.48 2.5-.78.78-2.73a4.95 4.95 0 0 1 4.04-2.12l2.74.05 1.1-2.48-2.12-4.03Z"/></svg>');
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.5 12.5c0-1.58.8-3.04 2.12-4.03l-1.1-2.48-2.74.05a4.95 4.95 0 0 1-4.04-2.12L14.24 3l-2.47 1.1-1.1-2.48-2.5.78L7.1 5.14a4.95 4.95 0 0 1-4.04 2.12l-2.74-.05-1.1 2.48 2.12 4.03-2.12 4.03 1.1 2.48 2.74-.05a4.95 4.95 0 0 1 4.04 2.12L9.76 21l2.47-1.1 1.1 2.48 2.5-.78.78-2.73a4.95 4.95 0 0 1 4.04-2.12l2.74.05 1.1-2.48-2.12-4.03Z"/></svg>');
            -webkit-mask-size: contain; mask-size: contain;
            -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
            margin-left: 4px; flex-shrink: 0; vertical-align: middle;
        }
        .v-badge::before {
            content: ""; width: 3.5px; height: 6.5px; border: solid white;
            border-width: 0 1.8px 1.8px 0; transform: translateY(-1px) rotate(45deg);
        }

        .call-meta { font-size: 0.75rem; color: var(--text-dim); }
        .status-missed { color: var(--danger); font-weight: bold; }
        .status-incoming { color: var(--success); }
        .status-outgoing { color: var(--accent); }
        .btn-call { width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(0, 210, 255, 0.1); color: var(--accent); cursor: pointer; font-size: 1.1rem; }

        /* Call Screen */
        #call-screen {
            position: fixed; inset: 0; 
            background: linear-gradient(to bottom, #0b141a, #121b22); 
            z-index: 9999;
            display: none; flex-direction: column; align-items: center; 
            justify-content: space-between; padding: 60px 20px 40px;
        }
        #remote-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
        #local-video { position: absolute; top: 40px; right: 20px; width: 90px; height: 130px; border-radius: 12px; border: 1.5px solid rgba(255,255,255,0.3); object-fit: cover; z-index: 10; display: none; background: #000; }
        
        .call-header { z-index: 5; text-align: center; }
        .call-header h2 { font-size: 1.8rem; margin: 0 0 8px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 5px; }
        #call-status { font-size: 0.9rem; color: #aebac1; text-transform: uppercase; letter-spacing: 1.5px; margin: 0; }
        #call-timer { font-size: 1.1rem; color: white; margin-top: 8px; font-weight: 400; display: none; }
        
        .call-body { z-index: 5; flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        .big-pfp-container { position: relative; }
        #target-pfp { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.1); }
        .pulse { position: absolute; inset: 0; border-radius: 50%; border: 2px solid var(--accent); animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.5); opacity: 0; } }

        .call-controls { display: flex; flex-direction: column; gap: 30px; z-index: 20; width: 100%; align-items: center; }
        .control-row { display: flex; gap: 25px; align-items: center; justify-content: center; }
        .ctrl-btn { width: 55px; height: 55px; border-radius: 50%; border: none; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: 0.2s; background: rgba(255,255,255,0.15); }
        .btn-end { width: 65px; height: 65px; background: var(--danger) !important; transform: rotate(135deg); }
        .btn-accept { width: 65px; height: 65px; background: var(--success) !important; }
        .btn-off { background: rgba(255,255,255,0.5); color: black; }
    </style>
</head>
<body oncontextmenu="return false;">

    <audio id="ringtone" loop preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" type="audio/mpeg"></audio>
    <audio id="dialtone" loop preload="auto"><source src="https://www.soundjay.com/phone/sounds/phone-calling-1.mp3" type="audio/mpeg"></audio>

    <header>
        <div class="header-logo">GOORAC</div>
        <div class="search-box">
            <input type="text" id="search" placeholder="Search callers..." autocomplete="off">
        </div>
        <div class="tabs">
            <div class="tab active" id="tab-recent" onclick="switchTab('recent')">Recent</div>
            <div class="tab" id="tab-contacts" onclick="switchTab('contacts')">Contacts</div>
        </div>
    </header>

    <div id="list-container"></div>

    <call-notifier></call-notifier>

    <div id="call-screen">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-header">
            <h2 id="target-name">User</h2>
            <p id="call-status">RINGING...</p>
            <div id="call-timer">00:00</div>
        </div>
        <div class="call-body" id="pfp-area">
            <div class="big-pfp-container">
                <div class="pulse" id="ring-animation"></div>
                <img src="" id="target-pfp">
            </div>
        </div>
        <div class="call-controls">
            <div class="control-row">
                <button class="ctrl-btn" id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
                <button class="ctrl-btn" id="cam-btn" onclick="toggleCam()">üì∑</button>
                <button class="ctrl-btn" id="speaker-btn" onclick="toggleSpeaker()">üîä</button>
            </div>
            <div class="control-row">
                <button class="ctrl-btn btn-accept" id="answer-btn" style="display:none;" onclick="triggerAnswer()">üìû</button>
                <button class="ctrl-btn btn-end" id="hangup-btn" onclick="hangUp()">üìû</button>
            </div>
        </div>
    </div>

    <script src="components/navbar.js" defer></script> 
    <main-navbar></main-navbar>

    <script>
        /* -------------------------------------------------------------------------- */
        /* CUSTOM ELEMENT: CALL NOTIFIER                                              */
        /* -------------------------------------------------------------------------- */
        class CallNotifier extends HTMLElement {
            constructor() { super(); }
            connectedCallback() {
                this.innerHTML = `
                <style>
                    #notif-banner {
                        position: fixed; top: -150px; left: 50%; transform: translateX(-50%);
                        width: calc(100% - 30px); max-width: 400px;
                        background: rgba(10, 15, 20, 0.98); backdrop-filter: blur(20px);
                        border: 1px solid rgba(0, 210, 255, 0.4); border-radius: 24px;
                        padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
                        z-index: 100000; box-shadow: 0 15px 40px rgba(0,0,0,0.8);
                        transition: top 0.5s cubic-bezier(0.16, 1, 0.3, 1);
                    }
                    #notif-banner.active { top: 20px; }
                    .nb-info { display: flex; align-items: center; gap: 12px; color: white; }
                    .nb-pfp { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
                    .nb-text h4 { margin: 0; font-size: 0.95rem; }
                    .nb-text p { margin: 0; font-size: 0.75rem; color: var(--accent); }
                    .nb-actions { display: flex; gap: 10px; }
                    .nb-btn { border: none; padding: 10px 18px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
                    .nb-acc { background: var(--accent); color: black; }
                    .nb-dec { background: rgba(255,68,68,0.2); color: #ff4444; }
                </style>
                <div id="notif-banner">
                    <div class="nb-info">
                        <img id="nb-img" class="nb-pfp" src="">
                        <div class="nb-text"><h4 id="nb-user">User</h4><p>Incoming Call...</p></div>
                    </div>
                    <div class="nb-actions">
                        <button class="nb-btn nb-dec" id="nb-decline">Decline</button>
                        <button class="nb-btn nb-acc" id="nb-answer">Answer</button>
                    </div>
                </div>`;
            }
            show(name, pfp, onAccept, onDecline) {
                const b = this.querySelector('#notif-banner');
                this.querySelector('#nb-user').innerText = name;
                this.querySelector('#nb-img').src = pfp || 'https://via.placeholder.com/150';
                b.classList.add('active');
                this.querySelector('#nb-answer').onclick = () => { b.classList.remove('active'); onAccept(); };
                this.querySelector('#nb-decline').onclick = () => { b.classList.remove('active'); onDecline(); };
            }
            hide() { 
                const b = this.querySelector('#notif-banner');
                if(b) b.classList.remove('active'); 
                document.getElementById('ringtone').pause();
            }
        }
        customElements.define('call-notifier', CallNotifier);

        /* -------------------------------------------------------------------------- */
        /* FIREBASE & PEER INITIALIZATION                                             */
        /* -------------------------------------------------------------------------- */
        const firebaseConfig = {
            apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
            authDomain: "goorac-c3b59.firebaseapp.com",
            projectId: "goorac-c3b59",
            storageBucket: "goorac-c3b59.firebasestorage.app",
            messagingSenderId: "746746595332",
            appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
            databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rdb = firebase.database();
        const auth = firebase.auth();

        let myUid, myData, peer, currentCall, localStream, timerInterval;
        let isCaller = false;
        let isLogged = false; 
        let secondsElapsed = 0;
        let activeTab = 'recent';
        let isCamOn = false;
        let currentActiveTarget = null;
        let incomingCallRef = null;
        let pendingAutoAnswer = false; // Flag for late arrivals

        auth.onAuthStateChanged(async user => {
            if (user) {
                myUid = user.uid;
                const doc = await db.collection("users").doc(myUid).get();
                myData = doc.data() || {};
                
                peer = new Peer(myUid, { host: '0.peerjs.com', secure: true, port: 443, debug: 1 });
                
                peer.on('open', () => {
                    checkAutoAnswer(); 
                });

                peer.on('call', (call) => {
                    incomingCallRef = call; 
                    if(pendingAutoAnswer) {
                        triggerAnswer();
                    } else {
                        handleIncomingCall(call);
                    }
                });
                
                loadData();
                listenForSignaling();
            } else { window.location.href = 'login.html'; }
        });

        /* -------------------------------------------------------------------------- */
        /* AUTO ANSWER LOGIC (FOR REDIRECTS)                                         */
        /* -------------------------------------------------------------------------- */
        async function checkAutoAnswer() {
            const params = new URLSearchParams(window.location.search);
            const autoAnswer = params.get('autoAnswer');
            const targetUid = params.get('targetUid');

            if (autoAnswer === 'true' && targetUid) {
                pendingAutoAnswer = true;
                showCallUI("Loading...", "", "PREPARING...", false);
                
                // Clear URL
                const newurl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                window.history.pushState({path:newurl},'',newurl);

                // If PeerJS call already arrived before 'open', trigger now
                if(incomingCallRef) triggerAnswer();
            }
        }

        /* -------------------------------------------------------------------------- */
        /* SIGNALING & PERSISTENT RINGING                                             */
        /* -------------------------------------------------------------------------- */
        function listenForSignaling() {
            rdb.ref(`calls_status/${myUid}`).on('value', async snap => {
                const callData = snap.val();
                
                if (!callData) return;

                if (callData === 'declined' || callData === 'ended') {
                    rdb.ref(`calls_status/${myUid}`).remove();
                    executeHangupSequence(false);
                    return;
                }

                if (callData.status === 'ringing' && !currentCall && !pendingAutoAnswer) {
                    const callerId = callData.callerId;
                    const uDoc = await db.collection("users").doc(callerId).get();
                    const uData = uDoc.data() || {};
                    
                    document.getElementById('ringtone').play().catch(()=>{});
                    document.querySelector('call-notifier').show(uData.name, uData.photoURL, 
                        () => triggerAnswer(), 
                        () => {
                            document.getElementById('ringtone').pause();
                            rdb.ref(`calls_status/${callerId}`).set('declined');
                            rdb.ref(`calls_status/${myUid}`).remove();
                            if(incomingCallRef) incomingCallRef.close();
                        }
                    );
                }
            });
        }

        /* -------------------------------------------------------------------------- */
        /* CALL HANDLING LOGIC                                                        */
        /* -------------------------------------------------------------------------- */
        async function startCall(targetUid, name, pfp, isVerified) {
            if (currentCall) return;
            isCaller = true;
            isLogged = false; 
            secondsElapsed = 0;
            currentActiveTarget = { uid: targetUid, name: name, pfp: pfp, verified: isVerified };
            
            showCallUI(name, pfp, "DIALING...", isVerified);
            document.getElementById('dialtone').play().catch(()=>{});

            try {
                if(!localStream) {
                    localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                }
                document.getElementById('local-video').srcObject = localStream;
                localStream.getVideoTracks()[0].enabled = false;

                rdb.ref(`calls_status/${targetUid}`).set({
                    status: 'ringing',
                    callerId: myUid,
                    timestamp: Date.now()
                });

                const call = peer.call(targetUid, localStream);
                setupCallEvents(call, name, pfp, isVerified);
                
            } catch (e) { 
                console.error("Stream error:", e);
                alert("Please enable camera/mic permissions.");
                hangUp(); 
            }
        }

        function handleIncomingCall(incoming) {
            incomingCallRef = incoming;
            const callerId = incoming.peer;
            
            db.collection("users").doc(callerId).get().then(uDoc => {
                const uData = uDoc.data() || {};
                document.getElementById('ringtone').play().catch(()=>{});
                document.querySelector('call-notifier').show(uData.name, uData.photoURL, 
                    () => triggerAnswer(), 
                    () => {
                        document.getElementById('ringtone').pause();
                        incoming.close();
                        rdb.ref(`calls_status/${callerId}`).set('declined');
                    }
                );
            });
        }

        async function triggerAnswer() {
            if (!incomingCallRef) {
                updateCallStatus("WAITING FOR SIGNAL...", "var(--accent)");
                pendingAutoAnswer = true;
                return;
            }

            document.getElementById('ringtone').pause();
            isCaller = false;
            isLogged = true; 
            pendingAutoAnswer = false;
            
            const callerId = incomingCallRef.peer;
            const uDoc = await db.collection("users").doc(callerId).get();
            const uData = uDoc.data() || {};
            currentActiveTarget = { uid: callerId, name: uData.name, pfp: uData.photoURL };

            try {
                if(!localStream) {
                    localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                }
                document.getElementById('local-video').srcObject = localStream;
                localStream.getVideoTracks()[0].enabled = false;
                
                incomingCallRef.answer(localStream);
                setupCallEvents(incomingCallRef, uData.name, uData.photoURL, uData.verified);
                
                rdb.ref(`calls_status/${myUid}`).set('connected');
                rdb.ref(`calls_status/${callerId}`).set('connected');
            } catch(e) { 
                console.error("Answer error:", e);
                hangUp(); 
            }
        }

        function setupCallEvents(call, name, pfp, isVerified) {
            currentCall = call;
            showCallUI(name, pfp, "CONNECTING...", isVerified);

            call.on('stream', (remoteStream) => {
                document.getElementById('dialtone').pause();
                document.getElementById('ringtone').pause();
                const rv = document.getElementById('remote-video');
                rv.srcObject = remoteStream;
                rv.style.display = 'block';
                updateCallStatus("CONNECTED", "var(--success)");
                document.getElementById('ring-animation').style.display = 'none';
                if (!timerInterval) startTimer();
            });

            call.on('close', () => executeHangupSequence(false));
            call.on('error', (err) => {
                console.error("Peer Error:", err);
                executeHangupSequence(false);
            });
        }

        async function hangUp() {
            executeHangupSequence(true);
        }

        async function executeHangupSequence(notifyRemote) {
            if (isCaller && !isLogged) {
                isLogged = true; 
                const status = secondsElapsed > 0 ? 'completed' : 'cancelled';
                await logCall(status);
            }

            if (notifyRemote && currentActiveTarget) {
                rdb.ref(`calls_status/${currentActiveTarget.uid}`).set('ended');
                rdb.ref(`calls_status/${myUid}`).remove();
            }

            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            document.getElementById('ringtone').pause();
            document.getElementById('dialtone').pause();
            document.getElementById('call-screen').style.display = 'none';
            
            incomingCallRef = null;
            setTimeout(() => window.location.reload(), 600);
        }

        /* -------------------------------------------------------------------------- */
        /* UI RENDERING & DATA                                                        */
        /* -------------------------------------------------------------------------- */
        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            loadData();
        }

        async function loadData() {
            showSkeleton();
            if (activeTab === 'recent') await loadRecent(); else await loadContacts();
        }

        async function loadRecent() {
            const snapshot = await db.collection("call_logs")
                .where('participants', 'array-contains', myUid)
                .orderBy('timestamp', 'desc').limit(10).get();
            
            let html = "";
            snapshot.forEach(doc => {
                const call = doc.data();
                const isOutgoing = call.callerId === myUid;
                const otherUid = isOutgoing ? call.receiverId : call.callerId;
                const name = isOutgoing ? call.receiverName : call.callerName;
                const pfp = isOutgoing ? call.receiverPfp : call.callerPfp;
                const time = new Date(call.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const statusClass = (call.status === 'missed' || call.status === 'cancelled') ? 'status-missed' : (isOutgoing ? 'status-outgoing' : 'status-incoming');

                html += `
                    <div class="call-item">
                        <img src="${pfp || 'https://via.placeholder.com/150'}" class="call-pfp">
                        <div class="call-info">
                            <div class="u-name">${name}</div>
                            <div class="call-meta ${statusClass}">${isOutgoing ? 'Outgoing' : 'Incoming'} ‚Ä¢ ${call.duration || '0s'} ‚Ä¢ ${time}</div>
                        </div>
                        <button class="btn-call" onclick="startCall('${otherUid}', '${name}', '${pfp}', false)">üìû</button>
                    </div>`;
            });
            document.getElementById('list-container').innerHTML = html || "<p style='text-align:center; padding:40px; opacity:0.5;'>No call history</p>";
        }

        async function loadContacts() {
            const following = myData.following || [];
            if (following.length === 0) {
                document.getElementById('list-container').innerHTML = "<p style='text-align:center; padding:40px; opacity:0.5;'>No mutual contacts</p>";
                return;
            }

            let html = "";
            for (let uid of following) {
                const uDoc = await db.collection("users").doc(uid).get();
                const u = uDoc.data();
                if (u && u.following && u.following.includes(myUid)) {
                    html += `
                        <div class="call-item">
                            <img src="${u.photoURL || 'https://via.placeholder.com/150'}" class="call-pfp">
                            <div class="call-info">
                                <div class="u-name">${u.name} ${u.verified ? '<span class="v-badge"></span>' : ''}</div>
                                <div class="call-meta">@${u.username || 'user'}</div>
                            </div>
                            <button class="btn-call" onclick="startCall('${uid}', '${u.name}', '${u.photoURL}', ${u.verified || false})">üìû</button>
                        </div>`;
                }
            }
            document.getElementById('list-container').innerHTML = html || "<p style='text-align:center; padding:40px; opacity:0.5;'>Follow friends to call them</p>";
        }

        function showSkeleton() {
            let html = '';
            for(let i=0; i<6; i++) html += `<div class="skeleton-item"><div class="sk-pfp skeleton"></div><div style="flex:1"><div class="sk-text skeleton"></div><div class="sk-meta skeleton"></div></div></div>`;
            document.getElementById('list-container').innerHTML = html;
        }

        /* -------------------------------------------------------------------------- */
        /* CALL CONTROLS & UTILS                                                      */
        /* -------------------------------------------------------------------------- */
        function startTimer() {
            secondsElapsed = 0;
            const timerEl = document.getElementById('call-timer');
            timerEl.style.display = 'block';
            timerInterval = setInterval(() => {
                secondsElapsed++;
                const mins = String(Math.floor(secondsElapsed / 60)).padStart(2, '0');
                const secs = String(secondsElapsed % 60).padStart(2, '0');
                timerEl.innerText = `${mins}:${secs}`;
            }, 1000);
        }

        async function logCall(status) {
            if(!currentActiveTarget) return;
            const durationStr = Math.floor(secondsElapsed / 60) + "m " + (secondsElapsed % 60) + "s";
            try {
                await db.collection("call_logs").add({
                    participants: [myUid, currentActiveTarget.uid],
                    callerId: myUid, receiverId: currentActiveTarget.uid,
                    callerName: myData.name || "User", receiverName: currentActiveTarget.name,
                    callerPfp: myData.photoURL || "", receiverPfp: currentActiveTarget.pfp || "",
                    duration: durationStr, status: status, timestamp: Date.now()
                });
            } catch(e) { console.error("Log failed", e); }
        }

        function toggleMic() {
            if(!localStream) return;
            const t = localStream.getAudioTracks()[0];
            t.enabled = !t.enabled;
            document.getElementById('mic-btn').classList.toggle('btn-off', !t.enabled);
        }

        function toggleCam() {
            if(!localStream) return;
            isCamOn = !isCamOn;
            const t = localStream.getVideoTracks()[0];
            t.enabled = isCamOn;
            document.getElementById('cam-btn').classList.toggle('btn-off', !isCamOn);
            document.getElementById('remote-video').style.display = isCamOn ? 'block' : 'none';
            document.getElementById('local-video').style.display = isCamOn ? 'block' : 'none';
            document.getElementById('pfp-area').style.display = isCamOn ? 'none' : 'flex';
        }

        function toggleSpeaker() {
            const rv = document.getElementById('remote-video');
            rv.muted = !rv.muted;
            document.getElementById('speaker-btn').classList.toggle('btn-off', rv.muted);
        }

        function showCallUI(name, pfp, status, verified) {
            document.getElementById('call-screen').style.display = 'flex';
            document.getElementById('target-name').innerHTML = `${name} ${verified ? '<span class="v-badge"></span>' : ''}`;
            document.getElementById('target-pfp').src = pfp || 'https://via.placeholder.com/150';
            updateCallStatus(status, "var(--accent)");
        }

        function updateCallStatus(text, color) {
            const el = document.getElementById('call-status');
            if (el) { el.innerText = text; el.style.color = color; }
        }

        document.addEventListener('keydown', e => {
            if (e.ctrlKey && ['c', 'v', 'u', 's', 'a', 'p'].includes(e.key)) e.preventDefault();
            if (e.key === 'F12') e.preventDefault();
        });
    </script>
</body>
</html>
