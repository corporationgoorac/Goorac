<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Calls | Goorac</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg: #000000;
            --surface: #121212;
            --accent: #00d2ff; 
            --border: rgba(255, 255, 255, 0.1);
            --text-dim: #8e8e93; 
            --danger: #ff453a; 
            --success: #32d74b;
            --ig-blue: #0095f6;
        }

        body {
            background: var(--bg); color: white; margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            -webkit-user-select: none; user-select: none;
        }

        input { -webkit-user-select: text; user-select: text; }

        /* --- HEADER --- */
        header { 
            padding: 15px 20px; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border); 
            z-index: 10; 
            padding-top: max(15px, env(safe-area-inset-top));
        }
        
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .page-title { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        
        /* Search */
        .search-container { position: relative; margin-bottom: 5px; }
        .search-container input {
            width: 100%; background: #1c1c1e; border: none;
            padding: 10px 15px; padding-left: 40px; border-radius: 12px;
            color: white; font-size: 1rem; outline: none; transition: background 0.2s;
        }
        .search-container input:focus { background: #2c2c2e; }
        .search-icon { 
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%); 
            width: 18px; height: 18px; fill: var(--text-dim); pointer-events: none;
        }

        /* Tabs */
        .segmented-control {
            display: flex; background: #1c1c1e; padding: 3px; border-radius: 9px; margin-top: 15px;
        }
        .segment-btn {
            flex: 1; padding: 6px; text-align: center; font-size: 0.85rem; font-weight: 600;
            color: var(--text-dim); border-radius: 7px; cursor: pointer; transition: all 0.2s;
        }
        .segment-btn.active { background: #636366; color: white; }

        /* --- LIST --- */
        #list-container { 
            flex: 1; overflow-y: auto; padding-bottom: 100px;
            -webkit-overflow-scrolling: touch; 
        }

        .list-section-title {
            padding: 15px 20px 5px; font-size: 0.8rem; font-weight: 700; 
            color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px;
        }

        .call-row {
            display: flex; align-items: center; padding: 12px 20px;
            transition: background 0.2s; cursor: pointer;
        }
        .call-row:active { background: #1c1c1e; }

        .avatar { 
            width: 48px; height: 48px; border-radius: 50%; margin-right: 15px; 
            object-fit: cover; border: 1px solid #333; flex-shrink: 0;
        }
        
        .info-col { flex: 1; min-width: 0; }
        .name-row { display: flex; align-items: center; gap: 4px; font-weight: 600; font-size: 1.05rem; margin-bottom: 2px; }
        .meta-row { font-size: 0.85rem; color: var(--text-dim); display: flex; align-items: center; gap: 6px; }
        
        /* Status Icons */
        .call-icon { width: 14px; height: 14px; fill: currentColor; }
        .missed { color: var(--danger); }
        .incoming { color: var(--text-dim); }
        .outgoing { color: var(--text-dim); }

        /* Action Buttons */
        .action-col { display: flex; align-items: center; gap: 15px; }
        .btn-icon {
            width: 36px; height: 36px; border-radius: 50%; border: none; background: transparent;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-icon svg { width: 22px; height: 22px; fill: var(--accent); }
        .btn-icon:active { background: rgba(0, 210, 255, 0.15); }

        /* Verified Badge */
        .v-badge { width: 14px; height: 14px; margin-left: 2px; }

        /* Empty State */
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 50vh; color: var(--text-dim); gap: 15px;
        }
        .empty-icon { font-size: 3rem; opacity: 0.3; }

        /* Call Screen */
        #call-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: none; flex-direction: column; align-items: center; 
            justify-content: space-between; padding: 60px 20px 40px;
        }
        #remote-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
        #local-video { position: absolute; top: 60px; right: 20px; width: 100px; height: 150px; border-radius: 16px; border: 2px solid rgba(255,255,255,0.2); object-fit: cover; z-index: 10; display: none; background: #111; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .call-header { z-index: 5; text-align: center; margin-top: 40px; }
        .call-header h2 { font-size: 2rem; margin: 0 0 8px; font-weight: 600; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        #call-status { font-size: 1rem; color: rgba(255,255,255,0.7); letter-spacing: 1px; margin: 0; font-weight: 500; }
        #call-timer { font-size: 1.2rem; color: white; margin-top: 10px; font-weight: 300; display: none; }
        
        .call-body { z-index: 5; flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        #target-pfp { width: 160px; height: 160px; border-radius: 50%; object-fit: cover; border: 4px solid rgba(255,255,255,0.1); box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        
        .call-controls { display: flex; flex-direction: column; gap: 30px; z-index: 20; width: 100%; align-items: center; padding-bottom: 40px; }
        .control-row { display: flex; gap: 25px; align-items: center; justify-content: center; }
        .ctrl-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: 0.2s; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); }
        .btn-end { width: 70px; height: 70px; background: var(--danger) !important; transform: rotate(135deg); }
        .btn-accept { width: 70px; height: 70px; background: var(--success) !important; }
        .btn-off { background: white; color: black; }

        /* Navbar Space */
        main-navbar { display: block; height: 60px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <audio id="ringtone" loop preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" type="audio/mpeg"></audio>
    <audio id="dialtone" loop preload="auto"><source src="https://www.soundjay.com/phone/sounds/phone-calling-1.mp3" type="audio/mpeg"></audio>

    <header>
        <div class="header-top">
            <div class="page-title">Calls</div>
            <div style="width: 24px;"></div> 
        </div>
        
        <div class="search-container">
            <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="search" placeholder="Search" autocomplete="off" oninput="filterList()">
        </div>

        <div class="segmented-control">
            <div class="segment-btn active" id="tab-recent" onclick="switchTab('recent')">All</div>
            <div class="segment-btn" id="tab-missed" onclick="switchTab('missed')">Missed</div>
            <div class="segment-btn" id="tab-contacts" onclick="switchTab('contacts')">Contacts</div>
        </div>
    </header>

    <div id="list-container"></div>

    <call-notifier></call-notifier>

    <div id="call-screen">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        
        <div class="call-header">
            <h2 id="target-name">User</h2>
            <p id="call-status">CONNECTING...</p>
            <div id="call-timer">00:00</div>
        </div>
        
        <div class="call-body" id="pfp-area">
            <img src="" id="target-pfp">
        </div>
        
        <div class="call-controls">
            <div class="control-row">
                <button class="ctrl-btn" id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
                <button class="ctrl-btn" id="cam-btn" onclick="toggleCam()">üì∑</button>
                <button class="ctrl-btn" id="speaker-btn" onclick="toggleSpeaker()">üîä</button>
            </div>
            <div class="control-row">
                <button class="ctrl-btn btn-accept" id="answer-btn" style="display:none;" onclick="triggerAnswer()">üìû</button>
                <button class="ctrl-btn btn-end" id="hangup-btn" onclick="hangUp()">üìû</button>
            </div>
        </div>
    </div>

    <script src="components/navbar.js" defer></script> 
    <main-navbar></main-navbar>

    <script>
        /* -------------------------------------------------------------------------- */
        /* CALL NOTIFIER COMPONENT                                                    */
        /* -------------------------------------------------------------------------- */
        class CallNotifier extends HTMLElement {
            constructor() { super(); }
            connectedCallback() {
                if (window.location.search.includes('autoAnswer')) { this.style.display = 'none'; return; }
                this.render(); this.init();
            }
            render() {
                this.innerHTML = `
                <style>
                    #notif-banner {
                        position: fixed; top: -120px; left: 20px; right: 20px;
                        background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px);
                        border-radius: 16px; padding: 15px; display: flex; align-items: center; 
                        justify-content: space-between; z-index: 99999; 
                        box-shadow: 0 10px 40px rgba(0,0,0,0.5); transition: top 0.5s cubic-bezier(0.19, 1, 0.22, 1);
                    }
                    #notif-banner.active { top: 20px; }
                    .nb-info { display: flex; align-items: center; gap: 12px; }
                    .nb-pfp { width: 42px; height: 42px; border-radius: 50%; }
                    .nb-text h4 { margin: 0; font-size: 1rem; color: white; }
                    .nb-text p { margin: 2px 0 0; font-size: 0.8rem; color: var(--text-dim); }
                    .nb-actions { display: flex; gap: 12px; }
                    .nb-btn { width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
                    .nb-acc { background: var(--success); color: white; }
                    .nb-dec { background: var(--danger); color: white; transform: rotate(135deg); }
                </style>
                <div id="notif-banner">
                    <div class="nb-info">
                        <img id="nb-img" class="nb-pfp" src="">
                        <div class="nb-text"><h4 id="nb-user">User</h4><p>Incoming video call...</p></div>
                    </div>
                    <div class="nb-actions">
                        <button class="nb-btn nb-dec" id="nb-decline">üìû</button>
                        <button class="nb-btn nb-acc" id="nb-answer">üìû</button>
                    </div>
                    <audio id="n-tone" loop><source src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3"></audio>
                </div>`;
            }
            init() {
                const check = setInterval(() => {
                    if (firebase.auth().currentUser) { clearInterval(check); this.listen(); }
                }, 1000);
            }
            listen() {
                const uid = firebase.auth().currentUser.uid;
                this.ref = firebase.database().ref(`calls_status/${uid}`);
                this.ref.on('value', async snap => {
                    const data = snap.val();
                    if (data && data.status === 'ringing') {
                        const uDoc = await firebase.firestore().collection("users").doc(data.callerId).get();
                        this.show(uDoc.data(), data.callerId);
                    } else { this.hide(); }
                });
            }
            show(user, callerId) {
                this.querySelector('#nb-user').textContent = user.name;
                this.querySelector('#nb-img').src = user.photoURL || 'https://via.placeholder.com/150';
                this.querySelector('#notif-banner').classList.add('active');
                this.querySelector('#n-tone').play().catch(()=>{});
                
                this.querySelector('#nb-answer').onclick = () => {
                    window.location.href = `calls.html?targetUid=${callerId}&autoAnswer=true`;
                };
                this.querySelector('#nb-decline').onclick = () => {
                    firebase.database().ref(`calls_status/${callerId}`).set('declined');
                    this.ref.remove(); this.hide();
                };
            }
            hide() {
                this.querySelector('#notif-banner').classList.remove('active');
                this.querySelector('#n-tone').pause();
            }
        }
        customElements.define('call-notifier', CallNotifier);

        /* -------------------------------------------------------------------------- */
        /* MAIN LOGIC                                                                 */
        /* -------------------------------------------------------------------------- */
        const firebaseConfig = {
            apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
            authDomain: "goorac-c3b59.firebaseapp.com",
            projectId: "goorac-c3b59",
            databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), rdb = firebase.database(), auth = firebase.auth();

        let myUid, myData, peer, currentCall, localStream, timerInterval;
        let activeTab = 'recent';
        let isCamOn = false;
        let listData = [];

        auth.onAuthStateChanged(async user => {
            if (user) {
                myUid = user.uid;
                const doc = await db.collection("users").doc(myUid).get();
                myData = doc.data() || {};
                
                peer = new Peer(myUid, { host: '0.peerjs.com', secure: true, port: 443 });
                
                // Auto Answer Logic
                if (new URLSearchParams(window.location.search).get('autoAnswer')) {
                    setupAutoAnswer();
                }

                peer.on('call', handleIncomingCall);
                loadData();
                listenSignaling();
            } else window.location.href = 'login.html';
        });

        /* -------------------------------------------------------------------------- */
        /* UI & DATA LOADING                                                          */
        /* -------------------------------------------------------------------------- */
        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            loadData();
        }

        async function loadData() {
            const container = document.getElementById('list-container');
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Loading...</div>';
            listData = [];

            if (activeTab === 'contacts') {
                const following = myData.following || [];
                // Limit to 30 for performance, then filter mutuals
                const uids = following.map(f => typeof f === 'string' ? f : f.uid).slice(0, 30);
                
                for (const uid of uids) {
                    const doc = await db.collection("users").doc(uid).get();
                    if(doc.exists) {
                        const u = doc.data();
                        // Mutual Check
                        const theirFollowing = (u.following || []).map(f => typeof f === 'string' ? f : f.uid);
                        if (theirFollowing.includes(myUid)) {
                            listData.push({
                                uid: uid, name: u.name, username: u.username, pfp: u.photoURL, verified: u.verified, type: 'contact'
                            });
                        }
                    }
                }
            } else {
                // Recent & Missed
                const snap = await db.collection("call_logs")
                    .where('participants', 'array-contains', myUid)
                    .orderBy('timestamp', 'desc')
                    .limit(10) // Limit read to 10
                    .get();

                snap.forEach(doc => {
                    const c = doc.data();
                    const isOut = c.callerId === myUid;
                    // For "Missed" tab filtering
                    if (activeTab === 'missed' && (isOut || (c.status !== 'missed' && c.status !== 'cancelled'))) return;

                    const otherUid = isOut ? c.receiverId : c.callerId;
                    const name = isOut ? c.receiverName : c.callerName;
                    const pfp = isOut ? c.receiverPfp : c.callerPfp;
                    
                    listData.push({
                        uid: otherUid, name: name, pfp: pfp, 
                        timestamp: c.timestamp, status: c.status, isOut: isOut,
                        type: 'log'
                    });
                });
            }
            renderList();
        }

        function renderList() {
            const container = document.getElementById('list-container');
            const term = document.getElementById('search').value.toLowerCase();
            container.innerHTML = '';

            const filtered = listData.filter(i => i.name.toLowerCase().includes(term));

            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìû</div><p>No calls found</p></div>`;
                return;
            }

            filtered.forEach(item => {
                let metaHtml = '';
                if (item.type === 'contact') {
                    metaHtml = `<div class="meta-row">@${item.username || 'user'}</div>`;
                } else {
                    const date = new Date(item.timestamp).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
                    const icon = item.status === 'missed' || item.status === 'cancelled' 
                        ? `<svg class="call-icon missed" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14h2v2h-2zm0-10h2v8h-2z"/></svg>` // Alert icon for missed
                        : (item.isOut 
                            ? `<svg class="call-icon outgoing" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>` // Out Arrow
                            : `<svg class="call-icon incoming" viewBox="0 0 24 24"><path d="M14 18l1.41-1.41L10.83 12l4.58-4.59L14 6l-6 6z"/></svg>` // In Arrow
                        );
                    
                    const statusText = (item.status === 'missed' || item.status === 'cancelled') ? 'Missed' : (item.isOut ? 'Outgoing' : 'Incoming');
                    const statusClass = (item.status === 'missed' || item.status === 'cancelled') ? 'missed' : 'incoming';
                    
                    metaHtml = `<div class="meta-row"><span class="${statusClass}">${icon} ${statusText}</span> ‚Ä¢ ${date}</div>`;
                }

                const verifiedIcon = item.verified ? `<img src="https://img.icons8.com/color/48/verified-badge.png" class="v-badge">` : '';

                const div = document.createElement('div');
                div.className = 'call-row';
                div.innerHTML = `
                    <img src="${item.pfp || 'https://via.placeholder.com/150'}" class="avatar">
                    <div class="info-col">
                        <div class="name-row">${item.name} ${verifiedIcon}</div>
                        ${metaHtml}
                    </div>
                    <div class="action-col">
                        <button class="btn-icon" onclick="startCall('${item.uid}', '${item.name}', '${item.pfp}')">
                            <svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-2.2 2.2a15.057 15.057 0 01-6.59-6.59l2.2-2.21a.96.96 0 00.25-1.01A11.36 11.36 0 018.59 3.99C8.59 3.44 8.14 3 7.59 3H4.03C3.48 3 3 3.44 3 3.99 3 13.28 10.73 21 20.01 21c.55 0 .99-.45.99-.99v-3.64c0-.55-.45-.99-.99-.99z"/></svg>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function filterList() { renderList(); }

        /* -------------------------------------------------------------------------- */
        /* CALL LOGIC                                                                 */
        /* -------------------------------------------------------------------------- */
        async function startCall(targetUid, name, pfp) {
            if (currentCall) return;
            document.getElementById('call-screen').style.display = 'flex';
            document.getElementById('target-name').innerText = name;
            document.getElementById('target-pfp').src = pfp || 'https://via.placeholder.com/150';
            document.getElementById('call-status').innerText = "DIALING...";
            document.getElementById('dialtone').play();

            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('local-video').srcObject = localStream;
                localStream.getVideoTracks()[0].enabled = false; // Start with camera off usually preferable or consistent state

                rdb.ref(`calls_status/${targetUid}`).set({ status: 'ringing', callerId: myUid, timestamp: Date.now() });

                // Loop connect until answered
                const connect = () => {
                    if (currentCall) return;
                    const call = peer.call(targetUid, localStream);
                    call.on('stream', rs => setupRemoteStream(call, rs));
                };
                connect();
                connectionRetry = setInterval(connect, 1500);

            } catch(e) { console.error(e); hangUp(); }
        }

        async function setupAutoAnswer() {
            const params = new URLSearchParams(window.location.search);
            const targetUid = params.get('targetUid');
            
            document.getElementById('call-screen').style.display = 'flex';
            document.getElementById('call-status').innerText = "CONNECTING...";
            document.getElementById('answer-btn').style.display = 'flex';
            document.getElementById('ringtone').play();

            const u = await db.collection("users").doc(targetUid).get();
            const d = u.data();
            document.getElementById('target-name').innerText = d.name;
            document.getElementById('target-pfp').src = d.photoURL;
        }

        function triggerAnswer() {
            // This is triggered by user clicking Answer on the UI
            // The actual peer.on('call') handles the logic
            document.getElementById('answer-btn').style.display = 'none';
            document.getElementById('ringtone').pause();
        }

        function handleIncomingCall(call) {
            // Auto Answer if user clicked 'Answer'
            const checkAnswer = setInterval(async () => {
                const btn = document.getElementById('answer-btn');
                // If button is hidden, it means user clicked it
                if (btn.style.display === 'none') {
                    clearInterval(checkAnswer);
                    localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                    document.getElementById('local-video').srcObject = localStream;
                    call.answer(localStream);
                    call.on('stream', rs => setupRemoteStream(call, rs));
                }
            }, 500);
        }

        function setupRemoteStream(call, remoteStream) {
            clearInterval(connectionRetry);
            currentCall = call;
            document.getElementById('dialtone').pause();
            document.getElementById('ringtone').pause();
            document.getElementById('remote-video').srcObject = remoteStream;
            document.getElementById('remote-video').style.display = 'block';
            document.getElementById('local-video').style.display = 'block';
            document.getElementById('pfp-area').style.display = 'none';
            document.getElementById('call-status').innerText = "CONNECTED";
            
            call.on('close', () => window.location.href = "calls.html"); // Refresh on end
        }

        function hangUp() {
            if (currentCall) currentCall.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('call-screen').style.display = 'none';
            window.location.href = "calls.html";
        }

        function listenSignaling() {
            rdb.ref(`calls_status/${myUid}`).on('value', snap => {
                const d = snap.val();
                if (d === 'declined' || d === 'ended') hangUp();
            });
        }

        // --- TOGGLES ---
        function toggleMic() {
            if(localStream) {
                const t = localStream.getAudioTracks()[0];
                t.enabled = !t.enabled;
                document.getElementById('mic-btn').classList.toggle('btn-off');
            }
        }
        function toggleCam() {
            if(localStream) {
                const t = localStream.getVideoTracks()[0];
                t.enabled = !t.enabled;
                document.getElementById('cam-btn').classList.toggle('btn-off');
            }
        }
        function toggleSpeaker() {
            const v = document.getElementById('remote-video');
            v.muted = !v.muted;
            document.getElementById('speaker-btn').classList.toggle('btn-off');
        }
    </script>
</body>
</html>
