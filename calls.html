<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac | Quantum Calls (PeerJS Alternative)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg: #0b141a;
            --accent: #00d2ff; 
            --border: rgba(255, 255, 255, 0.1);
            --text-dim: #888; 
            --danger: #ff4444; 
            --success: #1ebea5;
            --ig-blue: #0095f6;
        }

        /* Full layout and Anti-Copy preservation */
        body {
            background: #000; color: white; margin: 0;
            font-family: -apple-system, system-ui, sans-serif;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            -webkit-user-select: none;
            user-select: none;
        }

        header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: #000; }
        .header-logo { font-weight: 900; font-size: 1.4rem; color: var(--accent); }
        
        .search-box { padding: 15px; }
        .search-box input { 
            width: 100%; background: #111; border: 1px solid var(--border); 
            padding: 12px; border-radius: 12px; color: white; outline: none; box-sizing: border-box; 
        }

        .tabs { display: flex; padding: 0 20px 10px; gap: 20px; border-bottom: 1px solid var(--border); }
        .tab { font-size: 0.8rem; font-weight: 800; color: var(--text-dim); cursor: pointer; padding-bottom: 5px; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        #list-container { flex: 1; overflow-y: auto; padding-bottom: 80px; -webkit-overflow-scrolling: touch; }

        /* Preserved Skeleton Loading */
        .skeleton-item { display: flex; align-items: center; padding: 15px 20px; gap: 15px; }
        .sk-pfp { width: 50px; height: 50px; border-radius: 50%; background: #222; }
        .sk-text { height: 12px; width: 60%; background: #222; margin-bottom: 8px; }

        .call-item { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .call-pfp { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .call-info { flex: 1; }
        .u-name { font-weight: 700; display: flex; align-items: center; gap: 4px; }
        
        .v-badge { 
            display: inline-flex; width: 15px; height: 15px; background-color: var(--ig-blue);
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.5 12.5c0-1.58.8-3.04 2.12-4.03l-1.1-2.48-2.74.05a4.95 4.95 0 0 1-4.04-2.12L14.24 3l-2.47 1.1-1.1-2.48-2.5.78L7.1 5.14a4.95 4.95 0 0 1-4.04 2.12l-2.74-.05-1.1 2.48 2.12 4.03-2.12 4.03 1.1 2.48 2.74-.05a4.95 4.95 0 0 1 4.04 2.12L9.76 21l2.47-1.1 1.1 2.48 2.5-.78.78-2.73a4.95 4.95 0 0 1 4.04-2.12l2.74.05 1.1-2.48-2.12-4.03Z"/></svg>');
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.5 12.5c0-1.58.8-3.04 2.12-4.03l-1.1-2.48-2.74.05a4.95 4.95 0 0 1-4.04-2.12L14.24 3l-2.47 1.1-1.1-2.48-2.5.78L7.1 5.14a4.95 4.95 0 0 1-4.04 2.12l-2.74-.05-1.1 2.48 2.12 4.03-2.12 4.03 1.1 2.48 2.74-.05a4.95 4.95 0 0 1 4.04 2.12L9.76 21l2.47-1.1 1.1 2.48 2.5-.78.78-2.73a4.95 4.95 0 0 1 4.04-2.12l2.74.05 1.1-2.48-2.12-4.03Z"/></svg>');
            -webkit-mask-size: contain; mask-size: contain;
        }

        .call-meta { font-size: 0.75rem; color: var(--text-dim); }
        .status-missed { color: var(--danger); font-weight: bold; }
        .btn-call { width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(0, 210, 255, 0.1); color: var(--accent); cursor: pointer; }

        /* Full Call Screen Preservation */
        #call-screen {
            position: fixed; inset: 0; background: linear-gradient(to bottom, #0b141a, #121b22); 
            z-index: 9999; display: none; flex-direction: column; align-items: center; 
            justify-content: space-between; padding: 60px 20px 40px;
        }
        #remote-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
        #local-video { position: absolute; top: 40px; right: 20px; width: 90px; height: 130px; border-radius: 12px; border: 1.5px solid rgba(255,255,255,0.3); object-fit: cover; z-index: 10; display: none; background: #000; }
        
        .call-header { z-index: 5; text-align: center; }
        #call-status { font-size: 0.9rem; color: #aebac1; letter-spacing: 1.5px; }
        #call-timer { font-size: 1rem; color: white; margin-top: 5px; display: none; }
        
        .call-body { z-index: 5; flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        .big-pfp-container { position: relative; }
        #target-pfp { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); }
        
        .pulse { position: absolute; inset: 0; border-radius: 50%; border: 2px solid var(--accent); animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.5); opacity: 0; } }
        
        .call-controls { display: flex; flex-direction: column; gap: 30px; z-index: 20; width: 100%; align-items: center; }
        .control-row { display: flex; gap: 25px; }
        .ctrl-btn { 
            width: 55px; height: 55px; border-radius: 50%; border: none; 
            font-size: 1.4rem; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: white; background: rgba(255,255,255,0.15); 
        }
        .btn-end { background: var(--danger) !important; }
        .btn-accept { background: var(--success) !important; }
        .btn-off { background: rgba(255,255,255,0.5); color: black; }
    </style>
</head>
<body oncontextmenu="return false;">

    <audio id="ringtone" loop><source src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" type="audio/mpeg"></audio>
    <audio id="dialtone" loop><source src="https://www.soundjay.com/phone/sounds/phone-calling-1.mp3" type="audio/mpeg"></audio>

    <header>
        <div class="header-logo">GOORAC</div>
        <div class="search-box"><input type="text" id="search" placeholder="Search..." autocomplete="off"></div>
        <div class="tabs">
            <div class="tab active" id="tab-recent" onclick="switchTab('recent')">Recent</div>
            <div class="tab" id="tab-contacts" onclick="switchTab('contacts')">Contacts</div>
        </div>
    </header>

    <div id="list-container"></div>

    <div id="call-screen">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-header">
            <h2 id="target-name">User</h2>
            <p id="call-status">DIALING...</p>
            <div id="call-timer">00:00</div>
        </div>
        <div class="call-body" id="pfp-area">
            <div class="big-pfp-container">
                <div class="pulse" id="ring-animation"></div>
                <img src="" id="target-pfp">
            </div>
        </div>
        <div class="call-controls">
            <div class="control-row">
                <button class="ctrl-btn" id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
                <button class="ctrl-btn" id="cam-btn" onclick="toggleCam()">üì∑</button>
                <button class="ctrl-btn" id="speaker-btn">üîä</button>
            </div>
            <div class="control-row">
                <button class="ctrl-btn btn-end" id="hangup-btn" onclick="hangUp()">üìû</button>
            </div>
        </div>
    </div>

    <call-notifier></call-notifier>

    <script>
        /* -------------------------------------------------------------------------- */
        /* NOTIFIER COMPONENT PRESERVED                      */
        /* -------------------------------------------------------------------------- */
        class CallNotifier extends HTMLElement {
            constructor() { super(); }
            connectedCallback() {
                this.innerHTML = `
                <style>
                    #notif-banner {
                        position: fixed; top: -150px; left: 50%; transform: translateX(-50%);
                        width: calc(100% - 30px); max-width: 400px;
                        background: rgba(10, 15, 20, 0.98); backdrop-filter: blur(20px);
                        border: 1px solid rgba(0, 210, 255, 0.4); border-radius: 24px;
                        padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
                        z-index: 100000; transition: top 0.5s cubic-bezier(0.16, 1, 0.3, 1);
                    }
                    #notif-banner.active { top: 20px; }
                    .nb-info { display: flex; align-items: center; gap: 12px; color: white; }
                    .nb-pfp { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
                    .nb-text h4 { margin: 0; font-size: 0.95rem; }
                    .nb-actions { display: flex; gap: 10px; }
                    .nb-btn { border: none; padding: 10px 18px; border-radius: 12px; font-weight: bold; cursor: pointer; }
                    .nb-acc { background: var(--accent); color: black; }
                    .nb-dec { background: rgba(255,68,68,0.2); color: #ff4444; }
                </style>
                <div id="notif-banner">
                    <div class="nb-info">
                        <img id="nb-img" class="nb-pfp" src="">
                        <div class="nb-text"><h4 id="nb-user">User</h4><p>Incoming Call...</p></div>
                    </div>
                    <div class="nb-actions">
                        <button class="nb-btn nb-dec" id="nb-decline">Decline</button>
                        <button class="nb-btn nb-acc" id="nb-answer">Answer</button>
                    </div>
                </div>`;
            }
            show(name, pfp, onAccept, onDecline) {
                const b = this.querySelector('#notif-banner');
                this.querySelector('#nb-user').innerText = name;
                this.querySelector('#nb-img').src = pfp || 'https://via.placeholder.com/150';
                b.classList.add('active');
                this.querySelector('#nb-answer').onclick = () => { b.classList.remove('active'); onAccept(); };
                this.querySelector('#nb-decline').onclick = () => { b.classList.remove('active'); onDecline(); };
            }
            hide() { this.querySelector('#notif-banner')?.classList.remove('active'); }
        }
        customElements.define('call-notifier', CallNotifier);

        /* -------------------------------------------------------------------------- */
        /* FIREBASE CONFIG PRESERVED                         */
        /* -------------------------------------------------------------------------- */
        const firebaseConfig = {
            apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
            authDomain: "goorac-c3b59.firebaseapp.com",
            projectId: "goorac-c3b59",
            storageBucket: "goorac-c3b59.firebasestorage.app",
            messagingSenderId: "746746595332",
            appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
            databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rdb = firebase.database();
        const auth = firebase.auth();

        let myUid, myData, peer, currentCall, localStream, timerInterval;
        let secondsElapsed = 0;
        let isCaller = false;
        let activeTab = 'recent';
        let isCamOn = false;

        /* -------------------------------------------------------------------------- */
        /* PEERJS (THE ALTERNATIVE) LOGIC                       */
        /* -------------------------------------------------------------------------- */
        
        auth.onAuthStateChanged(async user => {
            if (user) {
                myUid = user.uid;
                const doc = await db.collection("users").doc(myUid).get();
                myData = doc.data() || {};
                
                // We use your Firebase UID as the Peer ID for direct mapping
                peer = new Peer(myUid, {
                    host: '0.peerjs.com',
                    secure: true,
                    port: 443,
                    debug: 1
                });

                // Listening for incoming "Alternative" PeerJS calls
                peer.on('call', async (incomingCall) => {
                    const callerId = incomingCall.peer;
                    const uDoc = await db.collection("users").doc(callerId).get();
                    const uData = uDoc.data() || {};
                    
                    document.getElementById('ringtone').play().catch(()=>{});
                    
                    document.querySelector('call-notifier').show(uData.name, uData.photoURL, 
                        async () => {
                            // On Answer
                            document.getElementById('ringtone').pause();
                            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                            document.getElementById('local-video').srcObject = localStream;
                            localStream.getVideoTracks()[0].enabled = false; // default start with cam off like original logic
                            
                            incomingCall.answer(localStream);
                            setupCallHandling(incomingCall, uData.name, uData.photoURL, uData.verified);
                        },
                        () => {
                            // On Decline
                            document.getElementById('ringtone').pause();
                            incomingCall.close();
                            rdb.ref(`calls_status/${callerId}`).set('declined');
                        }
                    );
                });

                loadData();
                listenForStatus();
            } else { window.location.href = 'login.html'; }
        });

        // Triggering an Alternative Call
        async function startCall(targetUid, name, pfp, isVerified) {
            isCaller = true;
            secondsElapsed = 0;
            showCallUI(name, pfp, "DIALING...", isVerified);
            document.getElementById('dialtone').play().catch(()=>{});

            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('local-video').srcObject = localStream;
                localStream.getVideoTracks()[0].enabled = false;

                // Instead of RTCPeerConnection Offer/Answer, we use one line:
                const call = peer.call(targetUid, localStream);
                setupCallHandling(call, name, pfp, isVerified);
                
                // Signal to target via Firebase (preserving your RDB signaling logic)
                rdb.ref(`calls_status/${targetUid}`).set('ringing');
            } catch (e) { 
                console.error(e);
                alert("Media access denied or Peer unavailable."); 
                hangUp(); 
            }
        }

        function setupCallHandling(call, name, pfp, isVerified) {
            currentCall = call;
            showCallUI(name, pfp, "CONNECTING...", isVerified);

            call.on('stream', (remoteStream) => {
                document.getElementById('dialtone').pause();
                const rv = document.getElementById('remote-video');
                rv.srcObject = remoteStream;
                rv.style.display = 'block';
                updateCallStatus("CONNECTED", "#1ebea5");
                document.getElementById('ring-animation').style.display = 'none';
                if (!timerInterval) startTimer();
            });

            call.on('close', () => hangUp());
            call.on('error', (err) => {
                console.error("PeerJS Error:", err);
                hangUp();
            });
        }

        /* -------------------------------------------------------------------------- */
        /* UI & LOGGING LOGIC PRESERVED                      */
        /* -------------------------------------------------------------------------- */
        
        function listenForStatus() {
            rdb.ref(`calls_status/${myUid}`).on('value', snap => {
                if (snap.val() === 'declined') {
                    rdb.ref(`calls_status/${myUid}`).remove();
                    hangUp();
                }
            });
        }

        function startTimer() {
            secondsElapsed = 0;
            const timerEl = document.getElementById('call-timer');
            timerEl.style.display = 'block';
            timerInterval = setInterval(() => {
                secondsElapsed++;
                const mins = String(Math.floor(secondsElapsed / 60)).padStart(2, '0');
                const secs = String(secondsElapsed % 60).padStart(2, '0');
                timerEl.innerText = `${mins}:${secs}`;
            }, 1000);
        }

        async function hangUp() {
            if (currentCall) currentCall.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (timerInterval) clearInterval(timerInterval);
            
            document.getElementById('ringtone').pause();
            document.getElementById('dialtone').pause();
            document.getElementById('call-screen').style.display = 'none';
            
            // Log to Firestore (Preserved Logic)
            if (isCaller && secondsElapsed > 0) {
                await db.collection("call_logs").add({
                    participants: [myUid, currentCall.peer],
                    duration: secondsElapsed + "s",
                    status: 'completed',
                    timestamp: Date.now(),
                    callerName: myData.name
                });
            }
            
            setTimeout(() => window.location.reload(), 500);
        }

        function toggleMic() {
            if(!localStream) return;
            const t = localStream.getAudioTracks()[0];
            t.enabled = !t.enabled;
            document.getElementById('mic-btn').classList.toggle('btn-off', !t.enabled);
        }

        function toggleCam() {
            if(!localStream) return;
            isCamOn = !isCamOn;
            const t = localStream.getVideoTracks()[0];
            t.enabled = isCamOn;
            document.getElementById('cam-btn').classList.toggle('btn-off', !isCamOn);
            document.getElementById('remote-video').style.display = isCamOn ? 'block' : 'none';
            document.getElementById('local-video').style.display = isCamOn ? 'block' : 'none';
            document.getElementById('pfp-area').style.display = isCamOn ? 'none' : 'flex';
        }

        /* -------------------------------------------------------------------------- */
        /* LIST RENDERING PRESERVED                          */
        /* -------------------------------------------------------------------------- */

        async function loadData() {
            document.getElementById('list-container').innerHTML = `
                <div class="skeleton-item"><div class="sk-pfp"></div><div class="sk-text"></div></div>
                <div class="skeleton-item"><div class="sk-pfp"></div><div class="sk-text"></div></div>
            `;
            if (activeTab === 'recent') loadRecent(); else loadContacts();
        }

        async function loadRecent() {
            const snapshot = await db.collection("call_logs")
                .where('participants', 'array-contains', myUid)
                .orderBy('timestamp', 'desc').limit(20).get();
            
            let html = "";
            for (const doc of snapshot.docs) {
                const call = doc.data();
                const otherUid = call.participants.find(id => id !== myUid);
                const uDoc = await db.collection("users").doc(otherUid).get();
                const uData = uDoc.data() || {};

                html += `
                    <div class="call-item">
                        <img src="${uData.photoURL || 'https://via.placeholder.com/150'}" class="call-pfp">
                        <div class="call-info">
                            <div class="u-name">${uData.name} ${uData.verified ? '<span class="v-badge"></span>' : ''}</div>
                            <div class="call-meta">${call.status} ‚Ä¢ ${call.duration}</div>
                        </div>
                        <button class="btn-call" onclick="startCall('${otherUid}', '${uData.name}', '${uData.photoURL}', ${uData.verified})">üìû</button>
                    </div>
                `;
            }
            document.getElementById('list-container').innerHTML = html || "<p style='text-align:center; padding:20px; opacity:0.5;'>No recent calls</p>";
        }

        async function loadContacts() {
            const snapshot = await db.collection("users").limit(50).get();
            let html = "";
            snapshot.forEach(doc => {
                const u = doc.data();
                if(doc.id === myUid) return;
                html += `
                    <div class="call-item">
                        <img src="${u.photoURL || 'https://via.placeholder.com/150'}" class="call-pfp">
                        <div class="call-info">
                            <div class="u-name">${u.name} ${u.verified ? '<span class="v-badge"></span>' : ''}</div>
                            <div class="call-meta">Available</div>
                        </div>
                        <button class="btn-call" onclick="startCall('${doc.id}', '${u.name}', '${u.photoURL}', ${u.verified})">üìû</button>
                    </div>
                `;
            });
            document.getElementById('list-container').innerHTML = html;
        }

        function showCallUI(name, pfp, status, verified) {
            document.getElementById('call-screen').style.display = 'flex';
            const badge = (verified === true) ? `<span class="v-badge"></span>` : "";
            document.getElementById('target-name').innerHTML = `${name} ${badge}`;
            document.getElementById('target-pfp').src = pfp || 'https://via.placeholder.com/150';
            updateCallStatus(status, "var(--accent)");
        }

        function updateCallStatus(text, color) {
            const el = document.getElementById('call-status');
            el.innerText = text; el.style.color = color;
        }

        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            loadData();
        }

        // Anti-Copy Key preservation
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && (e.key === 'c' || e.key === 'u' || e.key === 's')) e.preventDefault();
        });
    </script>
</body>
</html>
