<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goorac Pulse</title>
    
    <meta name="theme-color" content="#000000" id="themeMeta">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script src="config.js"></script>
    <script src="components/songPicker.js"></script>
    <script src="components/emojiPicker.js"></script>

    <style>
        /* --- CORE UI --- */
        :root {
            --pulse-color: #0a84ff; /* Dynamic Variable */
        }
        
        body {
            background-color: #000000; /* OLED Black */
            color: white;
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* --- VISUALIZER / AURA --- */
        .pulse-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .aura-glow {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--pulse-color) 0%, rgba(0,0,0,0) 70%);
            opacity: 0.4;
            filter: blur(40px);
            z-index: -1;
            animation: breathe 4s infinite ease-in-out;
            transition: background 1s ease;
        }

        @keyframes breathe {
            0% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.5); opacity: 0.6; }
            100% { transform: scale(1); opacity: 0.3; }
        }

        /* Beat animation triggers on logic */
        .beat-bump { animation: bump 0.4s ease-out; }
        @keyframes bump { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- PLAYER UI --- */
        .album-art-container {
            width: 280px;
            height: 280px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            margin-bottom: 40px;
            position: relative;
            z-index: 2;
        }

        .album-art {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .track-info {
            text-align: center;
            z-index: 2;
            padding: 0 20px;
        }

        .track-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .track-artist {
            font-size: 18px;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }

        /* --- USER BADGES --- */
        .user-badge {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(20,20,20,0.6);
            backdrop-filter: blur(10px);
            padding: 8px 16px 8px 8px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 10;
        }
        
        .pfp { width: 32px; height: 32px; border-radius: 50%; background: #333; object-fit: cover; }
        .username { font-size: 14px; font-weight: 600; }
        .verified-icon { width: 14px; height: 14px; fill: #1DA1F2; display: none; }
        .verified .verified-icon { display: block; }

        /* --- WAITING STATE --- */
        #waitingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100;
            transition: opacity 0.5s;
        }
        .loader-ring {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--pulse-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- FLOATING EMOJI --- */
        .floating-emoji {
            position: absolute;
            bottom: 100px;
            font-size: 40px;
            animation: floatUp 3s ease-out forwards;
            z-index: 50;
            pointer-events: none;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            10% { opacity: 1; transform: translateY(-20px) scale(1.2); }
            100% { transform: translateY(-400px) scale(1); opacity: 0; }
        }

        /* --- MODAL FOR EMOJI PICKER --- */
        #emojiModalWrapper {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50%;
            background: #121212; border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 80; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column;
        }
        #emojiModalWrapper.active { transform: translateY(0); }
        .modal-drag { width: 40px; height: 5px; background: #333; border-radius: 10px; margin: 10px auto; }
        
        /* Custom Elements Layering */
        song-picker { z-index: 90; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <audio id="mainAudio" preload="auto"></audio>

    <song-picker id="songPicker"></song-picker>
    
    <div id="emojiModalWrapper">
        <div class="modal-drag" onclick="closeEmoji()"></div>
        <emoji-picker id="emojiPicker" style="flex:1;"></emoji-picker>
    </div>

    <div id="waitingScreen">
        <div class="loader-ring"></div>
        <div id="statusText" style="color: #888; font-size: 14px;">Connecting to Pulse...</div>
    </div>

    <div class="pulse-container" id="mainUI" style="opacity: 0;">
        <div class="aura-glow" id="aura"></div>

        <div class="user-badge" id="partnerBadge">
            <img class="pfp" id="partnerImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
            <span class="username" id="partnerName">Connecting...</span>
            <svg class="verified-icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>

        <div class="album-art-container" id="artContainer">
            <img class="album-art" id="currentArt" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        </div>

        <div class="track-info">
            <div class="track-title" id="currentTitle">Waiting for selection...</div>
            <div class="track-artist" id="currentArtist">...</div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & HELPERS ---
        const urlParams = new URLSearchParams(window.location.search);
        const targetUsername = urlParams.get('u'); // ?u=target_username

        let currentUser = null;
        let sessionID = null;
        let isMyTurn = false;
        let hasQueuedNext = false;
        let presenceRef = null;
        let sessionRef = null;
        
        // --- 2. INITIALIZATION ---
        window.onload = async () => {
            // Init Firebase
            if(!window.initFirebaseCore()) {
                alert("Firebase Error: Config not loaded.");
                return;
            }

            // Auth Check
            window.auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    if(targetUsername) initPulse(user);
                    else document.getElementById('statusText').innerText = "Error: No user specified in URL.";
                } else {
                    // Redirect to login if needed, or show error
                    window.location.href = "/login.html"; 
                }
            });
        };

        async function initPulse(user) {
            const db = window.db;
            const rdb = window.rdb;
            
            // 1. Get Target User UID from Username
            const snapshot = await db.collection('users').where('username', '==', targetUsername).get();
            
            if (snapshot.empty) {
                document.getElementById('statusText').innerText = "User not found.";
                return;
            }

            const targetUserDoc = snapshot.docs[0];
            const targetData = targetUserDoc.data();
            const targetUID = targetUserDoc.id;

            // 2. Setup Session ID (Alphabetical sort ensures User A and User B get same ID)
            const ids = [user.uid, targetUID].sort();
            sessionID = `pulse_${ids[0]}_${ids[1]}`;
            sessionRef = rdb.ref(`pulse_sessions/${sessionID}`);

            // 3. UI Setup (Partner Badge)
            document.getElementById('partnerName').innerText = targetData.username || "User";
            document.getElementById('partnerImg').src = targetData.photoURL || "assets/default_pfp.png";
            if(targetData.isVerified) document.getElementById('partnerBadge').classList.add('verified');

            // 4. Presence System
            const myPresence = sessionRef.child(`members/${user.uid}`);
            myPresence.onDisconnect().remove();
            myPresence.set({
                username: user.displayName || "Unknown",
                state: 'online',
                last_seen: firebase.database.ServerValue.TIMESTAMP
            });

            // 5. Listen for Partner Presence
            sessionRef.child('members').on('value', (snap) => {
                const members = snap.val() || {};
                const count = Object.keys(members).length;
                
                if (count >= 2) {
                    // Both here!
                    startPulseSession();
                } else {
                    document.getElementById('waitingScreen').style.opacity = '1';
                    document.getElementById('waitingScreen').style.pointerEvents = 'auto';
                    document.getElementById('statusText').innerText = `Waiting for @${targetData.username}...`;
                }
            });

            // 6. Listen for Game State (Song, Reactions)
            setupGameListeners();
        }

        // --- 3. GAME LOGIC ---

        function startPulseSession() {
            // Fade out waiting screen
            const ws = document.getElementById('waitingScreen');
            ws.style.opacity = '0';
            ws.style.pointerEvents = 'none';
            document.getElementById('mainUI').style.opacity = '1';

            // Check if game hasn't started, default to alphabetical leader
            sessionRef.child('state').once('value', s => {
                if(!s.exists()) {
                    // First time load, initialize
                    // Alphabetical first ID starts
                    const ids = sessionID.replace('pulse_', '').split('_');
                    const firstTurn = ids[0] === currentUser.uid;
                    
                    if(firstTurn) {
                        openSongPicker(); // I am the leader, I start
                    } else {
                         document.getElementById('currentTitle').innerText = "Waiting for DJ...";
                    }
                }
            });
        }

        function setupGameListeners() {
            // A. LISTEN FOR NEW SONGS
            sessionRef.child('current_track').on('value', (snap) => {
                const song = snap.val();
                if (song) {
                    playSong(song);
                }
            });

            // B. LISTEN FOR REACTIONS
            sessionRef.child('reactions').limitToLast(1).on('child_added', (snap) => {
                const reaction = snap.val();
                // Don't show my own floating reaction (I saw it when I clicked)
                // Actually, showing both is fine for feedback
                if(Date.now() - reaction.timestamp < 5000) {
                    showFloatingEmoji(reaction.emoji);
                }
            });
        }

        const audio = document.getElementById('mainAudio');
        let playTimer;
        let emojiTimer;
        let queueTimer;

        function playSong(song) {
            // 1. Reset State
            hasQueuedNext = false;
            closeEmoji();
            document.querySelector('song-picker').close();
            clearTimeout(emojiTimer);
            clearTimeout(queueTimer);

            // 2. UI Update
            document.getElementById('currentTitle').innerText = song.trackName;
            document.getElementById('currentArtist').innerText = song.artistName;
            const hdArt = song.artworkUrl100.replace('100x100bb', '600x600bb');
            document.getElementById('currentArt').src = hdArt;
            
            // 3. Audio Sync
            audio.src = song.previewUrl;
            
            // Calculate offset (Server Time vs Now)
            // Ideally we use ServerValue.TIMESTAMP, but for simple sync:
            const now = Date.now();
            const startedAt = song.startedAt;
            const offset = (now - startedAt) / 1000;

            if (offset < 30) {
                audio.currentTime = offset > 0 ? offset : 0;
                audio.play().catch(e => console.log("Autoplay blocked usually, needs interaction"));
                
                // Bump animation
                const artContainer = document.getElementById('artContainer');
                artContainer.classList.remove('beat-bump');
                void artContainer.offsetWidth; // trigger reflow
                artContainer.classList.add('beat-bump');
                
                changeThemeColor(); // Random visualizer color
            }

            // 4. Determine Turn
            // If I did NOT choose this song, it is my turn next.
            isMyTurn = song.chosenBy !== currentUser.uid;

            // 5. Timers
            
            // A. Emoji Picker (3 seconds in)
            if (isMyTurn) {
                emojiTimer = setTimeout(() => {
                    openEmojiPicker();
                }, 3000); // 3s
            }

            // B. Song Picker (15 seconds in) - Time to queue next!
            if (isMyTurn) {
                queueTimer = setTimeout(() => {
                    // Close emoji if open
                    closeEmoji(); 
                    openSongPicker();
                }, 15000); // 15s
            }
        }

        // Handle Song End (Loop Logic)
        audio.onended = () => {
            // Check if next song is queued
            sessionRef.child('next_track').once('value', snap => {
                const next = snap.val();
                if (next) {
                    // Move Next -> Current
                    // Only one person needs to do this write. 
                    // Let the person who picked the NEXT song do the write to ensure ownership.
                    if (next.chosenBy === currentUser.uid) {
                        sessionRef.update({
                            current_track: {
                                ...next,
                                startedAt: firebase.database.ServerValue.TIMESTAMP
                            },
                            next_track: null // Clear queue
                        });
                    }
                } else {
                    // No song queued?
                    // If it was my turn and I didn't pick, force picker open
                    if (isMyTurn) openSongPicker();
                }
            });
        };

        // --- 4. COMPONENT HANDLERS ---

        const songPicker = document.getElementById('songPicker');
        const emojiModal = document.getElementById('emojiModalWrapper');

        function openSongPicker() {
            songPicker.open();
        }

        function openEmojiPicker() {
            emojiModal.classList.add('active');
        }

        function closeEmoji() {
            emojiModal.classList.remove('active');
        }

        // Listen for selection from SongPicker Component
        window.addEventListener('song-selected', (e) => {
            const song = e.detail;
            
            // Are we starting the session or queuing?
            if (audio.paused || audio.ended) {
                // Start immediately
                sessionRef.child('current_track').set({
                    ...song,
                    chosenBy: currentUser.uid,
                    startedAt: firebase.database.ServerValue.TIMESTAMP
                });
            } else {
                // Queue it for when current song ends
                sessionRef.child('next_track').set({
                    ...song,
                    chosenBy: currentUser.uid
                });
                hasQueuedNext = true;
                
                // Show feedback
                const title = document.getElementById('currentTitle');
                const oldText = title.innerText;
                title.innerText = "Next song queued!";
                setTimeout(() => title.innerText = oldText, 2000);
            }
        });

        // Listen for emoji click
        window.addEventListener('emoji-click', (e) => {
            const emoji = e.detail.emoji;
            
            // Send to DB
            sessionRef.child('reactions').push({
                emoji: emoji,
                from: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Close picker after selection? Or keep open?
            // User requirement: "choose a reaction... if not need simple close"
            // Let's keep it open for spamming, user closes manually or auto-closes at 15s
        });

        // --- 5. VISUALS ---

        function showFloatingEmoji(char) {
            const el = document.createElement('div');
            el.innerText = char;
            el.className = 'floating-emoji';
            el.style.left = (20 + Math.random() * 60) + '%'; // Random horizontal
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function changeThemeColor() {
            // Generate a vibrant color
            const hue = Math.floor(Math.random() * 360);
            const color = `hsl(${hue}, 80%, 60%)`;
            
            // Update CSS Variable for Aura
            document.documentElement.style.setProperty('--pulse-color', color);
            
            // Update Mobile Browser Toolbar
            document.getElementById('themeMeta').content = color;
        }

    </script>
</body>
</html>
