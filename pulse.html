<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goorac Pulse</title>
    
    <meta name="theme-color" content="#000000" id="themeMeta">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script src="config.js"></script>
    <script src="components/songPicker.js"></script>
    <script src="components/emojiPicker.js"></script>

    <style>
        /* --- CORE UI --- */
        :root {
            --pulse-color: #0a84ff; /* Dynamic Variable */
        }
        
        body {
            background-color: #000000; /* OLED Black */
            color: white;
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        /* --- VISUALIZER / AURA --- */
        .pulse-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1;
            transition: opacity 1s;
        }

        .aura-glow {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--pulse-color) 0%, rgba(0,0,0,0) 70%);
            opacity: 0.4;
            filter: blur(50px);
            z-index: -1;
            animation: breathe 4s infinite ease-in-out;
            transition: background 1s ease;
        }

        @keyframes breathe {
            0% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.5); opacity: 0.6; }
            100% { transform: scale(1); opacity: 0.3; }
        }

        /* Beat animation triggers on logic */
        .beat-bump { animation: bump 0.4s ease-out; }
        @keyframes bump { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- PLAYER UI --- */
        .album-art-container {
            width: 280px;
            height: 280px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            margin-bottom: 40px;
            position: relative;
            z-index: 2;
        }

        .album-art {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .track-info {
            text-align: center;
            z-index: 2;
            padding: 0 20px;
        }

        .track-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            max-width: 90vw;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            font-size: 18px;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }

        .turn-indicator {
            margin-top: 20px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--pulse-color);
            background: rgba(0,0,0,0.6);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- USER BADGES --- */
        .user-badge {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(20,20,20,0.6);
            backdrop-filter: blur(10px);
            padding: 8px 16px 8px 8px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 10;
        }
        
        .pfp { width: 32px; height: 32px; border-radius: 50%; background: #333; object-fit: cover; }
        .username { font-size: 14px; font-weight: 600; }
        .verified-icon { width: 14px; height: 14px; fill: #1DA1F2; display: none; }
        .verified .verified-icon { display: block; }

        /* --- WAITING STATE --- */
        #waitingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100;
            transition: opacity 0.5s;
        }
        .loader-ring {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--pulse-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- FLOATING EMOJI --- */
        .floating-emoji {
            position: absolute;
            bottom: 100px;
            font-size: 40px;
            animation: floatUp 3s ease-out forwards;
            z-index: 50;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            10% { opacity: 1; transform: translateY(-20px) scale(1.2); }
            100% { transform: translateY(-400px) scale(1); opacity: 0; }
        }

        /* --- MODAL FOR EMOJI PICKER --- */
        #emojiModalWrapper {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50%;
            background: #121212; border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 80; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        #emojiModalWrapper.active { transform: translateY(0); }
        .modal-drag { width: 40px; height: 5px; background: #333; border-radius: 10px; margin: 10px auto; }
        
        /* Custom Elements Layering */
        song-picker { z-index: 90; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <audio id="mainAudio" preload="auto"></audio>

    <song-picker id="songPicker"></song-picker>
    
    <div id="emojiModalWrapper">
        <div class="modal-drag" onclick="closeEmoji()"></div>
        <emoji-picker id="emojiPicker" style="flex:1;"></emoji-picker>
    </div>

    <div id="waitingScreen">
        <div class="loader-ring"></div>
        <div id="statusText" style="color: #888; font-size: 14px;">Initializing Pulse...</div>
    </div>

    <div class="pulse-container" id="mainUI" style="opacity: 0;">
        <div class="aura-glow" id="aura"></div>

        <div class="user-badge" id="partnerBadge">
            <img class="pfp" id="partnerImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
            <span class="username" id="partnerName">Connecting...</span>
            <svg class="verified-icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>

        <div class="album-art-container" id="artContainer">
            <img class="album-art" id="currentArt" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        </div>

        <div class="track-info">
            <div class="track-title" id="currentTitle">Waiting for DJ...</div>
            <div class="track-artist" id="currentArtist">...</div>
            <div class="turn-indicator" id="turnIndicator">CONNECTED</div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & HELPERS ---
        const urlParams = new URLSearchParams(window.location.search);
        // ?u=username of the person you are visiting
        const targetUsername = urlParams.get('u'); 

        let currentUser = null;
        let sessionID = null;
        let sessionRef = null;
        let isMyTurnToPick = false; 
        let hasQueuedNext = false;
        
        // --- 2. INITIALIZATION ---
        window.onload = async () => {
            if(!window.initFirebaseCore()) {
                alert("Firebase Error: Config not loaded.");
                return;
            }

            window.auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    if(targetUsername) initPulse(user);
                    else document.getElementById('statusText').innerText = "Link broken: No user specified.";
                } else {
                    window.location.href = "login.html"; 
                }
            });
        };

        async function initPulse(user) {
            const db = window.db;
            const rdb = window.rdb;
            
            // 1. Get Target User Profile
            const snapshot = await db.collection('users').where('username', '==', targetUsername).get();
            
            if (snapshot.empty) {
                document.getElementById('statusText').innerText = "User not found.";
                return;
            }

            const targetUserDoc = snapshot.docs[0];
            const targetData = targetUserDoc.data();
            const targetUID = targetUserDoc.id;

            // 2. Setup Session ID (Alphabetical sorting ensures consistency)
            const ids = [user.uid, targetUID].sort();
            sessionID = `pulse_${ids[0]}_${ids[1]}`;
            sessionRef = rdb.ref(`pulse_sessions/${sessionID}`);

            // 3. UI Setup
            document.getElementById('partnerName').innerText = targetData.username || "User";
            document.getElementById('partnerImg').src = targetData.photoURL || "assets/default_pfp.png";
            if(targetData.isVerified) document.getElementById('partnerBadge').classList.add('verified');

            // 4. Presence System
            const myPresence = sessionRef.child(`members/${user.uid}`);
            myPresence.onDisconnect().remove();
            myPresence.set({
                username: user.displayName || "Unknown",
                state: 'online',
                last_seen: firebase.database.ServerValue.TIMESTAMP
            });

            // 5. Listen for Partner Presence
            sessionRef.child('members').on('value', (snap) => {
                const members = snap.val() || {};
                const count = Object.keys(members).length;
                
                if (count >= 2) {
                    startPulseSession();
                } else {
                    document.getElementById('waitingScreen').style.opacity = '1';
                    document.getElementById('waitingScreen').style.pointerEvents = 'auto';
                    document.getElementById('statusText').innerText = `Waiting for @${targetData.username} to join...`;
                    // Pause if partner leaves
                    document.getElementById('mainAudio').pause(); 
                }
            });

            setupGameListeners();
        }

        // --- 3. GAME LOGIC ---

        function startPulseSession() {
            const ws = document.getElementById('waitingScreen');
            ws.style.opacity = '0';
            ws.style.pointerEvents = 'none';
            document.getElementById('mainUI').style.opacity = '1';

            // Initial Kickoff: If no song is playing, the alphabetical leader starts.
            sessionRef.child('current_track').once('value', s => {
                if(!s.exists()) {
                    const ids = sessionID.replace('pulse_', '').split('_');
                    // ID[0] is the leader by default
                    if(ids[0] === currentUser.uid) {
                        document.getElementById('turnIndicator').innerText = "IT'S YOUR TURN";
                        openSongPicker(); // Force open picker
                    } else {
                        document.getElementById('turnIndicator').innerText = "WAITING FOR DJ...";
                    }
                }
            });
        }

        function setupGameListeners() {
            // A. LISTEN FOR CURRENT SONG CHANGES
            sessionRef.child('current_track').on('value', (snap) => {
                const song = snap.val();
                if (song) playSong(song);
            });

            // B. LISTEN FOR REACTIONS
            sessionRef.child('reactions').limitToLast(1).on('child_added', (snap) => {
                const reaction = snap.val();
                if(Date.now() - reaction.timestamp < 3000) {
                    showFloatingEmoji(reaction.emoji);
                }
            });
        }

        const audio = document.getElementById('mainAudio');
        let emojiTimer, songQueueTimer;

        function playSong(song) {
            // 1. Reset
            hasQueuedNext = false;
            closeEmoji();
            document.querySelector('song-picker').close();
            clearTimeout(emojiTimer);
            clearTimeout(songQueueTimer);

            // 2. UI Update
            document.getElementById('currentTitle').innerText = song.trackName;
            document.getElementById('currentArtist').innerText = song.artistName;
            
            const hdArt = song.artworkUrl100.replace('100x100bb', '600x600bb');
            document.getElementById('currentArt').src = hdArt;

            // 3. Audio & Sync
            audio.src = song.previewUrl;
            
            const now = Date.now();
            const offset = (now - song.startedAt) / 1000;

            if (offset < 30) {
                audio.currentTime = offset > 0 ? offset : 0;
                audio.play().catch(console.warn);
                
                // Beat drop effect
                const artContainer = document.getElementById('artContainer');
                artContainer.classList.remove('beat-bump');
                void artContainer.offsetWidth; 
                artContainer.classList.add('beat-bump');
                
                changeThemeColor();
            }

            // 4. Turn Logic
            // The person who did NOT pick this song needs to pick the NEXT one.
            const iPickedThis = song.chosenBy === currentUser.uid;
            isMyTurnToPick = !iPickedThis;

            document.getElementById('turnIndicator').innerText = isMyTurnToPick ? "LISTENING..." : "DJING";

            if (isMyTurnToPick) {
                // TIMER 1: EMOJI (3s)
                emojiTimer = setTimeout(() => {
                    openEmojiPicker();
                }, 3000);

                // TIMER 2: SONG PICKER (15s)
                songQueueTimer = setTimeout(() => {
                    closeEmoji();
                    document.getElementById('turnIndicator').innerText = "PICK NEXT SONG";
                    openSongPicker();
                }, 15000);
            }
        }

        // --- 4. THE LOOP (Auto-Switch) ---
        audio.onended = () => {
            // Song finished (approx 30s).
            // Check for QUEUED song in DB.
            sessionRef.child('next_track').once('value', snap => {
                const nextSong = snap.val();
                
                if (nextSong) {
                    // Promote Next -> Current
                    // Only one client needs to perform this write. 
                    // Let the person who queued it (the NEW DJ) do it to ensure consistency.
                    if (nextSong.chosenBy === currentUser.uid) {
                        sessionRef.update({
                            current_track: { ...nextSong, startedAt: firebase.database.ServerValue.TIMESTAMP },
                            next_track: null
                        });
                    }
                } else {
                    // No song queued?
                    // Panic mode: If it was my turn and I didn't pick, force picker again.
                    if (isMyTurnToPick) {
                        openSongPicker();
                    }
                }
            });
        };

        // --- 5. COMPONENT EVENTS ---

        const songPicker = document.getElementById('songPicker');
        const emojiModal = document.getElementById('emojiModalWrapper');

        function openSongPicker() { songPicker.open(); }
        function openEmojiPicker() { emojiModal.classList.add('active'); }
        function closeEmoji() { emojiModal.classList.remove('active'); }

        // Event: Song Selected
        window.addEventListener('song-selected', (e) => {
            const song = e.detail;
            
            // Logic: Are we starting fresh or queuing?
            if (audio.paused || audio.ended) {
                // Start Immediately
                sessionRef.child('current_track').set({
                    ...song,
                    chosenBy: currentUser.uid,
                    startedAt: firebase.database.ServerValue.TIMESTAMP
                });
            } else {
                // Queue for next turn
                sessionRef.child('next_track').set({
                    ...song,
                    chosenBy: currentUser.uid
                });
                hasQueuedNext = true;
                
                // Feedback
                const oldText = document.getElementById('turnIndicator').innerText;
                document.getElementById('turnIndicator').innerText = "QUEUED NEXT";
                setTimeout(() => {
                   if(document.getElementById('turnIndicator').innerText === "QUEUED NEXT")
                       document.getElementById('turnIndicator').innerText = "WAITING...";
                }, 2000);
            }
        });

        // Event: Reaction
        window.addEventListener('emoji-click', (e) => {
            sessionRef.child('reactions').push({
                emoji: e.detail.emoji,
                from: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            // Optional: Close emoji picker after selection?
            // closeEmoji(); 
        });

        // --- 6. VISUALS ---

        function showFloatingEmoji(char) {
            const el = document.createElement('div');
            el.innerText = char;
            el.className = 'floating-emoji';
            // Random horizontal position (20% to 80%)
            el.style.left = (20 + Math.random() * 60) + '%'; 
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function changeThemeColor() {
            // Random vibrant hue
            const hue = Math.floor(Math.random() * 360);
            const color = `hsl(${hue}, 80%, 60%)`;
            
            document.documentElement.style.setProperty('--pulse-color', color);
            document.getElementById('themeMeta').content = color;
        }

    </script>
</body>
</html>
