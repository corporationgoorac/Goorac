<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>New Moment | Goorac Premium</title>
    
    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="components/songPicker.js"></script>
    <script src="components/closeFriends.js" defer></script>
    <script src="components/imagePicker.js" defer></script>
    <script src="components/filePicker.js" defer></script>
    <script src="components/emojiPicker.js" defer></script> 
    <script src="components/chatLoader.js" defer></script>
    <chat-loader></chat-loader>

    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Bangers&family=Dancing+Script:wght@700&family=Fredoka:wght@600&family=Orbitron:wght@700&family=Playfair+Display:ital,wght@1,700&family=Righteous&family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        /* ==========================================================================
           ROOT & CORE STYLES
           ========================================================================== */
        :root { 
            --bg: #000000; 
            --surface: #111111;
            --surface-glass: rgba(25, 25, 25, 0.7);
            --accent: #ff007f; 
            --accent-glow: rgba(255, 0, 127, 0.5);
            --text: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.6);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --safe-top: env(safe-area-inset-top, 20px);
            --nav-height: 70px;
            --transition-main: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            outline: none;
        }

        body {
            background-color: var(--bg); 
            color: var(--text);
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            margin: 0; 
            padding: 0; 
            height: 100dvh; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* COMPONENT Z-INDEX PRIORITY */
        song-picker, close-friends-selector, image-picker, file-picker { 
            position: absolute !important; 
            z-index: 999999 !important; 
            top: 0; left: 0;
        }

        /* ==========================================================================
           APP CONTAINER & NAVIGATION
           ========================================================================== */
        .app-modal {
            width: 100vw; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column;
            background: var(--bg);
            position: relative;
        }

        /* --- IMMERSIVE CANVAS --- */
        .canvas-container {
            flex: 1;
            position: relative; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: #0a0a0a; 
            z-index: 1; 
            overflow: hidden;
            transition: var(--transition-main);
        }

        #media-backdrop {
            position: absolute; 
            inset: -15%; 
            width: 130%; 
            height: 130%;
            object-fit: cover; 
            filter: blur(50px) brightness(0.4) saturate(1.2);
            z-index: 0; 
            display: none; 
            opacity: 0; 
            transition: opacity 0.8s ease;
        }

        /* ==========================================================================
           HEADER UI
           ========================================================================== */
        header {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            z-index: 100;
            padding: calc(15px + var(--safe-top)) 20px 30px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.85) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .header-left, .header-right {
            display: flex; 
            align-items: center; 
            gap: 12px; 
            pointer-events: auto;
        }

        .back-btn, .clear-media-btn { 
            width: 44px; 
            height: 44px; 
            border-radius: 50%;
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            display: flex; 
            align-items: center; 
            justify-content: center;
            color: #fff; 
            cursor: pointer; 
            border: 1px solid rgba(255,255,255,0.15);
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .back-btn:active, .clear-media-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.25); }
        
        .clear-media-btn { display: none; }
        .clear-media-btn.show { display: flex; animation: fadeInScale 0.3s ease forwards; }
        .back-btn.hide { display: none; }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .post-btn { 
            background: rgba(255,255,255,0.05); 
            color: rgba(255,255,255,0.3); 
            padding: 10px 24px; 
            border-radius: 100px; 
            backdrop-filter: blur(15px);
            font-weight: 800; 
            font-size: 14px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255,255,255,0.1); 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            pointer-events: none;
        }

        .post-btn.active { 
            pointer-events: auto; 
            background: #ffffff; 
            color: #000000; 
            border-color: #ffffff;
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.4); 
            animation: pulseBtnWhite 2s infinite;
        }

        @keyframes pulseBtnWhite {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 12px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        /* ==========================================================================
           MODE SELECTOR (CENTER UI)
           ========================================================================== */
        .mode-selector {
            display: flex; 
            flex-direction: column; 
            gap: 18px; 
            width: 100%; 
            max-width: 300px; 
            z-index: 50;
        }

        .mode-btn {
            background: rgba(255,255,255,0.08); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.12); 
            color: #fff; 
            padding: 18px 24px; 
            border-radius: 28px; 
            font-size: 16px; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            gap: 16px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        .mode-btn:active { transform: scale(0.96); background: rgba(255,255,255,0.15); }
        .mode-btn .material-icons-round { font-size: 26px; color: var(--accent); }

        /* ==========================================================================
           PREVIEW ELEMENTS
           ========================================================================== */
        #media-preview, #video-preview { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: none; 
            position: absolute; 
            inset: 0; 
            margin: auto; 
            z-index: 2; 
        }
        
        #text-preview { 
            width: 100%; 
            height: 100%; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            padding: 60px 40px 160px; 
            font-size: 38px; 
            font-weight: 800; 
            text-align: center; 
            word-break: break-word; 
            outline: none; 
            z-index: 10; 
            position: absolute; 
            inset: 0; 
            white-space: pre-wrap; 
            line-height: 1.2;
            transition: all 0.3s ease;
        }
        #text-preview:empty:before { content: 'Tap to express...'; opacity: 0.4; }

        /* TEXT EFFECTS */
        .fx-glow { text-shadow: 0 0 15px currentColor, 0 0 30px currentColor; }
        .fx-shadow { text-shadow: 4px 4px 0px rgba(0,0,0,0.8); }

        /* ==========================================================================
           TEXT TOOLS (FLOATING BAR)
           ========================================================================== */
        .text-tools {
            position: absolute; 
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            display: none; 
            align-items: center; 
            gap: 12px; 
            overflow-x: auto; 
            padding: 12px 20px; 
            scrollbar-width: none; 
            z-index: 150;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .text-tools::-webkit-scrollbar { display: none; }
        
        .t-btn { 
            width: 48px; 
            height: 48px; 
            border-radius: 16px; 
            background: rgba(255,255,255,0.1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0; 
            cursor: pointer; 
            color:#fff;
            transition: 0.2s;
        }
        .color-dot { 
            width: 34px; 
            height: 34px; 
            border-radius: 50%; 
            border: 2.5px solid rgba(255,255,255,0.4); 
            flex-shrink: 0; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .font-pill { 
            padding: 10px 20px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 16px; 
            font-size: 14px; 
            font-weight: 700;
            flex-shrink: 0; 
            cursor: pointer; 
            color:#fff;
        }

        /* ==========================================================================
           BOTTOM CONTROLS PANEL (THE FIXED BAR)
           ========================================================================== */
        .controls-panel {
            position: relative; /* Changed from absolute to ensure visibility */
            width: 100%;
            padding: 20px 20px calc(25px + var(--safe-bottom));
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
            background: #000;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 200;
            box-shadow: 0 -20px 60px rgba(0,0,0,0.9);
        }

        /* CAPTION AREA */
        .input-wrapper { 
            position: relative; 
            width: 100%; 
            display: flex; 
            align-items: flex-end; 
        }
        
        .caption-input {
            flex: 1; 
            background: rgba(255,255,255,0.07); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.12);
            color: #fff; 
            padding: 16px 90px 16px 20px; 
            border-radius: 22px; 
            font-size: 15px; 
            transition: var(--transition-main);
            resize: none; 
            min-height: 56px; 
            max-height: 140px; 
            overflow-y: auto;
            line-height: 1.5;
        }
        .caption-input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }
        
        .char-count {
            position: absolute; 
            right: 55px; 
            bottom: 18px;
            font-size: 10px; 
            font-weight: 800; 
            color: var(--text-dim); 
            pointer-events: none;
            letter-spacing: 1px;
        }

        .emoji-trigger-btn {
            position: absolute; 
            right: 10px; 
            bottom: 10px;
            background: rgba(255,255,255,0.05); 
            border-radius: 12px;
            font-size: 24px; 
            padding: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: 0.2s;
        }

        /* MUSIC TRIGGER */
        .song-btn {
            background: rgba(255,255,255,0.05); 
            border: 1.5px dashed rgba(255,255,255,0.2);
            color: #fff; 
            padding: 16px 20px; 
            border-radius: 24px; 
            font-size: 14px; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            gap: 14px; 
            cursor: pointer; 
            transition: 0.3s;
        }
        .song-btn.has-song { 
            border-style: solid; 
            border-color: var(--accent); 
            background: linear-gradient(90deg, rgba(255, 0, 127, 0.2), transparent); 
        }
        
        .song-icon { 
            background: rgba(255,255,255,0.1); 
            padding: 8px; 
            border-radius: 14px; 
            display: flex; 
            color: var(--accent);
        }

        /* SETTINGS ROW */
        .settings-row { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .setting-toggle {
            flex: 1; 
            background: rgba(255,255,255,0.05); 
            padding: 14px; 
            border-radius: 18px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            font-size: 13px; 
            font-weight: 700; 
            color: var(--text-dim); 
            border: 1px solid transparent; 
            transition: 0.3s;
        }
        .setting-toggle.active { 
            color: #fff; 
            border-color: rgba(255, 0, 127, 0.4); 
            background: rgba(255, 0, 127, 0.1); 
        }

        #edit-cf-btn {
            text-align: center; 
            font-size: 11px; 
            color: var(--accent); 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 1.2px;
            padding: 8px; 
            display: none; 
            animation: fadeIn 0.4s ease;
        }

        /* ==========================================================================
           EMOJI MODAL
           ========================================================================== */
        .emoji-modal-overlay {
            position: fixed; inset: 0; z-index: 1000000; background: rgba(0,0,0,0.8);
            display: none; align-items: flex-end; backdrop-filter: blur(8px);
            opacity: 0; transition: opacity 0.3s;
        }
        .emoji-modal-overlay.open { display: flex; opacity: 1; }
        
        .emoji-sheet {
            width: 100%; height: 60vh; background: #0a0a0a;
            border-top-left-radius: 32px; border-top-right-radius: 32px;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden; display: flex; flex-direction: column;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .emoji-modal-overlay.open .emoji-sheet { transform: translateY(0); }
        
        .emoji-sheet-header {
            display: flex; justify-content: center; padding: 15px;
            background: transparent;
        }
        .drag-handle { width: 44px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 10px; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="app-modal">
        
        <header>
            <div class="header-left">
                <div class="back-btn" id="header-back-btn" onclick="history.back()">
                    <span class="material-icons-round">arrow_back</span>
                </div>
                <button class="clear-media-btn" id="clear-btn" onclick="clearMedia()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="header-right">
                <button class="post-btn" id="post-btn" onclick="postMoment()">Share</button>
            </div>
        </header>

        <main class="canvas-container" id="canvas-bg">
            <img id="media-backdrop" src="" alt="Backdrop">

            <div class="mode-selector" id="mode-selector">
                <div class="mode-btn" onclick="setMode('text')">
                    <div class="song-icon"><span class="material-icons-round">text_fields</span></div> 
                    Type a Story
                </div>
                <div class="mode-btn" onclick="triggerHaptic(); document.getElementById('img-picker').openPicker()">
                    <div class="song-icon"><span class="material-icons-round">image</span></div> 
                    Gallery Photo
                </div>
                <div class="mode-btn" onclick="triggerHaptic(); document.getElementById('file-picker').openPicker()">
                    <div class="song-icon"><span class="material-icons-round">videocam</span></div> 
                    Pick a Video
                </div>
            </div>

            <div id="text-preview" contenteditable="true" spellcheck="false" data-placeholder="Tap to start typing..."></div>
            <img id="media-preview" src="" alt="Preview">
            <video id="video-preview" loop muted playsinline autoplay></video>

            <div class="text-tools" id="text-tools">
                <div class="t-btn" onclick="toggleAlign()"><span class="material-icons-round" id="align-icon">format_align_center</span></div>
                <div class="t-btn" onclick="toggleEffect()" id="fx-btn"><span class="material-icons-round">auto_fix_high</span></div>
                <div style="width:1px; height:30px; background:rgba(255,255,255,0.2); margin:0 8px;"></div>
                </div>
        </main>

        <footer class="controls-panel">
            <div class="input-wrapper">
                <textarea class="caption-input" id="caption-input" placeholder="What's happening? (Required)" maxlength="300" rows="1"></textarea>
                <span class="char-count" id="char-count">0/300</span>
                <button class="emoji-trigger-btn" onclick="openEmojiPicker()">ðŸ˜€</button>
            </div>
            
            <button class="song-btn" id="song-trigger" onclick="triggerHaptic(); document.getElementById('song-picker').open()">
                <div class="song-icon" id="song-icon-wrap"><span class="material-icons-round">music_note</span></div>
                <span id="song-label">Add Soundtrack (Required)</span>
            </button>

            <div class="settings-row">
                <div class="setting-toggle" id="audience-toggle" onclick="toggleAudience()">
                    <span class="material-icons-round" id="aud-icon" style="font-size:18px;">public</span>
                    <span id="aud-label">Public</span>
                </div>
                <div class="setting-toggle active" id="comments-toggle" onclick="toggleComments()">
                    <span class="material-icons-round" id="com-icon" style="font-size:18px;">chat_bubble</span>
                    <span id="com-label">Comments On</span>
                </div>
            </div>
            
            <div id="edit-cf-btn" onclick="document.getElementById('cf-selector').open()">
                Manage Close Friends <span class="material-icons-round" style="font-size: 14px; vertical-align: middle;">settings</span>
            </div>
        </footer>
    </div>

    <div class="emoji-modal-overlay" id="emoji-modal-overlay">
        <div class="emoji-sheet">
            <div class="emoji-sheet-header" onclick="closeEmojiPicker()">
                <div class="drag-handle"></div>
            </div>
            <div style="flex:1; position:relative;">
                <emoji-picker id="emoji-picker"></emoji-picker>
            </div>
        </div>
    </div>

    <song-picker id="song-picker"></song-picker>
    <close-friends-selector id="cf-selector"></close-friends-selector>
    <image-picker id="img-picker"></image-picker>
    <file-picker id="file-picker"></file-picker>

<script>
    /**
     * GOORAC CORE LOGIC
     * Handles state, Firebase interactions, and UI updates.
     */

    // --- FIREBASE INITIALIZATION ---
    if (typeof window.initFirebaseCore === 'function') {
        window.initFirebaseCore();
    } else if (!firebase.apps.length && window.firebaseConfig) {
        firebase.initializeApp(window.firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null;
    let isPosting = false;

    // --- CONFIGURATION ---
    const bgColors = [
        '#1a1a1a', '#ff007f', '#00d2ff', '#00ba7c', '#ff3b30', 
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'linear-gradient(45deg, #ff9a9e 0%, #fecfef 100%)',
        'radial-gradient(circle, #3f5efb 0%, #fc466b 100%)',
        'linear-gradient(to right, #4facfe 0%, #00f2fe 100%)'
    ];
    
    const fonts = [
        '-apple-system, sans-serif', 
        '"Abril Fatface"', 
        '"Bangers"', 
        '"Dancing Script"', 
        '"Orbitron"', 
        '"Fredoka"', 
        '"Righteous"'
    ];
    
    const effects = [
        { name: 'none', class: '' },
        { name: 'glow', class: 'fx-glow' },
        { name: 'shadow', class: 'fx-shadow' }
    ];

    // --- STATE MANAGEMENT ---
    let state = {
        mode: null, 
        text: '', 
        colorIdx: 0, 
        fontIdx: 0, 
        align: 'center', 
        effectIdx: 0,
        mediaUrl: null, 
        videoMeta: null,
        caption: '', 
        song: null,
        audience: 'public', 
        allowComments: true
    };

    // DOM Cache
    const els = {
        selector: document.getElementById('mode-selector'),
        textPreview: document.getElementById('text-preview'),
        imgPreview: document.getElementById('media-preview'),
        vidPreview: document.getElementById('video-preview'),
        mediaBackdrop: document.getElementById('media-backdrop'),
        clearBtn: document.getElementById('clear-btn'),
        backBtn: document.getElementById('header-back-btn'),
        canvasBg: document.getElementById('canvas-bg'),
        textTools: document.getElementById('text-tools'),
        captionInput: document.getElementById('caption-input'),
        charCount: document.getElementById('char-count'),
        songBtn: document.getElementById('song-trigger'),
        songLabel: document.getElementById('song-label'),
        songIconWrap: document.getElementById('song-icon-wrap'),
        postBtn: document.getElementById('post-btn'),
        emojiOverlay: document.getElementById('emoji-modal-overlay'),
        fxBtn: document.getElementById('fx-btn')
    };

    // --- UTILITIES ---
    function triggerHaptic() {
        if (navigator.vibrate) navigator.vibrate(12);
    }

    function autoResizeTextarea() {
        els.captionInput.style.height = 'auto';
        els.captionInput.style.height = (els.captionInput.scrollHeight) + 'px';
    }

    // --- INITIALIZATION ---
    function init() {
        // Auth Guardian
        auth.onAuthStateChanged(user => {
            if (user) currentUser = user;
            else window.location.href = 'login.html';
        });

        // Setup Text Tools
        bgColors.forEach((c, i) => {
            const dot = document.createElement('div');
            dot.className = 'color-dot';
            dot.style.background = c;
            dot.onclick = () => { 
                triggerHaptic(); 
                state.colorIdx = i; 
                updateTextVisuals(); 
                saveDraft(); 
            };
            els.textTools.appendChild(dot);
        });

        fonts.forEach((f, i) => {
            const pill = document.createElement('div');
            pill.className = 'font-pill';
            pill.style.fontFamily = f;
            pill.innerText = "Aa";
            pill.onclick = () => { 
                triggerHaptic(); 
                state.fontIdx = i; 
                updateTextVisuals(); 
                saveDraft(); 
            };
            els.textTools.appendChild(pill);
        });

        // Event Listeners
        els.captionInput.addEventListener('input', (e) => {
            autoResizeTextarea();
            updateCaptionState(e.target.value);
        });
        
        els.textPreview.addEventListener('input', (e) => { 
            state.text = e.target.innerText; 
            saveDraft(); 
        });
        
        // Listeners for Web Components
        document.addEventListener('song-selected', (e) => { 
            state.song = e.detail; 
            updateSongUI(); 
            saveDraft(); 
        });
        
        document.addEventListener('image-uploaded', (e) => {
            state.mediaUrl = e.detail.url; 
            setMode('image');
        });
        
        document.addEventListener('file-uploaded', (e) => {
            if(e.detail.metadata.type === 'video') {
                state.mediaUrl = e.detail.url; 
                state.videoMeta = e.detail.metadata; 
                setMode('video');
            } else {
                alert("Please upload a video file.");
            }
        });

        // Emoji System
        document.addEventListener('emoji-click', (e) => {
            triggerHaptic();
            if (state.mode === 'text' && document.activeElement === els.textPreview) {
                document.execCommand('insertText', false, e.detail.emoji);
            } else {
                const start = els.captionInput.selectionStart;
                const end = els.captionInput.selectionEnd;
                const text = els.captionInput.value;
                els.captionInput.value = text.substring(0, start) + e.detail.emoji + text.substring(end);
                autoResizeTextarea();
                updateCaptionState(els.captionInput.value);
            }
            saveDraft();
        });

        els.emojiOverlay.addEventListener('click', (e) => {
            if (e.target === els.emojiOverlay) closeEmojiPicker();
        });

        window.addEventListener('popstate', (e) => {
            if (els.emojiOverlay.classList.contains('open')) closeEmojiPicker(true);
        });

        loadDraft();
    }

    // --- NAVIGATION & MODALS ---
    function openEmojiPicker() {
        triggerHaptic();
        els.emojiOverlay.classList.add('open');
        window.history.pushState({ emojiPickerOpen: true }, "");
    }
    
    function closeEmojiPicker(fromHistory = false) {
        els.emojiOverlay.classList.remove('open');
        if (!fromHistory && window.history.state && window.history.state.emojiPickerOpen) {
            window.history.back();
        }
    }

    // --- CORE LOGIC ---
    function updateCaptionState(val) {
        state.caption = val;
        els.captionInput.value = val;
        const len = state.caption.length;
        els.charCount.innerText = `${len}/300`;
        els.charCount.classList.toggle('limit', len >= 290);
        saveDraft(); 
    }

    function setMode(mode) {
        triggerHaptic();
        state.mode = mode;
        els.selector.style.display = 'none';
        
        els.clearBtn.classList.add('show');
        els.backBtn.classList.add('hide');
        
        els.textPreview.style.display = 'none';
        els.imgPreview.style.display = 'none';
        els.vidPreview.style.display = 'none';
        els.mediaBackdrop.style.display = 'none';
        els.mediaBackdrop.style.opacity = '0';
        els.textTools.style.display = 'none';
        els.canvasBg.style.background = '#0a0a0a';

        if (mode === 'text') {
            els.textPreview.style.display = 'flex';
            els.textTools.style.display = 'flex';
            updateTextVisuals();
            setTimeout(() => els.textPreview.focus(), 100);
        } else if (mode === 'image') {
            els.imgPreview.style.display = 'block';
            els.imgPreview.src = state.mediaUrl;
            applyMediaBackdrop(state.mediaUrl);
        } else if (mode === 'video') {
            els.vidPreview.style.display = 'block';
            els.vidPreview.src = state.mediaUrl;
            applyMediaBackdrop(state.mediaUrl);
        }
        saveDraft();
    }

    function applyMediaBackdrop(url) {
        els.mediaBackdrop.src = url;
        els.mediaBackdrop.style.display = 'block';
        setTimeout(() => { els.mediaBackdrop.style.opacity = '1'; }, 100);
    }

    function clearMedia() {
        triggerHaptic();
        state.mode = null; 
        state.mediaUrl = null; 
        state.text = ''; 
        state.videoMeta = null;
        
        els.textPreview.innerText = '';
        els.imgPreview.src = ''; 
        els.vidPreview.src = ''; 
        els.mediaBackdrop.src = '';
        
        els.selector.style.display = 'flex';
        els.clearBtn.classList.remove('show');
        els.backBtn.classList.remove('hide');
        
        els.textPreview.style.display = 'none';
        els.imgPreview.style.display = 'none';
        els.vidPreview.style.display = 'none';
        els.mediaBackdrop.style.display = 'none';
        els.textTools.style.display = 'none';
        els.canvasBg.style.background = '#0a0a0a';
        saveDraft();
    }

    function updateTextVisuals() {
        els.canvasBg.style.background = bgColors[state.colorIdx];
        els.textPreview.style.fontFamily = fonts[state.fontIdx];
        els.textPreview.style.textAlign = state.align;
        
        els.textPreview.className = '';
        const currentEffect = effects[state.effectIdx];
        if (currentEffect && currentEffect.class) {
            els.textPreview.classList.add(currentEffect.class);
        }
        
        if (els.fxBtn) {
            els.fxBtn.style.background = state.effectIdx !== 0 ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
            els.fxBtn.style.color = state.effectIdx !== 0 ? '#fff' : '#fff';
        }
    }

    function toggleAlign() {
        triggerHaptic();
        const alignments = ['center', 'left', 'right'];
        const icons = ['format_align_center', 'format_align_left', 'format_align_right'];
        let curr = alignments.indexOf(state.align);
        state.align = alignments[(curr + 1) % 3];
        document.getElementById('align-icon').innerText = icons[(curr + 1) % 3];
        updateTextVisuals(); 
        saveDraft();
    }

    function toggleEffect() {
        triggerHaptic();
        state.effectIdx = (state.effectIdx + 1) % effects.length;
        updateTextVisuals(); 
        saveDraft();
    }

    function toggleAudience() {
        triggerHaptic();
        state.audience = state.audience === 'public' ? 'close_friends' : 'public';
        const isCF = state.audience === 'close_friends';
        
        const toggle = document.getElementById('audience-toggle');
        toggle.classList.toggle('active', isCF);
        document.getElementById('aud-icon').innerText = isCF ? 'stars' : 'public';
        document.getElementById('aud-label').innerText = isCF ? 'Close Friends' : 'Public';
        document.getElementById('edit-cf-btn').style.display = isCF ? 'block' : 'none';
        saveDraft();
    }

    function toggleComments() {
        triggerHaptic();
        state.allowComments = !state.allowComments;
        const toggle = document.getElementById('comments-toggle');
        toggle.classList.toggle('active', state.allowComments);
        document.getElementById('com-icon').innerText = state.allowComments ? 'chat_bubble' : 'comments_disabled';
        document.getElementById('com-label').innerText = state.allowComments ? 'Comments On' : 'Comments Off';
        saveDraft();
    }

    function updateSongUI() {
        if (state.song) {
            els.songBtn.classList.add('has-song');
            els.songLabel.innerText = `${state.song.trackName} â€¢ ${state.song.artistName}`;
            els.songIconWrap.style.color = '#fff';
            els.songIconWrap.style.background = 'var(--accent)';
        } else {
            els.songBtn.classList.remove('has-song');
            els.songLabel.innerText = "Add Soundtrack (Required)";
            els.songIconWrap.style.color = 'var(--accent)';
            els.songIconWrap.style.background = 'rgba(255,255,255,0.1)';
        }
    }

    // --- PERSISTENCE ---
    function saveDraft() {
        localStorage.setItem('goorac_moment_draft', JSON.stringify(state));
        validatePost();
    }

    function loadDraft() {
        const draftStr = localStorage.getItem('goorac_moment_draft');
        if (!draftStr) {
            validatePost();
            return;
        }
        
        try {
            const draft = JSON.parse(draftStr);
            state = { ...state, ...draft };
            
            updateCaptionState(state.caption || '');
            els.textPreview.innerText = state.text || '';
            updateSongUI();
            
            if (state.audience === 'close_friends') {
                state.audience = 'public'; 
                toggleAudience();
            }
            
            if (!state.allowComments) {
                state.allowComments = true; 
                toggleComments();
            }

            if (state.mode) setMode(state.mode);
        } catch(e) { console.error("Draft error", e); }
        
        validatePost();
    }

    function validatePost() {
        const hasMedia = (state.mode === 'text' && state.text.trim().length > 0) || 
                         (state.mode === 'image' && state.mediaUrl) || 
                         (state.mode === 'video' && state.mediaUrl);
        const hasCaption = state.caption.trim().length > 0;
        const hasSong = state.song !== null;

        if (hasMedia && hasCaption && hasSong) {
            els.postBtn.classList.add('active');
        } else {
            els.postBtn.classList.remove('active');
        }
    }

    // --- SUBMISSION ---
    async function postMoment() {
        if (isPosting || !els.postBtn.classList.contains('active')) return;
        if (!currentUser) return;

        triggerHaptic();
        isPosting = true;
        els.postBtn.classList.add('loading');
        els.postBtn.innerHTML = `<span class="material-icons-round" style="font-size:16px; animation:spin 1.5s linear infinite; margin-right:8px;">sync</span> Sending...`;

        try {
            const userDoc = await db.collection("users").doc(currentUser.uid).get();
            const userData = userDoc.data() || {};
            
            const expiry = new Date();
            expiry.setHours(expiry.getHours() + 24);

            const payload = {
                uid: currentUser.uid,
                username: userData.username || "anonymous",
                displayName: userData.name || "User",
                pfp: userData.photoURL || currentUser.photoURL || "",
                verified: userData.verified || false,
                
                type: state.mode, 
                caption: state.caption.trim(),
                audience: state.audience,
                allowComments: state.allowComments,
                
                songName: state.song.trackName,
                songArtist: state.song.artistName,
                songPreview: state.song.previewUrl,
                songArt: state.song.artworkUrl100,

                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: firebase.firestore.Timestamp.fromDate(expiry),
                likes: [],
                comments: []
            };

            if (state.mode === 'text') {
                payload.text = state.text;
                payload.bgColor = bgColors[state.colorIdx];
                payload.font = fonts[state.fontIdx];
                payload.align = state.align;
                payload.effect = effects[state.effectIdx].name;
            } else {
                payload.mediaUrl = state.mediaUrl;
                if (state.mode === 'video') payload.videoMeta = state.videoMeta;
            }

            await db.collection("moments").add(payload);
            
            localStorage.removeItem('goorac_moment_draft');
            window.location.href = 'home.html';

        } catch (error) {
            console.error("Post Error:", error);
            alert("Upload failed. Please check your connection.");
            els.postBtn.innerHTML = 'Share';
            isPosting = false;
        }
    }

    // Initialize the engine
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
