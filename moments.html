<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>New Moment | Goorac</title>
    
    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="components/songPicker.js"></script>
    <script src="components/closeFriends.js" defer></script>
    <script src="components/imagePicker.js" defer></script>
    <script src="components/filePicker.js" defer></script>
    <script src="components/emojiPicker.js" defer></script> 
    <script src="components/chatLoader.js" defer></script>
    <chat-loader></chat-loader>

    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Bangers&family=Dancing+Script:wght@700&family=Fredoka:wght@600&family=Orbitron:wght@700&family=Playfair+Display:ital,wght@1,700&family=Righteous&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root { 
            --bg: #000000; 
            --surface: #111111;
            --surface-glass: rgba(20, 20, 20, 0.6);
            --accent: #ff007f; 
            --accent-glow: rgba(255, 0, 127, 0.4);
            --text: #ffffff;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --safe-top: env(safe-area-inset-top, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; height: 100dvh; overflow: hidden;
        }

        /* FIX: Ultimate Z-Index to ensure components (like song-picker) are NEVER blocked */
        song-picker, close-friends-selector, image-picker, file-picker { 
            position: absolute !important; 
            z-index: 2147483647 !important; 
            top: 0; left: 0;
        }

        /* --- SLIDE-IN APP MODAL --- */
        .app-modal {
            width: 100vw; height: 100dvh; 
            display: flex; flex-direction: column;
            background: var(--bg);
            /* Slide animation removed per user request */
            position: relative;
        }

        /* --- IMMERSIVE CANVAS (IG Story Style) --- */
        .canvas-container {
            position: absolute; inset: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: #1a1a1a; z-index: 1; overflow: hidden;
            border-radius: 0; /* Edge to edge */
        }

        /* Dynamic Blurred Backdrop for Media */
        #media-backdrop {
            position: absolute; inset: -10%; width: 120%; height: 120%;
            object-fit: cover; filter: blur(40px) brightness(0.6);
            z-index: 0; display: none; opacity: 0; transition: opacity 0.5s;
        }

        /* Floating Header - Fixed Overlaps */
        header {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 50;
            padding: calc(15px + var(--safe-top)) 20px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .header-left, .header-right {
            display: flex; align-items: center; gap: 15px; pointer-events: auto;
        }

        .back-btn, .clear-media-btn { 
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            color: #fff; cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.2s;
        }
        .back-btn:active, .clear-media-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        
        /* Clear btn logic handled via display classes now */
        .clear-media-btn { display: none; }
        .clear-media-btn.show { display: flex; }
        .back-btn.hide { display: none; }

        .post-btn { 
            background: rgba(0,0,0,0.4); color: rgba(255,255,255,0.6); 
            padding: 8px 22px; border-radius: 100px; backdrop-filter: blur(10px);
            font-weight: 700; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            pointer-events: none;
        }
        /* Updated Share Button Style per request: White BG, Black Text */
        .post-btn.active { 
            pointer-events: auto; background: #ffffff; color: #000000; 
            border-color: #ffffff;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3); 
            animation: pulseBtnWhite 2s infinite;
        }
        @keyframes pulseBtnWhite {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        /* Mode Selection UI */
        .mode-selector {
            display: flex; flex-direction: column; gap: 16px; width: 100%; max-width: 280px; z-index: 20;
        }
        .mode-btn {
            background: rgba(20,20,20,0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1); color: #fff; 
            padding: 16px 20px; border-radius: 24px; font-size: 15px; font-weight: 600;
            display: flex; align-items: center; gap: 14px; cursor: pointer; transition: 0.2s;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        .mode-btn:active { transform: scale(0.95); background: rgba(40,40,40,0.8); }
        .mode-btn .material-icons-round { font-size: 24px; color: var(--accent); }

        /* Media Elements - Perfect centering with object-fit contain */
        #media-preview, #video-preview { 
            width: 100%; height: 100%; object-fit: contain; display: none; 
            position: absolute; inset: 0; margin: auto; z-index: 1; 
        }
        
        #text-preview { 
            width: 100%; height: 100%; display: none; align-items: center; justify-content: center; 
            padding: 40px 30px 140px; font-size: 36px; font-weight: 800; text-align: center; word-break: break-word; outline: none; 
            z-index: 2; position: absolute; inset: 0; white-space: pre-wrap; line-height: 1.25;
            transition: all 0.3s ease;
        }
        #text-preview:empty:before { content: 'Tap to type...'; opacity: 0.5; }

        /* NEW TEXT EFFECTS */
        .fx-glow { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
        .fx-shadow { text-shadow: 3px 3px 0px rgba(0,0,0,0.8); }

        /* Floating Text Tools */
        .text-tools {
            position: absolute; bottom: calc(200px + var(--safe-bottom)); left: 0; width: 100%;
            display: none; align-items: center; gap: 12px; overflow-x: auto; 
            padding: 10px 20px; scrollbar-width: none; z-index: 30;
        }
        .text-tools::-webkit-scrollbar { display: none; }
        .t-btn { width: 44px; height: 44px; border-radius: 14px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; color:#fff;}
        .t-btn:active { transform: scale(0.9); }
        .color-dot { width: 38px; height: 38px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); flex-shrink: 0; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: 0.2s;}
        .color-dot:active { transform: scale(0.85); }
        .font-pill { padding: 10px 18px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15); border-radius: 14px; font-size: 14px; flex-shrink: 0; cursor: pointer; color:#fff; transition: 0.2s;}

        /* --- BOTTOM CONTROLS PANEL (Floating Glass) --- */
        .controls-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px 20px calc(20px + var(--safe-bottom));
            display: flex; flex-direction: column; gap: 12px; 
            background: linear-gradient(to top, rgba(0,0,0,0.95) 20%, rgba(0,0,0,0.6) 80%, transparent);
            z-index: 50;
        }

        /* Input Wrappers */
        .input-wrapper { position: relative; width: 100%; display: flex; align-items: flex-end; }
        
        /* MULTILINE TEXTAREA UPGRADES */
        .caption-input {
            flex: 1; background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.15);
            color: #fff; padding: 16px 85px 16px 16px; border-radius: 20px; font-size: 15px; outline: none;
            transition: border-color 0.2s, background 0.2s;
            resize: none; /* Prevents manual resizing */
            min-height: 52px; /* Starting height */
            max-height: 120px; /* Max height before scrolling inside */
            overflow-y: auto;
            line-height: 1.4;
            font-family: inherit;
        }
        .caption-input:focus { border-color: var(--accent); background: rgba(255,255,255,0.15); }
        .caption-input::placeholder { color: rgba(255,255,255,0.5); }
        
        .char-count {
            position: absolute; right: 50px; bottom: 18px;
            font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.5); pointer-events: none;
        }
        .char-count.limit { color: #ff3b30; }

        .emoji-trigger-btn {
            position: absolute; right: 8px; bottom: 8px;
            background: none; border: none; font-size: 22px; cursor: pointer;
            padding: 6px; display: flex; align-items: center; justify-content: center;
            opacity: 0.8; transition: 0.2s;
        }
        .emoji-trigger-btn:active { transform: scale(0.9); opacity: 1; }

        .song-btn {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); border: 1px dashed rgba(255,255,255,0.3);
            color: #fff; padding: 14px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s;
        }
        .song-btn.has-song { border-style: solid; border-color: var(--accent); background: rgba(255, 0, 127, 0.15); }
        .song-btn span { flex: 1; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .song-icon { background: rgba(255,255,255,0.15); padding: 6px; border-radius: 12px; display: flex; }

        /* Settings Row */
        .settings-row { display: flex; align-items: center; gap: 10px; }
        
        .setting-toggle {
            flex: 1; background: rgba(255,255,255,0.08); backdrop-filter: blur(15px); padding: 12px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            font-size: 12px; font-weight: 700; color: #aaa; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.05); transition: 0.2s;
        }
        .setting-toggle.active { color: #fff; border-color: var(--accent); background: rgba(255, 0, 127, 0.15); }
        .setting-toggle:active { transform: scale(0.97); }

        #edit-cf-btn {
            text-align: center; font-size: 11px; color: var(--accent); 
            font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            padding: 5px; display: none; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* --- EMOJI MODAL BOTTOM SHEET --- */
        .emoji-modal-overlay {
            position: fixed; inset: 0; z-index: 100000; background: rgba(0,0,0,0.5);
            display: none; align-items: flex-end; backdrop-filter: blur(2px);
            opacity: 0; transition: opacity 0.2s;
        }
        .emoji-modal-overlay.open { display: flex; opacity: 1; }
        
        .emoji-sheet {
            width: 100%; height: 55vh; background: #121212;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1);
            overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .emoji-modal-overlay.open .emoji-sheet { transform: translateY(0); }
        
        .emoji-sheet-header {
            display: flex; justify-content: center; padding: 10px;
            background: #121212; border-bottom: 1px solid #222;
        }
        .drag-handle { width: 40px; height: 5px; background: #444; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="app-modal">
        
        <header>
            <div class="header-left">
                <div class="back-btn" id="header-back-btn" onclick="history.back()">
                    <span class="material-icons-round">arrow_back</span>
                </div>
                <button class="clear-media-btn" id="clear-btn" onclick="clearMedia()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="header-right">
                <button class="post-btn" id="post-btn" onclick="postMoment()">Share</button>
            </div>
        </header>

        <div class="canvas-container" id="canvas-bg">
            <img id="media-backdrop" src="">

            <div class="mode-selector" id="mode-selector">
                <div class="mode-btn" onclick="setMode('text')">
                    <div class="song-icon"><span class="material-icons-round">text_fields</span></div> 
                    Write a Text Moment
                </div>
                <div class="mode-btn" onclick="triggerHaptic(); document.getElementById('img-picker').openPicker()">
                    <div class="song-icon"><span class="material-icons-round">image</span></div> 
                    Upload a Photo
                </div>
                <div class="mode-btn" onclick="triggerHaptic(); document.getElementById('file-picker').openPicker()">
                    <div class="song-icon"><span class="material-icons-round">videocam</span></div> 
                    Upload a Video
                </div>
            </div>

            <div id="text-preview" contenteditable="true" spellcheck="false"></div>
            <img id="media-preview" src="">
            <video id="video-preview" loop muted playsinline autoplay></video>

            <div class="text-tools" id="text-tools">
                <div class="t-btn" onclick="toggleAlign()"><span class="material-icons-round" id="align-icon">format_align_center</span></div>
                <div class="t-btn" onclick="toggleEffect()" id="fx-btn"><span class="material-icons-round">auto_fix_high</span></div>
                <div style="width:1px; height:24px; background:rgba(255,255,255,0.3); margin:0 4px;"></div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="input-wrapper">
                <textarea class="caption-input" id="caption-input" placeholder="Write a caption (Required)..." maxlength="300" rows="1"></textarea>
                <span class="char-count" id="char-count">0/300</span>
                <button class="emoji-trigger-btn" onclick="openEmojiPicker()">ðŸ˜€</button>
            </div>
            
            <button class="song-btn" id="song-trigger" onclick="triggerHaptic(); document.getElementById('song-picker').open()">
                <div class="song-icon" id="song-icon-wrap"><span class="material-icons-round">music_note</span></div>
                <span id="song-label">Select a Song (Required)</span>
            </button>

            <div class="settings-row">
                <div class="setting-toggle" id="audience-toggle" onclick="toggleAudience()">
                    <span class="material-icons-round" id="aud-icon" style="font-size:16px;">public</span>
                    <span id="aud-label">Public</span>
                </div>
                <div class="setting-toggle active" id="comments-toggle" onclick="toggleComments()">
                    <span class="material-icons-round" id="com-icon" style="font-size:16px;">chat_bubble</span>
                    <span id="com-label">Comments On</span>
                </div>
            </div>
            
            <div id="edit-cf-btn" onclick="document.getElementById('cf-selector').open()">
                Edit Close Friends List <span class="material-icons-round" style="font-size: 12px; vertical-align: middle;">edit</span>
            </div>
        </div>
    </div>

    <div class="emoji-modal-overlay" id="emoji-modal-overlay">
        <div class="emoji-sheet">
            <div class="emoji-sheet-header" onclick="closeEmojiPicker()">
                <div class="drag-handle"></div>
            </div>
            <div style="flex:1; position:relative;">
                <emoji-picker id="emoji-picker"></emoji-picker>
            </div>
        </div>
    </div>

    <song-picker id="song-picker"></song-picker>
    <close-friends-selector id="cf-selector"></close-friends-selector>
    <image-picker id="img-picker"></image-picker>
    <file-picker id="file-picker"></file-picker>

<script>
    // --- FIREBASE INIT ---
    if (typeof window.initFirebaseCore === 'function') {
        window.initFirebaseCore();
    } else if (!firebase.apps.length && window.firebaseConfig) {
        firebase.initializeApp(window.firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null;
    let isPosting = false;

    // --- TEXT MODE CONFIG ---
    const bgColors = [
        '#1a1a1a', '#ff007f', '#00d2ff', '#00ba7c', '#ff3b30', 
        'linear-gradient(45deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)',
        'radial-gradient(circle, rgba(63,94,251,1) 0%, rgba(252,70,107,1) 100%)',
        'linear-gradient(to right, #4facfe 0%, #00f2fe 100%)',
        'linear-gradient(to top, #0ba360 0%, #3cba92 100%)'
    ];
    const fonts = ['-apple-system, sans-serif', '"Abril Fatface"', '"Bangers"', '"Dancing Script"', '"Orbitron"', '"Fredoka"', '"Righteous"'];
    
    // NEW TEXT EFFECTS CONFIG
    const effects = [
        { name: 'none', class: '' },
        { name: 'glow', class: 'fx-glow' },
        { name: 'shadow', class: 'fx-shadow' }
    ];

    // --- STATE ---
    let state = {
        mode: null, // 'text', 'image', 'video'
        text: '', colorIdx: 0, fontIdx: 0, align: 'center', effectIdx: 0,
        mediaUrl: null, videoMeta: null,
        caption: '', song: null,
        audience: 'public', allowComments: true
    };

    const els = {
        selector: document.getElementById('mode-selector'),
        textPreview: document.getElementById('text-preview'),
        imgPreview: document.getElementById('media-preview'),
        vidPreview: document.getElementById('video-preview'),
        mediaBackdrop: document.getElementById('media-backdrop'),
        clearBtn: document.getElementById('clear-btn'),
        backBtn: document.getElementById('header-back-btn'),
        canvasBg: document.getElementById('canvas-bg'),
        textTools: document.getElementById('text-tools'),
        captionInput: document.getElementById('caption-input'),
        charCount: document.getElementById('char-count'),
        songBtn: document.getElementById('song-trigger'),
        songLabel: document.getElementById('song-label'),
        songIconWrap: document.getElementById('song-icon-wrap'),
        postBtn: document.getElementById('post-btn'),
        emojiOverlay: document.getElementById('emoji-modal-overlay'),
        fxBtn: document.getElementById('fx-btn')
    };

    function triggerHaptic() {
        if (navigator.vibrate) navigator.vibrate(15);
    }

    // --- AUTO RESIZE MULTILINE CAPTION ---
    function autoResizeTextarea() {
        els.captionInput.style.height = 'auto'; // Reset height
        els.captionInput.style.height = (els.captionInput.scrollHeight) + 'px'; // Set to scroll height
    }

    // --- INIT ---
    function init() {
        auth.onAuthStateChanged(user => {
            if (user) currentUser = user;
            else window.location.href = 'login.html';
        });

        // Build Text Formatting Row
        bgColors.forEach((c, i) => {
            const dot = document.createElement('div');
            dot.className = 'color-dot';
            dot.style.background = c;
            dot.onclick = () => { triggerHaptic(); state.colorIdx = i; updateTextVisuals(); saveDraft(); };
            els.textTools.appendChild(dot);
        });
        fonts.forEach((f, i) => {
            const pill = document.createElement('div');
            pill.className = 'font-pill';
            pill.style.fontFamily = f;
            pill.innerText = "Abc";
            pill.onclick = () => { triggerHaptic(); state.fontIdx = i; updateTextVisuals(); saveDraft(); };
            els.textTools.appendChild(pill);
        });

        // Event Listeners
        els.captionInput.addEventListener('input', (e) => {
            autoResizeTextarea();
            updateCaptionState(e.target.value);
        });
        
        els.textPreview.addEventListener('input', (e) => { state.text = e.target.innerText; saveDraft(); });
        
        // Listeners for Web Components
        document.addEventListener('song-selected', (e) => { state.song = e.detail; updateSongUI(); saveDraft(); });
        
        document.addEventListener('image-uploaded', (e) => {
            state.mediaUrl = e.detail.url; setMode('image');
        });
        
        document.addEventListener('file-uploaded', (e) => {
            if(e.detail.metadata.type === 'video') {
                state.mediaUrl = e.detail.url; state.videoMeta = e.detail.metadata; setMode('video');
            } else {
                alert("Only videos are supported in Moments.");
            }
        });

        // Emoji Integration
        document.addEventListener('emoji-click', (e) => {
            triggerHaptic();
            if (state.mode === 'text' && document.activeElement === els.textPreview) {
                els.textPreview.innerText += e.detail.emoji;
                state.text = els.textPreview.innerText;
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(els.textPreview);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
            } else {
                els.captionInput.value += e.detail.emoji;
                autoResizeTextarea();
                updateCaptionState(els.captionInput.value);
            }
            saveDraft();
        });

        els.emojiOverlay.addEventListener('click', (e) => {
            if (e.target === els.emojiOverlay) closeEmojiPicker();
        });

        // HANDLE DEVICE BACK BUTTON FOR EMOJI PICKER
        window.addEventListener('popstate', (e) => {
            if (els.emojiOverlay.classList.contains('open')) {
                closeEmojiPicker(true);
            }
        });

        loadDraft();
        autoResizeTextarea(); // Initialize correct height if draft loaded
    }

    // --- EMOJI MODAL ---
    function openEmojiPicker() {
        triggerHaptic();
        els.emojiOverlay.classList.add('open');
        window.history.pushState({ emojiPickerOpen: true }, "");
    }
    
    function closeEmojiPicker(fromHistory = false) {
        els.emojiOverlay.classList.remove('open');
        if (!fromHistory && window.history.state && window.history.state.emojiPickerOpen) {
            window.history.back();
        }
    }

    // --- CORE LOGIC ---
    function updateCaptionState(val) {
        state.caption = val;
        els.captionInput.value = val;
        const len = state.caption.length;
        els.charCount.innerText = `${len}/300`;
        els.charCount.classList.toggle('limit', len >= 290);
        saveDraft(); 
    }

    function setMode(mode) {
        triggerHaptic();
        state.mode = mode;
        els.selector.style.display = 'none';
        
        els.clearBtn.classList.add('show');
        els.backBtn.classList.add('hide');
        
        els.textPreview.style.display = 'none';
        els.imgPreview.style.display = 'none';
        els.vidPreview.style.display = 'none';
        els.mediaBackdrop.style.display = 'none';
        els.mediaBackdrop.style.opacity = '0';
        els.textTools.style.display = 'none';
        els.canvasBg.style.background = '#1a1a1a';

        if (mode === 'text') {
            els.textPreview.style.display = 'flex';
            els.textTools.style.display = 'flex';
            updateTextVisuals();
            els.textPreview.focus();
        } else if (mode === 'image') {
            els.imgPreview.style.display = 'block';
            els.imgPreview.src = state.mediaUrl;
            applyMediaBackdrop(state.mediaUrl);
        } else if (mode === 'video') {
            els.vidPreview.style.display = 'block';
            els.vidPreview.src = state.mediaUrl;
            applyMediaBackdrop(state.mediaUrl); // Basic poster fallback if needed, but video centers itself
        }
        saveDraft();
    }

    function applyMediaBackdrop(url) {
        els.mediaBackdrop.src = url;
        els.mediaBackdrop.style.display = 'block';
        // Fade in slightly after load for smooth transition
        setTimeout(() => { els.mediaBackdrop.style.opacity = '1'; }, 50);
    }

    function clearMedia() {
        triggerHaptic();
        state.mode = null; state.mediaUrl = null; state.text = ''; state.videoMeta = null;
        els.textPreview.innerText = '';
        els.imgPreview.src = ''; els.vidPreview.src = ''; els.mediaBackdrop.src = '';
        
        els.selector.style.display = 'flex';
        els.clearBtn.classList.remove('show');
        els.backBtn.classList.remove('hide');
        
        els.textPreview.style.display = 'none';
        els.imgPreview.style.display = 'none';
        els.vidPreview.style.display = 'none';
        els.mediaBackdrop.style.display = 'none';
        els.textTools.style.display = 'none';
        els.canvasBg.style.background = '#1a1a1a';
        saveDraft();
    }

    function updateTextVisuals() {
        els.canvasBg.style.background = bgColors[state.colorIdx];
        els.textPreview.style.fontFamily = fonts[state.fontIdx];
        els.textPreview.style.textAlign = state.align;
        els.textPreview.style.color = '#fff'; 
        
        // Reset and Apply Effect Class
        els.textPreview.className = '';
        const currentEffect = effects[state.effectIdx];
        if (currentEffect && currentEffect.class) {
            els.textPreview.classList.add(currentEffect.class);
        }
        
        // Update Effect Button UI
        if (els.fxBtn) {
            els.fxBtn.style.background = state.effectIdx !== 0 ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0,0,0,0.6)';
            els.fxBtn.style.color = state.effectIdx !== 0 ? 'var(--accent)' : '#fff';
        }
    }

    function toggleAlign() {
        triggerHaptic();
        const alignments = ['center', 'left', 'right'];
        const icons = ['format_align_center', 'format_align_left', 'format_align_right'];
        let curr = alignments.indexOf(state.align);
        state.align = alignments[(curr + 1) % 3];
        document.getElementById('align-icon').innerText = icons[(curr + 1) % 3];
        updateTextVisuals(); saveDraft();
    }

    // NEW FUNCTION: Toggle Text Effects
    function toggleEffect() {
        triggerHaptic();
        state.effectIdx = (state.effectIdx + 1) % effects.length;
        updateTextVisuals(); 
        saveDraft();
    }

    function toggleAudience() {
        triggerHaptic();
        state.audience = state.audience === 'public' ? 'close_friends' : 'public';
        const isCF = state.audience === 'close_friends';
        
        const toggle = document.getElementById('audience-toggle');
        toggle.classList.toggle('active', isCF);
        document.getElementById('aud-icon').innerText = isCF ? 'stars' : 'public';
        document.getElementById('aud-label').innerText = isCF ? 'Close Friends' : 'Public';
        document.getElementById('edit-cf-btn').style.display = isCF ? 'block' : 'none';
        saveDraft();
    }

    function toggleComments() {
        triggerHaptic();
        state.allowComments = !state.allowComments;
        const toggle = document.getElementById('comments-toggle');
        toggle.classList.toggle('active', state.allowComments);
        document.getElementById('com-icon').innerText = state.allowComments ? 'chat_bubble' : 'comments_disabled';
        document.getElementById('com-label').innerText = state.allowComments ? 'Comments On' : 'Comments Off';
        saveDraft();
    }

    function updateSongUI() {
        if (state.song) {
            els.songBtn.classList.add('has-song');
            els.songLabel.innerText = `${state.song.trackName} â€¢ ${state.song.artistName}`;
            els.songIconWrap.style.background = 'var(--accent)';
        } else {
            els.songBtn.classList.remove('has-song');
            els.songLabel.innerText = "Select a Song (Required)";
            els.songIconWrap.style.background = 'rgba(255,255,255,0.15)';
        }
    }

    // --- DRAFT & VALIDATION ---
    function saveDraft() {
        localStorage.setItem('goorac_moment_draft', JSON.stringify(state));
        validatePost();
    }

    function loadDraft() {
        const draft = JSON.parse(localStorage.getItem('goorac_moment_draft'));
        if (draft) {
            state = { ...state, ...draft };
            updateCaptionState(state.caption || '');
            els.textPreview.innerText = state.text;
            updateSongUI();
            
            if (state.audience === 'close_friends') { state.audience = 'public'; toggleAudience(); } 
            if (!state.allowComments) { state.allowComments = true; toggleComments(); }

            if (state.mode) setMode(state.mode);
        }
        validatePost();
    }

    function validatePost() {
        const hasMedia = (state.mode === 'text' && state.text.trim().length > 0) || 
                         (state.mode === 'image' && state.mediaUrl) || 
                         (state.mode === 'video' && state.mediaUrl);
        const hasCaption = state.caption.trim().length > 0;
        const hasSong = state.song !== null;

        if (hasMedia && hasCaption && hasSong) {
            if(!els.postBtn.classList.contains('active')) triggerHaptic(); 
            els.postBtn.classList.add('active');
            els.postBtn.innerText = "Share";
        } else {
            els.postBtn.classList.remove('active');
            els.postBtn.innerText = "Share";
        }
    }

    // --- POSTING ---
    async function postMoment() {
        if (isPosting || !els.postBtn.classList.contains('active')) return;
        if (!currentUser) return;

        triggerHaptic();
        isPosting = true;
        els.postBtn.classList.add('loading');
        els.postBtn.innerHTML = `<span class="material-icons-round" style="font-size:14px; animation:spin 1s linear infinite;">refresh</span> Sending...`;

        try {
            const userDoc = await db.collection("users").doc(currentUser.uid).get();
            const userData = userDoc.data() || {};
            
            const expiry = new Date();
            expiry.setHours(expiry.getHours() + 24); // Expires in 24 hours

            const payload = {
                uid: currentUser.uid,
                username: userData.username || "",
                displayName: userData.name || "",
                pfp: userData.photoURL || currentUser.photoURL,
                verified: userData.verified || false,
                
                type: state.mode, 
                caption: state.caption.trim(),
                audience: state.audience,
                allowComments: state.allowComments,
                
                // Saving accurate Song Data to Firebase
                songName: state.song.trackName,
                songArtist: state.song.artistName,
                songPreview: state.song.previewUrl,
                songArt: state.song.artworkUrl100,

                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: firebase.firestore.Timestamp.fromDate(expiry),
                likes: [],
                comments: []
            };

            if (state.mode === 'text') {
                payload.text = state.text;
                payload.bgColor = bgColors[state.colorIdx];
                payload.font = fonts[state.fontIdx];
                payload.align = state.align;
                payload.effect = effects[state.effectIdx].name; // Added Effect Export
            } else {
                payload.mediaUrl = state.mediaUrl;
                if (state.mode === 'video') payload.videoMeta = state.videoMeta;
            }

            await db.collection("moments").add(payload);
            
            localStorage.removeItem('goorac_moment_draft');
            window.location.href = 'home.html';

        } catch (error) {
            console.error(error);
            alert("Failed to post Moment. Try again.");
            els.postBtn.innerHTML = 'Share';
            els.postBtn.classList.remove('loading');
            isPosting = false;
        }
    }

    init();
</script>
</body>
</html>
