<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>New Note | Goorac</title>
    
    <script src="config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="components/songPicker.js"></script>

    <style>
        :root { 
            --bg: #000; 
            --surface: #1c1c1e;
            --accent: #00d2ff; 
            --text: #ffffff;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; outline: none; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; 
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- HEADER --- */
        header { 
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            padding-top: max(15px, env(safe-area-inset-top)); z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .cancel-btn { font-size: 1rem; color: #fff; opacity: 0.8; cursor: pointer; padding: 10px; font-weight: 500; }
        
        .post-btn { 
            background: var(--text); color: #000; border: none; 
            padding: 8px 24px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;
            opacity: 0.4; pointer-events: none; transition: 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform: scale(0.95);
        }
        .post-btn.ready { opacity: 1; pointer-events: auto; transform: scale(1); box-shadow: 0 4px 15px rgba(255,255,255,0.2); }
        .post-btn:active { transform: scale(0.92); }

        /* --- EDITOR AREA (Auto Centering) --- */
        .editor-container { 
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            position: relative; width: 100%;
            /* Ensure space for toolbar */
            padding-bottom: 100px; 
        }

        /* Note Bubble */
        .bubble-wrapper {
            position: relative; z-index: 10;
            display: flex; flex-direction: column; align-items: center;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 100%;
        }
        .bubble-wrapper.typing { transform: translateY(-30px); }

        .note-bubble {
            background: #262626; color: #fff;
            padding: 24px 32px; border-radius: 36px;
            min-width: 120px; max-width: 80vw; min-height: 80px;
            text-align: center; position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            transition: all 0.3s ease;
            cursor: text; display: flex; flex-direction: column; justify-content: center;
        }
        /* Tail */
        .note-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 24px; height: 24px; background: inherit; border-radius: 50%; z-index: -1;
        }
        .note-bubble::before {
            content: ''; position: absolute; bottom: -18px; left: 45%;
            width: 14px; height: 14px; background: inherit; border-radius: 50%; opacity: 0.6; z-index: -2;
        }

        .display-text { 
            font-size: 1.2rem; font-weight: 600; line-height: 1.4; 
            white-space: pre-wrap; word-break: break-word;
        }

        /* Music Pill (Inside Bubble) */
        .music-pill {
            display: none; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.2); padding: 4px 10px;
            border-radius: 12px; font-size: 0.7rem; font-weight: 700;
            margin-top: 12px; width: fit-content; align-self: center;
            backdrop-filter: blur(10px); color: inherit;
        }

        .pfp-preview {
            width: 55px; height: 55px; border-radius: 50%; 
            border: 3px solid #111; margin-top: 20px;
            background: #222; object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Invisible Input overlay */
        #hidden-input {
            position: absolute; opacity: 0; width: 100%; height: 100%; 
            top: 0; left: 0; z-index: 20; font-size: 16px; 
            caret-color: transparent; color: transparent;
        }

        /* --- TOOLBAR (Bottom Fixed) --- */
        .toolbar {
            width: 100%; padding: 15px 20px; 
            padding-bottom: calc(20px + var(--safe-bottom));
            background: rgba(20, 20, 22, 0.85);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex; justify-content: space-evenly; align-items: center;
            position: fixed; bottom: 0; left: 0; z-index: 50;
        }

        .tool-btn {
            width: 48px; height: 48px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.06);
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); cursor: pointer;
        }
        .tool-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.15); }
        .tool-btn svg { width: 22px; height: 22px; fill: #e0e0e0; transition: fill 0.2s; }
        .tool-btn.active svg { fill: #fff; }

        /* --- MENUS (Bottom Sheets) --- */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 150;
            backdrop-filter: blur(4px);
        }
        .overlay.show { opacity: 1; pointer-events: auto; }

        .sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1c1c1e; border-radius: 24px 24px 0 0;
            padding: 25px; padding-bottom: max(35px, var(--safe-bottom));
            transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 200; border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .sheet.open { transform: translateY(0); }
        
        .sheet-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .sheet-label { font-size: 0.9rem; color: #fff; font-weight: 700; letter-spacing: 0.5px; }
        .sheet-close { font-size: 0.8rem; color: #888; font-weight: 600; cursor: pointer; background: #2c2c2e; padding: 4px 10px; border-radius: 12px; }

        /* Color Grid */
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
        .color-opt { 
            aspect-ratio: 1; border-radius: 50%; cursor: pointer; 
            position: relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
            transition: transform 0.2s;
        }
        .color-opt:active { transform: scale(0.9); }
        .color-opt.selected { border: 3px solid #fff; transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* Font Grid */
        .font-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .font-opt {
            padding: 12px 20px; background: #2c2c2e; border-radius: 14px;
            font-size: 1rem; color: #aaa; white-space: nowrap; cursor: pointer;
            border: 1px solid transparent; transition: 0.2s;
        }
        .font-opt.selected { background: #fff; color: #000; transform: scale(1.05); font-weight: 700; }

    </style>
</head>
<body>

<header>
    <div class="cancel-btn" onclick="clearAndBack()">Cancel</div>
    <button class="post-btn" id="post-btn" onclick="publishNote()">Post</button>
</header>

<div class="editor-container">
    <div class="bubble-wrapper" id="bubble-wrap">
        <div class="note-bubble" id="preview">
            <div class="display-text" id="display">Type a note...</div>
            <div class="music-pill" id="music-pill" onclick="removeSong(event)">
                <svg viewBox="0 0 24 24" style="width:12px; fill:currentColor;"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                <span id="song-name"></span>
                <span style="opacity:0.6; margin-left:4px;">Ã—</span>
            </div>
        </div>
        <img id="user-pfp" class="pfp-preview" src="https://via.placeholder.com/150">
        
        <input type="text" id="hidden-input" maxlength="60" autocomplete="off" onfocus="onFocus()" onblur="onBlur()">
    </div>
</div>

<div class="toolbar">
    <div class="tool-btn" onclick="openSheet('color')">
        <svg viewBox="0 0 24 24"><path d="M12 22C6.49 22 2 17.51 2 12S6.49 2 12 2s10 4.49 10 10-4.49 10-10 10zm1-17.93c-3.95.49-7 3.85-7 7.93 0 1.8.63 3.46 1.69 4.81l6.53-12.74z"/></svg>
    </div>
    <div class="tool-btn" onclick="openSheet('font')">
        <svg viewBox="0 0 24 24"><path d="M9.93 13.5h4.14L12 7.98zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-4.05 16.5l-1.14-3H9.17l-1.12 3H5.96l5.11-13h1.86l5.11 13h-2.09z"/></svg>
    </div>
    <div class="tool-btn" id="align-btn" onclick="toggleAlign()">
        <svg id="align-icon" viewBox="0 0 24 24"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg>
    </div>
    <div class="tool-btn" onclick="document.getElementById('song-picker').open()">
        <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheets()"></div>

<div class="sheet" id="color-sheet">
    <div class="sheet-header">
        <span class="sheet-label">Bubble Color</span>
        <span class="sheet-close" onclick="closeSheets()">Done</span>
    </div>
    <div class="color-grid" id="color-grid"></div>
</div>

<div class="sheet" id="font-sheet">
    <div class="sheet-header">
        <span class="sheet-label">Typography</span>
        <span class="sheet-close" onclick="closeSheets()">Done</span>
    </div>
    <div class="font-grid">
        <div class="font-opt selected" onclick="setFont('system-ui')" style="font-family:system-ui">System</div>
        <div class="font-opt" onclick="setFont('serif')" style="font-family:serif">Serif</div>
        <div class="font-opt" onclick="setFont('monospace')" style="font-family:monospace">Mono</div>
        <div class="font-opt" onclick="setFont('cursive')" style="font-family:cursive">Script</div>
        <div class="font-opt" onclick="setFont('fantasy')" style="font-family:fantasy">Bold</div>
    </div>
</div>

<song-picker id="song-picker"></song-picker>

<script>
    // --- 1. CONFIG ---
    let fbConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };
    if (!firebase.apps.length) firebase.initializeApp(fbConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- 2. STATE MANAGEMENT & RESTORE ---
    const DEFAULT_STATE = {
        text: '',
        bgColor: '#262626',
        textColor: '#fff',
        align: 'center',
        font: 'system-ui',
        song: null
    };

    let state = JSON.parse(localStorage.getItem('goorac_note_draft')) || { ...DEFAULT_STATE };

    // --- 3. THEME DATA ---
    const themes = [
        {bg:'#262626', t:'#fff'}, 
        {bg:'linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%)', t:'#000'},
        {bg:'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)', t:'#fff'},
        {bg:'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)', t:'#000'},
        {bg:'#fff', t:'#000'},
        {bg:'#007AFF', t:'#fff'},
        {bg:'#FF3B30', t:'#fff'},
        {bg:'#FFCC00', t:'#000'},
        {bg:'#5856D6', t:'#fff'},
        {bg:'#000', t:'#fff'}
    ];

    // --- 4. DOM REFERENCES ---
    const els = {
        input: document.getElementById('hidden-input'),
        display: document.getElementById('display'),
        preview: document.getElementById('preview'),
        pfp: document.getElementById('user-pfp'),
        postBtn: document.getElementById('post-btn'),
        wrap: document.getElementById('bubble-wrap'),
        musicPill: document.getElementById('music-pill'),
        songName: document.getElementById('song-name')
    };

    // --- 5. INITIALIZATION ---
    function init() {
        // Restore Text
        if(state.text) {
            els.input.value = state.text;
            els.display.innerText = state.text;
            els.display.style.opacity = '1';
            els.postBtn.classList.add('ready');
        }

        // Restore Style
        els.preview.style.background = state.bgColor;
        els.preview.style.color = state.textColor;
        els.preview.style.textAlign = state.align;
        els.display.style.fontFamily = state.font;

        // Restore Song
        if(state.song) {
            els.musicPill.style.display = 'flex';
            els.songName.innerText = state.song.trackName;
            els.postBtn.classList.add('ready');
        }

        // Restore PFP
        const cachedPfp = localStorage.getItem('goorac_user_pfp');
        if(cachedPfp) els.pfp.src = cachedPfp;

        auth.onAuthStateChanged(async (user) => {
            if(user) {
                const doc = await db.collection("users").doc(user.uid).get();
                const data = doc.data() || {};
                const src = data.photoURL || user.photoURL || 'https://via.placeholder.com/150';
                els.pfp.src = src;
                localStorage.setItem('goorac_user_pfp', src); // Update cache
            }
        });

        // Update Alignment Icon
        updateAlignIcon();
        
        // Update Font Selection UI
        document.querySelectorAll('.font-opt').forEach(el => {
            el.classList.toggle('selected', el.style.fontFamily.includes(state.font));
        });
    }

    // --- 6. LOGIC ---

    function saveState() {
        localStorage.setItem('goorac_note_draft', JSON.stringify(state));
    }

    els.input.addEventListener('input', (e) => {
        state.text = e.target.value;
        if(state.text.length > 0) {
            els.display.innerText = state.text;
            els.display.style.opacity = '1';
            els.postBtn.classList.add('ready');
        } else {
            els.display.innerText = "Type a note...";
            els.display.style.opacity = '0.5';
            if(!state.song) els.postBtn.classList.remove('ready');
        }
        saveState();
    });

    function onFocus() { els.wrap.classList.add('typing'); }
    function onBlur() { els.wrap.classList.remove('typing'); }

    // Color Picker
    const colorGrid = document.getElementById('color-grid');
    themes.forEach((t) => {
        const d = document.createElement('div');
        d.className = `color-opt ${state.bgColor === t.bg ? 'selected' : ''}`;
        d.style.background = t.bg;
        d.onclick = () => {
            document.querySelectorAll('.color-opt').forEach(x => x.classList.remove('selected'));
            d.classList.add('selected');
            state.bgColor = t.bg;
            state.textColor = t.t;
            els.preview.style.background = t.bg;
            els.preview.style.color = t.t;
            if(navigator.vibrate) navigator.vibrate(5);
            saveState();
        };
        colorGrid.appendChild(d);
    });

    // Font Logic
    function setFont(font) {
        state.font = font;
        els.display.style.fontFamily = font;
        document.querySelectorAll('.font-opt').forEach(el => {
            el.classList.toggle('selected', el.style.fontFamily.includes(font));
        });
        if(navigator.vibrate) navigator.vibrate(5);
        saveState();
    }

    // Alignment
    function toggleAlign() {
        if(navigator.vibrate) navigator.vibrate(10);
        state.align = (state.align === 'center') ? 'left' : 'center';
        els.preview.style.textAlign = state.align;
        updateAlignIcon();
        saveState();
    }

    function updateAlignIcon() {
        const icon = document.getElementById('align-icon');
        if(state.align === 'left') {
            icon.innerHTML = '<path d="M3 15h18v-2H3v2zm0 4h12v-2H3v2zm0-8h18v-2H3v2zm0-6v2h18V5H3z"/>';
        } else {
            icon.innerHTML = '<path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/>';
        }
    }

    // Song Logic
    const songPicker = document.getElementById('song-picker');
    songPicker.addEventListener('song-selected', (e) => {
        state.song = e.detail;
        els.musicPill.style.display = 'flex';
        els.songName.innerText = state.song.trackName;
        els.postBtn.classList.add('ready');
        saveState();
    });

    function removeSong(e) {
        e.stopPropagation(); // Don't trigger other clicks
        state.song = null;
        els.musicPill.style.display = 'none';
        if(state.text.length === 0) els.postBtn.classList.remove('ready');
        saveState();
    }

    // Sheets
    function openSheet(id) {
        document.getElementById('overlay').classList.add('show');
        document.getElementById(`${id}-sheet`).classList.add('open');
    }
    function closeSheets() {
        document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open'));
        document.getElementById('overlay').classList.remove('show');
    }

    function clearAndBack() {
        // Optional: clear draft if cancelling? 
        // For now, let's keep it saved so users don't lose work accidentally.
        // localStorage.removeItem('goorac_note_draft');
        history.back();
    }

    // --- PUBLISH ---
    async function publishNote() {
        if(!els.postBtn.classList.contains('ready')) return;
        const user = auth.currentUser;
        if(!user) return;

        els.postBtn.innerHTML = '...';
        els.postBtn.style.opacity = '0.7';

        try {
            const userDoc = await db.collection("users").doc(user.uid).get();
            const userData = userDoc.exists ? userDoc.data() : {};
            const expiry = new Date(Date.now() + 86400000); // 24h

            const notePayload = {
                uid: user.uid,
                username: userData.name || user.displayName || "User",
                handle: userData.username || "",
                pfp: userData.photoURL || user.photoURL,
                verified: userData.verified || false,
                text: state.text,
                bgColor: state.bgColor,
                textColor: state.textColor,
                textAlign: state.align,
                font: state.font,
                songName: state.song?.trackName || null,
                songArtist: state.song?.artistName || null,
                songPreview: state.song?.previewUrl || null,
                songArt: state.song?.artworkUrl100 || null,
                isActive: true, 
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: firebase.firestore.Timestamp.fromDate(expiry),
                likes: []
            };

            const batch = db.batch();
            const oldNotes = await db.collection("notes").where("uid", "==", user.uid).where("isActive", "==", true).get();
            oldNotes.forEach(doc => batch.update(doc.ref, { isActive: false }));
            batch.set(db.collection("notes").doc(), notePayload);
            await batch.commit();
            
            // Clear draft after success
            localStorage.removeItem('goorac_note_draft');
            window.location.href = 'home.html';

        } catch(e) {
            console.error(e);
            alert("Failed to post.");
            els.postBtn.innerHTML = 'Post';
        }
    }

    // Start
    init();

</script>
</body>
</html>
