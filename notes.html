
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>New Note | Goorac</title>
    
    <script src="config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="components/songPicker.js"></script>

    <style>
        :root { 
            --bg: #000; 
            --surface: #1c1c1e;
            --accent: #00d2ff; 
            --text: #ffffff;
            --danger: #ff3b30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; outline: none; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; 
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- HEADER --- */
        header { 
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            padding-top: max(15px, env(safe-area-inset-top)); z-index: 100;
        }

        .cancel-btn { font-size: 1rem; color: #fff; opacity: 0.7; cursor: pointer; padding: 10px; }
        
        .post-btn { 
            background: var(--text); color: #000; border: none; 
            padding: 8px 20px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;
            opacity: 0.5; pointer-events: none; transition: 0.2s;
        }
        .post-btn.ready { opacity: 1; pointer-events: auto; }
        .post-btn:active { transform: scale(0.95); }

        /* --- EDITOR AREA --- */
        .editor-container { 
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            position: relative; width: 100%;
        }

        /* Note Bubble Preview */
        .bubble-wrapper {
            position: relative; z-index: 10;
            display: flex; flex-direction: column; align-items: center;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .bubble-wrapper.typing { transform: scale(1.05); }

        .note-bubble {
            background: #262626; color: #fff;
            padding: 24px 32px; border-radius: 36px;
            min-width: 140px; max-width: 85vw;
            text-align: center; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            cursor: text;
        }
        /* Bubble Tail */
        .note-bubble::after {
            content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            width: 20px; height: 20px; background: inherit; border-radius: 50%; z-index: -1;
        }
        .note-bubble::before {
            content: ''; position: absolute; bottom: -22px; left: 46%;
            width: 12px; height: 12px; background: inherit; border-radius: 50%; opacity: 0.6; z-index: -2;
        }

        .display-text { 
            font-size: 1.3rem; font-weight: 600; line-height: 1.3; 
            min-height: 1.3em; white-space: pre-wrap; word-break: break-word;
        }

        .music-pill {
            display: none; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.15); padding: 6px 12px;
            border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            margin-top: 12px; width: fit-content; margin-left: auto; margin-right: auto;
            backdrop-filter: blur(10px);
        }

        /* Profile Pic Below Bubble */
        .pfp-preview {
            width: 60px; height: 60px; border-radius: 50%; 
            border: 3px solid #1c1c1e; margin-top: 25px;
            background: #222; object-fit: cover;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        #hidden-input {
            position: absolute; opacity: 0; width: 100%; height: 100%; 
            top: 0; left: 0; z-index: 20; font-size: 16px;
        }

        /* --- TOOLBAR --- */
        .toolbar {
            width: 100%; padding: 20px; 
            padding-bottom: max(30px, env(safe-area-inset-bottom));
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(30px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
        }

        .tool-btn {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05);
            transition: all 0.2s; cursor: pointer;
        }
        .tool-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.15); }
        .tool-btn svg { width: 24px; height: 24px; fill: #fff; }
        .tool-btn.active { background: var(--text); }
        .tool-btn.active svg { fill: #000; }

        /* --- MENUS (Sheets) --- */
        .sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1c1c1e; border-radius: 24px 24px 0 0;
            padding: 25px; padding-bottom: max(30px, env(safe-area-inset-bottom));
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 200; border-top: 1px solid rgba(255,255,255,0.1);
        }
        .sheet.open { transform: translateY(0); }
        
        .sheet-label { font-size: 0.85rem; color: #888; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 1px; }

        /* Color Grid */
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
        .color-opt { 
            aspect-ratio: 1; border-radius: 50%; cursor: pointer; 
            position: relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
        }
        .color-opt.selected { border: 3px solid #fff; transform: scale(1.1); }

        /* Font Grid */
        .font-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .font-opt {
            padding: 10px 20px; background: #2c2c2e; border-radius: 12px;
            font-size: 1rem; color: #fff; white-space: nowrap; cursor: pointer;
            border: 1px solid transparent;
        }
        .font-opt.selected { background: #fff; color: #000; border-color: #fff; }

        /* Overlay */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 150;
        }
        .overlay.show { opacity: 1; pointer-events: auto; }

    </style>
</head>
<body>

<header>
    <div class="cancel-btn" onclick="history.back()">Cancel</div>
    <button class="post-btn" id="post-btn" onclick="publishNote()">Post</button>
</header>

<div class="editor-container">
    <div class="bubble-wrapper" id="bubble-wrap">
        <div class="note-bubble" id="preview">
            <div class="display-text" id="display">Type a note...</div>
            <div class="music-pill" id="music-pill">
                <svg viewBox="0 0 24 24" style="width:12px; fill:currentColor;"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                <span id="song-name"></span>
            </div>
        </div>
        <img id="user-pfp" class="pfp-preview" src="https://via.placeholder.com/150">
        
        <input type="text" id="hidden-input" maxlength="60" autocomplete="off" onfocus="onFocus()" onblur="onBlur()">
    </div>
</div>

<div class="toolbar">
    <div class="tool-btn" onclick="openSheet('color')">
        <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z"/></svg>
    </div>
    <div class="tool-btn" onclick="openSheet('font')">
        <svg viewBox="0 0 24 24"><path d="M9 4v3h5v12h3V7h5V4H9zm-6 8h3v7h3v-7h3V9H3v3z"/></svg>
    </div>
    <div class="tool-btn" id="align-btn" onclick="toggleAlign()">
        <svg id="align-icon" viewBox="0 0 24 24"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg>
    </div>
    <div class="tool-btn" onclick="document.getElementById('song-picker').open()">
        <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheets()"></div>

<div class="sheet" id="color-sheet">
    <div class="sheet-label">Bubble Color</div>
    <div class="color-grid" id="color-grid"></div>
</div>

<div class="sheet" id="font-sheet">
    <div class="sheet-label">Font Style</div>
    <div class="font-grid">
        <div class="font-opt selected" onclick="setFont('system-ui')" style="font-family:system-ui">System</div>
        <div class="font-opt" onclick="setFont('serif')" style="font-family:serif">Serif</div>
        <div class="font-opt" onclick="setFont('monospace')" style="font-family:monospace">Mono</div>
        <div class="font-opt" onclick="setFont('cursive')" style="font-family:cursive">Script</div>
        <div class="font-opt" onclick="setFont('fantasy')" style="font-family:fantasy">Bold</div>
    </div>
</div>

<song-picker id="song-picker"></song-picker>

<script>
    // --- INIT ---
    let fbConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };
    if (!firebase.apps.length) firebase.initializeApp(fbConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- STATE ---
    let state = {
        text: '',
        bgColor: '#262626',
        textColor: '#fff',
        align: 'center',
        font: 'system-ui',
        song: null
    };

    const themes = [
        {bg:'#262626', t:'#fff'}, 
        {bg:'linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%)', t:'#000'},
        {bg:'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)', t:'#fff'},
        {bg:'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)', t:'#000'},
        {bg:'#fff', t:'#000'},
        {bg:'#007AFF', t:'#fff'},
        {bg:'#FF3B30', t:'#fff'},
        {bg:'#FFCC00', t:'#000'},
        {bg:'#5856D6', t:'#fff'}
    ];

    // --- DOM ELEMENTS ---
    const els = {
        input: document.getElementById('hidden-input'),
        display: document.getElementById('display'),
        preview: document.getElementById('preview'),
        pfp: document.getElementById('user-pfp'),
        postBtn: document.getElementById('post-btn'),
        wrap: document.getElementById('bubble-wrap'),
        musicPill: document.getElementById('music-pill'),
        songName: document.getElementById('song-name')
    };

    // --- LOAD USER ---
    auth.onAuthStateChanged(async (user) => {
        if(user) {
            const doc = await db.collection("users").doc(user.uid).get();
            const data = doc.data() || {};
            els.pfp.src = data.photoURL || user.photoURL || 'https://via.placeholder.com/150';
        }
    });

    // --- INPUT HANDLING ---
    els.input.addEventListener('input', (e) => {
        state.text = e.target.value;
        if(state.text.length > 0) {
            els.display.innerText = state.text;
            els.display.style.opacity = '1';
            els.postBtn.classList.add('ready');
        } else {
            els.display.innerText = "Type a note...";
            els.display.style.opacity = '0.5';
            if(!state.song) els.postBtn.classList.remove('ready');
        }
    });

    function onFocus() { els.wrap.classList.add('typing'); }
    function onBlur() { els.wrap.classList.remove('typing'); }

    // --- TOOLS ---
    function openSheet(id) {
        if(navigator.vibrate) navigator.vibrate(10);
        document.getElementById('overlay').classList.add('show');
        document.getElementById(`${id}-sheet`).classList.add('open');
    }

    function closeSheets() {
        document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open'));
        document.getElementById('overlay').classList.remove('show');
    }

    // Color Logic
    const colorGrid = document.getElementById('color-grid');
    themes.forEach((t, i) => {
        const d = document.createElement('div');
        d.className = `color-opt ${i===0?'selected':''}`;
        d.style.background = t.bg;
        d.onclick = () => {
            document.querySelectorAll('.color-opt').forEach(x => x.classList.remove('selected'));
            d.classList.add('selected');
            state.bgColor = t.bg;
            state.textColor = t.t;
            els.preview.style.background = t.bg;
            els.preview.style.color = t.t;
        };
        colorGrid.appendChild(d);
    });

    // Font Logic
    function setFont(font) {
        state.font = font;
        els.display.style.fontFamily = font;
        document.querySelectorAll('.font-opt').forEach(el => {
            el.classList.toggle('selected', el.innerText === font || el.style.fontFamily === font);
        });
    }

    // Alignment Logic
    function toggleAlign() {
        if(navigator.vibrate) navigator.vibrate(10);
        const icon = document.getElementById('align-icon');
        if(state.align === 'center') {
            state.align = 'left';
            els.preview.style.textAlign = 'left';
            icon.innerHTML = '<path d="M3 15h18v-2H3v2zm0 4h12v-2H3v2zm0-8h18v-2H3v2zm0-6v2h18V5H3z"/>';
        } else {
            state.align = 'center';
            els.preview.style.textAlign = 'center';
            icon.innerHTML = '<path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/>';
        }
    }

    // Music Picker
    const songPicker = document.getElementById('song-picker');
    songPicker.addEventListener('song-selected', (e) => {
        state.song = e.detail;
        els.musicPill.style.display = 'flex';
        els.songName.innerText = state.song.trackName;
        els.postBtn.classList.add('ready');
    });

    // --- PUBLISH LOGIC (THE FIX) ---
    async function publishNote() {
        if(!els.postBtn.classList.contains('ready')) return;
        const user = auth.currentUser;
        if(!user) return;

        // Visual Feedback
        els.postBtn.innerHTML = 'Posting...';
        els.postBtn.style.opacity = '0.7';

        try {
            const userDoc = await db.collection("users").doc(user.uid).get();
            const userData = userDoc.exists ? userDoc.data() : {};
            const expiry = new Date(Date.now() + 86400000); // 24h

            const notePayload = {
                uid: user.uid,
                username: userData.name || user.displayName || "User",
                handle: userData.username || "",
                pfp: userData.photoURL || user.photoURL,
                verified: userData.verified || false,
                
                text: state.text,
                bgColor: state.bgColor,
                textColor: state.textColor,
                textAlign: state.align,
                font: state.font,
                
                songName: state.song?.trackName || null,
                songArtist: state.song?.artistName || null,
                songPreview: state.song?.previewUrl || null,
                songArt: state.song?.artworkUrl100 || null,
                
                isActive: true, // Key flag
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: firebase.firestore.Timestamp.fromDate(expiry),
                likes: []
            };

            const batch = db.batch();

            // 1. Find OLD active notes and deactivate them
            const oldNotes = await db.collection("notes")
                .where("uid", "==", user.uid)
                .where("isActive", "==", true)
                .get();
            
            oldNotes.forEach(doc => {
                batch.update(doc.ref, { isActive: false });
            });

            // 2. Create NEW note doc (Auto-ID)
            const newNoteRef = db.collection("notes").doc();
            batch.set(newNoteRef, notePayload);

            // 3. Commit
            await batch.commit();
            
            // 4. Return home
            window.location.href = 'home.html';

        } catch(e) {
            console.error(e);
            alert("Error posting note");
            els.postBtn.innerHTML = 'Post';
        }
    }
</script>
</body>
</html>
