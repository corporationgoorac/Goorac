<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Profile | Goorac</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg: #000000;
            --surface: #121212;
            --surface-light: #1E1E1E;
            --border: #2A2A2A;
            --primary: #3b82f6;
            --text-main: #FFFFFF;
            --text-muted: #888888;
            --danger: #ef4444;
            --safe-area-top: env(safe-area-inset-top);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            padding-bottom: 40px;
        }

        /* --- HEADER --- */
        header {
            position: sticky; top: 0; z-index: 50;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: calc(12px + var(--safe-area-top)) 16px 12px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav-btn { background: none; border: none; color: var(--text-main); padding: 8px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .nav-btn:active { background: var(--surface-light); }
        .header-title { font-weight: 700; font-size: 16px; letter-spacing: -0.5px; text-transform: uppercase; }

        /* --- MAIN LAYOUT --- */
        main { max-width: 600px; margin: 0 auto; padding: 24px 16px; }

        /* --- PROFILE TOP --- */
        .profile-header { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 24px; }
        
        .avatar-container {
            width: 100px; height: 100px; margin-bottom: 16px;
            position: relative;
        }
        .avatar {
            width: 100%; height: 100%; border-radius: 50%;
            object-fit: cover; background: var(--surface-light);
            border: 2px solid var(--border);
        }

        .user-info { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .display-name { font-size: 22px; font-weight: 800; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .verified-badge { color: var(--primary); font-size: 18px; }
        
        .username-tag { color: var(--text-muted); font-size: 14px; font-weight: 500; }

        /* --- ID PILL --- */
        .id-pill {
            margin-top: 12px;
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--surface); border: 1px solid var(--border);
            padding: 6px 14px; border-radius: 100px;
            cursor: pointer; transition: 0.1s;
        }
        .id-pill:active { background: var(--surface-light); transform: scale(0.98); }
        .id-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .id-value { font-family: monospace; font-size: 13px; font-weight: 600; color: var(--text-main); letter-spacing: 1px; }

        .bio-text { margin: 16px 0; font-size: 14px; line-height: 1.5; color: #d4d4d4; max-width: 90%; }

        /* --- STATS --- */
        .stats-row {
            display: flex; justify-content: space-around; width: 100%;
            padding: 16px 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }
        .stat-box { display: flex; flex-direction: column; align-items: center; cursor: pointer; flex: 1; }
        .stat-box:active { opacity: 0.5; }
        .stat-num { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .stat-lbl { font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; margin-top: 4px; }

        /* --- BUTTONS --- */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 30px; }
        .btn {
            padding: 12px; border-radius: 8px; font-weight: 600; font-size: 14px;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: background 0.2s;
        }
        
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:active { opacity: 0.8; }
        
        .btn-secondary { background: var(--surface); color: var(--text-main); border: 1px solid var(--border); }
        .btn-secondary:active { background: var(--surface-light); }
        
        /* Following State Style */
        .btn-following { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }

        /* --- TABS --- */
        .tabs-header { display: flex; border-bottom: 1px solid var(--border); }
        .tab { 
            flex: 1; text-align: center; padding: 14px; font-size: 13px; font-weight: 600; 
            color: var(--text-muted); cursor: pointer; position: relative; 
        }
        .tab.active { color: var(--text-main); }
        .tab.active::after {
            content:''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--text-main);
        }

        .content-placeholder {
            padding: 60px 20px; text-align: center; color: var(--text-muted);
            font-size: 13px;
        }

        /* --- UTILS --- */
        .skeleton { background: #1E1E1E; color: transparent !important; border-radius: 4px; }
        .hide { display: none !important; }

        /* --- TOAST --- */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 20px);
            background: #fff; color: #000; padding: 10px 20px; border-radius: 50px;
            font-size: 12px; font-weight: 700; opacity: 0; pointer-events: none;
            transition: 0.3s; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        #toast.show { opacity: 1; transform: translate(-50%, 0); }

    </style>
</head>
<body>

    <header>
        <button class="nav-btn" onclick="history.back()">
            <span class="material-icons-round">arrow_back</span>
        </button>
        <div class="header-title" id="nav-name">Profile</div>
        <button class="nav-btn">
            <span class="material-icons-round">more_vert</span>
        </button>
    </header>

    <main>
        <div class="profile-header">
            <div class="avatar-container">
                <img id="pfp" class="avatar skeleton" src="" alt="">
            </div>

            <div class="user-info">
                <div class="display-name">
                    <span id="display-name" class="skeleton">Loading</span>
                    <span class="material-icons-round verified-badge hide" id="badge">verified</span>
                </div>
                <div class="username-tag skeleton" id="username" style="width:80px; height:16px; margin-top:4px;">@...</div>
            </div>

            <div class="id-pill" onclick="copyGooracID()">
                <span class="id-label">ID</span>
                <span class="id-value" id="goorac-id">------</span>
                <span class="material-icons-round" style="font-size:14px; color:#666;">content_copy</span>
            </div>

            <p class="bio-text skeleton" id="bio" style="width:90%; height:40px;">Fetching details...</p>
        </div>

        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-num" id="count-posts">0</span>
                <span class="stat-lbl">Posts</span>
            </div>
            <div class="stat-box" onclick="viewFollowers()">
                <span class="stat-num" id="count-followers">0</span>
                <span class="stat-lbl">Followers</span>
            </div>
            <div class="stat-box" onclick="viewFollowing()">
                <span class="stat-num" id="count-following">0</span>
                <span class="stat-lbl">Following</span>
            </div>
        </div>

        <div class="action-grid" id="action-container">
            <button class="btn btn-primary skeleton" id="btn-follow" onclick="handleFollow()">Follow</button>
            <button class="btn btn-secondary skeleton" id="btn-msg" onclick="openChat()">Message</button>
        </div>

        <div class="tabs-header">
            <div class="tab active">POSTS</div>
            <div class="tab">MEDIA</div>
            <div class="tab">TAGGED</div>
        </div>

        <div class="content-placeholder">
            <span class="material-icons-round" style="font-size:32px; margin-bottom:10px; opacity:0.3;">grid_view</span>
            <br>No posts yet
        </div>
    </main>

    <div id="toast">Copied to Clipboard</div>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- 2. GLOBAL STATE ---
    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');
    
    let myUid = null;
    let targetUid = null;
    let targetUserData = null;
    let isFollowActionLocked = false; // Prevents spam clicking

    // --- 3. CACHING SYSTEM (LocalStorage) ---
    // Why? To load the profile instantly if visited before.
    function loadFromCache() {
        if(!targetUsername) return;
        const cached = localStorage.getItem(`goorac_user_${targetUsername}`);
        if(cached) {
            console.log("Loaded from cache");
            const data = JSON.parse(cached);
            targetUserData = data;
            targetUid = data.uid; // Ensure UID is saved in data
            renderProfile(data);
        }
    }

    function saveToCache(data, uid) {
        if(!targetUsername) return;
        const dataToSave = { ...data, uid: uid }; 
        localStorage.setItem(`goorac_user_${targetUsername}`, JSON.stringify(dataToSave));
    }

    // --- 4. INITIALIZATION ---
    auth.onAuthStateChanged(user => {
        if (user) {
            myUid = user.uid;
            
            // 1. Load Cache Immediately (Fast)
            loadFromCache();

            // 2. Fetch Fresh Data (Reliable)
            if(targetUsername) fetchProfileFresh();
        } else {
            window.location.href = 'login.html';
        }
    });

    // --- 5. DATA FETCHING ---
    function fetchProfileFresh() {
        // Find user by username
        db.collection("users").where("username", "==", targetUsername).limit(1)
        .onSnapshot((snapshot) => {
            if(snapshot.empty) return; // Handle user not found later
            
            const doc = snapshot.docs[0];
            const freshData = doc.data();
            targetUid = doc.id;
            targetUserData = freshData;

            // Save & Render
            saveToCache(freshData, targetUid);
            renderProfile(freshData);
            
            // Check Relationship (Are we following?)
            checkRelation();
        });
    }

    // --- 6. RENDER UI ---
    function renderProfile(data) {
        // Remove skeleton classes
        document.querySelectorAll('.skeleton').forEach(el => {
            el.classList.remove('skeleton');
            el.style.width = ''; el.style.height = '';
        });

        // Safe sets
        document.getElementById('display-name').innerText = data.name || "User";
        document.getElementById('nav-name').innerText = (data.name || "Profile").toUpperCase();
        document.getElementById('username').innerText = `@${data.username}`;
        document.getElementById('bio').innerText = data.bio || "No bio available.";
        document.getElementById('goorac-id').innerText = data.gooracNumber || "N/A";
        
        // PFP
        const img = document.getElementById('pfp');
        img.src = data.photoURL || 'https://via.placeholder.com/150/111/fff?text=?';

        // Verified Badge
        if(data.verified) document.getElementById('badge').classList.remove('hide');

        // Stats (using array length)
        const followers = data.followers || [];
        const following = data.following || [];
        document.getElementById('count-followers').innerText = followers.length;
        document.getElementById('count-following').innerText = following.length;

        // Hide buttons if viewing own profile
        if(myUid === targetUid) {
            document.getElementById('action-container').style.display = 'none';
        }
    }

    // --- 7. RELATION LOGIC ---
    async function checkRelation() {
        if(!myUid || !targetUid || myUid === targetUid) return;

        const myDoc = await db.collection("users").doc(myUid).get();
        const myFollowing = myDoc.data().following || [];

        // Check if targetUid is in my following list
        // Supports both array of strings [uid, uid] and array of objects [{uid, time}, ...]
        const isFollowing = myFollowing.some(item => {
            const id = typeof item === 'string' ? item : item.uid;
            return id === targetUid;
        });

        updateFollowButton(isFollowing);
    }

    function updateFollowButton(isFollowing) {
        const btn = document.getElementById('btn-follow');
        if(isFollowing) {
            btn.innerText = "Following";
            btn.className = "btn btn-following";
        } else {
            btn.innerText = "Follow";
            btn.className = "btn btn-primary";
        }
    }

    // --- 8. ACTIONS ---

    // Follow / Unfollow
    async function handleFollow() {
        if(isFollowActionLocked || !targetUid) return;
        
        const btn = document.getElementById('btn-follow');
        const isUnfollowing = btn.innerText === "Following"; // Current state
        
        // LOCK & VIBRATE
        isFollowActionLocked = true;
        if(navigator.vibrate) navigator.vibrate(10);

        // Optimistic Update (Change UI immediately)
        updateFollowButton(!isUnfollowing);

        // Adjust local counter visually
        const countEl = document.getElementById('count-followers');
        let currentCount = parseInt(countEl.innerText);
        countEl.innerText = isUnfollowing ? Math.max(0, currentCount - 1) : currentCount + 1;

        const ts = firebase.firestore.Timestamp.now();

        try {
            if(!isUnfollowing) {
                // FOLLOW OPERATION
                const batch = db.batch();
                
                // 1. Add to My Following
                const myRef = db.collection("users").doc(myUid);
                batch.update(myRef, {
                    following: firebase.firestore.FieldValue.arrayUnion({ uid: targetUid, timestamp: ts })
                });

                // 2. Add to Their Followers
                const theirRef = db.collection("users").doc(targetUid);
                batch.update(theirRef, {
                    followers: firebase.firestore.FieldValue.arrayUnion({ uid: myUid, timestamp: ts })
                });

                // 3. Send Notification
                const notifRef = db.collection("notifications").doc();
                batch.set(notifRef, {
                    recipientId: targetUid,
                    senderId: myUid,
                    type: "follow",
                    timestamp: ts,
                    seen: false
                });

                await batch.commit();

            } else {
                // UNFOLLOW OPERATION
                // Note: ArrayRemove requires exact match. 
                // For simplified arrays of objects, read-modify-write is safer than arrayRemove if objects vary.
                // Here we use a transaction to safely remove the specific object based on UID.
                
                await db.runTransaction(async (t) => {
                    const myRef = db.collection("users").doc(myUid);
                    const theirRef = db.collection("users").doc(targetUid);
                    
                    const myDoc = await t.get(myRef);
                    const theirDoc = await t.get(theirRef);

                    // Filter out target from my following
                    const newFollowing = (myDoc.data().following || []).filter(i => (typeof i==='string'?i:i.uid) !== targetUid);
                    
                    // Filter me out of their followers
                    const newFollowers = (theirDoc.data().followers || []).filter(i => (typeof i==='string'?i:i.uid) !== myUid);

                    t.update(myRef, { following: newFollowing });
                    t.update(theirRef, { followers: newFollowers });
                });
            }
        } catch(e) {
            console.error("Follow Error:", e);
            // Revert UI on failure
            updateFollowButton(isUnfollowing);
            countEl.innerText = currentCount;
            showToast("Action failed");
        }

        // UNLOCK
        setTimeout(() => { isFollowActionLocked = false; }, 500);
    }

    function copyGooracID() {
        const txt = document.getElementById('goorac-id').innerText;
        if(txt === "N/A" || txt.includes("-")) return;
        
        navigator.clipboard.writeText(txt).then(() => {
            if(navigator.vibrate) navigator.vibrate(50);
            showToast("ID Copied");
        });
    }

    function openChat() {
        if(targetUserData) window.location.href = `chat.html?user=${targetUserData.username}`;
    }
    
    function viewFollowers() {
        if(targetUserData) window.location.href = `followers.html?user=${targetUserData.username}`;
    }

    function viewFollowing() {
        if(targetUserData) window.location.href = `following.html?user=${targetUserData.username}`;
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

</script>
</body>
</html>
