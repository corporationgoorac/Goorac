<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac | Nexus Command Pro</title>
    
    <script src="config.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. DESIGN SYSTEM (Obsidian Pro)
           ========================================= */
        :root {
            /* Backgrounds */
            --bg-root: #000000;
            --bg-card: #0A0A0A;
            --bg-card-hover: #111111;
            --bg-input: #0f0f0f;
            --bg-overlay: rgba(0, 0, 0, 0.7);
            --bg-glass: rgba(10, 10, 10, 0.8);

            /* Borders */
            --border-subtle: #1a1a1a;
            --border-light: #262626;
            --border-active: #404040;

            /* Typography */
            --text-primary: #EDEDED;
            --text-secondary: #888888;
            --text-tertiary: #444444;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            /* Brand Accents */
            --accent-primary: #ffffff; /* High Class White */
            --accent-blue: #0070f3;    /* Pro Blue */
            --accent-red: #e00;        /* Alert Red */
            --accent-green: #21c55e;   /* Success Green */
            --accent-purple: #8e2de2;  /* Admin Purple */

            /* Dimensions */
            --header-height: 64px;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 20px;
            
            /* Transitions */
            --ease-pro: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* =========================================
           2. GLOBAL RESET & BASE
           ========================================= */
        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* App-like container */
            background: var(--bg-root);
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Typography Utilities */
        h1, h2, h3 { font-weight: 700; letter-spacing: -0.02em; color: #fff; }
        .mono { font-family: var(--font-mono); }
        .label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        /* =========================================
           3. AUTH GATE (Security Layer)
           ========================================= */
        #auth-gate {
            position: fixed; inset: 0; z-index: 9999;
            background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s var(--ease-pro), transform 0.6s var(--ease-pro);
        }
        
        .auth-brand {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 40px;
        }
        .auth-icon {
            font-size: 48px; color: var(--text-primary); margin-bottom: 16px;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));
        }
        .auth-title { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .auth-sub { color: var(--text-secondary); margin-top: 8px; font-size: 13px; }

        .pin-wrapper { display: flex; gap: 16px; margin-bottom: 40px; }
        .pin-indicator {
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--bg-card-hover); border: 1px solid var(--border-light);
            transition: all 0.2s;
        }
        .pin-indicator.active { background: #fff; transform: scale(1.2); border-color: #fff; }
        .pin-indicator.error { background: var(--accent-red); border-color: var(--accent-red); }

        .keypad {
            display: grid; grid-template-columns: repeat(3, 80px); gap: 16px;
        }
        .key {
            width: 80px; height: 80px; border-radius: 24px;
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            color: #fff; font-size: 24px; font-weight: 500;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.1s; user-select: none;
        }
        .key:active { background: #222; transform: scale(0.96); }
        .key.action { color: var(--text-secondary); background: transparent; border-color: transparent; }

        /* =========================================
           4. DASHBOARD LAYOUT
           ========================================= */
        #dashboard {
            display: none; opacity: 0;
            flex-direction: column; height: 100%;
            transition: opacity 0.8s ease;
        }

        /* Header */
        .app-header {
            height: var(--header-height);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            position: sticky; top: 0; z-index: 100;
        }
        .brand-section { display: flex; align-items: center; gap: 12px; }
        .brand-logo { font-size: 24px; }
        .brand-name { font-weight: 700; font-size: 16px; }
        .brand-tag {
            font-size: 9px; padding: 3px 6px; border-radius: 4px;
            background: #222; color: #888; font-weight: 600; border: 1px solid #333;
        }

        .header-actions { display: flex; gap: 8px; }
        .icon-btn {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); cursor: pointer; transition: 0.2s;
            border: 1px solid transparent;
        }
        .icon-btn:hover { background: var(--bg-card-hover); color: #fff; border-color: var(--border-subtle); }
        .icon-btn.primary { background: #fff; color: #000; }
        .icon-btn.primary:hover { background: #e0e0e0; }

        /* Metrics Bar */
        .metrics-bar {
            display: grid; grid-template-columns: repeat(3, 1fr);
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
        }
        .metric {
            padding: 20px; border-right: 1px solid var(--border-subtle);
            display: flex; flex-direction: column; gap: 6px;
        }
        .metric:last-child { border-right: none; }
        .m-val { font-size: 24px; font-weight: 600; font-family: var(--font-mono); }
        .m-lbl { font-size: 11px; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; }

        /* Toolbar */
        .toolbar {
            padding: 16px 24px;
            display: flex; gap: 12px; align-items: center;
            background: var(--bg-root);
            border-bottom: 1px solid var(--border-subtle);
        }
        .search-wrapper {
            flex: 1; position: relative;
        }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--text-secondary); font-size: 18px; pointer-events: none;
        }
        .search-input {
            width: 100%; height: 44px;
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding-left: 40px; padding-right: 16px;
            color: #fff; font-family: var(--font-sans); font-size: 14px;
            transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--text-secondary); background: #141414; }

        .refresh-btn {
            height: 44px; padding: 0 16px;
            background: var(--bg-input); border: 1px solid var(--border-light);
            border-radius: 8px; color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .refresh-btn:active { transform: scale(0.96); }

        /* =========================================
           5. DATA LIST (SCROLLABLE)
           ========================================= */
        .content-area {
            flex: 1;
            overflow-y: auto; /* Enable Scroll */
            position: relative;
            background: var(--bg-root);
            scroll-behavior: smooth;
        }

        .user-row {
            display: flex; align-items: center; gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer; transition: background 0.15s;
        }
        .user-row:hover { background: var(--bg-card); }
        .user-row:active { background: var(--bg-card-hover); }

        .u-avatar {
            width: 44px; height: 44px; border-radius: 50%;
            background: #1a1a1a; object-fit: cover;
            border: 1px solid var(--border-subtle);
        }
        .u-info { flex: 1; min-width: 0; }
        .u-name { font-weight: 600; font-size: 15px; color: #fff; margin-bottom: 2px; }
        .u-handle { color: var(--text-secondary); font-size: 13px; display: flex; align-items: center; gap: 6px; }
        
        .u-status { display: flex; gap: 6px; align-items: center; }
        .badge {
            font-size: 10px; font-weight: 700;
            padding: 2px 8px; border-radius: 100px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .badge.admin { background: #fff; color: #000; }
        .badge.ver { background: var(--accent-blue); color: #fff; }
        .badge.ban { background: var(--accent-red); color: #fff; }

        /* Loading Sentinel */
        .sentinel {
            height: 60px; display: flex; align-items: center; justify-content: center;
            color: var(--text-tertiary); font-size: 12px; letter-spacing: 1px;
        }
        .spinner {
            width: 16px; height: 16px; border: 2px solid #333; 
            border-top-color: #fff; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* =========================================
           6. DRAWERS & MODALS (History API Support)
           ========================================= */
        .overlay-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .overlay-backdrop.active { opacity: 1; pointer-events: all; }

        /* Edit Drawer */
        .drawer-right {
            position: fixed; top: 0; right: 0; bottom: 0;
            width: 100%; max-width: 480px;
            background: #080808; border-left: 1px solid var(--border-light);
            transform: translateX(100%); transition: 0.4s var(--ease-pro);
            z-index: 1001; display: flex; flex-direction: column;
            box-shadow: -20px 0 50px rgba(0,0,0,0.5);
        }
        .overlay-backdrop.active .drawer-right { transform: translateX(0); }

        .drawer-header {
            height: 70px; padding: 0 30px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-subtle);
        }
        .drawer-title { font-size: 18px; font-weight: 700; }
        
        .drawer-content {
            flex: 1; overflow-y: auto; padding: 30px;
        }

        /* Profile Hero in Edit */
        .editor-hero {
            display: flex; align-items: center; gap: 24px; margin-bottom: 40px;
            padding-bottom: 30px; border-bottom: 1px solid var(--border-subtle);
        }
        .eh-img {
            width: 80px; height: 80px; border-radius: 50%;
            object-fit: cover; border: 2px solid var(--border-light);
        }
        .eh-info h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .eh-uid { 
            font-family: var(--font-mono); font-size: 11px; color: var(--text-secondary);
            cursor: pointer; padding: 4px 8px; background: var(--bg-card); 
            border-radius: 4px; display: inline-block; transition: 0.2s;
        }
        .eh-uid:hover { background: #222; color: #fff; }

        /* Form Grid */
        .form-grid {
            display: grid; gap: 24px; margin-bottom: 40px;
        }
        .input-group { display: flex; flex-direction: column; }
        .input-pro {
            width: 100%; padding: 14px 16px;
            background: var(--bg-input); border: 1px solid var(--border-light);
            border-radius: 8px; color: #fff; font-family: var(--font-sans); font-size: 14px;
            transition: 0.2s;
        }
        .input-pro:focus { border-color: var(--accent-blue); background: #111; }

        /* Switches */
        .switch-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px; background: var(--bg-card); border-radius: 8px;
            border: 1px solid var(--border-subtle); margin-bottom: 12px; cursor: pointer;
            transition: 0.2s;
        }
        .switch-row:hover { border-color: #333; }
        .switch-label { font-weight: 600; font-size: 14px; }
        
        .toggle-track {
            width: 48px; height: 26px; background: #333; border-radius: 100px;
            position: relative; transition: 0.3s;
        }
        .toggle-thumb {
            width: 20px; height: 20px; background: #fff; border-radius: 50%;
            position: absolute; top: 3px; left: 3px; transition: 0.3s var(--ease-pro);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* Active States */
        .switch-row.active .toggle-track { background: var(--accent-blue); }
        .switch-row.active .toggle-thumb { transform: translateX(22px); }
        .switch-row.active.red .toggle-track { background: var(--accent-red); }
        .switch-row.active.purple .toggle-track { background: var(--accent-purple); }

        .drawer-footer {
            padding: 24px 30px; border-top: 1px solid var(--border-subtle);
            background: var(--bg-card); display: grid; grid-template-columns: 1fr 2fr; gap: 16px;
        }
        
        .btn {
            height: 52px; border-radius: 8px; border: none; cursor: pointer;
            font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-primary { background: #fff; color: #000; }
        .btn-primary:hover { background: #f0f0f0; }
        .btn-danger { background: rgba(255,0,0,0.1); color: var(--accent-red); border: 1px solid rgba(255,0,0,0.2); }
        .btn-danger:hover { background: rgba(255,0,0,0.2); }
        .btn-action { width: 100%; margin-bottom: 24px; background: var(--bg-card-hover); color: #fff; border: 1px solid var(--border-light); }

        /* Broadcast Modal */
        .modal-broadcast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
            width: 90%; max-width: 500px; background: #0F0F0F;
            border: 1px solid var(--border-light); border-radius: 16px;
            z-index: 1005; opacity: 0; pointer-events: none; transition: 0.3s var(--ease-pro);
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
        }
        .overlay-backdrop.active .modal-broadcast.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: all; }

        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; }
        
        .target-pill {
            display: inline-block; padding: 6px 12px; background: rgba(0, 112, 243, 0.1); 
            color: var(--accent-blue); font-size: 12px; font-weight: 600; border-radius: 6px;
            margin-bottom: 16px;
        }

        .compose-area {
            width: 100%; height: 150px; background: var(--bg-root); border: 1px solid var(--border-light);
            border-radius: 8px; color: #fff; padding: 16px; font-family: var(--font-sans);
            resize: none; font-size: 15px; margin-bottom: 16px;
        }
        .compose-area:focus { border-color: #fff; }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 100px);
            background: #fff; color: #000; padding: 12px 24px; border-radius: 50px;
            font-weight: 600; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 9999;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0;
        }
        .toast.show { transform: translate(-50%, 0); opacity: 1; }

        /* Access Denied */
        #access-denied { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

    </style>
</head>
<body>

    <div id="toast" class="toast">Action Complete</div>

    <div id="auth-gate">
        <div class="auth-brand">
            <span class="material-icons-round auth-icon">shield</span>
            <div class="auth-title">NEXUS COMMAND</div>
            <div class="auth-sub">PRO EDITION v7.0</div>
        </div>

        <div class="pin-wrapper">
            <div class="pin-indicator" id="p1"></div>
            <div class="pin-indicator" id="p2"></div>
            <div class="pin-indicator" id="p3"></div>
            <div class="pin-indicator" id="p4"></div>
        </div>

        <div class="keypad">
            <div class="key" onclick="typePin(1)">1</div><div class="key" onclick="typePin(2)">2</div><div class="key" onclick="typePin(3)">3</div>
            <div class="key" onclick="typePin(4)">4</div><div class="key" onclick="typePin(5)">5</div><div class="key" onclick="typePin(6)">6</div>
            <div class="key" onclick="typePin(7)">7</div><div class="key" onclick="typePin(8)">8</div><div class="key" onclick="typePin(9)">9</div>
            <div class="key action"></div>
            <div class="key" onclick="typePin(0)">0</div>
            <div class="key action" onclick="typePin('c')"><span class="material-icons-round">backspace</span></div>
        </div>
    </div>

    <div id="access-denied">
        <span class="material-icons-round" style="font-size: 64px; color: #333; margin-bottom: 24px;">lock_person</span>
        <h2>Access Restricted</h2>
        <p style="color: #666; margin-top: 8px;">Your identity lacks the required clearance.</p>
        <button class="btn btn-primary" style="margin-top: 30px; width: auto; padding: 0 30px;" onclick="location.reload()">Reload</button>
    </div>

    <div id="dashboard">
        
        <header class="app-header">
            <div class="brand-section">
                <span class="material-icons-round brand-logo">hub</span>
                <span class="brand-name">Nexus</span>
                <span class="brand-tag">PRO</span>
            </div>
            <div class="header-actions">
                <div class="icon-btn primary" title="Broadcast" onclick="openBroadcast('ALL')">
                    <span class="material-icons-round">campaign</span>
                </div>
                <div class="icon-btn" title="Refresh" onclick="refreshData()">
                    <span class="material-icons-round">sync</span>
                </div>
                <div class="icon-btn" title="Logout" onclick="firebase.auth().signOut()">
                    <span class="material-icons-round">logout</span>
                </div>
            </div>
        </header>

        <div class="metrics-bar">
            <div class="metric">
                <div class="m-val" id="stat-total">--</div>
                <div class="m-lbl">Total Users</div>
            </div>
            <div class="metric">
                <div class="m-val" id="stat-active" style="color:var(--accent-green)">--</div>
                <div class="m-lbl" style="color:var(--accent-green)">Active Signals</div>
            </div>
            <div class="metric">
                <div class="m-val" id="stat-ban" style="color:var(--accent-red)">--</div>
                <div class="m-lbl" style="color:var(--accent-red)">Suspended</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-wrapper">
                <span class="material-icons-round search-icon">search</span>
                <input type="text" class="search-input" id="search-bar" placeholder="Search by name, handle, or ID..." oninput="handleSearch()">
            </div>
        </div>

        <div class="content-area" id="scroll-container">
            <div id="user-list">
                </div>
            <div class="sentinel" id="sentinel">
                <div class="spinner"></div> Loading Records...
            </div>
        </div>

    </div>

    <div id="overlay" class="overlay-backdrop" onclick="closeAll()">
        
        <div id="drawer-edit" class="drawer-right" onclick="event.stopPropagation()">
            <div class="drawer-header">
                <div class="drawer-title">Configuration</div>
                <div class="icon-btn" onclick="closeAll()"><span class="material-icons-round">close</span></div>
            </div>
            
            <div class="drawer-content">
                <div class="editor-hero">
                    <img src="" id="e-img" class="eh-img">
                    <div class="eh-info">
                        <h2 id="e-name">User Name</h2>
                        <div class="eh-uid" onclick="copyUID()">
                            <span id="e-uid">UID</span> <span class="material-icons-round" style="font-size:10px; margin-left:4px;">content_copy</span>
                        </div>
                    </div>
                </div>

                <button class="btn btn-action" onclick="composeToUser()">
                    <span class="material-icons-round" style="font-size:18px">mail</span> Send Official Message
                </button>

                <div class="form-grid">
                    <div class="input-group">
                        <label class="label">Display Name</label>
                        <input type="text" id="in-name" class="input-pro">
                    </div>
                    <div class="input-group">
                        <label class="label">Username (@)</label>
                        <input type="text" id="in-user" class="input-pro" oninput="sanitizeHandle(this)">
                    </div>
                    <div class="input-group">
                        <label class="label">Bio / Info</label>
                        <input type="text" id="in-bio" class="input-pro" placeholder="User biography...">
                    </div>
                    <div class="input-group">
                        <label class="label">Goorac ID</label>
                        <input type="number" id="in-num" class="input-pro">
                    </div>
                    <div class="input-group">
                        <label class="label">Avatar URL</label>
                        <input type="text" id="in-pfp" class="input-pro">
                    </div>
                </div>

                <div class="label">Access Controls</div>
                
                <div class="switch-row" id="tg-ver" onclick="toggleSwitch('tg-ver', 'blue')">
                    <span class="switch-label">Verified Account</span>
                    <div class="toggle-track"><div class="toggle-thumb"></div></div>
                </div>
                
                <div class="switch-row" id="tg-adm" onclick="toggleSwitch('tg-adm', 'purple')">
                    <span class="switch-label">Admin Privileges</span>
                    <div class="toggle-track"><div class="toggle-thumb"></div></div>
                </div>
                
                <div class="switch-row" id="tg-sus" onclick="toggleSwitch('tg-sus', 'red')">
                    <span class="switch-label" style="color:var(--accent-red)">Suspend Access</span>
                    <div class="toggle-track"><div class="toggle-thumb"></div></div>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label class="label">Raw Data</label>
                    <button class="btn btn-action" style="font-size:12px; height:40px; margin:0;" onclick="copyRawJSON()">Copy JSON to Clipboard</button>
                </div>

            </div>

            <div class="drawer-footer">
                <button class="btn btn-danger" onclick="deleteUser()">Delete</button>
                <button class="btn btn-primary" id="btn-save" onclick="saveUser()">Save Changes</button>
            </div>
        </div>

        <div id="modal-cast" class="modal-broadcast" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="drawer-title">Secure Uplink</div>
                <div class="icon-btn" onclick="closeAll()"><span class="material-icons-round">close</span></div>
            </div>
            <div class="modal-body">
                <div class="target-pill" id="cast-target">TARGET: ALL USERS</div>
                
                <textarea id="cast-msg" class="compose-area" placeholder="Type your transmission..."></textarea>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:16px;">
                    <input type="text" id="cast-img" class="input-pro" placeholder="Image URL">
                    <input type="text" id="cast-file" class="input-pro" placeholder="File URL">
                </div>

                <div style="font-size:11px; color:#666; font-family:var(--font-mono);">
                    Sender: <strong>Goorac Quantum</strong> (Official)
                </div>
            </div>
            <div class="drawer-footer" style="grid-template-columns: 1fr;">
                <button class="btn btn-primary" style="background:var(--accent-blue); color:#fff; border:none;" onclick="transmit()" id="btn-send">Send Transmission</button>
            </div>
        </div>

    </div>

    <script>
        // =========================================
        // 1. INITIALIZATION & CONFIG
        // =========================================
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rdb = firebase.database();
        const auth = firebase.auth();

        // State Variables
        let usersList = [];
        let lastDoc = null;
        let isLoading = false;
        let hasMore = true;
        const BATCH_SIZE = 10;
        
        let currentEditingId = null;
        let officialGooracId = null;
        let pinCode = "";
        let broadcastMode = 'ALL'; // ALL, VERIFIED, SINGLE

        // =========================================
        // 2. AUTH & SECURITY
        // =========================================
        auth.onAuthStateChanged(async user => {
            if (!user) return window.location.href = "login.html";
            
            // Validate Admin Status
            const doc = await db.collection("users").doc(user.uid).get();
            if (doc.exists) {
                const d = doc.data();
                if (d.admin === true || d.username === 'goorac' || d.username === 'sivamanihandan') {
                    // Authorized
                } else {
                    document.getElementById('access-denied').style.display = 'flex';
                }
            } else {
                document.getElementById('access-denied').style.display = 'flex';
            }
        });

        // PIN Logic
        function typePin(n) {
            if (n === 'c') pinCode = pinCode.slice(0, -1);
            else if (pinCode.length < 4) pinCode += n;
            
            // Update UI Dots
            for(let i=1; i<=4; i++) {
                const el = document.getElementById('p'+i);
                if (i <= pinCode.length) el.classList.add('active');
                else el.classList.remove('active', 'error');
            }

            if (pinCode === "2502") {
                unlockDashboard();
            } else if (pinCode.length === 4) {
                // Error Animation
                document.querySelectorAll('.pin-indicator').forEach(e => e.classList.add('error'));
                navigator.vibrate(200);
                setTimeout(() => { pinCode = ""; typePin('x'); }, 400);
            }
        }

        function unlockDashboard() {
            document.getElementById('auth-gate').style.opacity = '0';
            document.getElementById('auth-gate').style.transform = 'scale(1.1)';
            setTimeout(() => {
                document.getElementById('auth-gate').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                setTimeout(() => document.getElementById('dashboard').style.opacity = '1', 50);
                initData();
            }, 600);
        }

        // =========================================
        // 3. DATA & PAGINATION LOGIC
        // =========================================
        function initData() {
            // Find official ID
            db.collection("users").where("username", "==", "goorac").get().then(snap => {
                if(!snap.empty) officialGooracId = snap.docs[0].id;
            });

            // Start Monitoring Realtime Stats (Counts only)
            rdb.ref('status').on('value', snap => {
                let count = 0;
                snap.forEach(c => { if(c.val().state === 'online') count++; });
                document.getElementById('stat-active').innerText = count;
            });

            // Initial Load
            loadUsers();

            // Infinite Scroll Observer
            const observer = new IntersectionObserver((entries) => {
                if(entries[0].isIntersecting && !isLoading && hasMore) {
                    loadUsers();
                }
            }, { threshold: 0.1 });
            observer.observe(document.getElementById('sentinel'));
        }

        async function loadUsers() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById('sentinel').style.opacity = '1';

            let query = db.collection("users").orderBy("username").limit(BATCH_SIZE);
            if (lastDoc) query = query.startAfter(lastDoc);

            const snapshot = await query.get();
            
            if (snapshot.empty) {
                hasMore = false;
                document.getElementById('sentinel').innerText = "End of Records";
            } else {
                lastDoc = snapshot.docs[snapshot.docs.length - 1];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    usersList.push({ id: doc.id, ...data });
                    renderRow({ id: doc.id, ...data });
                });
            }
            
            // Update Totals (Approx)
            document.getElementById('stat-total').innerText = usersList.length + (hasMore ? "+" : "");
            
            isLoading = false;
            if(hasMore) document.getElementById('sentinel').style.opacity = '0';
        }

        function renderRow(u) {
            const list = document.getElementById('user-list');
            const row = document.createElement('div');
            row.className = 'user-row';
            row.onclick = () => openEdit(u);
            
            // Badges
            let badges = '';
            if(u.admin) badges += `<span class="badge admin">Admin</span>`;
            if(u.verified) badges += `<span class="badge ver">Ver</span>`;
            if(u.suspended) badges += `<span class="badge ban">Ban</span>`;

            row.innerHTML = `
                <img src="${u.photoURL || 'https://via.placeholder.com/50'}" class="u-avatar">
                <div class="u-info">
                    <div class="u-name">${u.name || 'Unknown'}</div>
                    <div class="u-handle">@${u.username || '...'} ${badges}</div>
                </div>
                <span class="material-icons-round" style="color:#333; font-size:16px;">chevron_right</span>
            `;
            list.appendChild(row);
        }

        // =========================================
        // 4. UI INTERACTIONS (History API)
        // =========================================
        
        // Handle Back Button
        window.addEventListener('popstate', () => {
            if(document.getElementById('overlay').classList.contains('active')) {
                closeAll(false); // Don't trigger back again
            }
        });

        function pushState(key) {
            history.pushState({ modal: key }, null, "");
        }

        function openEdit(u) {
            currentEditingId = u.id;
            pushState('edit');
            
            // Populate Fields
            document.getElementById('e-img').src = u.photoURL;
            document.getElementById('e-name').innerText = u.name;
            document.getElementById('e-uid').innerText = u.id;
            
            document.getElementById('in-name').value = u.name;
            document.getElementById('in-user').value = u.username;
            document.getElementById('in-bio').value = u.bio || '';
            document.getElementById('in-num').value = u.gooracNumber || '';
            document.getElementById('in-pfp').value = u.photoURL;
            
            // Toggles
            setSwitch('tg-ver', u.verified);
            setSwitch('tg-adm', u.admin);
            setSwitch('tg-sus', u.suspended);

            // Show
            document.getElementById('overlay').classList.add('active');
            document.getElementById('drawer-edit').style.transform = 'translateX(0)';
            document.getElementById('modal-cast').classList.remove('active');
        }

        function openBroadcast(mode) {
            broadcastMode = mode;
            pushState('cast');
            
            // Set Target Text
            const pill = document.getElementById('cast-target');
            if (mode === 'ALL') {
                pill.innerText = "TARGET: ALL USERS";
                pill.style.color = "var(--accent-blue)";
                pill.style.background = "rgba(0,112,243,0.1)";
            } else if (mode === 'SINGLE') {
                pill.innerText = "TARGET: " + currentEditingId;
                pill.style.color = "#fff";
                pill.style.background = "#333";
            }

            document.getElementById('overlay').classList.add('active');
            document.getElementById('modal-cast').classList.add('active');
            document.getElementById('drawer-edit').style.transform = 'translateX(100%)';
        }

        function closeAll(goBack = true) {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('drawer-edit').style.transform = 'translateX(100%)';
            document.getElementById('modal-cast').classList.remove('active');
            if (goBack) history.back();
        }

        function setSwitch(id, state) {
            const el = document.getElementById(id);
            if (state) el.classList.add('active');
            else el.classList.remove('active');
            
            // Special color handling
            if(state) {
                if(id === 'tg-ver') el.classList.add('active');
                if(id === 'tg-sus') el.classList.add('red');
                if(id === 'tg-adm') el.classList.add('purple');
            } else {
                el.classList.remove('red', 'purple');
            }
        }

        function toggleSwitch(id, color) {
            const el = document.getElementById(id);
            el.classList.toggle('active');
            if(color === 'red' || color === 'purple') el.classList.toggle(color);
        }

        // =========================================
        // 5. BUSINESS LOGIC (SAVE, VERIFY, SEND)
        // =========================================

        async function saveUser() {
            const btn = document.getElementById('btn-save');
            btn.innerText = "Saving...";
            
            // Get Current Data to check changes
            const oldUser = usersList.find(u => u.id === currentEditingId);
            const wasVerified = oldUser ? oldUser.verified : false;
            
            const isVerified = document.getElementById('tg-ver').classList.contains('active');

            const updates = {
                name: document.getElementById('in-name').value,
                username: document.getElementById('in-user').value,
                bio: document.getElementById('in-bio').value,
                gooracNumber: parseInt(document.getElementById('in-num').value),
                photoURL: document.getElementById('in-pfp').value,
                verified: isVerified,
                admin: document.getElementById('tg-adm').classList.contains('active'),
                suspended: document.getElementById('tg-sus').classList.contains('active')
            };

            try {
                await db.collection("users").doc(currentEditingId).update(updates);
                
                // --- AUTO VERIFICATION MESSAGE LOGIC ---
                if (!wasVerified && isVerified) {
                    await sendVerificationMessage(currentEditingId);
                    showToast("User Verified & Notified");
                } else {
                    showToast("Profile Updated");
                }
                
                // Update local list
                const idx = usersList.findIndex(u => u.id === currentEditingId);
                if (idx > -1) usersList[idx] = { ...usersList[idx], ...updates };
                
                // Re-render only improves if we implemented virtual scrolling, for now just reload list or ignore visual update until refresh
                closeAll();
            } catch (e) {
                showToast("Error: " + e.message);
            }
            btn.innerText = "Save Changes";
        }

        async function sendVerificationMessage(targetUid) {
            if (!officialGooracId) return;
            
            const message = `Congratulations! Your account has been officially verified by the Quantum Administration. You now have access to exclusive features. Welcome to the elite circle.\n\n- Goorac Quantum`;
            
            const chatId = officialGooracId < targetUid ? `${officialGooracId}_${targetUid}` : `${targetUid}_${officialGooracId}`;
            
            await db.collection("chats").doc(chatId).collection("messages").add({
                text: message,
                sender: officialGooracId, // Spoofing sender via Admin rules
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                seen: false,
                reactions: {}
            });
            
            await db.collection("chats").doc(chatId).set({
                lastMessage: message,
                lastSender: officialGooracId,
                lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                participants: [officialGooracId, targetUid],
                [`unreadCount.${targetUid}`]: firebase.firestore.FieldValue.increment(1)
            }, { merge: true });
        }

        async function transmit() {
            const btn = document.getElementById('btn-send');
            const txt = document.getElementById('cast-msg').value;
            const img = document.getElementById('cast-img').value;
            const file = document.getElementById('cast-file').value;

            if(!txt && !img && !file) return showToast("Empty Message");
            
            btn.innerText = "Sending...";

            let targets = [];
            
            // Logic to fetch ALL users if in Broadcast mode (bypassing the paginated list)
            if (broadcastMode === 'ALL' || broadcastMode === 'VERIFIED') {
                // Fetch full list for broadcast (Be careful with costs here)
                const snapshot = await db.collection("users").get();
                snapshot.forEach(d => targets.push({id: d.id, ...d.data()}));
                
                if (broadcastMode === 'VERIFIED') targets = targets.filter(u => u.verified);
            } else {
                // Single Mode
                targets = [{ id: currentEditingId }];
            }
            
            // Filter out Goorac himself
            targets = targets.filter(u => u.id !== officialGooracId);

            let sentCount = 0;
            const promises = targets.map(async (t) => {
                const chatId = officialGooracId < t.id ? `${officialGooracId}_${t.id}` : `${t.id}_${officialGooracId}`;
                const msg = {
                    text: txt, sender: officialGooracId, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    seen: false, reactions: {}
                };
                if(img) msg.imageUrl = img;
                if(file) msg.fileUrl = file;

                await db.collection("chats").doc(chatId).collection("messages").add(msg);
                await db.collection("chats").doc(chatId).set({
                    lastMessage: txt || "Media Attachment",
                    lastSender: officialGooracId,
                    lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: [officialGooracId, t.id],
                    [`unreadCount.${t.id}`]: firebase.firestore.FieldValue.increment(1)
                }, { merge: true });
                
                sentCount++;
            });

            await Promise.all(promises);
            showToast(`Sent to ${sentCount} users`);
            btn.innerText = "Send Transmission";
            closeAll();
        }

        function composeToUser() {
            openBroadcast('SINGLE');
        }

        // =========================================
        // 6. UTILITIES
        // =========================================
        
        function handleSearch() {
            const term = document.getElementById('search-bar').value.toLowerCase();
            const list = document.getElementById('user-list');
            list.innerHTML = ""; // Clear current view
            
            // If search is active, filter local list (Note: For true scalability, use Algolia, but here we filter loaded batch)
            const filtered = usersList.filter(u => 
                (u.name && u.name.toLowerCase().includes(term)) || 
                (u.username && u.username.toLowerCase().includes(term)) ||
                u.id === term
            );
            
            filtered.forEach(u => renderRow(u));
        }

        function copyUID() {
            navigator.clipboard.writeText(currentEditingId);
            showToast("UID Copied");
        }
        
        function copyRawJSON() {
            const u = usersList.find(x => x.id === currentEditingId);
            navigator.clipboard.writeText(JSON.stringify(u, null, 2));
            showToast("JSON Copied");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function refreshData() {
            usersList = [];
            lastDoc = null;
            hasMore = true;
            document.getElementById('user-list').innerHTML = "";
            loadUsers();
            showToast("Database Synced");
        }

        function sanitizeHandle(el) {
            el.value = el.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
        }

        async function deleteUser() {
            if(!confirm("DANGER: Permanently delete this node?")) return;
            await db.collection("users").doc(currentEditingId).delete();
            showToast("User Deleted");
            refreshData();
            closeAll();
        }

    </script>
</body>
</html>
