<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac | Nexus Command Titan</title>
    
    <script src="config.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- 1. CORE VARIABLES --- */
        :root {
            /* Palette: Deep Void */
            --bg-void: #000000;
            --bg-panel: #0a0a0a;
            --bg-glass: rgba(15, 15, 15, 0.85);
            --bg-surface: #111111;
            
            /* Accents */
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-red: #ff2a2a;
            --neon-green: #0aff68;
            --neon-gold: #ffd700;
            
            /* Borders & UI */
            --border-dim: rgba(255, 255, 255, 0.08);
            --border-bright: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #666666;
            
            /* Typography */
            --font-display: 'Rajdhani', sans-serif;
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            
            /* Motion */
            --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* --- 2. GLOBAL RESET --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        ::selection { background: var(--neon-blue); color: #000; }
        
        body {
            background: var(--bg-void);
            color: var(--text-main);
            margin: 0;
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-size: 14px;
        }

        /* --- 3. ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes pulse-signal { 
            0% { box-shadow: 0 0 0 0 rgba(10, 255, 104, 0.4); } 
            70% { box-shadow: 0 0 0 8px rgba(10, 255, 104, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(10, 255, 104, 0); } 
        }
        @keyframes scanline {
            0% { top: -20%; opacity: 0; }
            50% { opacity: 0.5; }
            100% { top: 120%; opacity: 0; }
        }
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        /* --- 4. AUTH SECURITY GATE --- */
        #auth-gate {
            position: fixed; inset: 0; z-index: 5000;
            background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.8s var(--ease-smooth);
        }
        
        .gate-scanner {
            width: 280px; height: 280px; border-radius: 50%;
            border: 1px solid #222; position: relative;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 40px;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.05);
        }
        .gate-scanner::before {
            content: ''; position: absolute; inset: -2px; border-radius: 50%;
            background: conic-gradient(transparent 20%, var(--neon-blue) 50%, transparent 80%);
            animation: spin 2s linear infinite; opacity: 0.3;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .gate-logo { font-family: var(--font-display); font-size: 32px; font-weight: 700; letter-spacing: 4px; }
        .gate-sub { color: var(--text-muted); font-size: 10px; font-family: var(--font-code); letter-spacing: 2px; margin-top: 5px; }

        .pin-grid { display: grid; grid-template-columns: repeat(3, 80px); gap: 16px; position: relative; z-index: 2; }
        .pin-key {
            width: 80px; height: 80px; border-radius: 20px;
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-dim);
            color: #fff; font-size: 24px; font-family: var(--font-display);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .pin-key:active { background: var(--neon-blue); color: #000; transform: scale(0.95); }
        .pin-status {
            display: flex; gap: 12px; margin-bottom: 30px; height: 12px;
        }
        .p-dot { width: 12px; height: 12px; background: #222; border-radius: 50%; transition: 0.3s cubic-bezier(0.5, 1.5, 0.5, 1); }
        .p-dot.active { background: var(--neon-blue); transform: scale(1.4); box-shadow: 0 0 10px var(--neon-blue); }

        /* --- 5. MAIN DASHBOARD LAYOUT --- */
        #dashboard { display: none; flex: 1; flex-direction: column; opacity: 0; transition: 1s ease; position: relative; }
        
        /* HEADER */
        header {
            height: 70px; padding: 0 24px;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-dim);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 100;
        }
        .brand { display: flex; align-items: center; gap: 12px; }
        .b-icon { color: var(--neon-blue); font-size: 28px; }
        .b-text { font-family: var(--font-display); font-weight: 700; font-size: 20px; letter-spacing: 1px; }
        .b-ver { font-size: 9px; background: #111; padding: 2px 6px; border: 1px solid #333; border-radius: 4px; color: #888; }
        
        .h-tools { display: flex; gap: 8px; }
        .tool-btn {
            width: 40px; height: 40px; border-radius: 12px;
            background: var(--bg-surface); border: 1px solid var(--border-dim);
            color: #888; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .tool-btn:hover { color: #fff; border-color: #444; }
        .tool-btn.active { color: var(--neon-blue); border-color: var(--neon-blue); background: rgba(0, 243, 255, 0.1); }

        /* HUD STATS ROW */
        .hud-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 20px;
        }
        .stat-card {
            background: linear-gradient(180deg, #111, #050505);
            border: 1px solid var(--border-dim); border-radius: 16px;
            padding: 16px; position: relative; overflow: hidden;
        }
        .stat-card::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }
        .sc-val { font-family: var(--font-code); font-size: 28px; font-weight: 700; color: #fff; }
        .sc-lbl { font-size: 10px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px; }
        .sc-icon { position: absolute; right: 12px; bottom: 12px; opacity: 0.1; font-size: 32px; }

        /* NETWATCH MONITOR */
        .netwatch {
            margin: 0 20px 20px; padding: 16px;
            background: rgba(10, 255, 104, 0.03); border: 1px solid rgba(10, 255, 104, 0.15);
            border-radius: 12px; display: flex; align-items: center; justify-content: space-between;
        }
        .nw-left { display: flex; align-items: center; gap: 12px; }
        .nw-led { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 10px var(--neon-green); animation: pulse-signal 2s infinite; }
        .nw-text { font-family: var(--font-code); font-size: 13px; color: var(--neon-green); font-weight: 600; }
        .nw-graph { display: flex; align-items: flex-end; gap: 3px; height: 20px; }
        .bar { width: 3px; background: var(--neon-green); opacity: 0.3; border-radius: 2px; }
        .bar.a { height: 40%; animation: eq 0.6s infinite alternate; }
        .bar.b { height: 80%; animation: eq 0.4s infinite alternate; }
        .bar.c { height: 60%; animation: eq 0.8s infinite alternate; }
        .bar.d { height: 90%; animation: eq 0.5s infinite alternate; }
        @keyframes eq { to { height: 20%; opacity: 0.8; } }

        /* SEARCH & FILTER */
        .ctrl-bar {
            padding: 0 20px 10px; display: flex; gap: 10px; position: sticky; top: 0; z-index: 50; background: var(--bg-void);
        }
        .search-box {
            flex: 1; position: relative;
        }
        .search-input {
            width: 100%; height: 48px; background: var(--bg-surface);
            border: 1px solid var(--border-dim); border-radius: 12px;
            padding: 0 16px 0 44px; color: #fff; font-family: var(--font-ui); font-size: 14px;
            transition: 0.3s;
        }
        .search-input:focus { border-color: var(--neon-blue); box-shadow: 0 0 0 1px var(--neon-blue); }
        .search-icon { position: absolute; left: 14px; top: 14px; color: #555; }
        
        .filter-btn {
            width: 48px; height: 48px; border-radius: 12px; background: var(--bg-surface);
            border: 1px solid var(--border-dim); color: var(--text-muted);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .filter-btn.active { color: var(--neon-purple); border-color: var(--neon-purple); background: rgba(188, 19, 254, 0.1); }

        /* USER LIST */
        .list-viewport { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .u-card {
            display: flex; align-items: center; gap: 16px; padding: 16px 20px;
            border-bottom: 1px solid var(--border-dim); cursor: pointer; transition: 0.2s;
            position: relative;
        }
        .u-card:hover { background: rgba(255,255,255,0.02); }
        .u-card::before {
            content:''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; 
            background: transparent; transition: 0.2s;
        }
        .u-card.is-adm::before { background: var(--neon-purple); }
        .u-card.is-sus::before { background: var(--neon-red); }
        
        .u-avi {
            width: 48px; height: 48px; border-radius: 14px; background: #1a1a1a; 
            object-fit: cover; border: 1px solid var(--border-dim);
        }
        .u-info { flex: 1; min-width: 0; }
        .u-name { font-weight: 600; font-size: 15px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .u-sub { font-size: 12px; color: #666; font-family: var(--font-code); display: flex; align-items: center; gap: 6px; }
        .u-tags { display: flex; gap: 6px; }
        .tag { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .tag.ver { color: var(--neon-blue); background: rgba(0, 243, 255, 0.1); border: 1px solid rgba(0, 243, 255, 0.3); }
        .tag.sus { color: var(--neon-red); background: rgba(255, 42, 42, 0.1); border: 1px solid rgba(255, 42, 42, 0.3); }
        .tag.adm { color: var(--neon-purple); background: rgba(188, 19, 254, 0.1); border: 1px solid rgba(188, 19, 254, 0.3); }

        /* --- 6. OVERLAYS & MODALS (HISTORY API SUPPORT) --- */
        .overlay-dim {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .overlay-dim.visible { opacity: 1; pointer-events: all; }

        /* DRAWER (EDIT USER) */
        .drawer {
            position: fixed; bottom: 0; left: 0; right: 0; height: 90vh;
            background: #090909; border-radius: 32px 32px 0 0;
            border-top: 1px solid var(--border-bright);
            box-shadow: 0 -20px 50px rgba(0,0,0,0.5);
            transform: translateY(110%); transition: 0.5s var(--ease-elastic);
            z-index: 1001; display: flex; flex-direction: column;
        }
        .overlay-dim.visible .drawer.active { transform: translateY(0); }

        .dr-head {
            padding: 24px; border-bottom: 1px solid var(--border-dim);
            display: flex; justify-content: space-between; align-items: center;
        }
        .dr-title { font-family: var(--font-display); font-size: 20px; font-weight: 700; }
        .dr-body { padding: 24px; overflow-y: auto; flex: 1; }
        
        /* Profile Hero */
        .p-hero { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .p-img { width: 80px; height: 80px; border-radius: 20px; object-fit: cover; border: 2px solid var(--border-bright); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .p-meta h1 { margin: 0; font-size: 22px; font-weight: 700; }
        .p-uid { font-family: var(--font-code); font-size: 11px; color: var(--neon-blue); cursor: pointer; display: flex; align-items: center; gap: 6px; margin-top: 4px; }

        /* Controls */
        .ctrl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .ctrl-btn {
            background: #111; border: 1px solid var(--border-dim); color: #fff;
            padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px;
        }
        .ctrl-btn:hover { border-color: #555; }
        .ctrl-btn.msg { grid-column: span 2; background: rgba(0, 243, 255, 0.05); color: var(--neon-blue); border-color: rgba(0, 243, 255, 0.2); }
        .ctrl-btn.msg:hover { background: rgba(0, 243, 255, 0.15); }
        
        .inp-field {
            width: 100%; background: #141414; border: 1px solid var(--border-dim);
            color: #fff; padding: 16px; border-radius: 12px; font-family: var(--font-ui);
            margin-bottom: 16px; transition: 0.3s;
        }
        .inp-field:focus { border-color: var(--neon-blue); background: #1a1a1a; }
        
        .toggle-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: #111; border-radius: 12px; margin-bottom: 12px;
            border: 1px solid var(--border-dim); cursor: pointer;
        }
        .toggle-row.on-ver { border-color: var(--neon-blue); background: rgba(0, 243, 255, 0.05); }
        .toggle-row.on-sus { border-color: var(--neon-red); background: rgba(255, 42, 42, 0.05); }
        .toggle-row.on-adm { border-color: var(--neon-purple); background: rgba(188, 19, 254, 0.05); }

        .sw-track { width: 44px; height: 24px; background: #333; border-radius: 20px; position: relative; transition: 0.3s; }
        .sw-knob { width: 18px; height: 18px; background: #fff; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .active .sw-knob { transform: translateX(20px); }
        .active .sw-track.blue { background: var(--neon-blue); }
        .active .sw-track.red { background: var(--neon-red); }
        .active .sw-track.purple { background: var(--neon-purple); }

        .dr-foot {
            padding: 24px; border-top: 1px solid var(--border-dim); background: rgba(9,9,9,0.95);
            display: grid; grid-template-columns: 1fr 2fr; gap: 12px; padding-bottom: calc(24px + env(safe-area-inset-bottom));
        }
        .btn-lrg {
            height: 56px; border-radius: 14px; font-weight: 700; font-size: 16px; border: none; cursor: pointer;
        }
        .btn-pri { background: #fff; color: #000; }
        .btn-dan { background: rgba(255, 42, 42, 0.1); color: var(--neon-red); border: 1px solid rgba(255, 42, 42, 0.3); }

        /* BROADCAST MODAL (CENTERED) */
        .modal-card {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 90%; max-width: 480px; background: #0a0a0a; border: 1px solid var(--border-bright);
            border-radius: 24px; z-index: 1002; opacity: 0; pointer-events: none; transition: 0.4s var(--ease-elastic);
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
        }
        .overlay-dim.visible .modal-card.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: all; }

        .mode-select { display: flex; gap: 8px; margin-bottom: 20px; }
        .mode-chip {
            padding: 8px 16px; border-radius: 8px; background: #1a1a1a; color: #666; font-size: 11px;
            font-weight: 700; cursor: pointer; border: 1px solid #333; transition: 0.2s;
        }
        .mode-chip.active { color: #000; background: var(--neon-gold); border-color: var(--neon-gold); }
        .mode-chip.active-ver { color: #000; background: var(--neon-blue); border-color: var(--neon-blue); }

        .composer {
            width: 100%; min-height: 120px; background: #000; border: 1px solid #333;
            color: #fff; padding: 16px; border-radius: 12px; font-family: var(--font-ui); font-size: 15px;
            margin-bottom: 12px; resize: none;
        }
        .composer:focus { border-color: var(--neon-gold); }
        
        .attach-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }

        /* NOTIFICATIONS */
        #toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-200%);
            background: rgba(255,255,255,0.9); backdrop-filter: blur(12px);
            color: #000; padding: 12px 28px; border-radius: 30px; font-weight: 600;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 9999; transition: 0.5s var(--ease-elastic);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* JSON VIEWER */
        #json-modal { display: none; }
        .json-box {
            background: #050505; color: #0aff68; font-family: var(--font-code); font-size: 11px;
            padding: 16px; border-radius: 12px; overflow: auto; max-height: 300px; border: 1px solid #222;
        }

        /* SESSION LOGGER */
        .log-drawer {
            position: fixed; top: 0; right: 0; bottom: 0; width: 300px; background: #080808;
            border-left: 1px solid #222; transform: translateX(100%); transition: 0.3s; z-index: 1005;
            padding: 20px; overflow-y: auto;
        }
        .log-drawer.active { transform: translateX(0); }
        .log-item {
            font-family: var(--font-code); font-size: 10px; padding: 8px 0; border-bottom: 1px solid #1a1a1a; color: #888;
        }
        .log-item span { color: var(--neon-blue); }

    </style>
</head>
<body>

    <div id="toast">Command Executed</div>

    <div id="auth-gate">
        <div class="gate-scanner">
            <span class="material-icons-round" style="font-size: 64px; color: #fff;">fingerprint</span>
        </div>
        <div class="gate-logo">NEXUS TITAN</div>
        <div class="gate-sub">SECURE ADMIN TERMINAL v6.0</div>

        <div class="pin-status">
            <div class="p-dot" id="pd1"></div><div class="p-dot" id="pd2"></div>
            <div class="p-dot" id="pd3"></div><div class="p-dot" id="pd4"></div>
        </div>

        <div class="pin-grid">
            <div class="pin-key" onclick="kp(1)">1</div><div class="pin-key" onclick="kp(2)">2</div><div class="pin-key" onclick="kp(3)">3</div>
            <div class="pin-key" onclick="kp(4)">4</div><div class="pin-key" onclick="kp(5)">5</div><div class="pin-key" onclick="kp(6)">6</div>
            <div class="pin-key" onclick="kp(7)">7</div><div class="pin-key" onclick="kp(8)">8</div><div class="pin-key" onclick="kp(9)">9</div>
            <div class="pin-key" style="opacity:0"></div>
            <div class="pin-key" onclick="kp(0)">0</div>
            <div class="pin-key" onclick="kp('c')" style="color:var(--neon-red)"><span class="material-icons-round">backspace</span></div>
        </div>
        </div>

    <div id="access-denied" style="display:none; position:fixed; inset:0; background:#000; z-index:6000; flex-direction:column; align-items:center; justify-content:center;">
        <span class="material-icons-round" style="font-size:80px; color:var(--neon-red); margin-bottom:20px;">lock</span>
        <h1 style="font-family:var(--font-display); letter-spacing:2px;">UNAUTHORIZED</h1>
        <p style="color:#666; font-family:var(--font-code);">Identity hash verification failed.</p>
        <button onclick="location.reload()" style="margin-top:40px; background:none; border:1px solid #333; color:#fff; padding:10px 30px; border-radius:8px;">REBOOT</button>
    </div>

    <div id="dashboard">
        <header>
            <div class="brand">
                <span class="material-icons-round b-icon">hub</span>
                <div>
                    <div class="b-text">NEXUS</div>
                    <div class="b-ver">TITAN BUILD</div>
                </div>
            </div>
            <div class="h-tools">
                <div class="tool-btn" onclick="toggleLogs()"><span class="material-icons-round">history</span></div>
                <div class="tool-btn" onclick="refreshData()"><span class="material-icons-round">sync</span></div>
                <div class="tool-btn" onclick="firebase.auth().signOut()"><span class="material-icons-round">power_settings_new</span></div>
            </div>
        </header>

        <div class="hud-grid">
            <div class="stat-card">
                <div class="sc-val" id="stat-total">--</div>
                <div class="sc-lbl">Total Entities</div>
                <span class="material-icons-round sc-icon">group</span>
            </div>
            <div class="stat-card" style="border-color: rgba(255, 42, 42, 0.3);">
                <div class="sc-val" id="stat-ban" style="color:var(--neon-red)">--</div>
                <div class="sc-lbl">Suspended</div>
                <span class="material-icons-round sc-icon" style="color:red">block</span>
            </div>
        </div>

        <div class="netwatch">
            <div class="nw-left">
                <div class="nw-led"></div>
                <div class="nw-text">NETWATCH ACTIVE: <span id="stat-online" style="color:#fff">0</span> NODES</div>
            </div>
            <div class="nw-graph">
                <div class="bar a"></div><div class="bar b"></div><div class="bar c"></div><div class="bar d"></div>
            </div>
        </div>

        <div class="ctrl-bar">
            <div class="search-box">
                <span class="material-icons-round search-icon">search</span>
                <input type="text" class="search-input" id="search-input" placeholder="Query User Database..." oninput="handleSearch()">
            </div>
            <div class="filter-btn" id="fab-cast" onclick="openBroadcast()">
                <span class="material-icons-round">campaign</span>
            </div>
        </div>

        <div class="list-viewport" id="user-list-render">
            </div>
    </div>

    <div id="overlay" class="overlay-dim" onclick="closeAll()">
        
        <div id="drawer-edit" class="drawer" onclick="event.stopPropagation()">
            <div class="dr-head">
                <div class="dr-title">Node Config</div>
                <span class="material-icons-round" style="cursor:pointer; color:#666;" onclick="closeAll()">expand_more</span>
            </div>
            <div class="dr-body">
                <div class="p-hero">
                    <img src="" id="e-img" class="p-img">
                    <div class="p-meta">
                        <h1 id="e-name">User Name</h1>
                        <div class="p-uid" onclick="copyId()">
                            <span class="material-icons-round" style="font-size:12px;">fingerprint</span>
                            <span id="e-uid">UID_STRING</span>
                        </div>
                    </div>
                </div>

                <div class="ctrl-grid">
                    <div class="ctrl-btn msg" onclick="composeDirect()">
                        <span class="material-icons-round">mail</span> Send Official Message
                    </div>
                    <div class="ctrl-btn" onclick="showJson()">
                        <span class="material-icons-round">data_object</span> Raw Data
                    </div>
                    <div class="ctrl-btn" onclick="copyJSON()">
                        <span class="material-icons-round">content_copy</span> Copy JSON
                    </div>
                </div>

                <input type="text" id="in-name" class="inp-field" placeholder="Display Name">
                <input type="text" id="in-user" class="inp-field" placeholder="@username" oninput="cleanHandle(this)">
                <input type="number" id="in-num" class="inp-field" placeholder="Goorac ID (10 digit)">
                <input type="text" id="in-pfp" class="inp-field" placeholder="Avatar URL">

                <h4 style="margin:20px 0 10px; color:#666; text-transform:uppercase; font-size:11px;">Permissions</h4>
                
                <div class="toggle-row" id="tog-ver" onclick="toggleSwitch('tog-ver', 'blue')">
                    <span style="font-weight:600">Verified Badge</span>
                    <div class="sw-track blue"><div class="sw-knob"></div></div>
                </div>
                
                <div class="toggle-row" id="tog-adm" onclick="toggleSwitch('tog-adm', 'purple')">
                    <span style="font-weight:600">Admin Privileges</span>
                    <div class="sw-track purple"><div class="sw-knob"></div></div>
                </div>
                
                <div class="toggle-row" id="tog-sus" onclick="toggleSwitch('tog-sus', 'red')">
                    <span style="font-weight:600; color:var(--neon-red)">Suspend Access</span>
                    <div class="sw-track red"><div class="sw-knob"></div></div>
                </div>
                
                <div id="json-modal" style="display:none; margin-top:20px;">
                    <div class="json-box" id="json-viewer"></div>
                </div>

            </div>
            <div class="dr-foot">
                <button class="btn-lrg btn-dan" onclick="deleteNode()">DESTROY</button>
                <button class="btn-lrg btn-pri" id="btn-save" onclick="saveNode()">COMMIT</button>
            </div>
        </div>

        <div id="modal-cast" class="modal-card" onclick="event.stopPropagation()">
            <div class="dr-head">
                <div class="dr-title" style="color:var(--neon-gold)">
                    <span class="material-icons-round" style="vertical-align:bottom; margin-right:5px;">satellite_alt</span>
                    Uplink
                </div>
                <span class="material-icons-round" onclick="closeAll()" style="cursor:pointer">close</span>
            </div>
            <div class="dr-body" style="background:#050505;">
                
                <div id="cast-target-ui">
                    <div class="mode-select">
                        <div class="mode-chip active" id="chip-all" onclick="setCastMode('ALL')">ALL NODES</div>
                        <div class="mode-chip" id="chip-ver" onclick="setCastMode('VERIFIED')">VERIFIED ONLY</div>
                        <div class="mode-chip" id="chip-sgl" style="display:none; cursor:default;">TARGET LOCKED</div>
                    </div>
                </div>

                <textarea id="cast-msg" class="composer" placeholder="Enter secure transmission..."></textarea>
                
                <div class="attach-row">
                    <input type="text" id="cast-img" class="inp-field" style="margin:0; font-size:12px; padding:12px;" placeholder="Image Link">
                    <input type="text" id="cast-file" class="inp-field" style="margin:0; font-size:12px; padding:12px;" placeholder="File Link">
                </div>

                <p style="font-family:var(--font-code); color:#444; font-size:10px;">
                    > SENDER: @goorac (OFFICIAL)<br>
                    > PROTOCOL: OMEGA-7
                </p>
            </div>
            <div class="dr-foot" style="grid-template-columns:1fr;">
                <button class="btn-lrg btn-pri" style="background:var(--neon-gold); color:#000;" id="btn-transmit" onclick="transmit()">TRANSMIT SIGNAL</button>
            </div>
        </div>

    </div>

    <div id="logs" class="log-drawer">
        <h3 style="margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">SESSION LOGS</h3>
        <div id="log-list"></div>
    </div>

    <script>
        // --- 1. CONFIG & INIT ---
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rdb = firebase.database();
        const auth = firebase.auth();

        // State
        let users = [];
        let currentUID = null;
        let officialGooracID = null;
        let castMode = 'ALL'; 
        let pinBuffer = "";
        let logs = [];

        // --- 2. HISTORY API (BACK BUTTON HANDLING) ---
        window.addEventListener('popstate', (e) => {
            // When user presses back, if overlay is visible, close it
            const overlay = document.getElementById('overlay');
            if (overlay.classList.contains('visible')) {
                closeAll(false); // false = don't push history, just close UI
            }
        });

        function pushStateForModal(id) {
            history.pushState({modal: id}, null, "");
        }

        // --- 3. LOGGING SYSTEM ---
        function log(action, detail) {
            const ts = new Date().toLocaleTimeString('en-US', {hour12:false});
            const entry = `<div class="log-item">[${ts}] <span>${action}</span>: ${detail}</div>`;
            document.getElementById('log-list').innerHTML = entry + document.getElementById('log-list').innerHTML;
            logs.push({ts, action, detail});
        }
        function toggleLogs() { document.getElementById('logs').classList.toggle('active'); }

        // --- 4. AUTHENTICATION ---
        auth.onAuthStateChanged(async u => {
            if(!u) return location.href="login.html";
            
            // Check Admin
            const doc = await db.collection("users").doc(u.uid).get();
            if(doc.exists) {
                const d = doc.data();
                if(d.admin === true || d.username === 'goorac' || d.username === 'sivamanihandan') {
                    log("AUTH", "Admin Session Started: " + d.username);
                } else {
                    document.getElementById('access-denied').style.display = 'flex';
                }
            } else {
                document.getElementById('access-denied').style.display = 'flex';
            }
        });

        // --- 5. PIN GATE ---
        function kp(key) {
            if(key === 'c') pinBuffer = pinBuffer.slice(0, -1);
            else if(pinBuffer.length < 4) pinBuffer += key;
            
            // UI Feedback
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById('pd'+i);
                if(i <= pinBuffer.length) dot.classList.add('active');
                else dot.classList.remove('active');
            }

            if(pinBuffer === "2502") {
                unlockTerminal();
            } else if (pinBuffer.length === 4) {
                navigator.vibrate([50,50,50]);
                toast("ACCESS DENIED");
                setTimeout(()=>{ pinBuffer=""; kp('x'); }, 400);
            }
        }

        function unlockTerminal() {
            document.getElementById('auth-gate').style.opacity = '0';
            document.getElementById('auth-gate').style.pointerEvents = 'none';
            document.getElementById('dashboard').style.display = 'flex';
            setTimeout(() => document.getElementById('dashboard').style.opacity = '1', 50);
            initDataStream();
        }

        // --- 6. DATA ENGINE ---
        function initDataStream() {
            log("SYS", "Initializing Data Stream...");
            
            // Firestore Listener
            db.collection("users").orderBy("username").onSnapshot(snap => {
                users = [];
                snap.forEach(d => {
                    const data = d.data();
                    users.push({id: d.id, ...data});
                    if(data.username === 'goorac') officialGooracID = d.id;
                });
                renderList(users);
                updateStats();
                log("DB", `Synced ${users.length} entities`);
            });

            // Realtime Presence Count
            rdb.ref('status').on('value', snap => {
                let online = 0;
                snap.forEach(c => { if(c.val().state === 'online') online++; });
                document.getElementById('stat-online').innerText = online;
            });
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = users.length;
            document.getElementById('stat-ban').innerText = users.filter(u => u.suspended).length;
        }

        function renderList(list) {
            const container = document.getElementById('user-list-render');
            container.innerHTML = "";
            
            list.forEach(u => {
                const el = document.createElement('div');
                el.className = `u-card ${u.admin?'is-adm':''} ${u.suspended?'is-sus':''}`;
                el.onclick = () => openEditor(u);
                
                let tags = "";
                if(u.admin) tags += `<span class="tag adm">ADM</span>`;
                if(u.verified) tags += `<span class="tag ver">VER</span>`;
                if(u.suspended) tags += `<span class="tag sus">SUS</span>`;

                el.innerHTML = `
                    <img src="${u.photoURL || 'https://via.placeholder.com/50'}" class="u-avi">
                    <div class="u-info">
                        <div class="u-name">${u.name}</div>
                        <div class="u-sub">@${u.username}</div>
                    </div>
                    <div class="u-tags">${tags}</div>
                `;
                container.appendChild(el);
            });
        }

        // --- 7. UI INTERACTIONS ---
        function openEditor(u) {
            currentUID = u.id;
            
            // Populate Fields
            document.getElementById('e-img').src = u.photoURL;
            document.getElementById('e-name').innerText = u.name;
            document.getElementById('e-uid').innerText = u.id;
            
            document.getElementById('in-name').value = u.name;
            document.getElementById('in-user').value = u.username;
            document.getElementById('in-num').value = u.gooracNumber || '';
            document.getElementById('in-pfp').value = u.photoURL;
            
            // Set Toggles
            setSwitch('tog-ver', u.verified);
            setSwitch('tog-adm', u.admin);
            setSwitch('tog-sus', u.suspended);
            
            // Show Drawer
            document.getElementById('json-modal').style.display = 'none';
            document.getElementById('overlay').classList.add('visible');
            document.getElementById('drawer-edit').classList.add('active');
            document.getElementById('modal-cast').classList.remove('active'); // ensure closed
            
            pushStateForModal('edit');
            log("UI", "Opened Inspector: " + u.username);
        }

        function openBroadcast() {
            setCastMode('ALL');
            document.getElementById('overlay').classList.add('visible');
            document.getElementById('modal-cast').classList.add('active');
            document.getElementById('drawer-edit').classList.remove('active');
            
            pushStateForModal('cast');
        }

        function closeAll(backNav = true) {
            document.getElementById('overlay').classList.remove('visible');
            document.getElementById('drawer-edit').classList.remove('active');
            document.getElementById('modal-cast').classList.remove('active');
            document.getElementById('logs').classList.remove('active');
            if(backNav) history.back();
        }

        // Toggle Logic
        function setSwitch(id, state) {
            const el = document.getElementById(id);
            if(state) el.classList.add('active');
            else el.classList.remove('active');
        }
        function toggleSwitch(id, type) {
            const el = document.getElementById(id);
            el.classList.toggle('active');
        }

        // --- 8. BUSINESS LOGIC ---
        
        async function saveNode() {
            const btn = document.getElementById('btn-save');
            btn.innerText = "SAVING...";
            
            const updates = {
                name: document.getElementById('in-name').value,
                username: document.getElementById('in-user').value,
                gooracNumber: parseInt(document.getElementById('in-num').value),
                photoURL: document.getElementById('in-pfp').value,
                verified: document.getElementById('tog-ver').classList.contains('active'),
                admin: document.getElementById('tog-adm').classList.contains('active'),
                suspended: document.getElementById('tog-sus').classList.contains('active')
            };

            try {
                // Check dupes (Username/Number) - Basic check logic
                await db.collection("users").doc(currentUID).update(updates);
                toast("NODE UPDATED");
                closeAll();
                log("DB", "Updated Node: " + currentUID);
            } catch(e) {
                toast("ERROR: " + e.message);
            }
            btn.innerText = "COMMIT";
        }

        async function deleteNode() {
            if(!confirm("WARNING: Irreversible deletion of user node. Proceed?")) return;
            await db.collection("users").doc(currentUID).delete();
            toast("NODE DESTROYED");
            closeAll();
            log("DB", "Deleted Node: " + currentUID);
        }

        // --- 9. MESSAGING SYSTEM ---
        function composeDirect() {
            document.getElementById('drawer-edit').classList.remove('active');
            document.getElementById('modal-cast').classList.add('active');
            
            // Set Single Mode
            castMode = 'SINGLE';
            document.getElementById('chip-all').className = 'mode-chip';
            document.getElementById('chip-ver').className = 'mode-chip';
            const sgl = document.getElementById('chip-sgl');
            sgl.style.display = 'block';
            sgl.innerText = "TARGET: " + currentUID;
            sgl.classList.add('active', 'active-ver'); // reuse active-ver style
        }

        function setCastMode(m) {
            castMode = m;
            document.getElementById('chip-sgl').style.display = 'none';
            document.getElementById('chip-all').className = m === 'ALL' ? 'mode-chip active' : 'mode-chip';
            document.getElementById('chip-ver').className = m === 'VERIFIED' ? 'mode-chip active-ver' : 'mode-chip';
        }

        async function transmit() {
            if(!officialGooracID) return toast("SYS ERR: Official ID Not Found");
            
            const btn = document.getElementById('btn-transmit');
            const txt = document.getElementById('cast-msg').value;
            const img = document.getElementById('cast-img').value;
            const file = document.getElementById('cast-file').value;

            if(!txt && !img && !file) return toast("ERR: Empty Payload");

            btn.innerText = "TRANSMITTING...";

            let targets = [];
            if(castMode === 'ALL') targets = users.filter(u => u.id !== officialGooracID);
            else if(castMode === 'VERIFIED') targets = users.filter(u => u.verified && u.id !== officialGooracID);
            else if(castMode === 'SINGLE') targets = users.filter(u => u.id === currentUID);

            let sent = 0;
            const batch = [];
            
            // Client-side loop for sending (Titan can handle it)
            for(const t of targets) {
                const chatId = officialGooracID < t.id ? `${officialGooracID}_${t.id}` : `${t.id}_${officialGooracID}`;
                
                const msg = {
                    text: txt,
                    sender: officialGooracID,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    seen: false, reactions: {}
                };
                if(img) msg.imageUrl = img;
                if(file) msg.fileUrl = file;

                // Add to promise array
                batch.push(
                    db.collection("chats").doc(chatId).collection("messages").add(msg)
                    .then(() => {
                        let preview = txt || (img?"ðŸ“· Image":"ðŸ“„ File");
                        return db.collection("chats").doc(chatId).set({
                            lastMessage: preview,
                            lastSender: officialGooracID,
                            lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            participants: [officialGooracID, t.id],
                            [`unreadCount.${t.id}`]: firebase.firestore.FieldValue.increment(1)
                        }, {merge:true});
                    })
                );
                sent++;
            }

            try {
                await Promise.all(batch);
                toast(`TRANSMISSION COMPLETE: ${sent} NODES`);
                log("MSG", `Broadcast sent to ${sent} targets`);
                
                // Reset UI
                document.getElementById('cast-msg').value = "";
                document.getElementById('cast-img').value = "";
                document.getElementById('cast-file').value = "";
                closeAll();
            } catch(e) {
                toast("ERR: " + e.message);
            }
            btn.innerText = "TRANSMIT SIGNAL";
        }

        // --- 10. UTILS & SEARCH ---
        function handleSearch() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const filtered = users.filter(u => u.name.toLowerCase().includes(q) || u.username.toLowerCase().includes(q) || u.id === q);
            renderList(filtered);
        }

        function cleanHandle(el) { el.value = el.value.toLowerCase().replace(/[^a-z0-9_]/g, ''); }
        
        function copyId() {
            navigator.clipboard.writeText(currentUID);
            toast("UID COPIED TO CLIPBOARD");
        }
        
        function showJson() {
            const u = users.find(x => x.id === currentUID);
            const box = document.getElementById('json-viewer');
            box.innerText = JSON.stringify(u, null, 2);
            document.getElementById('json-modal').style.display = 'block';
        }
        
        function copyJSON() {
             const u = users.find(x => x.id === currentUID);
             navigator.clipboard.writeText(JSON.stringify(u, null, 2));
             toast("RAW JSON COPIED");
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function refreshData() {
            toast("RESYNCING DATABASE...");
            // Listeners will auto-update, just fake feedback
        }

    </script>
</body>
</html>
