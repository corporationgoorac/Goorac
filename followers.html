<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Followers | Quantum</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="config.js"></script>
    <script src="components/navbar.js" defer></script>

    <style>
        :root {
            --bg: #000;
            --surface: #0a0a0a;
            --accent: #00d2ff;
            --text: #ffffff;
            --dim: #a8a8a8;
            --border: #262626;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0;
            padding-top: 110px;
            padding-bottom: 70px;
        }

        .header {
            position: fixed;
            top: 0; width: 100%;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            padding-top: env(safe-area-inset-top);
        }

        .header-top {
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 15px;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 15px;
        }

        .header h1 { font-size: 1rem; font-weight: 600; flex-grow: 1; text-align: center; margin-right: 30px; }

        .search-container {
            padding: 10px 15px;
            background: var(--bg);
        }

        .search-input {
            width: 100%;
            background: #262626;
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            color: white;
            outline: none;
            font-size: 0.9rem;
        }

        .list-container {
            padding: 10px 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 0.85rem;
            color: var(--dim);
            margin: 15px 0 10px 0;
            text-transform: uppercase;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
        }

        .user-pfp {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border);
        }

        .username { font-weight: 600; font-size: 0.9rem; }
        .full-name { color: var(--dim); font-size: 0.85rem; }

        .action-btn {
            background: #363636;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }

        .mutual-lock {
            text-align: center;
            padding: 50px 20px;
            color: var(--dim);
        }

        .v-badge {
            width: 14px;
            height: 14px;
            background: var(--accent);
            display: inline-block;
            mask: url('https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg') no-repeat center;
            -webkit-mask: url('https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg') no-repeat center;
        }

        #loading { text-align: center; padding: 20px; color: var(--accent); }
    </style>
</head>
<body>

<div class="header">
    <div class="header-top">
        <button class="back-btn" onclick="window.history.back()">&#8592;</button>
        <h1 id="header-title">Followers</h1>
    </div>
    <div class="search-container">
        <input type="text" id="follower-search" class="search-input" placeholder="Search followers..." oninput="filterFollowers()">
    </div>
</div>

<div id="loading">Synchronizing...</div>

<div id="content" class="list-container">
    <div id="followers-list"></div>
    <div id="suggestions-section" style="display: none;">
        <div class="section-title">Suggestions</div>
        <div id="suggestions-list"></div>
    </div>
</div>

<script>
    const db = firebase.firestore();
    const auth = firebase.auth();
    const urlParams = new URLSearchParams(window.location.search);
    const targetUsername = urlParams.get('user');
    
    let allFollowersData = []; 
    let globalIsOwnProfile = true;

    auth.onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = "login.html";
            return;
        }
        initFollowersPage(user);
    });

    async function initFollowersPage(currentUser) {
        const contentDiv = document.getElementById('content');
        const loadingDiv = document.getElementById('loading');
        
        try {
            let targetUID = currentUser.uid;

            if (targetUsername) {
                const userQuery = await db.collection("users").where("username", "==", targetUsername).get();
                if (userQuery.empty) {
                    contentDiv.innerHTML = "<div class='mutual-lock'>User not found.</div>";
                    loadingDiv.style.display = 'none';
                    return;
                }
                const targetDoc = userQuery.docs[0];
                targetUID = targetDoc.id;
                const targetData = targetDoc.data();
                globalIsOwnProfile = (targetUID === currentUser.uid);
                document.getElementById('header-title').innerText = `@${targetData.username}'s Followers`;
            } else {
                globalIsOwnProfile = true;
                document.getElementById('header-title').innerText = `Your Followers`;
            }

            // Mutual Check Logic
            if (!globalIsOwnProfile) {
                const [myDoc, targetDoc] = await Promise.all([
                    db.collection("users").doc(currentUser.uid).get(),
                    db.collection("users").doc(targetUID).get()
                ]);
                
                const myData = myDoc.data() || {};
                const targetData = targetDoc.data() || {};

                const iFollowThem = (myData.following || []).includes(targetUID);
                const theyFollowMe = (targetData.following || []).includes(currentUser.uid);

                if (!(iFollowThem && theyFollowMe)) {
                    contentDiv.innerHTML = `
                        <div class="mutual-lock">
                            <div style="font-size: 3rem; margin-bottom: 10px;">ðŸ”’</div>
                            <p>This list is only visible to mutual followers.</p>
                        </div>`;
                    loadingDiv.style.display = 'none';
                    return;
                }
            }

            // High Performance Listener
            db.collection("users").doc(targetUID).onSnapshot(async (doc) => {
                if(!doc.exists) {
                    loadingDiv.style.display = 'none';
                    return;
                }
                const userData = doc.data();
                const followerIDs = userData.followers || [];

                if (followerIDs.length === 0) {
                    document.getElementById('followers-list').innerHTML = "<div class='mutual-lock'>No followers yet.</div>";
                    loadingDiv.style.display = 'none';
                } else {
                    await loadAndStoreFollowers(followerIDs, globalIsOwnProfile);
                }
                fetchSuggestions(currentUser.uid, followerIDs);
            }, (error) => {
                console.error("Snapshot error:", error);
                loadingDiv.style.display = 'none'; // Clear loading even on error
            });

        } catch (error) {
            console.error("Initialization error:", error);
            loadingDiv.innerText = "Error syncing data.";
            setTimeout(() => loadingDiv.style.display = 'none', 2000);
        }
    }

    async function loadAndStoreFollowers(uids, isOwnProfile) {
        const loadingDiv = document.getElementById('loading');
        try {
            // Parallel Fetch with individual existence check
            const snapshots = await Promise.all(uids.map(uid => db.collection("users").doc(uid).get()));
            
            allFollowersData = snapshots
                .filter(snap => snap.exists)
                .map(snap => ({ ...snap.data(), uid: snap.id }));

            renderUserList(allFollowersData, 'followers-list', isOwnProfile);
        } catch (e) {
            console.error("Batch load error:", e);
        } finally {
            loadingDiv.style.display = 'none'; // CRITICAL: This hides the "Synchronizing" text
        }
    }

    function renderUserList(users, containerId, isOwnProfile) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        users.forEach(u => {
            const userEl = document.createElement('div');
            userEl.className = 'user-item';
            userEl.innerHTML = `
                <a href="userProfile.html?user=${u.username}" class="user-info">
                    <img src="${u.photoURL || 'https://via.placeholder.com/150'}" class="user-pfp">
                    <div>
                        <div class="username">${u.username || 'unknown'} ${u.verified ? '<span class="v-badge"></span>' : ''}</div>
                        <div class="full-name">${u.name || ''}</div>
                    </div>
                </a>
                ${isOwnProfile && containerId === 'followers-list' ? 
                    `<button class="action-btn" onclick="removeFollower('${u.uid}')">Remove</button>` : 
                    `<button class="action-btn" onclick="location.href='userProfile.html?user=${u.username}'">View</button>`}
            `;
            container.appendChild(userEl);
        });
    }

    function filterFollowers() {
        const query = document.getElementById('follower-search').value.toLowerCase();
        const filtered = allFollowersData.filter(u => 
            (u.username && u.username.toLowerCase().includes(query)) || 
            (u.name && u.name.toLowerCase().includes(query))
        );
        renderUserList(filtered, 'followers-list', globalIsOwnProfile);
        document.getElementById('suggestions-section').style.display = query.length > 0 ? 'none' : 'block';
    }

    async function fetchSuggestions(myUid, existingFollowerIDs) {
        try {
            const sugSection = document.getElementById('suggestions-section');
            const usersSnap = await db.collection("users").limit(10).get();
            const suggestions = [];
            
            usersSnap.forEach(doc => {
                if (doc.id !== myUid && !existingFollowerIDs.includes(doc.id)) {
                    suggestions.push({ ...doc.data(), uid: doc.id });
                }
            });

            if (suggestions.length > 0) {
                sugSection.style.display = 'block';
                renderUserList(suggestions.slice(0, 5), 'suggestions-list', false);
            }
        } catch(e) { console.warn("Suggestions failed", e); }
    }

    async function removeFollower(followerUID) {
        if (!confirm("Remove this follower?")) return;
        const myUID = auth.currentUser.uid;
        const batch = db.batch();
        batch.update(db.collection("users").doc(myUID), {
            followers: firebase.firestore.FieldValue.arrayRemove(followerUID),
            followerCount: firebase.firestore.FieldValue.increment(-1)
        });
        batch.update(db.collection("users").doc(followerUID), {
            following: firebase.firestore.FieldValue.arrayRemove(myUID),
            followingCount: firebase.firestore.FieldValue.increment(-1)
        });
        await batch.commit();
    }
</script>



<script src="components/call-notifier.js" defer></script>
<call-notifier></call-notifier>

</body>
</html>
