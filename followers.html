<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">

    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000"> 
    <title>Followers | Goorac</title>
    
    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg: #000;
            --surface: #121212;
            --accent: #00d2ff;
            --text: #ffffff;
            --dim: #888;
            --border: #2a2a2a;
            --glass: rgba(18, 18, 18, 0.85);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding-top: 110px; padding-bottom: 40px;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: var(--glass); border-bottom: 1px solid var(--border);
            z-index: 100; padding-top: env(safe-area-inset-top);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .header-top { 
            height: 54px; display: flex; align-items: center; padding: 0 16px; 
            justify-content: space-between;
        }
        
        .back-btn { 
            background: none; border: none; color: var(--text); font-size: 1.6rem; 
            cursor: pointer; padding: 5px; display: flex; align-items: center;
        }
        
        .header-title-box { text-align: center; flex: 1; display: flex; flex-direction: column; }
        .header h1 { font-size: 1rem; font-weight: 700; margin: 0; letter-spacing: 0.5px; }
        .header-count { font-size: 0.75rem; color: var(--dim); margin-top: 2px; font-weight: 500; }

        /* --- SEARCH --- */
        .search-container { padding: 8px 16px 12px; }
        .search-wrapper {
            position: relative; width: 100%;
        }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px; fill: var(--dim); pointer-events: none;
        }
        .search-input {
            width: 100%; background: #1c1c1e; border: 1px solid #333; border-radius: 12px;
            padding: 10px 14px 10px 38px; color: white; outline: none; font-size: 0.95rem;
            transition: border-color 0.2s, background 0.2s;
        }
        .search-input:focus { border-color: var(--accent); background: #222; }

        /* --- LIST --- */
        .list-container { padding: 0 16px; max-width: 600px; margin: 0 auto; }
        
        .user-item { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 14px 0; border-bottom: 1px solid var(--border);
            animation: fadeIn 0.3s ease;
        }
        
        /* Highlight "You" */
        .user-item.is-me { background: linear-gradient(90deg, rgba(0, 210, 255, 0.05), transparent); margin: 0 -16px; padding: 14px 16px; border-bottom: 1px solid #333; }

        .user-info { display: flex; align-items: center; gap: 14px; text-decoration: none; color: inherit; flex: 1; min-width: 0; }
        
        .user-pfp { 
            width: 48px; height: 48px; border-radius: 50%; object-fit: cover; 
            border: 1px solid #333; background: #222; flex-shrink: 0;
        }
        
        .name-container { display: flex; flex-direction: column; min-width: 0; gap: 2px; }
        
        .display-name { 
            font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 4px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff;
        }
        .user-handle { 
            color: var(--dim); font-size: 0.85rem; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .you-badge {
            font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 2px 6px;
            border-radius: 4px; color: var(--dim); margin-left: auto; margin-right: 10px;
        }

        .action-btn {
            background: var(--text); color: #000; border: none; padding: 7px 18px;
            border-radius: 20px; font-size: 0.85rem; font-weight: 700; cursor: pointer;
            min-width: 85px; transition: transform 0.1s, background 0.2s, opacity 0.2s;
            flex-shrink: 0; margin-left: 10px;
        }
        .action-btn:active { transform: scale(0.96); }
        
        .action-btn.following { 
            background: transparent; border: 1px solid #444; color: #fff;
        }
        .action-btn.remove {
            background: rgba(255, 59, 48, 0.15); color: #ff453a; border: 1px solid rgba(255, 59, 48, 0.3);
        }

        .v-badge { width: 14px; height: 14px; vertical-align: middle; }

        /* Skeletons & States */
        .skeleton-item { display: flex; align-items: center; padding: 14px 0; opacity: 0.6; }
        .skeleton-pfp { width: 48px; height: 48px; border-radius: 50%; background: #222; margin-right: 14px; }
        .skeleton-info { flex: 1; }
        .skeleton-line { height: 12px; background: #222; border-radius: 6px; margin-bottom: 8px; }
        
        .pulse { animation: pulse-bg 1.5s infinite ease-in-out; }
        @keyframes pulse-bg { 0% { background-color: #111; } 50% { background-color: #222; } 100% { background-color: #111; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .empty-state { text-align: center; padding: 80px 20px; color: var(--dim); }
        .empty-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.3; filter: grayscale(1); }
        .lock-msg { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; font-size: 0.9rem; }

    </style>
</head>
<body>

<div class="header">
    <div class="header-top">
        <button class="back-btn" onclick="window.history.back()">‚Äπ</button>
        <div class="header-title-box">
            <h1 id="header-title">Followers</h1>
            <div id="header-count" class="header-count">Loading...</div>
        </div>
        <div style="width: 30px;"></div> </div>
    <div class="search-container">
        <div class="search-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="follower-search" class="search-input" placeholder="Search" oninput="filterList()" autocomplete="off">
        </div>
    </div>
</div>

<div id="content" class="list-container">
    <div id="followers-list">
        <div class="skeleton-item"><div class="skeleton-pfp pulse"></div><div class="skeleton-info"><div class="skeleton-line pulse" style="width:40%"></div><div class="skeleton-line pulse" style="width:25%"></div></div></div>
        <div class="skeleton-item"><div class="skeleton-pfp pulse"></div><div class="skeleton-info"><div class="skeleton-line pulse" style="width:50%"></div><div class="skeleton-line pulse" style="width:30%"></div></div></div>
        <div class="skeleton-item"><div class="skeleton-pfp pulse"></div><div class="skeleton-info"><div class="skeleton-line pulse" style="width:35%"></div><div class="skeleton-line pulse" style="width:20%"></div></div></div>
    </div>
    <div id="load-more-trigger"></div>
</div>

<script>
    // --- FIREBASE SETUP ---
    let fbConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51"
    };

    if (typeof window.CONFIG !== 'undefined' && window.CONFIG.firebase) {
        fbConfig = window.CONFIG.firebase;
    }

    if (!firebase.apps.length) { firebase.initializeApp(fbConfig); }
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const targetUsername = urlParams.get('user');
    
    // State Management
    let allUsersData = [];
    let isOwnProfile = false;
    let currentUserFollowing = []; // Strings (UIDs)
    let followerIds = []; // Strings (UIDs)
    
    // Pagination
    let lastFetchedIndex = 0;
    const limit = 20;
    let isLoadingMore = false;

    // --- AUTH & INIT ---
    auth.onAuthStateChanged(user => {
        if (user) { 
            // Real-time listener for MY following list (to update button states)
            db.collection("users").doc(user.uid).onSnapshot(doc => {
                const data = doc.data();
                if(data && data.following) {
                    // Extract IDs whether strings or objects
                    currentUserFollowing = data.following.map(f => typeof f === 'string' ? f : f.uid);
                    // Update buttons if list already rendered
                    if (allUsersData.length > 0) updateButtons();
                }
            });
            initPage(user); 
        } else { 
            window.location.href = 'login.html'; 
        }
    });

    async function initPage(currentUser) {
        const list = document.getElementById('followers-list');
        try {
            let targetUID = currentUser.uid;
            
            // 1. Determine Target User
            if (targetUsername) {
                const userQuery = await db.collection("users").where("username", "==", targetUsername).get();
                if (userQuery.empty) {
                    list.innerHTML = "<div class='empty-state'><div class='empty-icon'>üîç</div><p>User not found</p></div>";
                    document.getElementById('header-title').innerText = "Error";
                    document.getElementById('header-count').innerText = "";
                    return;
                }
                const targetDoc = userQuery.docs[0];
                targetUID = targetDoc.id;
                isOwnProfile = (targetUID === currentUser.uid);
                document.getElementById('header-title').innerText = `@${targetDoc.data().username}`;
            } else {
                isOwnProfile = true;
                document.getElementById('header-title').innerText = "My Followers";
            }

            // 2. Privacy/Mutual Check (Optional Logic Placeholder)
            // If implementing private profiles, check mutual status here.

            // 3. Listen to Followers Array
            db.collection("users").doc(targetUID).onSnapshot(async doc => {
                const rawFollowers = doc.data()?.followers || [];
                
                // Update Count in Header
                document.getElementById('header-count').innerText = `${rawFollowers.length} followers`;

                // Normalize: array might contain Strings (old) or Objects (new)
                // We reverse it to show newest followers at top (if array pushed chronologically)
                followerIds = rawFollowers.map(item => typeof item === 'string' ? item : item.uid).reverse();
                
                if (followerIds.length === 0) {
                    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üë•</div><p>No followers yet.</p></div>`;
                    return;
                }
                
                // Reset for new data load
                allUsersData = [];
                lastFetchedIndex = 0;
                list.innerHTML = ''; // Clear skeleton
                await loadMoreUsers();
            });

        } catch (e) {
            console.error(e);
            list.innerHTML = "<div class='empty-state'><p>Something went wrong.</p></div>";
        }
    }

    // --- BATCH LOADING ---
    async function loadMoreUsers() {
        if (isLoadingMore || lastFetchedIndex >= followerIds.length) return;
        isLoadingMore = true;

        const nextBatchIds = followerIds.slice(lastFetchedIndex, lastFetchedIndex + limit);
        
        try {
            // Parallel fetch user docs
            const profilePromises = nextBatchIds.map(id => db.collection("users").doc(id).get());
            const snapshots = await Promise.all(profilePromises);
            
            const newUsers = snapshots.filter(p => p.exists).map(p => ({...p.data(), uid: p.id}));
            
            allUsersData = [...allUsersData, ...newUsers];
            lastFetchedIndex += limit;
            
            renderList(allUsersData);
        } catch (e) {
            console.error("Batch load error:", e);
        } finally {
            isLoadingMore = false;
        }
    }

    // Infinite Scroll
    window.onscroll = () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
            loadMoreUsers();
        }
    };

    // --- RENDER LIST ---
    function renderList(users) {
        const list = document.getElementById('followers-list');
        list.innerHTML = "";
        const myUid = auth.currentUser.uid;

        // Sort: Put ME at the top if present
        const sortedUsers = [...users].sort((a, b) => {
            if (a.uid === myUid) return -1;
            if (b.uid === myUid) return 1;
            return 0;
        });

        sortedUsers.forEach(u => {
            const isMe = u.uid === myUid;
            const isFollowing = currentUserFollowing.includes(u.uid);
            
            const item = document.createElement('div');
            item.className = `user-item ${isMe ? 'is-me' : ''}`;
            
            // Logic for Buttons
            let actionHtml = '';
            if (isMe) {
                // If it's me, show a "You" badge instead of a button
                actionHtml = `<div class="you-badge">You</div>`;
            } else {
                let btnText = isOwnProfile ? 'Remove' : (isFollowing ? 'Following' : 'Follow');
                let btnClass = isOwnProfile ? 'action-btn remove' : (isFollowing ? 'action-btn following' : 'action-btn');
                
                // Assign ID to button for optimistic updates
                actionHtml = `<button id="btn-${u.uid}" class="${btnClass}" onclick="handleAction('${u.uid}', '${u.username}')">${btnText}</button>`;
            }

            item.innerHTML = `
                <a href="userProfile.html?user=${u.username}" class="user-info">
                    <img src="${u.photoURL || 'https://via.placeholder.com/150'}" class="user-pfp">
                    <div class="name-container">
                        <div class="display-name">
                            ${u.name || u.username} 
                            ${u.verified ? '<img src="https://img.icons8.com/color/48/verified-badge.png" class="v-badge">' : ''}
                        </div>
                        <div class="user-handle">@${u.username}</div>
                    </div>
                </a>
                ${actionHtml}
            `;
            list.appendChild(item);
        });
    }

    // Only updates classes/text, doesn't redraw list (smoothness)
    function updateButtons() {
        if(isOwnProfile) return; // Own profile always uses 'Remove' logic

        const buttons = document.querySelectorAll('.action-btn');
        buttons.forEach(btn => {
            const uid = btn.id.replace('btn-', '');
            if(currentUserFollowing.includes(uid)) {
                btn.innerText = "Following";
                btn.className = "action-btn following";
            } else {
                btn.innerText = "Follow";
                btn.className = "action-btn";
            }
        });
    }

    // --- ACTIONS (Follow/Unfollow/Remove) ---
    async function handleAction(targetUid, username) {
        const myUid = auth.currentUser.uid;
        
        // 1. Prepare Data Objects with Metadata (Date/Time)
        const timestamp = firebase.firestore.Timestamp.now();
        const dateStr = new Date().toISOString();
        
        const myFollowData = { uid: targetUid, timestamp: timestamp, date: dateStr, type: 'following' };
        const theirFollowerData = { uid: myUid, timestamp: timestamp, date: dateStr, type: 'follower' };

        if (isOwnProfile) {
            // REMOVING A FOLLOWER
            if (!confirm(`Remove @${username} from your followers?`)) return;
            
            // UI Optimistic Remove
            const btn = document.getElementById(`btn-${targetUid}`);
            if(btn) btn.closest('.user-item').style.opacity = '0.5';

            await removeFromList(myUid, 'followers', targetUid); // Remove from my followers list
            await removeFromList(targetUid, 'following', myUid); // Remove me from their following list
            
            // Real removal from DOM handled by snapshot or manual reload if needed
            if(btn) btn.closest('.user-item').remove();

        } else {
            // FOLLOW / UNFOLLOW LOGIC
            const isFollowing = currentUserFollowing.includes(targetUid);
            const btn = document.getElementById(`btn-${targetUid}`);

            if (isFollowing) {
                // UNFOLLOW
                btn.innerText = "Follow";
                btn.className = "action-btn"; // Revert style instantly
                
                await removeFromList(myUid, 'following', targetUid);
                await removeFromList(targetUid, 'followers', myUid);
            } else {
                // FOLLOW
                btn.innerText = "Following";
                btn.className = "action-btn following"; // Update style instantly
                
                const batch = db.batch();
                // Store FULL OBJECT for future features
                batch.update(db.collection("users").doc(myUid), {
                    following: firebase.firestore.FieldValue.arrayUnion(myFollowData),
                    followingCount: firebase.firestore.FieldValue.increment(1)
                });
                batch.update(db.collection("users").doc(targetUid), {
                    followers: firebase.firestore.FieldValue.arrayUnion(theirFollowerData),
                    followerCount: firebase.firestore.FieldValue.increment(1)
                });
                
                try { await batch.commit(); } catch (e) { console.error(e); }
            }
        }
    }

    // Helper: Safely remove item from array whether it's stored as String or Object
    async function removeFromList(docUid, field, targetUid) {
        const docRef = db.collection("users").doc(docUid);
        try {
            await db.runTransaction(async (t) => {
                const doc = await t.get(docRef);
                if (!doc.exists) return;
                
                const currentArray = doc.data()[field] || [];
                // Filter out: Check if item is string (==uid) OR if item.uid matches
                const newArray = currentArray.filter(item => {
                    const id = typeof item === 'string' ? item : item.uid;
                    return id !== targetUid;
                });
                
                // Only write if changed to save cost
                if (newArray.length !== currentArray.length) {
                    const countField = field === 'followers' ? 'followerCount' : 'followingCount';
                    t.update(docRef, { 
                        [field]: newArray,
                        [countField]: newArray.length
                    });
                }
            });
        } catch (e) {
            console.error("Remove failed", e);
        }
    }

    function filterList() {
        const val = document.getElementById('follower-search').value.toLowerCase();
        const filtered = allUsersData.filter(u => 
            u.username.toLowerCase().includes(val) || (u.name && u.name.toLowerCase().includes(val))
        );
        renderList(filtered);
    }
</script>

<script src="components/navbar.js" defer></script>
</body>
</html>
