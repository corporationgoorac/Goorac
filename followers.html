<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Followers | Quantum</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg: #000;
            --surface: #0a0a0a;
            --accent: #00d2ff;
            --text: #ffffff;
            --dim: #a8a8a8;
            --border: #262626;
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; padding-top: 110px; padding-bottom: 70px;
        }

        .header {
            position: fixed; top: 0; width: 100%;
            background: var(--bg); border-bottom: 1px solid var(--border);
            z-index: 100; padding-top: env(safe-area-inset-top);
        }

        .header-top { height: 50px; display: flex; align-items: center; padding: 0 15px; }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 15px; }
        .header h1 { font-size: 1rem; font-weight: 600; flex-grow: 1; text-align: center; margin-right: 30px; }

        .search-container { padding: 10px 15px; background: var(--bg); }
        .search-input {
            width: 100%; background: #262626; border: none; border-radius: 10px;
            padding: 8px 12px; color: white; outline: none; font-size: 0.9rem;
        }

        .list-container { padding: 10px 15px; max-width: 600px; margin: 0 auto; }
        .user-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; }
        .user-info { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; }
        .user-pfp { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
        
        .name-container { display: flex; flex-direction: column; }
        .display-name { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 4px; }
        .user-handle { color: var(--dim); font-size: 0.85rem; }

        .action-btn {
            background: #363636; color: white; border: none; padding: 6px 16px;
            border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer;
            min-width: 80px;
        }
        .action-btn.following { background: transparent; border: 1px solid #363636; }
        .action-btn.follow { background: #fff; color: #000; }

        .v-badge {
            width: 14px; height: 14px; background: var(--accent); display: inline-block;
            mask: url('https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg') no-repeat center;
            -webkit-mask: url('https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg') no-repeat center;
        }

        .skeleton-item { display: flex; align-items: center; padding: 12px 0; opacity: 0.6; }
        .skeleton-pfp { width: 48px; height: 48px; border-radius: 50%; background: #222; margin-right: 12px; }
        .skeleton-info { flex: 1; }
        .skeleton-line { height: 10px; background: #222; border-radius: 4px; margin-bottom: 8px; }
        
        .pulse { animation: pulse-bg 1.5s infinite ease-in-out; }
        @keyframes pulse-bg {
            0% { background-color: #111; }
            50% { background-color: #222; }
            100% { background-color: #111; }
        }

        .mutual-lock { text-align: center; padding: 50px 20px; color: var(--dim); }
        #load-more-trigger { height: 20px; width: 100%; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-top">
        <button class="back-btn" onclick="window.history.back()">&#8592;</button>
        <h1 id="header-title">Followers</h1>
    </div>
    <div class="search-container">
        <input type="text" id="follower-search" class="search-input" placeholder="Search followers..." oninput="filterList()">
    </div>
</div>

<div id="content" class="list-container">
    <div id="followers-list">
        <div class="skeleton-item"><div class="skeleton-pfp pulse"></div><div class="skeleton-info"><div class="skeleton-line pulse" style="width:40%"></div><div class="skeleton-line pulse" style="width:25%"></div></div></div>
        <div class="skeleton-item"><div class="skeleton-pfp pulse"></div><div class="skeleton-info"><div class="skeleton-line pulse" style="width:35%"></div><div class="skeleton-line pulse" style="width:20%"></div></div></div>
        <div class="skeleton-item"><div class="skeleton-pfp pulse"></div><div class="skeleton-info"><div class="skeleton-line pulse" style="width:50%"></div><div class="skeleton-line pulse" style="width:30%"></div></div></div>
    </div>
    <div id="load-more-trigger"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const targetUsername = urlParams.get('user');
    
    let allUsersData = [];
    let isOwnProfile = false;
    let currentUserFollowing = [];
    
    // Pagination Variables
    let followerIds = [];
    let lastFetchedIndex = 0;
    const limit = 10;
    let isLoadingMore = false;

    auth.onAuthStateChanged(user => {
        if (user) { 
            db.collection("users").doc(user.uid).onSnapshot(doc => {
                currentUserFollowing = doc.data()?.following || [];
                if (allUsersData.length > 0) renderList(allUsersData);
            });
            initFollowers(user); 
        } else { 
            window.location.href = 'login.html'; 
        }
    });

    async function initFollowers(currentUser) {
        const list = document.getElementById('followers-list');
        try {
            let targetUID = currentUser.uid;
            if (targetUsername) {
                const userQuery = await db.collection("users").where("username", "==", targetUsername).get();
                if (userQuery.empty) {
                    list.innerHTML = "<div class='mutual-lock'>User not found.</div>";
                    return;
                }
                const targetDoc = userQuery.docs[0];
                targetUID = targetDoc.id;
                isOwnProfile = (targetUID === currentUser.uid);
                document.getElementById('header-title').innerText = `@${targetDoc.data().username}'s Followers`;
            } else {
                isOwnProfile = true;
            }

            if (!isOwnProfile) {
                const [me, them] = await Promise.all([
                    db.collection("users").doc(currentUser.uid).get(),
                    db.collection("users").doc(targetUID).get()
                ]);
                const myFollowing = me.data()?.following || [];
                const theirFollowing = them.data()?.following || [];
                if (!myFollowing.includes(targetUID) || !theirFollowing.includes(currentUser.uid)) {
                    document.getElementById('content').innerHTML = `<div class="mutual-lock"><div style="font-size: 3rem; margin-bottom: 10px;">ðŸ”’</div><p>This list is only visible to mutual followers.</p></div>`;
                    return;
                }
            }

            // Get the full list of IDs first (Arrays don't support partial fetching, but IDs are small)
            db.collection("users").doc(targetUID).onSnapshot(async doc => {
                followerIds = doc.data()?.followers || [];
                if (followerIds.length === 0) {
                    list.innerHTML = "<div class='mutual-lock'>No followers yet.</div>";
                    return;
                }
                
                // Initial Load
                allUsersData = [];
                lastFetchedIndex = 0;
                await loadMoreUsers();
            });
        } catch (e) {
            console.error(e);
            list.innerHTML = "<p style='text-align:center; color:red;'>Error syncing data.</p>";
        }
    }

    async function loadMoreUsers() {
        if (isLoadingMore || lastFetchedIndex >= followerIds.length) return;
        isLoadingMore = true;

        const nextBatchIds = followerIds.slice(lastFetchedIndex, lastFetchedIndex + limit);
        
        try {
            const profilePromises = nextBatchIds.map(id => db.collection("users").doc(id).get());
            const snapshots = await Promise.all(profilePromises);
            
            const newUsers = snapshots.filter(p => p.exists).map(p => ({...p.data(), uid: p.id}));
            
            allUsersData = [...allUsersData, ...newUsers];
            lastFetchedIndex += limit;
            
            renderList(allUsersData);
        } catch (e) {
            console.error("Batch load error:", e);
        } finally {
            isLoadingMore = false;
        }
    }

    // Scroll Listener for Pagination
    window.onscroll = () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
            loadMoreUsers();
        }
    };

    function renderList(users) {
        const list = document.getElementById('followers-list');
        list.innerHTML = "";
        const myUid = auth.currentUser.uid;

        users.forEach(u => {
            if (u.uid === myUid) return;
            
            const isFollowing = currentUserFollowing.includes(u.uid);
            const item = document.createElement('div');
            item.className = 'user-item';
            
            let btnText = isOwnProfile ? 'Remove' : (isFollowing ? 'Following' : 'Follow');
            let btnClass = isOwnProfile ? '' : (isFollowing ? 'following' : 'follow');

            item.innerHTML = `
                <a href="userProfile.html?user=${u.username}" class="user-info">
                    <img src="${u.photoURL || 'https://via.placeholder.com/150'}" class="user-pfp">
                    <div class="name-container">
                        <div class="display-name">
                            ${u.name || u.username} 
                            ${u.verified ? '<span class="v-badge"></span>' : ''}
                        </div>
                        <div class="user-handle">@${u.username}</div>
                    </div>
                </a>
                <button class="action-btn ${btnClass}" onclick="handleAction('${u.uid}', '${u.username}', ${isFollowing})">
                    ${btnText}
                </button>
            `;
            list.appendChild(item);
        });
    }

    async function handleAction(uid, username, isFollowingNow) {
        const myUid = auth.currentUser.uid;
        const batch = db.batch();

        if (isOwnProfile) {
            if (!confirm("Remove this follower?")) return;
            batch.update(db.collection("users").doc(myUid), {
                followers: firebase.firestore.FieldValue.arrayRemove(uid),
                followerCount: firebase.firestore.FieldValue.increment(-1)
            });
            batch.update(db.collection("users").doc(uid), {
                following: firebase.firestore.FieldValue.arrayRemove(myUid),
                followingCount: firebase.firestore.FieldValue.increment(-1)
            });
        } else {
            if (isFollowingNow) {
                batch.update(db.collection("users").doc(myUid), {
                    following: firebase.firestore.FieldValue.arrayRemove(uid),
                    followingCount: firebase.firestore.FieldValue.increment(-1)
                });
                batch.update(db.collection("users").doc(uid), {
                    followers: firebase.firestore.FieldValue.arrayRemove(myUid),
                    followerCount: firebase.firestore.FieldValue.increment(-1)
                });
            } else {
                batch.update(db.collection("users").doc(myUid), {
                    following: firebase.firestore.FieldValue.arrayUnion(uid),
                    followingCount: firebase.firestore.FieldValue.increment(1)
                });
                batch.update(db.collection("users").doc(uid), {
                    followers: firebase.firestore.FieldValue.arrayUnion(myUid),
                    followerCount: firebase.firestore.FieldValue.increment(1)
                });
            }
        }
        
        try {
            await batch.commit();
        } catch (err) {
            console.error("Action failed:", err);
        }
    }

    function filterList() {
        const val = document.getElementById('follower-search').value.toLowerCase();
        const filtered = allUsersData.filter(u => 
            u.username.toLowerCase().includes(val) || (u.name && u.name.toLowerCase().includes(val))
        );
        renderList(filtered);
    }
</script>

<script src="components/navbar.js" defer></script>
</body>
</html>