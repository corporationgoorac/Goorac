<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000"> 
    <title>Goorac | Quantum Chat</title>

    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

      // Your web app's Firebase configuration
      export const firebaseConfig = {
          apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
          authDomain: "goorac-c3b59.firebaseapp.com",
          projectId: "goorac-c3b59",
          storageBucket: "goorac-c3b59.firebasestorage.app",
          messagingSenderId: "746746595332",
          appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
          measurementId: "G-M46FEVRYSS"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
    </script>

    <script src="components/emojiPicker.js" defer></script>
    <script src="components/imagePicker.js" defer></script>
    <script src="components/filePicker.js" defer></script>
    <script src="components/viewMedia.js" defer></script>
    <script src="components/call-notifier.js" defer></script>

    <style>
        :root { 
            /* Professional Dark Theme Palette */
            --bg-base: #000000;
            --bg-surface: #121212;
            --bg-elevated: #1e1e1e;
            
            --accent: #0095f6; /* Messenger Blue */
            --accent-gradient: linear-gradient(135deg, #0095f6 0%, #006aff 100%);
            
            --border: #2a2a2a; 
            
            /* Chat Bubble Colors */
            --sent-bg: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%); /* Modern Blue Gradient */
            --received-bg: #262626; 
            
            --text-primary: #ffffff; 
            --text-secondary: #a0a0a0;
            --text-tertiary: #666666;

            --shimmer: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            
            /* Dimensions */
            --header-height: 60px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0; 
            -webkit-touch-callout: none; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        html, body {
            height: 100%; width: 100%;
            overflow: hidden;
            background-color: var(--bg-base);
            position: fixed; left: 0; top: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: var(--text-primary);
        }

        /* --- UTILS --- */
        div, span, p, img, svg { user-select: none; -webkit-user-select: none; }
        input, textarea { user-select: text !important; -webkit-user-select: text !important; outline: none; font-family: inherit; }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes shimmer { 0% { background-position: -200px 0; } 100% { background-position: 200px 0; } }
        @keyframes flashMessage { 0% { background-color: rgba(0, 149, 246, 0.3); transform: scale(1.02); } 100% { background-color: transparent; transform: scale(1); } }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); } 70% { box-shadow: 0 0 0 4px rgba(0, 230, 118, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); } }

        /* --- LAYOUT --- */
        .app-container { 
            display: flex; flex-direction: column; 
            height: 100%; width: 100%; 
            position: absolute; top: 0; left: 0; 
            overflow: hidden;
            background: radial-gradient(circle at 50% 10%, #1a1a1a 0%, #000000 70%);
        }

        /* --- HEADER --- */
        header { 
            position: absolute; top: 0; left: 0; right: 0;
            padding: calc(var(--safe-top) + 10px) 16px 10px;
            height: calc(var(--header-height) + var(--safe-top));
            background: rgba(10, 10, 10, 0.85); 
            border-bottom: 1px solid rgba(255,255,255,0.08); 
            display: flex; align-items: center; gap: 8px; 
            z-index: 2000; 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            transition: background 0.3s;
        }

        .back-btn { 
            font-size: 1.5rem; color: var(--accent); 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            height: 40px; width: 40px; border-radius: 50%;
            transition: background 0.2s;
        }
        .back-btn:active { background: rgba(255,255,255,0.1); }

        .h-profile-group { 
            display: flex; align-items: center; gap: 12px; 
            cursor: pointer; flex: 1; overflow: hidden; 
            padding: 4px; border-radius: 12px;
        }
        .h-profile-group:active { background: rgba(255,255,255,0.05); }
        
        .pfp-container { position: relative; width: 40px; height: 40px; flex-shrink: 0; }
        .h-pfp { 
            width: 100%; height: 100%; border-radius: 50%; 
            object-fit: cover; background: var(--bg-elevated); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .online-dot { 
            position: absolute; bottom: 1px; right: 1px; 
            width: 11px; height: 11px; 
            background: #00e676; border-radius: 50%; 
            border: 2px solid #000; display: none; 
            animation: pulseGreen 2s infinite; 
        }
        
        .h-info { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .h-name-wrapper { display: flex; align-items: center; gap: 4px; }
        .h-name { 
            font-weight: 600; font-size: 1.05rem; 
            color: var(--text-primary); white-space: nowrap; 
            overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.3px;
        }
        .h-username-sub { 
            font-size: 0.8rem; color: var(--text-secondary); 
            font-weight: 400; transition: color 0.3s ease;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .v-badge { width: 14px; height: 14px; display: none; }

        .header-actions { display: flex; align-items: center; gap: 18px; margin-left: auto; }
        .header-icon { 
            width: 24px; height: 24px; cursor: pointer; 
            fill: var(--accent); opacity: 0.9; 
            transition: transform 0.2s, opacity 0.2s; 
        }
        .header-icon:active { opacity: 0.6; transform: scale(0.92); }

        /* --- CHAT AREA --- */
        #chat-flow { 
            flex: 1; overflow-y: auto; overflow-x: hidden; 
            padding: 0; 
            display: flex; flex-direction: column;
            background: transparent; 
            position: relative;
            padding-top: calc(75px + var(--safe-top)); 
            padding-bottom: 20px;
            -ms-overflow-style: none; scrollbar-width: none;
            opacity: 0; transition: opacity 0.3s ease-out;
        }
        #chat-flow::-webkit-scrollbar { display: none; }
        
        #messages-container { 
            display: flex; flex-direction: column; 
            padding: 0 16px; width: 100%; padding-bottom: 10px; 
            min-height: min-content;
        }

        .loading-shimmer { background: var(--shimmer); background-size: 400px 100%; animation: shimmer 1.5s ease-in-out infinite; }

        /* Typing Indicator */
        #typing-indicator-bottom { 
            display: none; margin-left: 56px; margin-bottom: 15px; 
            background: var(--bg-elevated); width: 54px; height: 32px; 
            border-radius: 16px; border-bottom-left-radius: 4px; 
            align-items: center; justify-content: center; gap: 4px; 
            padding: 0 12px; align-self: flex-start; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: slideInUp 0.3s ease;
        }
        .typing-dot { width: 6px; height: 6px; background: #888; border-radius: 50%; animation: typingWave 1.3s linear infinite; }
        .typing-dot:nth-child(2) { animation-delay: -1.1s; }
        .typing-dot:nth-child(3) { animation-delay: -0.9s; }
        @keyframes typingWave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }

        /* Date Dividers */
        .date-divider { 
            text-align: center; margin: 20px 0; 
            font-size: 0.7rem; color: var(--text-secondary); 
            font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;
            background: rgba(40,40,40,0.4); 
            padding: 4px 12px; border-radius: 100px; 
            align-self: center; width: fit-content; 
            backdrop-filter: blur(4px);
            position: sticky; top: 10px; z-index: 10;
        }

        /* --- MESSAGES --- */
        .msg-row { 
            display: flex; width: 100%; margin-bottom: 2px; 
            position: relative; flex-direction: column; 
            animation: slideInUp 0.25s ease-out backwards;
        }
        .msg-row.sent { align-items: flex-end; }
        .msg-row.received { align-items: flex-start; margin-bottom: 6px; }

        .received-inner-row { display: flex; align-items: flex-end; gap: 8px; max-width: 100%; }
        .msg-avatar { 
            width: 28px; height: 28px; border-radius: 50%; 
            object-fit: cover; flex-shrink: 0; margin-bottom: 4px; 
            background: var(--bg-elevated); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .msg-bubble-box { 
            position: relative; max-width: 75%; 
            display: flex; flex-direction: column; 
        }
        .sent .msg-bubble-box { align-items: flex-end; }
        .received .msg-bubble-box { align-items: flex-start; }

        .bubble { 
            padding: 10px 16px; 
            border-radius: 20px; 
            font-size: 0.98rem; line-height: 1.4; 
            position: relative; word-wrap: break-word; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            transform-origin: bottom center;
        }
        .sent .bubble { 
            background: var(--sent-bg); color: #fff; 
            border-bottom-right-radius: 4px; 
        }
        .received .bubble { 
            background: var(--received-bg); color: #fff; 
            border-bottom-left-radius: 4px; 
        }
        
        .bubble a { color: #fff; text-decoration: underline; font-weight: 500; cursor: pointer; }

        .sliding-timestamp { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            font-size: 0.65rem; color: var(--text-tertiary); 
            font-weight: 500; opacity: 0; transition: opacity 0.2s;
            pointer-events: none;
        }
        .sent .sliding-timestamp { left: -50px; }
        .received .sliding-timestamp { right: -50px; }
        .msg-row:hover .sliding-timestamp { opacity: 1; }

        /* Reaction Badge */
        .reaction-badge { 
            position: absolute; bottom: -10px;
            background: #2a2a2a; border: 2px solid #000; 
            border-radius: 12px; padding: 2px 5px; 
            font-size: 0.8rem; z-index: 5; 
            display: none; cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .reaction-badge:active { transform: scale(1.2); }
        .sent .reaction-badge { right: 0; }
        .received .reaction-badge { left: 0; }

        .seen-status { 
            font-size: 0.65rem; color: var(--text-tertiary); 
            margin-top: 2px; margin-right: 2px; text-align: right; 
            font-weight: 500; height: 12px; opacity: 0; 
            animation: fadeIn 0.3s forwards; 
        }

        /* Reply Preview */
        .reply-box-ui { 
            background: rgba(0, 0, 0, 0.2); 
            padding: 8px 12px; border-radius: 12px; 
            margin-bottom: 4px; font-size: 0.8rem; 
            border-left: 3px solid rgba(255, 255, 255, 0.4); 
            color: #ccc; max-width: 100%; cursor: pointer; 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        /* Media */
        .msg-media-wrapper { 
            position: relative; margin-bottom: 2px; cursor: pointer; 
            border-radius: 18px; overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .chat-media-img { 
            display: block; width: 100%; max-width: 280px; max-height: 350px; 
            object-fit: cover; border-radius: 18px; 
            transition: opacity 0.3s;
        }
        
        /* Audio Player Styling */
        .msg-audio-pill {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px; background: var(--bg-elevated);
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            min-width: 200px; margin-bottom: 4px;
        }
        .audio-control-btn {
            width: 32px; height: 32px; background: var(--accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; cursor: pointer; color: white;
            box-shadow: 0 2px 8px rgba(0,149,246,0.4);
        }
        .audio-wave-container {
            flex: 1; display: flex; align-items: center; gap: 2px; 
            height: 16px; overflow: hidden; position: relative;
        }
        .wave-bar {
            width: 3px; background: #555; border-radius: 2px; height: 100%;
            transition: height 0.1s, background 0.2s;
        }
        .audio-playing .wave-bar { background: var(--accent); animation: waveAnim 0.8s ease-in-out infinite; }
        @keyframes waveAnim { 0% { height: 30%; } 50% { height: 100%; } 100% { height: 30%; } }

        /* --- INPUT AREA --- */
        .input-area-container { 
            background: rgba(18, 18, 18, 0.95);
            border-top: 1px solid rgba(255,255,255,0.08); 
            padding-bottom: var(--safe-bottom); 
            flex-shrink: 0; width: 100%; z-index: 1000; 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .input-area { padding: 10px 12px; display: flex; align-items: flex-end; gap: 8px; }
        
        .plus-btn { 
            font-size: 24px; color: var(--accent); cursor: pointer; 
            height: 38px; width: 38px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: rgba(255,255,255,0.05);
            transition: transform 0.2s, background 0.2s; 
        }
        .plus-btn:active { transform: rotate(45deg); background: rgba(255,255,255,0.1); }

        .input-box { 
            flex: 1; background: #262626; 
            border-radius: 24px; padding: 6px 16px; 
            display: flex; align-items: center; min-height: 40px; 
            border: 1px solid transparent; transition: border 0.2s;
        }
        .input-box:focus-within { border-color: #444; background: #2a2a2a; }

        .msg-input { 
            width: 100%; background: transparent; border: none; 
            color: white; padding: 8px 0; font-size: 1rem; 
            resize: none; max-height: 100px; overflow-y: auto; 
            line-height: 1.4; 
        }
        .msg-input::placeholder { color: #777; }

        .send-btn { 
            background: transparent; border: none; 
            color: var(--text-tertiary); font-weight: 600; font-size: 1rem; 
            padding: 0 10px; height: 38px; display: flex; align-items: center; 
            transition: color 0.2s ease, transform 0.1s; 
            pointer-events: none;
        }
        .send-btn.active { 
            color: var(--accent); cursor: pointer; pointer-events: auto; 
        }
        .send-btn.active:active { transform: scale(0.95); }

        /* --- MENUS & OVERLAYS --- */
        #attachment-menu {
            display: none; position: absolute; bottom: 80px; left: 16px;
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(15px);
            border-radius: 16px; padding: 8px; z-index: 1001;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            animation: slideInUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            flex-direction: column; width: 180px;
        }
        .attach-opt { 
            display: flex; align-items: center; gap: 12px; 
            padding: 12px; border-radius: 10px; cursor: pointer; 
            color: white; font-size: 0.95rem; font-weight: 500; 
            transition: background 0.2s;
        }
        .attach-opt:active { background: rgba(255,255,255,0.1); }
        .attach-opt svg { width: 20px; height: 20px; fill: var(--text-secondary); }

        #scroll-down-btn { 
            position: fixed; bottom: 90px; right: 20px; 
            width: 40px; height: 40px; background: #262626; 
            border-radius: 50%; display: none; align-items: center; justify-content: center; 
            color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            border: 1px solid #333; z-index: 900; cursor: pointer; 
            font-size: 1.2rem; transition: all 0.3s ease; 
        }
        #scroll-down-btn.new-msg { background: var(--accent); color: #fff; transform: scale(1.1); }

        #reply-dock { 
            display: none; background: #1a1a1a; 
            padding: 10px 16px; border-top: 1px solid #333; 
            justify-content: space-between; align-items: center; 
            animation: slideInUp 0.2s;
        }

        /* --- MODALS (Menus, Reactions) --- */
        #menu-overlay, #reaction-details-overlay { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0, 0, 0, 0.6); z-index: 2500; 
            justify-content: center; align-items: center; 
            backdrop-filter: blur(4px);
        }
        .menu-card { 
            background: #1e1e1e; border-radius: 18px; 
            width: 260px; overflow: hidden; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.6); 
            border: 1px solid rgba(255,255,255,0.05);
            animation: scaleIn 0.2s ease;
        }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .reaction-bar { display: flex; justify-content: space-between; padding: 16px 16px; background: #252525; }
        .reaction-bar span { font-size: 1.8rem; cursor: pointer; transition: transform 0.1s; }
        .reaction-bar span:active { transform: scale(1.3); }

        .menu-opt { 
            padding: 14px 16px; text-align: left; font-size: 1rem; 
            border-top: 1px solid rgba(255,255,255,0.05); 
            color: var(--text-primary); active: background: #2a2a2a; 
        }
        .menu-opt:first-of-type { border-top: none; }
        .menu-opt:active { background: rgba(255,255,255,0.05); }

    </style>
</head>
<body>

<call-notifier></call-notifier>
<image-picker id="img-picker"></image-picker>
<file-picker id="file-picker"></file-picker>
<view-media id="media-viewer"></view-media>

<div id="heart-overlay" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0); font-size:80px; pointer-events:none; z-index:3000;">‚ù§Ô∏è</div>

<div id="scroll-down-btn" onclick="scrollToBottom()">‚¨á</div>

<div id="reaction-details-overlay" onclick="closeReactionDetails()">
    <div class="menu-card" style="width: 85%; max-width: 320px; max-height: 50vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
        <div style="padding: 14px; text-align: center; font-weight: 600; border-bottom: 1px solid #333;">Reactions</div>
        <div id="react-list-items" style="overflow-y: auto; flex: 1;"></div>
        <div onclick="closeReactionDetails()" style="padding: 12px; text-align: center; border-top: 1px solid #333; color: #888;">Close</div>
    </div>
</div>

<div id="reaction-picker-modal" onclick="closeReactionPicker()" style="display:none; position:fixed; inset:0; z-index:3000; background:rgba(0,0,0,0.5); backdrop-filter:blur(2px); align-items:flex-end;">
    <div class="picker-modal-content" onclick="event.stopPropagation()" style="width:100%; height:55vh; background:#1c1c1c; border-radius:20px 20px 0 0; display:flex; flex-direction:column; animation:slideInUp 0.3s;">
        <div style="padding:10px 0; display:flex; justify-content:center;"><div style="width:40px; height:5px; background:#444; border-radius:10px;"></div></div>
        <div id="reaction-picker-container" style="flex:1; overflow:hidden;"></div>
    </div>
</div>

<div id="menu-overlay" onclick="closeMenu()">
    <div class="menu-card" id="main-menu-card" onclick="event.stopPropagation()">
        <div class="reaction-bar">
            <span onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="applyReaction('üòÇ')">üòÇ</span>
            <span onclick="applyReaction('üòÆ')">üòÆ</span>
            <span onclick="applyReaction('üò¢')">üò¢</span>
            <span onclick="applyReaction('üëç')">üëç</span>
            <div onclick="expandEmojiMenu()" style="background:#333; border-radius:50%; width:34px; height:34px; display:flex; align-items:center; justify-content:center; font-size:18px;">+</div>
        </div>
        <div class="menu-opt" onclick="copyMessageText()">Copy Text</div>
        <div class="menu-opt" onclick="initReplyFromActive()">Reply</div>
        <div id="edit-btn" class="menu-opt" onclick="initEdit()">Edit</div>
        <div id="unsend-btn" class="menu-opt" style="color:#ff3b30;" onclick="unsendMsg()">Unsend</div>
    </div>
</div>

<div class="app-container" id="main-app">
    <header id="chat-header">
        <div class="back-btn" onclick="history.back()">‚Äπ</div>
        <div class="h-profile-group" onclick="goToProfile()">
            <div class="pfp-container">
                <img id="h-pfp" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="h-pfp loading-shimmer">
                <div class="online-dot" id="h-online-dot"></div>
            </div>
            <div class="h-info">
                <div class="h-name-wrapper">
                    <div class="h-name" id="h-display-name"></div>
                    <img id="v-badge" src="https://img.icons8.com/color/48/verified-badge.png" class="v-badge">
                </div>
                <div class="h-username-sub" id="h-username-label"></div>
            </div>
        </div>
        <div class="header-actions">
            <svg class="header-icon" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 0 0-1.01.24l-1.57 1.97c-2.83-1.44-5.15-3.75-6.59-6.59l1.97-1.57c.22-.22.3-.54.24-1.01a11.36 11.36 0 0 1-.56-3.53c0-.55-.45-1-1-1H4.39c-.55 0-1 .45-1 1c0 9.39 7.61 17 17 17c.55 0 1-.45 1-1v-3.56c0-.55-.45-1-1-1z"/></svg>
            <svg class="header-icon" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
        </div>
    </header>

    <div id="chat-flow">
        <div id="scroll-trigger"></div>
        <div id="messages-container"></div>
        <div id="typing-indicator-bottom">
            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
        </div>
    </div>

    <div class="input-area-container">
        
        <div id="reply-dock">
            <div id="reply-text" style="color:#aaa; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:90%;"></div>
            <div onclick="cancelInteraction()" style="color:#fff; padding:5px; cursor:pointer;">‚úï</div>
        </div>

        <div id="emoji-tray" style="display:none; height:280px; border-top:1px solid #333;">
             <emoji-picker id="main-picker" style="width:100%; height:100%;"></emoji-picker>
        </div>

        <div id="attachment-menu">
            <div class="attach-opt" onclick="openCameraPicker()">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <span>Camera / Gallery</span>
            </div>
            <div class="attach-opt" onclick="openFilePicker()">
                <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                <span>File / Video / Audio</span>
            </div>
            <div class="attach-opt" onclick="toggleEmojiTray()">
                <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
                <span>Emoji</span>
            </div>
        </div>

        <div class="input-area">
            <div class="plus-btn" onclick="toggleAttachmentMenu()">+</div>
            <div class="input-box" id="msg-input-box">
                <textarea id="m-input" class="msg-input" placeholder="Message..." rows="1"></textarea>
            </div>
            <button id="send-btn" class="send-btn">Send</button>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE INIT ---
    let fbConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        measurementId: "G-M46FEVRYSS",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };

    if (typeof CONFIG !== 'undefined' && CONFIG.firebase) fbConfig = CONFIG.firebase;
    if (!firebase.apps.length) firebase.initializeApp(fbConfig);

    const db = firebase.firestore();
    const rdb = firebase.database();
    const auth = firebase.auth();

    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');
    
    // Core State
    let myUid, targetUid, chatId, replyingTo = null, editModeId = null;
    let activeMenuId = null, unsubscribe = null, isLoadingMore = false;
    let lastVisible = null; 
    let messagesMap = new Map(); 
    let chatTargetData = null; 
    let myUserData = null;
    let isFirstLoad = true;
    let statusTimeout = null, lastStatusData = null;
    let isFirstStatusLoad = true;

    // DOM Elements
    const mInput = document.getElementById('m-input');
    const inputBox = document.getElementById('msg-input-box');
    const chatFlow = document.getElementById('chat-flow');
    const container = document.getElementById('messages-container');
    const bottomTyping = document.getElementById('typing-indicator-bottom');
    const emojiTray = document.getElementById('emoji-tray');
    const scrollBtn = document.getElementById('scroll-down-btn');
    const sendBtnUI = document.getElementById('send-btn');
    const onlineDot = document.getElementById('h-online-dot');
    const headerSubLabel = document.getElementById('h-username-label');
    const attachmentMenu = document.getElementById('attachment-menu');
    const mainPicker = document.getElementById('main-picker');
    const imagePickerComponent = document.getElementById('img-picker');
    const filePickerComponent = document.getElementById('file-picker');

    // Sounds
    const popSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"); 
    const likeSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"); 

    // --- LOCAL STORAGE HELPERS (PERSISTENCE) ---
    function saveToLocal() {
        if (!chatId) return;
        const key = `chat_cache_${chatId}`;
        const dataToSave = Array.from(messagesMap.entries()).map(([id, data]) => {
            // Convert Timestamp to ISO string for JSON storage
            let safeData = { ...data };
            if (safeData.timestamp && safeData.timestamp.toDate) {
                safeData.timestamp = safeData.timestamp.toDate().toISOString();
            }
            if (safeData.seenAt && safeData.seenAt.toDate) {
                safeData.seenAt = safeData.seenAt.toDate().toISOString();
            }
            // Sanitize reactions timestamps
            if (safeData.reactions) {
                // Keep as is, JS objects are fine
            }
            return [id, safeData];
        });
        localStorage.setItem(key, JSON.stringify(dataToSave));
        
        // Save target data
        if(chatTargetData) localStorage.setItem(`user_cache_${targetUsername}`, JSON.stringify(chatTargetData));
    }

    function loadFromLocal() {
        if (!chatId) return;
        
        // Load User Data First
        const cachedUser = localStorage.getItem(`user_cache_${targetUsername}`);
        if(cachedUser) {
            chatTargetData = JSON.parse(cachedUser);
            updateHeaderUI();
        }

        const key = `chat_cache_${chatId}`;
        const cached = localStorage.getItem(key);
        if (cached) {
            try {
                const parsed = JSON.parse(cached);
                messagesMap = new Map();
                parsed.forEach(([id, data]) => {
                    // Reconstruct objects from JSON
                    // We mock the Firestore Timestamp object so render functions work
                    if (data.timestamp) {
                        const dateObj = new Date(data.timestamp);
                        data.timestamp = { toDate: () => dateObj, toMillis: () => dateObj.getTime() };
                    }
                    if (data.seenAt) {
                        const dateObj = new Date(data.seenAt);
                        data.seenAt = { toDate: () => dateObj, toMillis: () => dateObj.getTime() };
                    }
                    messagesMap.set(id, data);
                });
                renderAll();
                setTimeout(() => { 
                    chatFlow.scrollTop = chatFlow.scrollHeight; 
                    chatFlow.style.opacity = '1';
                }, 10);
            } catch (e) {
                console.error("Cache load error", e);
            }
        }
    }

    // --- UI LOGIC ---
    document.addEventListener('dblclick', (e) => {
        if (e.target.id === 'chat-flow' || e.target.id === 'messages-container') {
            scrollToBottom();
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('#attachment-menu') && !e.target.closest('.plus-btn')) {
            attachmentMenu.style.display = 'none';
        }
    });

    const handleSendClick = (e) => { e.preventDefault(); sendMsg(); };
    sendBtnUI.addEventListener('mousedown', handleSendClick);
    sendBtnUI.addEventListener('touchstart', handleSendClick);

    function formatTime12(date) {
        let hours = date.getHours();
        let minutes = date.getMinutes();
        let ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12; hours = hours ? hours : 12;
        minutes = minutes < 10 ? '0'+minutes : minutes;
        return hours + ':' + minutes + ' ' + ampm;
    }

    function timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "y ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "mo ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "d ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "h ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "m ago";
        return "Just now";
    }

    function getDateDivider(date) {
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        if (date.toDateString() === today.toDateString()) return "Today";
        if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    mInput.addEventListener('input', function() {
        this.style.height = 'auto'; 
        this.style.height = (this.scrollHeight) + 'px';
        if(this.value.trim().length > 0) sendBtnUI.classList.add('active');
        else sendBtnUI.classList.remove('active');
        
        rdb.ref(`typing/${chatId}/${myUid}`).set(this.value.trim().length > 0);
        if(chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight < 100) scrollToBottom();
    });

    chatFlow.addEventListener('scroll', () => {
        const diff = chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight;
        if (diff > 300) scrollBtn.style.display = 'flex';
        else { scrollBtn.style.display = 'none'; scrollBtn.classList.remove('new-msg'); }
    });

    if(mainPicker) {
        mainPicker.addEventListener('emoji-click', event => {
            const emoji = event.detail.emoji || event.detail.unicode; 
            mInput.value += emoji; mInput.focus();
            mInput.dispatchEvent(new Event('input'));
        });
    }

    if (imagePickerComponent) {
        imagePickerComponent.addEventListener('image-uploaded', (e) => {
            if (e.detail.url) sendImageMessage(e.detail.url);
        });
    }

    if (filePickerComponent) {
        filePickerComponent.addEventListener('file-uploaded', (e) => {
            if (e.detail.url) sendFileMessage(e.detail.url, e.detail.metadata);
        });
    }

    function toggleAttachmentMenu() {
        if (attachmentMenu.style.display === 'flex') attachmentMenu.style.display = 'none';
        else { emojiTray.style.display = 'none'; attachmentMenu.style.display = 'flex'; }
    }

    function openCameraPicker() { attachmentMenu.style.display = 'none'; imagePickerComponent.openPicker(); }
    function openFilePicker() { attachmentMenu.style.display = 'none'; filePickerComponent.openPicker(); }
    function toggleEmojiTray() {
        attachmentMenu.style.display = 'none';
        emojiTray.style.display = (emojiTray.style.display === 'block') ? 'none' : 'block';
        scrollToBottom();
    }

    function expandEmojiMenu() {
        closeMenu();
        const reactionModal = document.getElementById('reaction-picker-modal');
        const container = document.getElementById('reaction-picker-container');
        container.innerHTML = ''; 
        const reactionPicker = document.createElement('emoji-picker');
        reactionPicker.style.width = "100%"; reactionPicker.style.height = "100%";
        reactionPicker.addEventListener('emoji-click', event => {
             applyReaction(event.detail.emoji || event.detail.unicode);
             closeReactionPicker();
        });
        container.appendChild(reactionPicker);
        reactionModal.style.display = 'flex';
    }
    function closeReactionPicker() { document.getElementById('reaction-picker-modal').style.display = 'none'; }

    function vibrate(ms = 10) { if (navigator.vibrate) navigator.vibrate(ms); }
    function goToProfile() { if(targetUsername) window.location.href = `userProfile.html?user=${targetUsername}`; }
    mInput.addEventListener("focus", () => { emojiTray.style.display = 'none'; attachmentMenu.style.display = 'none'; });

    // --- REALTIME PRESENCE ---
    function setupMyPresence() {
        const ref = rdb.ref('/status/' + myUid);
        rdb.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() == false) return;
            ref.onDisconnect().set({ state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP })
               .then(() => ref.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP }));
        });
    }

    function updateHeaderStatus() {
        if (!lastStatusData) return;
        const isTyping = bottomTyping.style.display === 'flex';
        if (isTyping) return; 

        if (lastStatusData.state === 'online') {
            onlineDot.style.display = 'block';
            headerSubLabel.innerText = "Active now";
            headerSubLabel.style.color = "#00e676";
        } else {
            onlineDot.style.display = 'none';
            headerSubLabel.innerText = formatActiveTime(lastStatusData.last_changed);
            headerSubLabel.style.color = "var(--text-secondary)";
        }
    }
    
    function formatActiveTime(timestamp) {
        if (!timestamp) return "";
        const diff = Date.now() - timestamp;
        if (diff < 60000) return "Active now";
        return "Active " + timeAgo(new Date(timestamp));
    }

    function monitorTargetStatus() {
        if (!targetUid) return;
        setInterval(() => { if (!isFirstStatusLoad) updateHeaderStatus(); }, 60000);
        rdb.ref('/status/' + targetUid).on('value', (snapshot) => {
            lastStatusData = snapshot.val();
            if (!lastStatusData) {
               headerSubLabel.innerText = `@${chatTargetData.username}`;
               return;
            }
            if (isFirstStatusLoad) {
                headerSubLabel.innerText = `@${chatTargetData.username}`;
                onlineDot.style.display = 'none';
                statusTimeout = setTimeout(() => { isFirstStatusLoad = false; updateHeaderStatus(); }, 3000);
            } else {
                if(bottomTyping.style.display !== 'flex') setTimeout(updateHeaderStatus, 500);
            }
        });
    }

    // --- AUTH & INIT ---
    auth.onAuthStateChanged(user => {
        if (user) { 
            myUid = user.uid; 
            db.collection('users').doc(myUid).get().then(doc => { if (doc.exists) myUserData = doc.data(); });
            setupMyPresence();
            initChat(); 
        }
        else { window.location.href = 'login.html'; }
    });

    async function initChat() {
        if(!targetUsername) return;
        
        // 1. Resolve Target UID (Network check required unless cached mapping exists)
        // For simplicity, we query Firestore but you could cache username->uid too.
        const snap = await db.collection("users").where("username", "==", targetUsername).get();
        if (snap.empty) return;
        
        targetUid = snap.docs[0].id;
        chatTargetData = snap.docs[0].data();
        chatId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
        
        // 2. Load from Cache & Render Immediately
        loadFromLocal();
        updateHeaderUI();

        // 3. Mark Seen
        db.collection("chats").doc(chatId).update({ [`unreadCount.${myUid}`]: 0, seen: true }).catch(e => {});

        // 4. Listeners
        monitorTargetStatus();
        rdb.ref(`typing/${chatId}/${targetUid}`).on('value', (s) => {
            const isTyping = s.val();
            bottomTyping.style.display = isTyping ? 'flex' : 'none';
            if(isTyping) {
                if (statusTimeout) clearTimeout(statusTimeout);
                headerSubLabel.innerText = "Typing..."; headerSubLabel.style.color = "#00e676";
                scrollToBottom();
            } else updateHeaderStatus();
        });

        startListener(); 
        setupObserver();
        
        // Visual viewport resize handling
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                document.getElementById('main-app').style.height = window.visualViewport.height + 'px';
                scrollToBottom();
            });
        }
    }

    function updateHeaderUI() {
        if(!chatTargetData) return;
        const pfp = document.getElementById('h-pfp');
        pfp.classList.remove('loading-shimmer');
        pfp.src = chatTargetData.photoURL || 'https://via.placeholder.com/150';
        document.getElementById('h-display-name').innerText = chatTargetData.name || chatTargetData.username;
        document.getElementById('h-username-label').innerText = `@${chatTargetData.username}`;
        if(chatTargetData.verified) document.getElementById('v-badge').style.display = 'block';
    }

    function setupObserver() {
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isLoadingMore && lastVisible) loadMoreMessages();
        }, { root: chatFlow, threshold: 0.5 });
        observer.observe(document.getElementById('scroll-trigger'));
    }

    function startListener() {
        if (unsubscribe) unsubscribe();
        unsubscribe = db.collection("chats").doc(chatId).collection("messages")
            .orderBy("timestamp", "desc").limit(20)
            .onSnapshot(snapshot => {
                if (snapshot.empty) return;
                if (!lastVisible) lastVisible = snapshot.docs[snapshot.docs.length - 1];
                let isNewIncoming = false;

                snapshot.docChanges().forEach(change => {
                    const msgData = change.doc.data();
                    const msgId = change.doc.id;
                    if (change.type === "added") {
                        messagesMap.set(msgId, msgData);
                        if(msgData.sender !== myUid) isNewIncoming = true;
                    } else if (change.type === "modified") {
                        messagesMap.set(msgId, msgData);
                    } else if (change.type === "removed") {
                        messagesMap.delete(msgId);
                    }
                    if(msgData.sender !== myUid && !msgData.seen) {
                        db.collection("chats").doc(chatId).collection("messages").doc(msgId).update({ seen: true, seenAt: firebase.firestore.FieldValue.serverTimestamp() });
                    }
                });

                saveToLocal(); // PERSIST TO LOCAL STORAGE ON EVERY UPDATE
                renderAll();

                if(isNewIncoming) { 
                    vibrate(20);
                    if(chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight > 250) scrollBtn.classList.add('new-msg');
                    else scrollToBottom();
                }

                if (isFirstLoad) {
                    chatFlow.scrollTop = chatFlow.scrollHeight;
                    setTimeout(() => { chatFlow.style.opacity = '1'; isFirstLoad = false; }, 50);
                }
            });
    }

    async function loadMoreMessages() {
        if (isLoadingMore || !lastVisible) return;
        isLoadingMore = true;
        const oldScrollHeight = chatFlow.scrollHeight;
        
        const snapshot = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("timestamp", "desc").startAfter(lastVisible).limit(15).get();

        if (!snapshot.empty) {
            snapshot.forEach(doc => { messagesMap.set(doc.id, doc.data()); });
            lastVisible = snapshot.docs[snapshot.docs.length - 1];
            
            saveToLocal(); // Update Cache
            renderAll();
            
            chatFlow.scrollTop = chatFlow.scrollHeight - oldScrollHeight;
            isLoadingMore = false;
        } else {
            isLoadingMore = false; lastVisible = null; 
        }
    }

    // --- RENDER LOGIC ---
    function renderAll() {
        container.innerHTML = '';
        const sorted = Array.from(messagesMap.entries())
            .filter(([id, data]) => data.timestamp) 
            .sort((a, b) => {
                // Handle both FireStore Timestamp and our Mock Object from Cache
                const tA = a[1].timestamp.toMillis ? a[1].timestamp.toMillis() : new Date(a[1].timestamp).getTime();
                const tB = b[1].timestamp.toMillis ? b[1].timestamp.toMillis() : new Date(b[1].timestamp).getTime();
                return tA - tB;
            });

        let lastDateLabel = "";
        let lastSeenMsgId = null;

        // Find last seen message
        for (let i = sorted.length - 1; i >= 0; i--) {
            const [id, data] = sorted[i];
            if (data.sender === myUid && data.seen === true) { lastSeenMsgId = id; break; }
        }

        sorted.forEach(([id, data], index) => { 
            // Robust Date extraction
            const msgDate = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
            const dateLabel = getDateDivider(msgDate);
            
            if (dateLabel !== lastDateLabel) {
                const div = document.createElement('div');
                div.className = "date-divider";
                div.innerText = dateLabel;
                container.appendChild(div);
                lastDateLabel = dateLabel;
            }

            let isLastInGroup = true;
            if (index + 1 < sorted.length) {
                if (sorted[index + 1][1].sender === data.sender) isLastInGroup = false;
            }

            renderMessage(data, id, id === lastSeenMsgId, isLastInGroup); 
        });
    }

    function renderMessage(m, id, isLastSeen, isLastInGroup) {
        const side = m.sender === myUid ? 'sent' : 'received';
        const date = m.timestamp.toDate ? m.timestamp.toDate() : new Date(m.timestamp);

        const rowDiv = document.createElement('div');
        rowDiv.id = id;
        rowDiv.className = `msg-row ${side}`;
        
        let reactionsList = [];
        if (m.reactions) reactionsList = Object.values(m.reactions);
        const reactionDisplay = reactionsList.map(r => r.emoji).join(' ');
        
        const boxStyle = reactionDisplay ? 'style="margin-bottom: 18px"' : '';
        const replyHtml = m.replyTo ? `<div class="reply-box-ui" onclick="event.stopPropagation(); scrollToAndFlash('${m.replyTo}')">‚§¥ ${m.replyTo}</div>` : '';

        // --- MEDIA TYPES ---
        let mediaHtml = '';
        let bubbleClass = 'bubble';
        let bubbleStyle = '';

        if (m.imageUrl) {
            mediaHtml = `
            <div class="msg-media-wrapper" onclick="document.getElementById('media-viewer').open('${m.imageUrl}')">
                <img src="${m.imageUrl}" class="chat-media-img">
                <div id="react-${id}" class="reaction-badge" onclick="showReactionDetails('${id}', event)" style="${reactionDisplay ? 'display:block' : ''}">${reactionDisplay}</div>
            </div>`;
            bubbleClass = "bubble has-media";
            if(!m.text) bubbleStyle = "display:none;";
        } 
        else if (m.fileUrl && m.fileMeta && m.fileMeta.type.includes('audio')) {
            const safeId = 'audio-' + id;
            mediaHtml = `
            <div class="msg-audio-pill" id="pill-${safeId}">
                <div class="audio-control-btn" onclick="event.stopPropagation(); toggleAudio('${safeId}')">
                    <svg id="icon-${safeId}" viewBox="0 0 24 24" style="width:16px; fill:#fff;"><path d="M8 5v14l11-7z"/></svg>
                </div>
                <div class="audio-wave-container" id="wave-${safeId}">
                    ${Array(12).fill('<div class="wave-bar"></div>').join('')}
                </div>
                <audio id="${safeId}" src="${m.fileUrl}" ontimeupdate="updateAudioUI('${safeId}')" onended="resetAudioUI('${safeId}')"></audio>
                <div id="react-${id}" class="reaction-badge" style="bottom:-8px; right:5px; ${reactionDisplay ? 'display:block' : ''}" onclick="showReactionDetails('${id}', event)">${reactionDisplay}</div>
            </div>`;
            bubbleClass = "bubble has-media"; 
            if(!m.text) bubbleStyle = "display:none;";
        }
        else if (m.fileUrl) {
             // Generic File / Video
             let icon = "üìÑ";
             if(m.fileMeta && m.fileMeta.type.includes('video')) icon = "üé•";
             mediaHtml = `
            <div class="msg-audio-pill" onclick="window.open('${m.fileUrl}', '_blank')" style="cursor:pointer">
                <div style="font-size:24px;">${icon}</div>
                <div style="display:flex; flex-direction:column; overflow:hidden;">
                    <div style="font-size:0.9rem; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:140px;">${m.fileMeta.name || 'Attachment'}</div>
                    <div style="font-size:0.75rem; color:#888;">${(m.fileMeta.size/(1024*1024)).toFixed(1)} MB</div>
                </div>
                <div id="react-${id}" class="reaction-badge" style="bottom:-8px; right:5px; ${reactionDisplay ? 'display:block' : ''}" onclick="showReactionDetails('${id}', event)">${reactionDisplay}</div>
            </div>`;
            bubbleClass = "bubble has-media";
            if(!m.text) bubbleStyle = "display:none;";
        }

        // --- CONTENT ASSEMBLY ---
        const safeText = m.text ? linkify(m.text) : "";
        let innerHTML = '';
        
        const contentHTML = `
            ${replyHtml}
            ${mediaHtml}
            <div class="${bubbleClass}" id="bubble-${id}" style="${bubbleStyle}">
                <span id="text-${id}">${safeText} ${m.edited ? '<small style="opacity:0.5; font-size:0.7em">(edited)</small>' : ''}</span>
                ${(!m.imageUrl && !m.fileUrl) ? `<div id="react-${id}" class="reaction-badge" onclick="showReactionDetails('${id}', event)" style="${reactionDisplay ? 'display:block' : ''}">${reactionDisplay}</div>` : ''}
            </div>
        `;

        if (side === 'received') {
            const pfpUrl = chatTargetData ? chatTargetData.photoURL : 'https://via.placeholder.com/30';
            const visibility = isLastInGroup ? 'visible' : 'hidden';
            innerHTML = `
                <div class="received-inner-row">
                    <img src="${pfpUrl}" class="msg-avatar" style="visibility: ${visibility}">
                    <div class="msg-bubble-box" ${boxStyle}>${contentHTML}</div>
                </div>`;
        } else {
            innerHTML = `<div class="msg-bubble-box" ${boxStyle}>${contentHTML}</div>`;
        }

        let seenText = "";
        if (isLastSeen && side === 'sent') {
            // Handle both real timestamp and cache object
            const sTime = m.seenAt ? (m.seenAt.toDate ? m.seenAt.toDate() : new Date(m.seenAt)) : null;
            seenText = sTime ? "Seen " + timeAgo(sTime) : "Seen";
        }

        rowDiv.innerHTML = `
            ${innerHTML}
            ${seenText ? `<div class="seen-status">${seenText}</div>` : ''}
            <div class="sliding-timestamp">${formatTime12(date)}</div>
        `;
        container.appendChild(rowDiv);

        // Listeners
        const bubbleEl = rowDiv.querySelector(`#bubble-${id}`);
        if(bubbleEl && bubbleEl.style.display !== 'none') attachMessageListeners(bubbleEl, id, m);
        if(m.imageUrl || m.fileUrl) {
             const mediaEl = rowDiv.querySelector('.msg-media-wrapper') || rowDiv.querySelector('.msg-audio-pill');
             if(mediaEl) attachMessageListeners(mediaEl, id, m);
        }
    }

    // --- FUNCTIONALITY (Linkify, Scroll, Audio) ---
    function linkify(text) {
        if (!text) return "";
        return text.replace(/(https?:\/\/[^\s]+)/g, url => `<a onclick="event.stopPropagation(); window.open('${url}', '_blank')">${url}</a>`);
    }

    function scrollToAndFlash(textSnippet) {
        const bubbles = document.querySelectorAll('.bubble span');
        let targetId = null;
        for(let span of bubbles) {
            if(span.innerText.includes(textSnippet)) { targetId = span.id.replace('text-', ''); break; }
        }
        if(targetId) {
            const el = document.getElementById(targetId);
            if(el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const bubble = el.querySelector('.bubble') || el.closest('.bubble');
                if(bubble) {
                    bubble.style.animation = 'none'; bubble.offsetHeight; bubble.style.animation = 'flashMessage 1s ease';
                }
            }
        }
    }

    window.toggleAudio = function(id) {
        const audio = document.getElementById(id);
        const icon = document.getElementById('icon-' + id);
        const wave = document.getElementById('wave-' + id);
        
        document.querySelectorAll('audio').forEach(a => { if(a.id !== id) { a.pause(); resetAudioUI(a.id); }});

        if (audio.paused) {
            audio.play().catch(e => console.log(e));
            icon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; // Pause
            if(wave) wave.classList.add('audio-playing');
        } else {
            audio.pause();
            icon.innerHTML = '<path d="M8 5v14l11-7z"/>'; // Play
            if(wave) wave.classList.remove('audio-playing');
        }
    };
    window.resetAudioUI = function(id) {
        const icon = document.getElementById('icon-' + id);
        const wave = document.getElementById('wave-' + id);
        if(icon) icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
        if(wave) wave.classList.remove('audio-playing');
    };

    // --- INTERACTION LISTENERS (Tap, Swipe) ---
    function attachMessageListeners(element, id, m) {
        let myReaction = (m.reactions && m.reactions[myUid]) ? m.reactions[myUid].emoji : null;
        
        element.addEventListener('dblclick', (e) => {
            e.preventDefault(); e.stopPropagation(); vibrate(50); 
            const h = document.getElementById('heart-overlay');
            h.style.animation = 'none'; h.offsetHeight; h.style.animation = 'heartPop 0.8s ease-out';
            likeSound.play().catch(e => {}); 
            applyReactionToId(id, myReaction === '‚ù§Ô∏è' ? '' : '‚ù§Ô∏è');
        });

        let startX = 0, currentX = 0, menuTimer = null, isScrolling = false, swipeTriggered = false;
        element.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX; isScrolling = false; swipeTriggered = false;
            menuTimer = setTimeout(() => { if (!isScrolling) { vibrate(70); openMenu(id, m.sender, m.text); } }, 500);
        }, {passive: true});

        element.addEventListener('touchmove', (e) => {
            currentX = e.touches[0].clientX;
            if (Math.abs(currentX - startX) > 10) { clearTimeout(menuTimer); isScrolling = true; }
            let diff = currentX - startX;
            if (diff > 0 && diff < 80) {
                element.style.transform = `translateX(${diff}px)`; element.style.transition = "none";
                if (diff > 50 && !swipeTriggered) { vibrate(20); swipeTriggered = true; }
            }
        }, {passive: true});

        element.addEventListener('touchend', () => {
            clearTimeout(menuTimer);
            let diff = currentX - startX;
            element.style.transition = "transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            element.style.transform = `translateX(0px)`;
            if (diff > 50 && swipeTriggered) {
                let rText = m.text || (m.imageUrl ? "üì∑ Image" : (m.fileUrl ? "üìÑ File" : "Attachment"));
                triggerReply(rText);
            }
            startX = 0; currentX = 0;
        });
    }

    // --- SEND / EDIT / REPLY ---
    function triggerReply(text) {
        replyingTo = text;
        document.getElementById('reply-text').innerText = "Replying to: " + text;
        document.getElementById('reply-dock').style.display = 'flex';
        mInput.focus();
    }

    async function sendImageMessage(imageUrl) {
        popSound.play().catch(e => {});
        scrollToBottom();
        cancelInteraction();
        let msgData = {
            text: "", sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            replyTo: replyingTo, seen: false, reactions: {}, imageUrl: imageUrl
        };
        await db.collection("chats").doc(chatId).collection("messages").add(msgData);
        updateLastMsg("üì∑ Image");
        scrollToBottom();
    }

    async function sendFileMessage(fileUrl, metadata) {
        popSound.play().catch(e => {});
        scrollToBottom();
        const caption = metadata.caption || "";
        let msgData = {
            text: caption, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            replyTo: replyingTo, seen: false, reactions: {}, fileUrl: fileUrl, fileMeta: metadata
        };
        cancelInteraction();
        await db.collection("chats").doc(chatId).collection("messages").add(msgData);
        let label = metadata.type.includes('video') ? "üé• Video" : (metadata.type.includes('audio') ? "üéµ Audio" : "üìÑ File");
        updateLastMsg(caption ? label + " " + caption : label);
        scrollToBottom();
    }

    async function sendMsg() {
        const text = mInput.value.trim();
        if (!text) return;
        popSound.play().catch(e => {});

        mInput.value = ""; mInput.style.height = 'auto'; sendBtnUI.classList.remove('active');
        emojiTray.style.display = 'none'; attachmentMenu.style.display = 'none';
        rdb.ref(`typing/${chatId}/${myUid}`).set(false);
        mInput.focus(); 

        if (editModeId) {
            const id = editModeId; editModeId = null; cancelInteraction();
            await db.collection("chats").doc(chatId).collection("messages").doc(id).update({ text, edited: true });
        } else {
            const rText = replyingTo; cancelInteraction(); scrollToBottom();
            let msgData = {
                text, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                replyTo: rText, seen: false, reactions: {}
            };
            await db.collection("chats").doc(chatId).collection("messages").add(msgData);
            updateLastMsg(text);
        }
        scrollToBottom();
    }

    async function updateLastMsg(msgText) {
        await db.collection("chats").doc(chatId).set({
            lastMessage: msgText, lastSender: myUid, lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
            participants: [myUid, targetUid], seen: false,
            [`unreadCount.${targetUid}`]: firebase.firestore.FieldValue.increment(1)
        }, { merge: true });
    }

    // --- MENUS & ACTIONS ---
    function openMenu(id, sender, text) {
        activeMenuId = id;
        document.getElementById('edit-btn').style.display = (sender === myUid && text) ? 'block' : 'none';
        document.getElementById('unsend-btn').style.display = (sender === myUid) ? 'block' : 'none';
        document.getElementById('menu-overlay').style.display = 'flex';
    }
    
    function closeMenu() { document.getElementById('menu-overlay').style.display = 'none'; }

    async function copyMessageText() {
        if (!activeMenuId) return;
        const el = document.getElementById('text-' + activeMenuId);
        if(el) {
            try { await navigator.clipboard.writeText(el.innerText.split('(edited)')[0].trim()); closeMenu(); } catch(e){}
        }
    }

    function initEdit() {
        const el = document.getElementById('text-'+activeMenuId);
        if(!el) return;
        mInput.value = el.innerText.split('(edited)')[0].trim();
        mInput.style.height = 'auto'; mInput.style.height = mInput.scrollHeight + 'px';
        editModeId = activeMenuId; closeMenu();
        document.getElementById('reply-text').innerHTML = "<strong style='color:var(--accent)'>Editing:</strong> " + mInput.value;
        document.getElementById('reply-dock').style.display = 'flex'; mInput.focus();
    }

    function cancelInteraction() { 
        if (editModeId) { mInput.value = ""; mInput.style.height = 'auto'; }
        replyingTo = null; editModeId = null;
        document.getElementById('reply-dock').style.display = 'none'; 
    }

    function initReplyFromActive() {
        const el = document.getElementById('text-'+activeMenuId);
        const text = el ? el.innerText.split('(edited)')[0].trim() : "Attachment";
        triggerReply(text); closeMenu();
    }

    async function unsendMsg() { 
        const id = activeMenuId; closeMenu();
        if (messagesMap.has(id)) { messagesMap.delete(id); renderAll(); }
        await db.collection("chats").doc(chatId).collection("messages").doc(id).delete();
    }

    async function applyReaction(emoji) {
        if (activeMenuId) { 
            const id = activeMenuId; closeMenu(); 
            await applyReactionToId(id, emoji); 
        }
    }

    async function applyReactionToId(id, emoji) {
        // Optimistic UI Update
        if(messagesMap.has(id)) {
            let msg = messagesMap.get(id);
            if(!msg.reactions) msg.reactions = {};
            if(msg.reactions[myUid] && msg.reactions[myUid].emoji === emoji) delete msg.reactions[myUid];
            else if (emoji !== '') msg.reactions[myUid] = { emoji: emoji, timestamp: Date.now() };
            messagesMap.set(id, msg);
            saveToLocal(); // Save reaction change to cache
            renderAll();
        }
        
        const msgRef = db.collection("chats").doc(chatId).collection("messages").doc(id);
        const doc = await msgRef.get();
        const data = doc.data();
        let cur = (data.reactions && data.reactions[myUid]) ? data.reactions[myUid].emoji : null;

        if (cur === emoji) await msgRef.update({ [`reactions.${myUid}`]: firebase.firestore.FieldValue.delete() });
        else await msgRef.update({ [`reactions.${myUid}`]: { emoji: emoji, timestamp: Date.now() } });
    }

    function showReactionDetails(msgId, event) {
        event.stopPropagation();
        const msgData = messagesMap.get(msgId);
        if (!msgData || !msgData.reactions) return;

        const list = document.getElementById('react-list-items');
        list.innerHTML = '';
        Object.entries(msgData.reactions).forEach(([uid, rData]) => {
            const isMe = uid === myUid;
            const pfpSrc = isMe ? (myUserData ? myUserData.photoURL : 'https://via.placeholder.com/40') : chatTargetData.photoURL;
            const name = isMe ? "You" : (chatTargetData.name || chatTargetData.username);
            
            const el = document.createElement('div');
            el.style.cssText = "display:flex; align-items:center; padding:10px 14px; border-bottom:1px solid #333;";
            el.innerHTML = `
                <img src="${pfpSrc}" style="width:36px; height:36px; border-radius:50%; margin-right:12px;">
                <div style="flex:1;">
                    <div style="font-weight:600; font-size:0.9rem;">${name}</div>
                </div>
                <div style="font-size:1.4rem;">${rData.emoji}</div>
            `;
            list.appendChild(el);
        });
        document.getElementById('reaction-details-overlay').style.display = 'flex';
    }
    function closeReactionDetails() { document.getElementById('reaction-details-overlay').style.display = 'none'; }
    function scrollToBottom() { chatFlow.scrollTop = chatFlow.scrollHeight; }

</script>
</body>
</html>
