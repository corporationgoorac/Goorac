<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac | Quantum</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { 
            --bg: #000000; 
            --header-bg: rgba(0,0,0,0.85);
            --accent: #0095f6; 
            --border: #262626; 
            --sent-bg: linear-gradient(135deg, #a43ff2 0%, #3797f0 100%);
            --received-bg: #262626; 
            --text: #ffffff; 
            --text-secondary: #a8a8a8;
            --shimmer: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
        }

        * { 
            box-sizing: border-box; -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0; -webkit-touch-callout: none; 
            -webkit-font-smoothing: antialiased;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: var(--bg);
            position: fixed; 
            left: 0; top: 0;
        }

        body { 
            -webkit-user-select: none; user-select: none; 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        }

        /* --- ENABLE COPY PASTE ONLY IN INPUTS --- */
        input, textarea { 
            -webkit-user-select: text !important; 
            user-select: text !important; 
            outline: none; 
            font-family: inherit;
        }

        /* --- UPDATED SHIMMER --- */
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }

        .loading-shimmer {
            background: var(--shimmer);
            background-size: 400px 100%;
            animation: shimmer 1.2s ease-in-out infinite;
        }

        .app-container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            height: 100dvh;
            width: 100%; 
            position: absolute;
            top: 0; left: 0;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header { 
            padding: 10px 16px;
            padding-top: calc(env(safe-area-inset-top) + 10px); 
            height: calc(64px + env(safe-area-inset-top));
            background: var(--header-bg); 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            z-index: 1000;
            flex-shrink: 0; 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            width: 100%;
        }

        .back-btn {
            font-size: 1.8rem; 
            color: var(--accent); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            height: 40px; width: 30px;
        }

        .h-profile-group { display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1; overflow: hidden; }
        
        .h-pfp { 
            width: 38px; height: 38px; border-radius: 50%; object-fit: cover; 
            background: #121212; border: 1px solid #222; flex-shrink: 0;
            transition: opacity 0.3s ease;
        }
        
        .h-info { display: flex; flex-direction: column; justify-content: center; gap: 2px; min-width: 0; }
        .h-name-wrapper { display: flex; align-items: center; gap: 4px; line-height: 1; }
        
        .h-name { 
            font-weight: 600; font-size: 1rem; color: #fff; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .h-name:empty {
            height: 16px; width: 120px; border-radius: 4px; 
            background: var(--shimmer); background-size: 400px 100%; 
            animation: shimmer 1.2s infinite;
        }

        .h-username-sub { font-size: 0.75rem; color: var(--text-secondary); }
        .v-badge { width: 14px; height: 14px; display: none; }

        /* --- CHAT AREA --- */
        #chat-flow { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            padding: 15px 0; 
            display: flex; 
            flex-direction: column; 
            -webkit-overflow-scrolling: touch;
            background: #000;
            overscroll-behavior-y: contain; 
            position: relative;
        }
        
        #messages-container { 
            display: flex; 
            flex-direction: column; 
            padding: 0 12px;
            transition: transform 0.2s cubic-bezier(0.215, 0.610, 0.355, 1.000); /* Smooth spring slide */
            will-change: transform;
            width: 100%;
        }

        #typing-indicator-bottom {
            padding: 5px 25px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: none;
            margin-bottom: 10px;
            margin-left: 15px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }

        #scroll-trigger { text-align: center; padding: 20px; color: #262626; font-size: 0.7rem; order: -1; }

        .date-divider {
            text-align: center; margin: 20px 0 10px 0; font-size: 0.7rem;
            color: #555; font-weight: 500;
        }

        /* --- MESSAGE ROW STRUCTURE --- */
        .msg-row {
            display: flex;
            width: 100%;
            margin-bottom: 2px; /* Tight professional gap */
            position: relative;
        }
        .msg-row.sent { justify-content: flex-end; }
        .msg-row.received { justify-content: flex-start; }

        /* --- BUBBLE UI --- */
        .msg-bubble-box {
            position: relative;
            max-width: 75%;
            display: flex;
            flex-direction: column;
        }
        .sent .msg-bubble-box { align-items: flex-end; }
        .received .msg-bubble-box { align-items: flex-start; }

        .bubble { 
            padding: 10px 15px; 
            border-radius: 20px; 
            font-size: 0.96rem; 
            line-height: 1.4; 
            position: relative; 
            word-wrap: break-word; 
            z-index: 2;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Rounded corners logic */
        .sent .bubble { 
            background: var(--sent-bg); 
            color: #fff; 
            border-bottom-right-radius: 4px; 
        }
        .received .bubble { 
            background: var(--received-bg); 
            color: #fff; 
            border-bottom-left-radius: 4px; 
        }

        /* --- HIDDEN TIMESTAMP (Right Side) --- */
        /* Positioned absolutely relative to the ROW, so it sits off-screen */
        .sliding-timestamp {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: -65px; /* Hidden off screen */
            font-size: 0.7rem;
            color: #666;
            font-weight: 500;
            width: 50px;
            text-align: center;
            pointer-events: none;
        }

        .reaction-badge { 
            position: absolute; bottom: -8px; background: #1a1a1a; border: 2px solid #000; 
            border-radius: 20px; padding: 2px 6px; font-size: 0.8rem; z-index: 10; display: none;
            cursor: pointer;
        }
        .sent .reaction-badge { right: 0; }
        .received .reaction-badge { left: 0; }

        /* Meta for "Seen" only, no time */
        .meta { 
            display: block; 
            font-size: 0.65rem; color: var(--text-secondary); 
            margin-top: 2px; margin-right: 2px;
            height: 14px;
        }

        .reply-box-ui { 
            background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 8px; 
            margin-bottom: 2px; font-size: 0.75rem; border-left: 3px solid var(--accent); color: #ccc;
            max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.9;
        }

        /* --- INPUT AREA --- */
        .input-area-container {
            background: #000;
            border-top: 1px solid var(--border);
            padding-bottom: env(safe-area-inset-bottom, 10px);
            flex-shrink: 0;
            width: 100%;
            z-index: 1000;
        }

        .input-area { padding: 8px 10px; display: flex; align-items: flex-end; gap: 8px; }
        
        .input-box { 
            flex: 1; background: #121212; border-radius: 22px; 
            padding: 2px 12px; border: 1px solid #333;
            display: flex; align-items: center; min-height: 44px;
        }
        
        /* Auto-growing Textarea */
        .msg-input { 
            width: 100%; background: transparent; border: none; color: white; 
            padding: 10px 0; font-size: 16px; 
            resize: none; 
            max-height: 100px; /* Limit to ~4 lines */
            overflow-y: auto;
            line-height: 1.3;
        }
        
        .plus-btn { 
            font-size: 26px; color: var(--accent); cursor: pointer; 
            padding: 0 5px; height: 44px; display: flex; align-items: center; 
        }
        .send-btn { 
            background: transparent; color: var(--accent); border: none; 
            font-weight: 600; font-size: 1rem; cursor: pointer; 
            padding: 0 5px; height: 44px; display: flex; align-items: center;
        }

        #emoji-tray {
            display: none; background: #000; border-top: 1px solid var(--border);
            height: 250px; overflow-y: auto; padding: 15px;
            grid-template-columns: repeat(7, 1fr); gap: 10px;
        }
        .emoji-item { font-size: 1.8rem; cursor: pointer; text-align: center; }

        /* --- MENUS --- */
        #menu-overlay, #reaction-details-overlay { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0, 0, 0, 0.6); z-index: 2000; 
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .menu-card { background: #1c1c1c; border-radius: 16px; width: 280px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .reaction-bar { display: flex; justify-content: space-evenly; padding: 16px 10px; border-bottom: 1px solid #333; }
        .reaction-bar span { font-size: 2rem; cursor: pointer; transition: transform 0.1s; }
        .reaction-bar span:active { transform: scale(1.3); }
        .more-emoji-trigger { background: #333; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; }

        #menu-emoji-grid { display: none; max-height: 220px; overflow-y: auto; grid-template-columns: repeat(6, 1fr); padding: 15px; gap: 8px; background: #1c1c1c; }
        .menu-grid-emoji { font-size: 1.6rem; cursor: pointer; text-align: center; }

        .menu-opt { padding: 16px; text-align: center; font-size: 1rem; border-bottom: 1px solid #333; color: #fff; }
        .menu-opt:active { background: #333; }
        
        #reply-dock { 
            display: none; background: #111; padding: 12px 16px; 
            border-top: 1px solid var(--border); justify-content: space-between; align-items: center;
        }

        .react-list-container {
            width: 85%; max-width: 340px; background: #1c1c1c; border-radius: 16px; 
            overflow: hidden; display: flex; flex-direction: column; max-height: 50vh;
        }
        .react-list-header { padding: 16px; text-align: center; font-weight: 600; font-size: 1.1rem; border-bottom: 1px solid #333; position: relative; color: white;}
        .react-list-close { position: absolute; right: 16px; top: 16px; cursor: pointer; color: #888; }
        .reactor-item { display: flex; align-items: center; padding: 12px 16px; gap: 12px; border-bottom: 1px solid #2a2a2a; }
        .reactor-pfp { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; background: #333; }
        .reactor-info { flex: 1; }
        .reactor-name { font-weight: 600; font-size: 0.9rem; color: #fff; }
        .reactor-time { font-size: 0.7rem; color: #888; margin-top: 2px; }
        .reactor-emoji { font-size: 1.4rem; }
    </style>
</head>
<body>

<div id="reaction-details-overlay" onclick="closeReactionDetails()">
    <div class="react-list-container" onclick="event.stopPropagation()">
        <div class="react-list-header">
            Reactions
            <div class="react-list-close" onclick="closeReactionDetails()">‚úï</div>
        </div>
        <div class="react-list-content" id="react-list-items"></div>
    </div>
</div>

<div id="menu-overlay" onclick="closeMenu()">
    <div class="menu-card" id="main-menu-card" onclick="event.stopPropagation()">
        <div class="reaction-bar">
            <span onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="applyReaction('üòÇ')">üòÇ</span>
            <span onclick="applyReaction('üòÆ')">üòÆ</span>
            <span onclick="applyReaction('üò¢')">üò¢</span>
            <span onclick="applyReaction('üëç')">üëç</span>
            <div class="more-emoji-trigger" onclick="expandEmojiMenu()">+</div>
        </div>
        <div id="menu-emoji-grid"></div>
        <div class="menu-opt" onclick="initReplyFromActive()">Reply</div>
        <div id="edit-btn" class="menu-opt" onclick="initEdit()">Edit</div>
        <div id="unsend-btn" class="menu-opt" style="color:#ff3b30; font-weight: 600;" onclick="unsendMsg()">Unsend</div>
        <div class="menu-opt" onclick="closeMenu()" style="border-bottom:none; color: #888">Cancel</div>
    </div>
</div>

<div class="app-container" id="main-app">
    <header id="chat-header">
        <div class="back-btn" onclick="history.back()">‚Äπ</div>
        <div class="h-profile-group" onclick="goToProfile()">
            <img id="h-pfp" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="h-pfp loading-shimmer">
            <div class="h-info">
                <div class="h-name-wrapper">
                    <div class="h-name" id="h-display-name"></div>
                    <img id="v-badge" src="https://img.icons8.com/color/48/verified-badge.png" class="v-badge">
                </div>
                <div class="h-username-sub" id="h-username-label"></div>
            </div>
        </div>
    </header>

    <div id="chat-flow">
        <div id="scroll-trigger"></div>
        <div id="messages-container"></div>
        <div id="typing-indicator-bottom">typing...</div>
    </div>

    <div class="input-area-container">
        <div id="reply-dock">
            <div id="reply-text" style="font-size:0.8rem; color:#aaa; overflow:hidden; text-overflow:ellipsis;"></div>
            <div onclick="cancelReply()" style="color:#fff; font-weight:bold; padding:5px; cursor:pointer;">‚úï</div>
        </div>

        <div id="emoji-tray"></div>

        <div class="input-area">
            <div class="plus-btn" onclick="toggleEmojiTray()">+</div>
            <div class="input-box">
                <textarea id="m-input" class="msg-input" placeholder="Message..." rows="1"></textarea>
            </div>
            <button class="send-btn" onclick="sendMsg()">Send</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const rdb = firebase.database();
    const auth = firebase.auth();

    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');
    let myUid, targetUid, chatId, replyingTo = null, editModeId = null;
    let activeMenuId = null, unsubscribe = null, isLoadingMore = false;
    let lastVisible = null; 
    let messagesMap = new Map(); 
    let chatTargetData = null; 

    const mInput = document.getElementById('m-input');
    const chatFlow = document.getElementById('chat-flow');
    const container = document.getElementById('messages-container');
    const bottomTyping = document.getElementById('typing-indicator-bottom');
    const emojiTray = document.getElementById('emoji-tray');

    const emojis = ["‚ù§Ô∏è","üòÇ","üòÆ","üî•","üëç","üò¢","üôè","üëè","üôå","‚ú®","üòç","ü§î","üòé","üò≠","‚úÖ","‚ùå","üöÄ","üíØ","üòÇ","ü§£","üòä","ü•∞","üòò","üòú","ü§™","ü§©","ü•≥","üôÑ","üò¥","ü•±","üí©","üëª","üíÄ","üëΩ","ü§ñ","üéÉ","üò∫","ü§≤","ü§ù","üëé","üëä","‚úä","‚úåÔ∏è","ü§ü","ü§ò","üëå","üëà","üëâ","üëÜ","üëá","‚òùÔ∏è","‚úã","ü§ö","üñêÔ∏è","üññ","üëã","ü§ô","üí™","ü¶æ","üñï","‚úçÔ∏è","üíç","üíÑ","üíã","üëÑ","ü¶∑","üëÖ","üëÇ","üëÉ","üë£","üëÅÔ∏è","üëÄ","üß†","üó£Ô∏è","üë§","üë•"];

    function formatTime12(date) {
        let hours = date.getHours();
        let minutes = date.getMinutes();
        let ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        minutes = minutes < 10 ? '0'+minutes : minutes;
        return hours + ':' + minutes + ' ' + ampm;
    }

    function getDateDivider(date) {
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        if (date.toDateString() === today.toDateString()) return "Today";
        if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
        return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }

    // Auto-resize textarea function
    mInput.addEventListener('input', function() {
        this.style.height = 'auto'; 
        this.style.height = (this.scrollHeight) + 'px';
        if(this.value === '') this.style.height = 'auto';
        
        // Typing indicator trigger
        rdb.ref(`typing/${chatId}/${myUid}`).set(this.value.trim().length > 0);
    });

    // Handle Enter key (Shift+Enter for newline, Enter to send)
    mInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMsg();
        }
    });

    function toggleEmojiTray() {
        if (emojiTray.style.display === 'grid') {
            emojiTray.style.display = 'none';
        } else {
            emojiTray.style.display = 'grid';
            if (emojiTray.innerHTML === "") {
                emojis.forEach(e => {
                    const span = document.createElement('span');
                    span.className = 'emoji-item';
                    span.innerText = e;
                    span.onclick = () => { mInput.value += e; mInput.focus(); };
                    emojiTray.appendChild(span);
                });
            }
        }
        scrollToBottom();
    }

    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            const viewportHeight = window.visualViewport.height;
            document.getElementById('main-app').style.height = viewportHeight + 'px';
            document.body.style.top = window.visualViewport.offsetTop + 'px';
            scrollToBottom();
        });
    }

    window.oncontextmenu = (e) => { e.preventDefault(); return false; };
    function vibrate(ms = 50) { if (navigator.vibrate) navigator.vibrate(ms); }

    function goToProfile() {
        if(targetUsername) window.location.href = `userProfile.html?user=${targetUsername}`;
    }
    
    mInput.addEventListener("focus", () => { emojiTray.style.display = 'none'; });

    auth.onAuthStateChanged(user => {
        if (user) { myUid = user.uid; initChat(); }
        else { window.location.href = 'login.html'; }
    });

    async function initChat() {
        if(!targetUsername) return;
        const snap = await db.collection("users").where("username", "==", targetUsername).get();
        if (snap.empty) return;
        targetUid = snap.docs[0].id;
        chatId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
        
        chatTargetData = snap.docs[0].data();
        
        const pfp = document.getElementById('h-pfp');
        pfp.classList.remove('loading-shimmer');
        pfp.src = chatTargetData.photoURL || 'https://via.placeholder.com/150';
        
        document.getElementById('h-display-name').innerText = chatTargetData.name || chatTargetData.username;
        document.getElementById('h-username-label').innerText = `@${chatTargetData.username}`;
        
        if(chatTargetData.verified === true) document.getElementById('v-badge').style.display = 'block';

        db.collection("chats").doc(chatId).update({ [`unreadCount.${myUid}`]: 0, seen: true }).catch(e => {});

        rdb.ref(`typing/${chatId}/${targetUid}`).on('value', (s) => {
            bottomTyping.style.display = s.val() ? 'block' : 'none';
        });

        startListener(); 
        setupObserver();
        setupGlobalSlide(); 
    }

    // --- INSTAGRAM STYLE TIME REVEAL LOGIC ---
    function setupGlobalSlide() {
        let startX = 0, currentX = 0, isDragging = false;
        const container = document.getElementById('messages-container');

        chatFlow.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = false;
        }, {passive: true});

        chatFlow.addEventListener('touchmove', (e) => {
            currentX = e.touches[0].clientX;
            const diff = currentX - startX;
            
            // Drag LEFT to reveal time
            if (diff < -10) { 
                isDragging = true;
                const translate = Math.max(diff, -70);
                container.style.transform = `translateX(${translate}px)`;
                container.style.transition = 'none';
            }
        }, {passive: true});

        chatFlow.addEventListener('touchend', (e) => {
            if (isDragging) {
                container.style.transition = 'transform 0.2s cubic-bezier(0.215, 0.610, 0.355, 1.000)';
                container.style.transform = `translateX(0px)`;
            }
            startX = 0; currentX = 0; isDragging = false;
        });
    }

    function setupObserver() {
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isLoadingMore && lastVisible) {
                loadMoreMessages();
            }
        }, { root: chatFlow, threshold: 0.5 });
        observer.observe(document.getElementById('scroll-trigger'));
    }

    function startListener() {
        if (unsubscribe) unsubscribe();
        
        unsubscribe = db.collection("chats").doc(chatId).collection("messages")
            .orderBy("timestamp", "desc")
            .limit(20)
            .onSnapshot(snapshot => {
                if (snapshot.empty) return;
                
                if (!lastVisible) lastVisible = snapshot.docs[snapshot.docs.length - 1];

                snapshot.docChanges().forEach(change => {
                    const msgData = change.doc.data();
                    const msgId = change.doc.id;
                    
                    if (change.type === "added" || change.type === "modified") {
                        messagesMap.set(msgId, msgData);
                    } else if (change.type === "removed") {
                        messagesMap.delete(msgId);
                    }
                    
                    if(msgData.sender !== myUid && !msgData.seen) {
                        db.collection("chats").doc(chatId).collection("messages").doc(msgId).update({ seen: true });
                    }
                });

                const isNearBottom = chatFlow.scrollTop + chatFlow.clientHeight >= chatFlow.scrollHeight - 100;
                renderAll();
                if (isNearBottom) scrollToBottom();
            });
    }

    async function loadMoreMessages() {
        if (isLoadingMore || !lastVisible) return;
        isLoadingMore = true;
        const oldScrollHeight = chatFlow.scrollHeight;
        
        const snapshot = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("timestamp", "desc")
            .startAfter(lastVisible)
            .limit(15)
            .get();

        if (!snapshot.empty) {
            snapshot.forEach(doc => { messagesMap.set(doc.id, doc.data()); });
            lastVisible = snapshot.docs[snapshot.docs.length - 1];
            renderAll();
            chatFlow.scrollTop = chatFlow.scrollHeight - oldScrollHeight;
            isLoadingMore = false;
        } else {
            isLoadingMore = false;
            lastVisible = null; 
        }
    }

    function renderAll() {
        container.innerHTML = '';
        const sorted = Array.from(messagesMap.entries())
            .filter(([id, data]) => data.timestamp) 
            .sort((a, b) => a[1].timestamp.toMillis() - b[1].timestamp.toMillis());

        let lastDateLabel = "";

        sorted.forEach(([id, data]) => { 
            const msgDate = data.timestamp.toDate();
            const dateLabel = getDateDivider(msgDate);
            
            if (dateLabel !== lastDateLabel) {
                const div = document.createElement('div');
                div.className = "date-divider";
                div.innerText = dateLabel;
                container.appendChild(div);
                lastDateLabel = dateLabel;
            }
            renderMessage(data, id); 
        });
    }

    function renderMessage(m, id) {
        const side = m.sender === myUid ? 'sent' : 'received';
        const date = m.timestamp ? m.timestamp.toDate() : new Date();

        // WRAPPER ROW for layout alignment
        const rowDiv = document.createElement('div');
        rowDiv.id = id;
        rowDiv.className = `msg-row ${side}`;
        
        let reactionsList = [];
        let myReaction = null;
        if (m.reactions) {
            reactionsList = Object.values(m.reactions);
            if (m.reactions[myUid]) myReaction = m.reactions[myUid].emoji;
        }
        
        const reactionDisplay = reactionsList.map(r => r.emoji).join(' ');

        // Double click reaction on the Bubble box
        rowDiv.addEventListener('dblclick', (e) => {
            e.preventDefault(); vibrate(40);
            applyReactionToId(id, myReaction === '‚ù§Ô∏è' ? '' : '‚ù§Ô∏è');
        });

        // Swipe Right to Reply (Bubble only logic)
        let startX = 0, currentX = 0, menuTimer = null, isMoving = false, swipeTriggered = false;

        rowDiv.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isMoving = false; swipeTriggered = false;
            menuTimer = setTimeout(() => {
                if (!isMoving) { vibrate(70); openMenu(id, m.sender, m.text); }
            }, 500);
        }, {passive: true});

        rowDiv.addEventListener('touchmove', (e) => {
            currentX = e.touches[0].clientX;
            let diff = currentX - startX;
            if (Math.abs(diff) > 10) isMoving = true;
            
            // Only allow Right swipe for Reply
            if (diff > 0 && diff < 80) {
                const b = rowDiv.querySelector('.bubble');
                b.style.transform = `translateX(${diff}px)`;
                b.style.transition = "none";
                if (diff > 50 && !swipeTriggered) { vibrate(20); swipeTriggered = true; }
            }
        }, {passive: true});

        rowDiv.addEventListener('touchend', () => {
            clearTimeout(menuTimer);
            let diff = currentX - startX;
            const bubble = rowDiv.querySelector('.bubble');
            if(bubble) {
                bubble.style.transition = "transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
                bubble.style.transform = `translateX(0px)`;
            }
            if (diff > 50) triggerReply(m.text);
            startX = 0; currentX = 0;
        });

        // HTML Structure: 
        // 1. Bubble Box (Message)
        // 2. Sliding Timestamp (Hidden right, relative to row)
        rowDiv.innerHTML = `
            <div class="msg-bubble-box">
                ${m.replyTo ? `<div class="reply-box-ui">‚§¥ ${m.replyTo}</div>` : ''}
                <div class="bubble">
                    <span id="text-${id}">${m.text} ${m.edited ? '<small style="opacity:0.4;font-size:0.6rem"> (edited)</small>' : ''}</span>
                    <div id="react-${id}" class="reaction-badge" onclick="showReactionDetails('${id}', event)" style="${reactionDisplay ? 'display:block' : ''}">${reactionDisplay}</div>
                </div>
                ${side === 'sent' ? `<div class="meta"><span class="seen">${m.seen ? 'Seen' : 'Sent'}</span></div>` : ''}
            </div>
            
            <div class="sliding-timestamp">${formatTime12(date)}</div>
        `;
        container.appendChild(rowDiv);
    }

    function triggerReply(text) {
        replyingTo = text;
        document.getElementById('reply-text').innerText = replyingTo;
        document.getElementById('reply-dock').style.display = 'flex';
        mInput.focus(); 
    }

    async function sendMsg() {
        const text = mInput.value.trim();
        if (!text) return;

        mInput.value = "";
        mInput.style.height = 'auto'; // Reset height
        emojiTray.style.display = 'none';
        rdb.ref(`typing/${chatId}/${myUid}`).set(false);
        
        if (editModeId) {
            const idToEdit = editModeId; editModeId = null;
            await db.collection("chats").doc(chatId).collection("messages").doc(idToEdit).update({ text, edited: true });
        } else {
            const rText = replyingTo; cancelReply();
            scrollToBottom();
            await db.collection("chats").doc(chatId).collection("messages").add({
                text, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                replyTo: rText, seen: false, reactions: {}
            });
            await db.collection("chats").doc(chatId).set({
                lastMessage: text, lastSender: myUid,
                lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                participants: [myUid, targetUid], seen: false,
                [`unreadCount.${targetUid}`]: firebase.firestore.FieldValue.increment(1)
            }, { merge: true });
        }
        scrollToBottom();
    }

    function scrollToBottom() { chatFlow.scrollTop = chatFlow.scrollHeight; }

    function openMenu(id, sender, text) {
        activeMenuId = id;
        const isMine = sender === myUid;
        document.getElementById('edit-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('unsend-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('menu-emoji-grid').style.display = 'none';
        document.getElementById('menu-overlay').style.display = 'flex';
    }

    async function applyReaction(emoji) {
        if (!activeMenuId) return;
        const msgId = activeMenuId; closeMenu(); 
        await applyReactionToId(msgId, emoji);
    }

    async function applyReactionToId(id, emoji) {
        const msgRef = db.collection("chats").doc(chatId).collection("messages").doc(id);
        const doc = await msgRef.get();
        const data = doc.data();
        let currentReaction = (data.reactions && data.reactions[myUid]) ? data.reactions[myUid].emoji : null;

        if (currentReaction === emoji) {
            await msgRef.update({ [`reactions.${myUid}`]: firebase.firestore.FieldValue.delete() });
        } else {
            await msgRef.update({ [`reactions.${myUid}`]: { emoji: emoji, timestamp: Date.now() } });
        }
    }

    function showReactionDetails(msgId, event) {
        event.stopPropagation();
        const msgData = messagesMap.get(msgId);
        if (!msgData || !msgData.reactions) return;

        const listContainer = document.getElementById('react-list-items');
        listContainer.innerHTML = '';

        const currentUser = firebase.auth().currentUser;
        const myPhoto = currentUser ? currentUser.photoURL : 'https://via.placeholder.com/40';

        Object.entries(msgData.reactions).forEach(([uid, rData]) => {
            const isMe = uid === myUid;
            const pfpSrc = isMe ? myPhoto : chatTargetData.photoURL;
            const name = isMe ? "You" : (chatTargetData.name || chatTargetData.username);
            const timeStr = formatTime12(new Date(rData.timestamp));

            const el = document.createElement('div');
            el.className = 'reactor-item';
            el.innerHTML = `
                <img src="${pfpSrc || 'https://via.placeholder.com/40'}" class="reactor-pfp">
                <div class="reactor-info">
                    <div class="reactor-name">${name}</div>
                    <div class="reactor-time">${timeStr}</div>
                </div>
                <div class="reactor-emoji">${rData.emoji}</div>
            `;
            listContainer.appendChild(el);
        });
        document.getElementById('reaction-details-overlay').style.display = 'flex';
    }

    function closeReactionDetails() { document.getElementById('reaction-details-overlay').style.display = 'none'; }

    function expandEmojiMenu() {
        const grid = document.getElementById('menu-emoji-grid');
        if (grid.style.display === 'grid') {
            grid.style.display = 'none';
        } else {
            grid.style.display = 'grid';
            if (grid.innerHTML === "") {
                emojis.forEach(e => {
                    const span = document.createElement('span');
                    span.className = 'menu-grid-emoji';
                    span.innerText = e;
                    span.onclick = () => applyReaction(e);
                    grid.appendChild(span);
                });
            }
        }
    }

    function initReplyFromActive() {
        triggerReply(document.getElementById('text-'+activeMenuId).innerText.split('(edited)')[0].trim());
        closeMenu();
    }

    function closeMenu() { document.getElementById('menu-overlay').style.display = 'none'; }
    function cancelReply() { replyingTo = null; document.getElementById('reply-dock').style.display = 'none'; }
    
    function initEdit() {
        mInput.value = document.getElementById('text-'+activeMenuId).innerText.split('(edited)')[0].trim();
        mInput.style.height = 'auto'; mInput.style.height = mInput.scrollHeight + 'px';
        editModeId = activeMenuId; closeMenu(); mInput.focus();
    }

    async function unsendMsg() { 
        const idToDelete = activeMenuId; closeMenu();
        if (messagesMap.has(idToDelete)) { messagesMap.delete(idToDelete); renderAll(); }
        await db.collection("chats").doc(chatId).collection("messages").doc(idToDelete).delete();
        const snapshot = await db.collection("chats").doc(chatId).collection("messages").orderBy("timestamp", "desc").limit(1).get();
        if (!snapshot.empty) {
            const lastMsg = snapshot.docs[0].data();
            await db.collection("chats").doc(chatId).update({ lastMessage: lastMsg.text, lastSender: lastMsg.sender, lastTimestamp: lastMsg.timestamp });
        }
    }
</script>

<script src="components/call-notifier.js" defer></script>
<call-notifier></call-notifier>

</body>
</html>
