<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#000000"> 
<title>Goorac | Quantum</title>

<script src="config.js"></script>

<script src="[https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js](https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js)"></script>
<script src="[https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js](https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js)"></script>
<script src="[https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js)"></script>
<script src="[https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js](https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js)"></script>

<script type="module">
  import { initializeApp } from "[https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js](https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js)";
  import { getAnalytics } from "[https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js](https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js)";

  export const firebaseConfig = {
      apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
      authDomain: "goorac-c3b59.firebaseapp.com",
      projectId: "goorac-c3b59",
      storageBucket: "goorac-c3b59.firebasestorage.app",
      messagingSenderId: "746746595332",
      appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
      measurementId: "G-M46FEVRYSS"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

<script type="module" src="components/presence.js"></script>

<script src="components/emojiPicker.js" defer></script>
<script src="components/imagePicker.js" defer></script>
<script src="components/filePicker.js" defer></script>
<script src="components/viewMedia.js" defer></script>

<style>
    :root { 
        /* Subtle radial background for depth */
        --bg: radial-gradient(circle at center, #0a0a0a 0%, #000000 100%); 
        --header-bg: rgba(0,0,0,0.96);
        --accent: #0095f6; 
        --border: #262626; 
        --sent-bg: linear-gradient(135deg, #ff6b00 0%, #ff3b00 100%);
        --received-bg: #262626; 
        --text: #ffffff; 
        --text-secondary: #a8a8a8;
        --shimmer: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
    }

    * { 
        box-sizing: border-box; -webkit-tap-highlight-color: transparent; 
        margin: 0; padding: 0; -webkit-touch-callout: none; 
        -webkit-font-smoothing: antialiased;
    }
    
    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        background: var(--bg);
        position: fixed; 
        left: 0; top: 0;
        margin: 0 !important;
        padding: 0 !important;
    }

    body { 
        -webkit-user-select: none; user-select: none; 
        color: var(--text); 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
    }

    /* --- STRICT COPY PASTE CONTROL --- */
    div, span, p, img, svg { -webkit-user-select: none; user-select: none; }
    
    input, textarea { 
        -webkit-user-select: text !important; 
        user-select: text !important; 
        outline: none; 
        font-family: inherit;
    }

    /* --- ANIMATIONS --- */
    @keyframes shimmer { 0% { background-position: -200px 0; } 100% { background-position: 200px 0; } }
    @keyframes flashMessage { 0% { background-color: rgba(255, 165, 0, 0.3); transform: scale(1.02); } 100% { background-color: transparent; transform: scale(1); } }
    @keyframes scaleIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes fadeStatus { 0% { opacity: 0; transform: translateY(2px); } 100% { opacity: 1; transform: translateY(0); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); } 20%, 40%, 60%, 80% { transform: translateX(4px); } }
    
    /* FEATURE: Pulse Animation for Online Dot */
    @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); } 70% { box-shadow: 0 0 0 4px rgba(0, 230, 118, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); } }
    
    /* FEATURE: Smooth Image Fade In */
    @keyframes imgFadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

    /* Modal Slide Up Animation */
    @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }

    .shake-anim { animation: shake 0.4s ease-in-out; border-color: #ff3b00 !important; }

    .loading-shimmer {
        background: var(--shimmer); background-size: 400px 100%; animation: shimmer 1.2s ease-in-out infinite;
    }

    /* INSTANT LOAD OVERRIDE: Remove animations when data is cached */
    .instant-load .loading-shimmer { animation: none; background: transparent; }
    .instant-load .chat-media-img { animation: none; }
    .instant-load #chat-flow { opacity: 1 !important; transition: none !important; }

    .app-container { 
        display: flex; flex-direction: column; height: 100vh; height: 100dvh; width: 100%; position: absolute; top: 0; left: 0; overflow: hidden;
    }

    /* --- HEADER ABSOLUTE (WEBVIEW FIX) --- */
    header { 
        position: absolute; /* Request: Absolute positioning */
        top: 0; left: 0; right: 0;
        padding: 0 16px;
        padding-top: calc(env(safe-area-inset-top) + 10px);
        height: calc(60px + env(safe-area-inset-top));
        background: var(--header-bg); 
        border-bottom: 1px solid var(--border); 
        display: flex; align-items: center; gap: 12px; 
        z-index: 2000; 
        backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    }

    .back-btn { font-size: 1.8rem; color: var(--accent); cursor: pointer; display: flex; align-items: center; justify-content: center; height: 40px; width: 30px; }

    .h-profile-group { display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1; overflow: hidden; }
    
    .pfp-container { position: relative; width: 38px; height: 38px; flex-shrink: 0; }
    .h-pfp { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #121212; border: 1px solid #333; transition: opacity 0.3s ease; }
    .online-dot { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #00e676; border-radius: 50%; border: 2px solid #000; display: none; box-shadow: 0 0 4px rgba(0,230,118,0.5); animation: pulseGreen 2s infinite; }
    
    .h-info { display: flex; flex-direction: column; justify-content: center; gap: 1px; min-width: 0; }
    .h-name-wrapper { display: flex; align-items: center; gap: 4px; line-height: 1.1; }
    .h-name { font-weight: 700; font-size: 1rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .h-name:empty { height: 16px; width: 120px; border-radius: 4px; background: var(--shimmer); background-size: 400px 100%; animation: shimmer 1.2s infinite; }
    .h-username-sub { font-size: 0.75rem; color: var(--text-secondary); font-weight: 400; animation: fadeStatus 0.3s ease; }
    .v-badge { width: 14px; height: 14px; display: none; }

    .header-actions { display: flex; align-items: center; gap: 20px; margin-left: auto; padding-right: 5px; }
    .header-icon { width: 26px; height: 26px; cursor: pointer; fill: #ffffff; opacity: 0.9; transition: transform 0.2s, opacity 0.2s; }
    .header-icon:active { opacity: 0.6; transform: scale(0.9); }

    /* --- CHAT AREA --- */
    #chat-flow { 
        flex: 1; overflow-y: auto; overflow-x: hidden; padding: 15px 0; 
        display: flex; flex-direction: column; -webkit-overflow-scrolling: touch;
        background: transparent; overscroll-behavior-y: contain; position: relative;
        /* PADDING TOP to clear absolute header */
        padding-top: calc(75px + env(safe-area-inset-top)); 
        
        /* Hide Scrollbar */
        -ms-overflow-style: none; scrollbar-width: none;
        
        /* Initial State Hidden (Unless Instant Load) */
        opacity: 0; transition: opacity 0.2s ease-in;
    }
    #chat-flow::-webkit-scrollbar { display: none; }
    
    #messages-container { display: flex; flex-direction: column; padding: 0 14px; will-change: transform; width: 100%; padding-bottom: 30px; }

    #typing-indicator-bottom { display: none; margin-left: 56px; margin-bottom: 15px; background: #262626; width: 54px; height: 32px; border-radius: 16px; border-bottom-left-radius: 4px; align-items: center; justify-content: center; gap: 4px; padding: 0 12px; align-self: flex-start; }
    .typing-dot { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: typingWave 1.3s linear infinite; }
    .typing-dot:nth-child(2) { animation-delay: -1.1s; }
    .typing-dot:nth-child(3) { animation-delay: -0.9s; }
    @keyframes typingWave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }

    #scroll-trigger { text-align: center; padding: 20px; color: #262626; font-size: 0.7rem; order: -1; }
    .date-divider { text-align: center; margin: 10px 0; font-size: 0.75rem; color: #fff; font-weight: 600; text-transform: capitalize; background: rgba(40,40,40,0.6); padding: 4px 10px; border-radius: 12px; align-self: center; width: fit-content; position: sticky; top: 10px; z-index: 5; backdrop-filter: blur(4px); }

    .msg-row { display: flex; width: 100%; margin-bottom: 6px; position: relative; flex-direction: column; }
    .msg-row.sent { align-items: flex-end; padding-right: 0px; }
    .msg-row.received { align-items: flex-start; }
    .received-inner-row { display: flex; align-items: flex-end; gap: 8px; max-width: 100%; }
    .msg-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; flex-shrink: 0; margin-bottom: 4px; background: #121212; border: 1px solid #222; }

    .msg-bubble-box { position: relative; max-width: 78%; display: flex; flex-direction: column; transition: margin-bottom 0.2s; }
    .sent .msg-bubble-box { align-items: flex-end; }
    .received .msg-bubble-box { align-items: flex-start; }

    .bubble { padding: 12px 16px; border-radius: 20px; font-size: 1rem; line-height: 1.45; position: relative; word-wrap: break-word; z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
    .sent .bubble { background: var(--sent-bg); color: #fff; border-top-right-radius: 18px; border-top-left-radius: 18px; border-bottom-left-radius: 18px; border-bottom-right-radius: 4px; text-align: left; }
    .received .bubble { background: var(--received-bg); color: #fff; border-top-left-radius: 18px; border-top-right-radius: 18px; border-bottom-right-radius: 18px; border-bottom-left-radius: 4px; text-align: left; }
    
    /* OWN FEATURE: Link Styling */
    .bubble a { color: #87ceeb; text-decoration: underline; cursor: pointer; }

    .sliding-timestamp { position: absolute; top: 50%; transform: translateY(-50%); right: -65px; font-size: 0.7rem; color: #666; font-weight: 500; width: 50px; text-align: center; pointer-events: none; }
    
    /* FIXED REACTION BADGE VISIBILITY */
    .reaction-badge { 
        position: absolute; 
        bottom: -10px; /* Moves emoji slightly below the bubble/image */
        background: #1a1a1a; 
        border: 2px solid #000; 
        border-radius: 20px; 
        padding: 4px 7px; 
        font-size: 0.85rem; 
        z-index: 20; /* Ensure it sits on top of images */
        display: none; 
        cursor: pointer; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.5); 
    }
    .sent .reaction-badge { right: 0; }
    .received .reaction-badge { left: 0; }

    .seen-status { font-size: 0.65rem; color: var(--text-secondary); margin-top: 4px; margin-right: 2px; text-align: right; font-weight: 500; height: 14px; width: 100%; opacity: 0; animation: fadeIn 0.3s forwards; position: relative; z-index: 1; }
    @keyframes fadeIn { to { opacity: 1; } }

    .reply-box-ui { background: rgba(0, 0, 0, 0.25); padding: 10px 14px; border-radius: 12px; margin-bottom: 6px; font-size: 0.88rem; border-left: 4px solid rgba(255, 255, 255, 0.5); color: #e0e0e0; max-width: 100%; cursor: pointer; transition: opacity 0.2s; white-space: normal; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.35; }
    .reply-box-ui:active { opacity: 0.7; }
    
    /* === NEW: PROFESSIONAL INSTAGRAM NOTE REPLY UI === */
    .note-reply-wrapper {
        margin-bottom: 8px;
        display: flex; flex-direction: column; align-items: center;
        max-width: 100%; cursor: pointer;
    }
    .note-reply-pill { 
        /* Fallback dark background if no color provided */
        background: #262626; 
        padding: 10px 16px; 
        border-radius: 22px; 
        display: inline-flex; flex-direction: column;
        align-items: center; justify-content: center;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        min-width: 120px; max-width: 220px; text-align: center;
        position: relative;
        transition: transform 0.2s;
    }
    .note-reply-pill:active { transform: scale(0.96); }
    
    .note-header-row {
        display: flex; align-items: center; gap: 5px;
        margin-bottom: 4px;
    }
    .note-mini-pfp {
        width: 16px; height: 16px; border-radius: 50%;
        background: #444; object-fit: cover;
    }
    .note-label {
        font-size: 0.65rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.5px;
        color: rgba(255,255,255,0.7);
    }
    
    .note-content-text {
        font-size: 0.9rem; font-weight: 600; color: #fff;
        line-height: 1.3; margin-bottom: 2px;
        display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
    }
    
    .note-song-tag {
        display: flex; align-items: center; gap: 4px;
        font-size: 0.65rem; color: rgba(255,255,255,0.8);
        margin-top: 4px; background: rgba(0,0,0,0.2);
        padding: 2px 8px; border-radius: 10px;
    }
    
    /* The little line connecting note to message */
    .note-connector {
        width: 2px; height: 8px; background: rgba(255,255,255,0.2);
        margin-top: -1px; margin-bottom: -4px; z-index: 0;
    }

    #scroll-down-btn { position: fixed; bottom: 85px; right: 20px; width: 42px; height: 42px; background: #262626; border-radius: 50%; display: none; align-items: center; justify-content: center; color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #333; z-index: 900; cursor: pointer; font-size: 1.2rem; transition: all 0.3s ease; }
    #scroll-down-btn.new-msg { background: var(--accent); color: #fff; animation: bounce 1s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    #heart-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 80px; pointer-events: none; z-index: 3000; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    @keyframes heartPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 70% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(0); opacity: 0; } }

    .input-area-container { background: #000; border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom, 10px); flex-shrink: 0; width: 100%; z-index: 1000; }
    .input-area { padding: 10px 12px; display: flex; align-items: flex-end; gap: 10px; }
    .input-box { flex: 1; background: #121212; border-radius: 22px; padding: 4px 14px; border: 1px solid #333; display: flex; align-items: center; min-height: 42px; transition: border-color 0.2s; }
    .msg-input { width: 100%; background: transparent; border: none; color: white; padding: 9px 0; font-size: 16px; resize: none; max-height: 120px; overflow-y: auto; line-height: 1.35; }
    .plus-btn { font-size: 26px; color: var(--accent); cursor: pointer; padding: 0 5px; height: 44px; display: flex; align-items: center; transition: transform 0.2s; }
    .plus-btn:active { transform: scale(0.9); }
    .send-btn { background: transparent; border: none; font-weight: 600; font-size: 1rem; padding: 0 5px; height: 44px; display: flex; align-items: center; color: #444; pointer-events: none; transition: color 0.2s ease, text-shadow 0.2s ease; }
    .send-btn.active { color: var(--accent); cursor: pointer; pointer-events: auto; text-shadow: 0 0 12px rgba(0, 149, 246, 0.6); }

    #emoji-tray { display: none; background: #000; border-top: 1px solid var(--border); height: 280px; padding: 0; }
    
    /* NEW: Attachment Menu (Popup for + Button) */
    #attachment-menu {
        display: none; position: absolute; bottom: 70px; left: 15px;
        background: rgba(28, 28, 28, 0.95); backdrop-filter: blur(10px);
        border-radius: 16px; padding: 10px; z-index: 1001;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        border: 1px solid #333;
        animation: slideUpFade 0.2s ease-out;
        flex-direction: column; gap: 5px; width: 150px;
    }
    @keyframes slideUpFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .attach-opt { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; cursor: pointer; color: white; font-size: 0.95rem; font-weight: 500; }
    .attach-opt:active { background: rgba(255,255,255,0.1); }
    .attach-opt svg { width: 22px; height: 22px; fill: white; }

    #menu-overlay, #reaction-details-overlay { 
        display: none; position: fixed; inset: 0; 
        background: rgba(0, 0, 0, 0.6); z-index: 2000; 
        justify-content: center; align-items: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
    }
    .menu-card { background: #1c1c1c; border-radius: 16px; width: 280px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .reaction-bar { display: flex; justify-content: space-evenly; padding: 16px 10px; border-bottom: 1px solid #333; }
    .reaction-bar span { font-size: 2rem; cursor: pointer; transition: transform 0.1s; }
    .reaction-bar span:active { transform: scale(1.3); }
    .more-emoji-trigger { background: #333; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; cursor: pointer; }
    .menu-opt { padding: 16px; text-align: center; font-size: 1rem; border-bottom: 1px solid #333; color: #fff; }
    .menu-opt:active { background: #333; }
    
    #reply-dock { display: none; background: #111; padding: 12px 16px; border-top: 1px solid var(--border); justify-content: space-between; align-items: center; }

    .react-list-container { width: 85%; max-width: 340px; background: #1c1c1c; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; max-height: 50vh; }
    .react-list-header { padding: 16px; text-align: center; font-weight: 600; font-size: 1.1rem; border-bottom: 1px solid #333; position: relative; color: white;}
    .react-list-close { position: absolute; right: 16px; top: 16px; cursor: pointer; color: #888; }
    .reactor-item { display: flex; align-items: center; padding: 12px 16px; gap: 12px; border-bottom: 1px solid #2a2a2a; }
    .reactor-pfp { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; background: #333; }
    .reactor-info { flex: 1; }
    .reactor-name { font-weight: 600; font-size: 0.9rem; color: #fff; }
    .reactor-time { font-size: 0.7rem; color: #888; margin-top: 2px; }
    .reactor-emoji { font-size: 1.4rem; }

    /* REACTION HALF-SCREEN MODAL */
    #reaction-picker-modal {
        display: none; position: fixed; inset: 0; z-index: 3000;
        background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
        align-items: flex-end; /* Bottom alignment */
    }
    .picker-modal-content {
        width: 100%; height: 55vh; /* Half screen */
        background: #1c1c1c;
        border-top-left-radius: 20px; border-top-right-radius: 20px;
        display: flex; flex-direction: column;
        animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: hidden;
    }
    .picker-header {
        padding: 15px; display: flex; align-items: center; gap: 12px;
        border-bottom: 1px solid #333; color: white; font-weight: 600; font-size: 1rem;
    }
    .picker-drag-handle {
        width: 40px; height: 5px; background: #444; border-radius: 10px; margin: 0 auto;
    }

    /* NEW: Styles for Media Messages - FIXED VISIBILITY */
    .msg-media-wrapper {
        position: relative; /* Allows absolute positioning of badge */
        /* REMOVED overflow:hidden so reaction can stick out */
        cursor: pointer; 
        margin-bottom: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .chat-media-img {
        display: block; width: 100%; max-width: 280px; max-height: 350px; 
        object-fit: cover; 
        border-radius: 18px; /* Rounded corners handled here now */
        animation: imgFadeIn 0.4s ease-out; /* Feature: Smooth Fade In */
    }
    
    /* Corner logic since parent no longer clips */
    .received .chat-media-img { border-bottom-left-radius: 4px; }
    .sent .chat-media-img { border-bottom-right-radius: 4px; }

    /* When media is present, the caption bubble needs less padding at top or needs to be attached */
    .bubble.has-media {
        border-top-left-radius: 4px; border-top-right-radius: 4px;
        margin-top: 2px;
    }

    /* --- NEW STYLES FOR FILES/VIDEO/AUDIO --- */
    
    /* Video Container with Overlay Play Button */
    .msg-video-container {
        position: relative;
        max-width: 280px; border-radius: 18px;
        overflow: hidden;
    }
    .play-overlay {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 45px; height: 45px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,255,255,0.2);
        pointer-events: none; /* Click goes through to wrapper */
    }
    
    /* Audio Pill (Instagram Style) */
    .msg-audio-pill {
        display: flex; align-items: center; gap: 12px;
        padding: 12px 16px;
        background: #262626;
        border-radius: 22px;
        min-width: 220px;
        border: 1px solid rgba(255,255,255,0.1);
        position: relative;
    }
    .audio-control-btn {
        width: 32px; height: 32px;
        background: #fff; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        color: #000; cursor: pointer; flex-shrink: 0;
        z-index: 5;
    }
    
    /* VISUALIZER CSS */
    .audio-wave-container {
        flex: 1; display: flex; align-items: center; gap: 3px; height: 15px; overflow: hidden;
        position: relative;
    }
    .wave-bar {
        width: 3px; background: #666; border-radius: 2px;
        height: 100%; transition: height 0.1s;
        animation: none;
    }
    /* Fake Visualization Animation */
    .audio-playing .wave-bar {
        background: var(--accent);
        animation: waveAnim 0.8s ease-in-out infinite;
    }
    .audio-playing .wave-bar:nth-child(odd) { animation-duration: 0.6s; }
    .audio-playing .wave-bar:nth-child(2n) { animation-duration: 1.1s; }
    .audio-playing .wave-bar:nth-child(3n) { animation-duration: 0.9s; }
    
    @keyframes waveAnim { 0% { height: 20%; } 50% { height: 100%; } 100% { height: 20%; } }

    .audio-progress-track {
        position: absolute; bottom: -5px; left: 0; width: 100%; height: 2px; background: #444;
    }
    .audio-real-progress { height: 100%; background: #fff; width: 0%; transition: width 0.1s linear; }
    
    /* File Card */
    .msg-file-pill {
        display: flex; align-items: center; gap: 12px;
        padding: 12px 14px;
        background: #262626;
        border-radius: 16px;
        min-width: 200px; max-width: 260px;
        border: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
    }
    .file-icon {
        width: 40px; height: 40px;
        background: #333; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.4rem; flex-shrink: 0;
    }
    .file-details { flex: 1; min-width: 0; }
    .file-name {
        font-size: 0.9rem; font-weight: 500; color: #fff;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        margin-bottom: 2px;
    }
    .file-meta { font-size: 0.75rem; color: #888; }
    .file-dl-btn { color: #0095f6; font-size: 1.2rem; padding: 5px; }
    
</style>

</head>
<body>
<image-picker id="img-picker"></image-picker>
<file-picker id="file-picker"></file-picker>
<view-media id="media-viewer"></view-media>
<div id="heart-overlay">‚ù§Ô∏è</div>
<div id="scroll-down-btn" onclick="scrollToBottom()">‚¨á</div>
<div id="reaction-details-overlay" onclick="closeReactionDetails()">
<div class="react-list-container" onclick="event.stopPropagation()">
<div class="react-list-header">
Reactions
<div class="react-list-close" onclick="closeReactionDetails()">‚úï</div>
</div>
<div class="react-list-content" id="react-list-items"></div>
</div>
</div>
<div id="reaction-picker-modal" onclick="closeReactionPicker()">
<div class="picker-modal-content" onclick="event.stopPropagation()">
<div style="padding:10px 0 5px 0;"><div class="picker-drag-handle"></div></div>
<div class="picker-header">
<span onclick="closeReactionPicker()" style="font-size:1.2rem; cursor:pointer;">‚úï</span>
React
</div>
<div id="reaction-picker-container" style="flex:1; overflow:hidden;"></div>
</div>
</div>
<div id="menu-overlay" onclick="closeMenu()">
<div class="menu-card" id="main-menu-card" onclick="event.stopPropagation()">
<div class="reaction-bar">
<span onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
<span onclick="applyReaction('üòÇ')">üòÇ</span>
<span onclick="applyReaction('üòÆ')">üòÆ</span>
<span onclick="applyReaction('üò¢')">üò¢</span>
<span onclick="applyReaction('üëç')">üëç</span>
<div class="more-emoji-trigger" onclick="expandEmojiMenu()">+</div>
</div>
<div id="menu-emoji-grid"></div>
<div class="menu-opt" onclick="copyMessageText()">Copy Text</div>
<div class="menu-opt" onclick="initReplyFromActive()">Reply</div>
<div id="edit-btn" class="menu-opt" onclick="initEdit()">Edit</div>
<div id="unsend-btn" class="menu-opt" style="color:#ff3b30; font-weight: 600;" onclick="unsendMsg()">Unsend</div>
<div class="menu-opt" onclick="closeMenu()" style="border-bottom:none; color: #888">Cancel</div>
</div>
</div>
<div class="app-container" id="main-app">
<header id="chat-header">
<div class="back-btn" onclick="history.back()">‚Äπ</div>
<div class="h-profile-group" onclick="goToProfile()">
<div class="pfp-container">
<img id="h-pfp" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="h-pfp loading-shimmer">
<div class="online-dot" id="h-online-dot"></div>
</div>
<div class="h-info">
<div class="h-name-wrapper">
<div class="h-name" id="h-display-name"></div>
<img id="v-badge" src="https://img.icons8.com/color/48/verified-badge.png" class="v-badge">
</div>
<div class="h-username-sub" id="h-username-label"></div>
</div>
</div>
<div class="header-actions">
<svg class="header-icon" onclick="window.location.href='calls.html'" viewBox="0 0 24 24">
<path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 0 0-1.01.24l-1.57 1.97c-2.83-1.44-5.15-3.75-6.59-6.59l1.97-1.57c.22-.22.3-.54.24-1.01a11.36 11.36 0 0 1-.56-3.53c0-.55-.45-1-1-1H4.39c-.55 0-1 .45-1 1c0 9.39 7.61 17 17 17c.55 0 1-.45 1-1v-3.56c0-.55-.45-1-1-1z"/>
</svg>
<svg class="header-icon" onclick="window.location.href='calls.html'" viewBox="0 0 24 24">
<path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
</svg>
</div>
</header>
<div id="chat-flow">
    <div id="scroll-trigger"></div>
    <div id="messages-container"></div>
    <div id="typing-indicator-bottom">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    </div>
</div>

<div class="input-area-container">
    
    <div id="reply-dock">
        <div id="reply-text" style="font-size:0.8rem; color:#aaa; overflow:hidden; text-overflow:ellipsis;"></div>
        <div onclick="cancelInteraction()" style="color:#fff; font-weight:bold; padding:5px; cursor:pointer;">‚úï</div>
    </div>

    <div id="emoji-tray">
         <emoji-picker id="main-picker" style="width:100%; height:100%;"></emoji-picker>
    </div>

    <div id="attachment-menu">
        <div class="attach-opt" onclick="openCameraPicker()">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>Camera / Gallery</span>
        </div>
        <div class="attach-opt" onclick="openFilePicker()">
            <svg viewBox="0 0 24 24" style="fill:white;"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
            <span>File / Video</span>
        </div>
        <div class="attach-opt" onclick="toggleEmojiTray()">
            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
            <span>Emoji</span>
        </div>
    </div>

    <div class="input-area">
        <div class="plus-btn" onclick="toggleAttachmentMenu()">+</div>
        <div class="input-box" id="msg-input-box">
            <textarea id="m-input" class="msg-input" placeholder="Message..." rows="1"></textarea>
        </div>
        <button id="send-btn" class="send-btn">Send</button>
    </div>
</div>

</div>
<script>
// --- FIREBASE INIT ---
let fbConfig = {
apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
authDomain: "goorac-c3b59.firebaseapp.com",
projectId: "goorac-c3b59",
storageBucket: "goorac-c3b59.firebasestorage.app",
messagingSenderId: "746746595332",
appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
measurementId: "G-M46FEVRYSS",
databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
};
if (typeof CONFIG !== &#39;undefined&#39; &amp;&amp; CONFIG.firebase) {
    fbConfig = CONFIG.firebase;
}

if (!firebase.apps.length) {
    firebase.initializeApp(fbConfig);
}
const db = firebase.firestore();
const rdb = firebase.database();
const auth = firebase.auth();

const params = new URLSearchParams(window.location.search);
const targetUsername = params.get(&#39;user&#39;);
let myUid, targetUid, chatId, replyingTo = null, editModeId = null;
let activeMenuId = null, unsubscribe = null, isLoadingMore = false;
let lastVisible = null; 
let messagesMap = new Map(); 
let chatTargetData = null; 
let myUserData = null;
let isFirstLoad = true;
let statusTimeout = null;

// NEW: Variables for periodic status update
let lastStatusData = null;
let statusUpdateInterval = null;

// NEW: First load flag for header logic
let isFirstStatusLoad = true;

// Custom Feature: Sound Effect (Base64 Pop &amp; Like)
const popSound = new Audio(&quot;data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU&quot;); 
const likeSound = new Audio(&quot;data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU&quot;); 

const mInput = document.getElementById(&#39;m-input&#39;);
const inputBox = document.getElementById(&#39;msg-input-box&#39;);
const chatFlow = document.getElementById(&#39;chat-flow&#39;);
const container = document.getElementById(&#39;messages-container&#39;);
const bottomTyping = document.getElementById(&#39;typing-indicator-bottom&#39;);
const emojiTray = document.getElementById(&#39;emoji-tray&#39;);
const scrollBtn = document.getElementById(&#39;scroll-down-btn&#39;);
const sendBtnUI = document.getElementById(&#39;send-btn&#39;);
const onlineDot = document.getElementById(&#39;h-online-dot&#39;);
const headerSubLabel = document.getElementById(&#39;h-username-label&#39;);
const attachmentMenu = document.getElementById(&#39;attachment-menu&#39;);

// === 0MS INSTANT LOADING BLOCK ===
// This executes synchronously before any network requests
(function instantRender() {
    const storedMyUid = localStorage.getItem(&#39;my_uid_cache&#39;);
    const userCacheKey = `chat_user_${targetUsername}`;
    const storedUser = localStorage.getItem(userCacheKey);

    if (storedUser &amp;&amp; storedMyUid &amp;&amp; targetUsername) {
        try {
            // 1. Render Header Instantly
            chatTargetData = JSON.parse(storedUser);
            const pfp = document.getElementById(&#39;h-pfp&#39;);
            pfp.classList.remove(&#39;loading-shimmer&#39;);
            pfp.src = chatTargetData.photoURL || &#39;[https://via.placeholder.com/150](https://via.placeholder.com/150)&#39;;
            document.getElementById(&#39;h-display-name&#39;).innerText = chatTargetData.name || chatTargetData.username;
            document.getElementById(&#39;h-username-label&#39;).innerText = `@${chatTargetData.username}`;
            if(chatTargetData.verified === true) document.getElementById(&#39;v-badge&#39;).style.display = &#39;block&#39;;

            // 2. Calculate ChatID
            myUid = storedMyUid; // Temporarily set strictly for render
            targetUid = chatTargetData.uid;
            chatId = myUid &lt; targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;

            // 3. Render Messages Instantly
            const msgCacheKey = `chat_msgs_${chatId}`;
            const storedMsgs = localStorage.getItem(msgCacheKey);
            
            if (storedMsgs) {
                const msgs = JSON.parse(storedMsgs);
                msgs.forEach(m =&gt; {
                    m.timestamp = { toDate: () =&gt; new Date(m.timestampIso || m.timestamp) };
                    if(m.seenAtIso) m.seenAt = { toDate: () =&gt; new Date(m.seenAtIso) };
                    messagesMap.set(m.id || m.timestampIso, m);
                });
                
                // Add class to kill animations for instant feel
                document.body.classList.add(&#39;instant-load&#39;);
                renderAll();
                
                // Scroll to bottom immediately
                chatFlow.style.opacity = &#39;1&#39;;
                chatFlow.scrollTop = chatFlow.scrollHeight;
                isFirstLoad = false;
            }
        } catch(e) { console.error(&quot;Instant Load Error&quot;, e); }
    }
})();
// === END INSTANT LOAD ===

// NEW: Double Tap on Background to Scroll Down
document.addEventListener(&#39;dblclick&#39;, (e) =&gt; {
    if (e.target.id === &#39;chat-flow&#39; || e.target.id === &#39;messages-container&#39;) {
        scrollToBottom();
        vibrate(30);
    }
});

// NEW: Global Ripple Effect
document.addEventListener(&#39;click&#39;, function(e) {
    // Close attachment menu if clicking elsewhere
    if (!e.target.closest(&#39;#attachment-menu&#39;) &amp;&amp; !e.target.closest(&#39;.plus-btn&#39;)) {
        attachmentMenu.style.display = &#39;none&#39;;
    }
    
    if(e.target.tagName === &#39;INPUT&#39; || e.target.tagName === &#39;TEXTAREA&#39; || e.target.closest(&#39;emoji-picker&#39;)) return;
    const circle = document.createElement(&#39;div&#39;);
    circle.style.width = circle.style.height = &#39;15px&#39;;
    circle.style.left = `${e.clientX}px`;
    circle.style.top = `${e.clientY}px`;
    circle.classList.add(&#39;ripple&#39;);
    document.body.appendChild(circle);
    setTimeout(() =&gt; circle.remove(), 600);
});

// === KEYBOARD FIX: Prevent focus loss on Send Button ===
const handleSendClick = (e) =&gt; {
    e.preventDefault(); // Stop button from stealing focus
    sendMsg();
};

sendBtnUI.addEventListener(&#39;mousedown&#39;, handleSendClick);
sendBtnUI.addEventListener(&#39;touchstart&#39;, handleSendClick);

function formatTime12(date) {
    let hours = date.getHours();
    let minutes = date.getMinutes();
    let ampm = hours &gt;= 12 ? &#39;PM&#39; : &#39;AM&#39;;
    hours = hours % 12;
    hours = hours ? hours : 12;
    minutes = minutes &lt; 10 ? &#39;0&#39;+minutes : minutes;
    return hours + &#39;:&#39; + minutes + &#39; &#39; + ampm;
}

// Helper for &quot;Seen 1m ago&quot; &amp; Active status
function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = seconds / 31536000;
    if (interval &gt; 1) return Math.floor(interval) + &quot;y ago&quot;;
    interval = seconds / 2592000;
    if (interval &gt; 1) return Math.floor(interval) + &quot;mo ago&quot;;
    interval = seconds / 86400;
    if (interval &gt; 1) return Math.floor(interval) + &quot;d ago&quot;;
    interval = seconds / 3600;
    if (interval &gt; 1) return Math.floor(interval) + &quot;h ago&quot;;
    interval = seconds / 60;
    if (interval &gt; 1) return Math.floor(interval) + &quot;m ago&quot;;
    return &quot;Just now&quot;;
}

function formatActiveTime(timestamp) {
    if (!timestamp) return &quot;&quot;;
    const now = Date.now();
    const diff = now - timestamp;
    if (diff &lt; 60000) return &quot;Active now&quot;;
    return &quot;Active &quot; + timeAgo(new Date(timestamp));
}

function getDateDivider(date) {
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);
    if (date.toDateString() === today.toDateString()) return &quot;Today&quot;;
    if (date.toDateString() === yesterday.toDateString()) return &quot;Yesterday&quot;;
    return date.toLocaleDateString(&#39;en-US&#39;, { month: &#39;long&#39;, day: &#39;numeric&#39;, year: &#39;numeric&#39; });
}

// Auto-resize textarea &amp; Send Button Animation
mInput.addEventListener(&#39;input&#39;, function() {
    this.style.height = &#39;auto&#39;; 
    this.style.height = (this.scrollHeight) + &#39;px&#39;;
    if(this.value === &#39;&#39;) this.style.height = &#39;auto&#39;;
    
    if(this.value.trim().length &gt; 0) {
        sendBtnUI.classList.add(&#39;active&#39;);
    } else {
        sendBtnUI.classList.remove(&#39;active&#39;);
    }

    rdb.ref(`typing/${chatId}/${myUid}`).set(this.value.trim().length &gt; 0);
    
    // Own Feature: Auto-Scroll on Typing
    if(chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight &lt; 100) {
          scrollToBottom();
    }
});

// Handle Enter key - Modified as per request
mInput.addEventListener(&#39;keydown&#39;, (e) =&gt; {
    // Enter creates new line, so we do nothing here (default behavior)
    // Only explicitly shift+enter might be useful, but standard Enter = Next Line
});

// --- SCROLL BUTTON VISIBILITY LOGIC ---
chatFlow.addEventListener(&#39;scroll&#39;, () =&gt; {
    const diff = chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight;
    if (diff &gt; 250) {
        scrollBtn.style.display = &#39;flex&#39;;
    } else {
        scrollBtn.style.display = &#39;none&#39;;
        scrollBtn.classList.remove(&#39;new-msg&#39;);
    }
});

// --- FIX: ALLOW PASTE BUT DISABLE RIGHT CLICK ELSEWHERE ---
window.oncontextmenu = (e) =&gt; { 
    if(e.target.tagName === &#39;INPUT&#39; || e.target.tagName === &#39;TEXTAREA&#39;) return true;
    e.preventDefault(); 
    return false; 
};

// --- COMPONENT INTEGRATION ---
const mainPicker = document.getElementById(&#39;main-picker&#39;);
const imagePickerComponent = document.getElementById(&#39;img-picker&#39;);
const filePickerComponent = document.getElementById(&#39;file-picker&#39;);
const mediaViewerComponent = document.getElementById(&#39;media-viewer&#39;);

if(mainPicker) {
    mainPicker.addEventListener(&#39;emoji-click&#39;, event =&gt; {
        const emoji = event.detail.emoji || event.detail.unicode; 
        mInput.value += emoji;
        mInput.focus();
        mInput.dispatchEvent(new Event(&#39;input&#39;));
    });
}

// NEW: Image Picker Listener - DIRECT SEND
if (imagePickerComponent) {
    imagePickerComponent.addEventListener(&#39;image-uploaded&#39;, (e) =&gt; {
        const url = e.detail.url;
        if (url) {
            // Immediately send the message with the image
            sendImageMessage(url);
        }
    });
}

// NEW: File Picker Listener
if (filePickerComponent) {
    filePickerComponent.addEventListener(&#39;file-uploaded&#39;, (e) =&gt; {
        const { url, metadata } = e.detail;
        if (url) {
            sendFileMessage(url, metadata);
        }
    });
}

function toggleAttachmentMenu() {
    if (attachmentMenu.style.display === &#39;flex&#39;) {
        attachmentMenu.style.display = &#39;none&#39;;
    } else {
        emojiTray.style.display = &#39;none&#39;; // Close emoji if open
        attachmentMenu.style.display = &#39;flex&#39;;
    }
}

function openCameraPicker() {
    attachmentMenu.style.display = &#39;none&#39;;
    if (imagePickerComponent) {
        imagePickerComponent.openPicker();
    }
}

function openFilePicker() {
    attachmentMenu.style.display = &#39;none&#39;;
    if (filePickerComponent) {
        filePickerComponent.openPicker();
    }
}

function toggleEmojiTray() {
    attachmentMenu.style.display = &#39;none&#39;; // Close menu if open
    if (emojiTray.style.display === &#39;block&#39;) {
        emojiTray.style.display = &#39;none&#39;;
    } else {
        emojiTray.style.display = &#39;block&#39;;
    }
    scrollToBottom();
}

// Reaction Picker Logic (Half Screen Modal Component)
// Updated to ensure component usage for reactions
function expandEmojiMenu() {
    closeMenu();
    const reactionModal = document.getElementById(&#39;reaction-picker-modal&#39;);
    const container = document.getElementById(&#39;reaction-picker-container&#39;);
    container.innerHTML = &#39;&#39;; 
    
    // Dynamically create the component
    const reactionPicker = document.createElement(&#39;emoji-picker&#39;);
    reactionPicker.style.width = &quot;100%&quot;;
    reactionPicker.style.height = &quot;100%&quot;;
    reactionPicker.addEventListener(&#39;emoji-click&#39;, event =&gt; {
         const emoji = event.detail.emoji || event.detail.unicode;
         applyReaction(emoji);
         closeReactionPicker(); // Auto-close on selection (Fast Interaction)
    });
    container.appendChild(reactionPicker);
    reactionModal.style.display = &#39;flex&#39;;
}

function closeReactionPicker() {
    document.getElementById(&#39;reaction-picker-modal&#39;).style.display = &#39;none&#39;;
}

if (window.visualViewport) {
    window.visualViewport.addEventListener(&#39;resize&#39;, () =&gt; {
        const viewportHeight = window.visualViewport.height;
        document.getElementById(&#39;main-app&#39;).style.height = viewportHeight + &#39;px&#39;;
        document.body.style.top = window.visualViewport.offsetTop + &#39;px&#39;;
        scrollToBottom();
    });
}

function vibrate(ms = 50) { if (navigator.vibrate) navigator.vibrate(ms); }

function goToProfile() {
    if(targetUsername) window.location.href = `userProfile.html?user=${targetUsername}`;
}

mInput.addEventListener(&quot;focus&quot;, () =&gt; { emojiTray.style.display = &#39;none&#39;; attachmentMenu.style.display = &#39;none&#39;; });

// === UPDATED: Function to update header UI based on latest data ===
function updateHeaderStatus() {
    if (!lastStatusData) return;
    
    // Check typing status first (priority)
    const isTyping = bottomTyping.style.display === &#39;flex&#39;;
    if (isTyping) return; // Don&#39;t overwrite &quot;Typing...&quot;

    // PRIVACY LOGIC: Check both users
    const amIHidden = myUserData?.showActivityStatus === false;
    const isTheyHidden = chatTargetData?.showActivityStatus === false;

    if (amIHidden || isTheyHidden) {
        // If either user has hidden status, show only username, no dot
        onlineDot.style.display = &#39;none&#39;;
        headerSubLabel.innerText = `@${chatTargetData.username}`;
        headerSubLabel.style.color = &quot;var(--text-secondary)&quot;;
        return;
    }

    if (lastStatusData.state === &#39;online&#39;) {
        onlineDot.style.display = &#39;block&#39;;
        headerSubLabel.innerText = &quot;Active now&quot;;
        headerSubLabel.style.color = &quot;#00e676&quot;;
    } else {
        onlineDot.style.display = &#39;none&#39;;
        headerSubLabel.innerText = formatActiveTime(lastStatusData.last_changed);
        headerSubLabel.style.color = &quot;var(--text-secondary)&quot;;
    }
}

function monitorTargetStatus() {
    if (!targetUid) return;
    
    // Clear any existing interval
    if (statusUpdateInterval) clearInterval(statusUpdateInterval);

    // Start interval to refresh time every 60s
    statusUpdateInterval = setInterval(() =&gt; {
        if (!isFirstStatusLoad) {
            updateHeaderStatus();
        }
    }, 60000);

    rdb.ref(&#39;/status/&#39; + targetUid).on(&#39;value&#39;, (snapshot) =&gt; {
        lastStatusData = snapshot.val();
        
        // Only update immediately if not typing
        if (statusTimeout) clearTimeout(statusTimeout);
        
        // Initial simple state
        if (!lastStatusData) {
           headerSubLabel.innerText = `@${chatTargetData.username}`;
           headerSubLabel.style.color = &quot;var(--text-secondary)&quot;;
           return;
        }

        // === NEW LOGIC: SHOW USERNAME FIRST 3 SECONDS ===
        if (isFirstStatusLoad) {
            // Force show username
            headerSubLabel.innerText = `@${chatTargetData.username}`;
            headerSubLabel.style.color = &quot;var(--text-secondary)&quot;;
            onlineDot.style.display = &#39;none&#39;;

            // Wait 3 seconds, then switch to live status
            statusTimeout = setTimeout(() =&gt; {
                isFirstStatusLoad = false;
                updateHeaderStatus(); 
            }, 3000);
        } else {
            // Normal live update
            if(bottomTyping.style.display !== &#39;flex&#39;) {
                // Small delay to prevent jitter
                statusTimeout = setTimeout(() =&gt; {
                    updateHeaderStatus();
                }, 500); 
            }
        }
    });
}

auth.onAuthStateChanged(user =&gt; {
    if (user) { 
        myUid = user.uid; 
        // Save UID for next instant load
        localStorage.setItem(&#39;my_uid_cache&#39;, myUid);
        
        db.collection(&#39;users&#39;).doc(myUid).get().then(doc =&gt; {
             if (doc.exists) myUserData = doc.data();
        });
        // setupMyPresence removed in favor of presence.js component
        initChat(); 
    }
    else { window.location.href = &#39;login.html&#39;; }
});

async function initChat() {
    if(!targetUsername) return;

    // --- CACHE LAYER: INSTANT LOAD USER DATA ---
    const cacheKeyUser = `chat_user_${targetUsername}`;
    // Note: Cache loading now handled in the immediate block above, 
    // but we still do a fresh fetch here to update any changes.
    
    const snap = await db.collection(&quot;users&quot;).where(&quot;username&quot;, &quot;==&quot;, targetUsername).get();
    if (snap.empty) return;
    
    // Update Data from Network
    targetUid = snap.docs[0].id;
    chatTargetData = snap.docs[0].data();
    chatTargetData.uid = targetUid; // Append UID for cache usage next time
    
    // SAVE USER TO CACHE
    localStorage.setItem(cacheKeyUser, JSON.stringify(chatTargetData));

    chatId = myUid &lt; targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
    
    // If no cache hit happened, update UI now
    if (!messagesMap.size) {
        const pfp = document.getElementById(&#39;h-pfp&#39;);
        pfp.classList.remove(&#39;loading-shimmer&#39;);
        pfp.src = chatTargetData.photoURL || &#39;[https://via.placeholder.com/150](https://via.placeholder.com/150)&#39;;
        document.getElementById(&#39;h-display-name&#39;).innerText = chatTargetData.name || chatTargetData.username;
        document.getElementById(&#39;h-username-label&#39;).innerText = `@${chatTargetData.username}`;
        if(chatTargetData.verified === true) document.getElementById(&#39;v-badge&#39;).style.display = &#39;block&#39;;
    }

    monitorTargetStatus();

    db.collection(&quot;chats&quot;).doc(chatId).update({ 
        [`unreadCount.${myUid}`]: 0, 
        seen: true 
    }).catch(e =&gt; {});

    rdb.ref(`typing/${chatId}/${targetUid}`).on(&#39;value&#39;, (s) =&gt; {
        const isTyping = s.val();
        bottomTyping.style.display = isTyping ? &#39;flex&#39; : &#39;none&#39;;
        if(isTyping) {
            if (statusTimeout) clearTimeout(statusTimeout);
            headerSubLabel.innerText = &quot;Typing...&quot;;
            headerSubLabel.style.color = &quot;#00e676&quot;;
            scrollToBottom();
        } else {
            updateHeaderStatus(); // Revert to status
        }
    });

    startListener(); 
    setupObserver();
    setupGlobalSlide(); 
}

// --- INSTAGRAM STYLE TIME REVEAL LOGIC ---
function setupGlobalSlide() {
    let startX = 0, currentX = 0, isDragging = false;
    const container = document.getElementById(&#39;messages-container&#39;);

    chatFlow.addEventListener(&#39;touchstart&#39;, (e) =&gt; {
        startX = e.touches[0].clientX;
        isDragging = false;
    }, {passive: true});

    chatFlow.addEventListener(&#39;touchmove&#39;, (e) =&gt; {
        currentX = e.touches[0].clientX;
        const diff = currentX - startX;
        if (diff &lt; -10) { 
            isDragging = true;
            const translate = Math.max(diff, -70);
            container.style.transform = `translateX(${translate}px)`;
            container.style.transition = &#39;none&#39;;
        }
    }, {passive: true});

    chatFlow.addEventListener(&#39;touchend&#39;, (e) =&gt; {
        if (isDragging) {
            container.style.transition = &#39;transform 0.2s cubic-bezier(0.215, 0.610, 0.355, 1.000)&#39;;
            container.style.transform = `translateX(0px)`;
        }
        startX = 0; currentX = 0; isDragging = false;
    });
}

function setupObserver() {
    const observer = new IntersectionObserver((entries) =&gt; {
        if (entries[0].isIntersecting &amp;&amp; !isLoadingMore &amp;&amp; lastVisible) {
            loadMoreMessages();
        }
    }, { root: chatFlow, threshold: 0.5 });
    observer.observe(document.getElementById(&#39;scroll-trigger&#39;));
}

// Helper to Save Messages to LocalStorage
function saveMessagesToCache() {
    if (!chatId) return;
    try {
        const msgsToSave = Array.from(messagesMap.values()).map(m =&gt; {
            // Clone and convert timestamp objects to ISO strings for storage
            let savedM = { ...m };
            if (m.timestamp &amp;&amp; typeof m.timestamp.toDate === &#39;function&#39;) {
                savedM.timestampIso = m.timestamp.toDate().toISOString();
            }
            if (m.seenAt &amp;&amp; typeof m.seenAt.toDate === &#39;function&#39;) {
                savedM.seenAtIso = m.seenAt.toDate().toISOString();
            }
            // Don&#39;t store the complex object
            delete savedM.timestamp; 
            delete savedM.seenAt;
            return savedM;
        });
        // Sort to ensure order
        msgsToSave.sort((a, b) =&gt; new Date(a.timestampIso) - new Date(b.timestampIso));
        // Limit cache size to last 50 messages to prevent overflow
        const limitMsgs = msgsToSave.slice(-50); 
        localStorage.setItem(`chat_msgs_${chatId}`, JSON.stringify(limitMsgs));
    } catch (e) { console.error(&quot;Cache Save Error&quot;, e); }
}

function startListener() {
    if (unsubscribe) unsubscribe();
    
    unsubscribe = db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;)
        .orderBy(&quot;timestamp&quot;, &quot;desc&quot;)
        .limit(20)
        .onSnapshot(snapshot =&gt; {
            if (snapshot.empty) return;
            
            if (!lastVisible) lastVisible = snapshot.docs[snapshot.docs.length - 1];
            let isNewIncoming = false;

            snapshot.docChanges().forEach(change =&gt; {
                const msgData = change.doc.data();
                const msgId = change.doc.id;
                msgData.id = msgId; // Append ID
                
                if (change.type === &quot;added&quot;) {
                    messagesMap.set(msgId, msgData);
                    if(msgData.sender !== myUid) isNewIncoming = true;
                } else if (change.type === &quot;modified&quot;) {
                    messagesMap.set(msgId, msgData);
                } else if (change.type === &quot;removed&quot;) {
                    messagesMap.delete(msgId);
                }
                
                if(msgData.sender !== myUid &amp;&amp; !msgData.seen) {
                    db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;).doc(msgId).update({ 
                        seen: true,
                        seenAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                }
            });

            if(isNewIncoming) { 
                vibrate(20);
                if(chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight &gt; 250) {
                    scrollBtn.classList.add(&#39;new-msg&#39;);
                }
            }

            // Initial Load Instant Jump
            if (isFirstLoad) {
                renderAll();
                chatFlow.scrollTop = chatFlow.scrollHeight;
                setTimeout(() =&gt; {
                    chatFlow.style.opacity = &#39;1&#39;;
                    isFirstLoad = false;
                }, 50);
            } else {
                const isNearBottom = chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight &lt; 300;
                renderAll();
                if (isNearBottom || isNewIncoming &amp;&amp; isNearBottom) {
                    scrollToBottom();
                }
            }
            
            // SAVE TO CACHE AFTER UPDATE
            saveMessagesToCache();
        });
}

async function loadMoreMessages() {
    if (isLoadingMore || !lastVisible) return;
    isLoadingMore = true;
    
    // CAPTURE SCROLL POS
    chatFlow.style.scrollBehavior = &#39;auto&#39;; // Disable smooth for instant jump
    const oldScrollHeight = chatFlow.scrollHeight;
    
    const snapshot = await db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;)
        .orderBy(&quot;timestamp&quot;, &quot;desc&quot;)
        .startAfter(lastVisible)
        .limit(15)
        .get();

    if (!snapshot.empty) {
        snapshot.forEach(doc =&gt; { 
            let d = doc.data(); 
            d.id = doc.id; 
            messagesMap.set(doc.id, d); 
        });
        lastVisible = snapshot.docs[snapshot.docs.length - 1];
        renderAll();
        
        // ADJUST SCROLL POSITION INSTANTLY
        chatFlow.scrollTop = chatFlow.scrollHeight - oldScrollHeight;
        
        // Re-enable smooth after a tick
        setTimeout(() =&gt; { chatFlow.style.scrollBehavior = &#39;smooth&#39;; }, 50);
        
        isLoadingMore = false;
    } else {
        isLoadingMore = false;
        lastVisible = null; 
    }
}

function renderAll() {
    container.innerHTML = &#39;&#39;;
    const sorted = Array.from(messagesMap.entries())
        .filter(([id, data]) =&gt; data.timestamp) 
        .sort((a, b) =&gt; {
            // Robust sort handling for both Firestore Object and Cache Object
            const tA = (data =&gt; data.timestamp.toMillis ? data.timestamp.toMillis() : new Date(data.timestampIso).getTime());
            const tB = (data =&gt; data.timestamp.toMillis ? data.timestamp.toMillis() : new Date(data.timestampIso).getTime());
            return tA(a[1]) - tB(b[1]);
        });

    let lastDateLabel = &quot;&quot;;

    // Logic for Last Seen
    let lastSeenMsgId = null;
    for (let i = sorted.length - 1; i &gt;= 0; i--) {
        const [id, data] = sorted[i];
        if (data.sender === myUid &amp;&amp; data.seen === true) {
            lastSeenMsgId = id;
            break; 
        }
    }
    
    // Own Feature: Logic for grouping times
    let lastTimeStr = &quot;&quot;;
    let lastSender = &quot;&quot;;

    sorted.forEach(([id, data], index) =&gt; { 
        const msgDate = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestampIso);
        const dateLabel = getDateDivider(msgDate);
        const timeStr = formatTime12(msgDate);
        
        if (dateLabel !== lastDateLabel) {
            const div = document.createElement(&#39;div&#39;);
            div.className = &quot;date-divider&quot;;
            div.innerText = dateLabel;
            container.appendChild(div);
            lastDateLabel = dateLabel;
        }

        // --- SMART PROFILE PICTURE LOGIC ---
        let isLastInGroup = true;
        let showTime = true;

        if (index + 1 &lt; sorted.length) {
            const nextMsg = sorted[index + 1][1];
            if (nextMsg.sender === data.sender) {
                isLastInGroup = false;
                // Own Feature: If same minute and same sender, hide time on first msg
                const nextDate = nextMsg.timestamp.toDate ? nextMsg.timestamp.toDate() : new Date(nextMsg.timestampIso);
                if (formatTime12(nextDate) === timeStr) {
                     // We could hide time here, but CSS handles absolute positioning well.
                     // Let&#39;s keep it visible for slide-to-reveal.
                }
            }
        }

        renderMessage(data, id, id === lastSeenMsgId, isLastInGroup); 
    });
}

function triggerHeartAnimation() {
    const h = document.getElementById(&#39;heart-overlay&#39;);
    h.style.animation = &#39;none&#39;;
    h.offsetHeight; 
    h.style.animation = &#39;heartPop 0.8s ease-out&#39;;
    likeSound.play().catch(e =&gt; {}); 
}

// Own Feature: Link Detection
function linkify(text) {
    if (!text) return &quot;&quot;;
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function(url) {
        return `&lt;a onclick=&quot;event.stopPropagation(); window.open(&#39;${url}&#39;, &#39;_blank&#39;)&quot;&gt;${url}&lt;/a&gt;`;
    });
}

function scrollToAndFlash(textSnippet) {
    const bubbles = document.querySelectorAll(&#39;.bubble span&#39;);
    let targetId = null;
    for(let span of bubbles) {
        if(span.innerText.includes(textSnippet)) {
            targetId = span.id.replace(&#39;text-&#39;, &#39;&#39;);
            break;
        }
    }
    if(targetId) {
        const el = document.getElementById(targetId);
        if(el) {
            el.scrollIntoView({ behavior: &#39;smooth&#39;, block: &#39;center&#39; });
            const bubble = el.querySelector(&#39;.bubble&#39;) || el.closest(&#39;.bubble&#39;);
            if(bubble) {
                bubble.style.animation = &#39;none&#39;;
                bubble.offsetHeight; 
                bubble.style.animation = &#39;flashMessage 1s ease&#39;;
            }
        }
    }
}

function renderMessage(m, id, isLastSeen, isLastInGroup) {
    const side = m.sender === myUid ? &#39;sent&#39; : &#39;received&#39;;
    const date = m.timestamp.toDate ? m.timestamp.toDate() : new Date(m.timestampIso);

    const rowDiv = document.createElement(&#39;div&#39;);
    rowDiv.id = id;
    rowDiv.className = `msg-row ${side}`;
    
    let reactionsList = [];
    let myReaction = null;
    if (m.reactions) {
        reactionsList = Object.values(m.reactions);
        if (m.reactions[myUid]) myReaction = m.reactions[myUid].emoji;
    }
    const reactionDisplay = reactionsList.map(r =&gt; r.emoji).join(&#39; &#39;);

    let seenText = &quot;&quot;;
    if (isLastSeen &amp;&amp; side === &#39;sent&#39;) {
        if (m.seenAt) {
            const sDate = m.seenAt.toDate ? m.seenAt.toDate() : new Date(m.seenAtIso);
            seenText = &quot;Seen &quot; + timeAgo(sDate);
        } else {
            seenText = &quot;Seen&quot;; 
        }
    }
    
    const boxStyle = reactionDisplay ? &#39;style=&quot;margin-bottom: 14px&quot;&#39; : &#39;&#39;;
    const replyHtml = m.replyTo ? `&lt;div class=&quot;reply-box-ui&quot; onclick=&quot;event.stopPropagation(); scrollToAndFlash(&#39;${m.replyTo}&#39;)&quot;&gt;‚§¥ ${m.replyTo}&lt;/div&gt;` : &#39;&#39;;

    // NEW: Unique Instagram-like Note Reply UI
    const noteReplyHtml = m.replyToNote ? `
        &lt;div class=&quot;note-reply-wrapper&quot;&gt;
            &lt;div class=&quot;note-reply-pill&quot; style=&quot;background: ${m.noteMetadata ? (m.noteMetadata.bgColor || &#39;#262626&#39;) : &#39;#262626&#39;}; color: ${m.noteMetadata ? (m.noteMetadata.textColor || &#39;#fff&#39;) : &#39;#fff&#39;}&quot;&gt;
                &lt;div class=&quot;note-header-row&quot;&gt;
                    &lt;img src=&quot;${m.noteMetadata &amp;&amp; m.noteMetadata.pfp ? m.noteMetadata.pfp : (chatTargetData ? chatTargetData.photoURL : &#39;[https://via.placeholder.com/20](https://via.placeholder.com/20)&#39;)}&quot; class=&quot;note-mini-pfp&quot;&gt;
                    &lt;span class=&quot;note-label&quot;&gt;Replied to note&lt;/span&gt;
                &lt;/div&gt;
                &lt;div class=&quot;note-content-text&quot;&gt;&quot;${m.replyToNote}&quot;&lt;/div&gt;
                ${m.noteMetadata &amp;&amp; m.noteMetadata.songName ? `
                &lt;div class=&quot;note-song-tag&quot;&gt;
                    &lt;svg viewBox=&quot;0 0 24 24&quot; style=&quot;width:10px; fill:currentColor&quot;&gt;&lt;path d=&quot;M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4 4 4 4-1.79 4-4V7h4V3h-6z&quot;/&gt;&lt;/svg&gt;
                    &lt;span&gt;${m.noteMetadata.songName}&lt;/span&gt;
                &lt;/div&gt;` : &#39;&#39;}
            &lt;/div&gt;
            &lt;div class=&quot;note-connector&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
    ` : &#39;&#39;;

    // --- MEDIA TYPES LOGIC ---
    let mediaHtml = &#39;&#39;;
    let bubbleClass = &#39;bubble&#39;;
    let bubbleStyle = &#39;&#39;;

    // 1. IMAGE (Existing)
    if (m.imageUrl) {
        const imgClass = side === &#39;sent&#39; ? &#39;sent-media-img&#39; : &#39;received-media-img&#39;;
        mediaHtml = `
        &lt;div class=&quot;msg-media-wrapper&quot; onclick=&quot;document.getElementById(&#39;media-viewer&#39;).open(&#39;${m.imageUrl}&#39;)&quot;&gt;
            &lt;img src=&quot;${m.imageUrl}&quot; class=&quot;chat-media-img ${imgClass}&quot;&gt;
            &lt;div id=&quot;react-${id}&quot; class=&quot;reaction-badge&quot; onclick=&quot;showReactionDetails(&#39;${id}&#39;, event)&quot; style=&quot;${reactionDisplay ? &#39;display:block&#39; : &#39;&#39;}&quot;&gt;${reactionDisplay}&lt;/div&gt;
        &lt;/div&gt;`;
        bubbleClass = &quot;bubble has-media&quot;;
        if(!m.text) bubbleStyle = &quot;display:none;&quot;;
    } 
    // 2. VIDEO
    else if (m.fileUrl &amp;&amp; m.fileMeta &amp;&amp; m.fileMeta.type.includes(&#39;video&#39;)) {
        mediaHtml = `
        &lt;div class=&quot;msg-video-container&quot; onclick=&quot;document.getElementById(&#39;media-viewer&#39;).open(&#39;${m.fileUrl}&#39;, &#39;video&#39;)&quot;&gt;
            &lt;video src=&quot;${m.fileUrl}#t=0.5&quot; class=&quot;chat-media-img&quot; style=&quot;object-fit:cover; width:100%; height:200px; background:#000;&quot; preload=&quot;metadata&quot;&gt;&lt;/video&gt;
            &lt;div class=&quot;play-overlay&quot;&gt;&lt;svg viewBox=&quot;0 0 24 24&quot; fill=&quot;white&quot; style=&quot;width:24px; height:24px;&quot;&gt;&lt;path d=&quot;M8 5v14l11-7z&quot;/&gt;&lt;/svg&gt;&lt;/div&gt;
            &lt;div id=&quot;react-${id}&quot; class=&quot;reaction-badge&quot; onclick=&quot;showReactionDetails(&#39;${id}&#39;, event)&quot; style=&quot;${reactionDisplay ? &#39;display:block&#39; : &#39;&#39;}&quot;&gt;${reactionDisplay}&lt;/div&gt;
        &lt;/div&gt;`;
        bubbleClass = &quot;bubble has-media&quot;;
        if(!m.text) bubbleStyle = &quot;display:none;&quot;;
    }
    // 3. AUDIO (Instagram Style + VISUALIZER FIX)
    else if (m.fileUrl &amp;&amp; m.fileMeta &amp;&amp; m.fileMeta.type.includes(&#39;audio&#39;)) {
        const safeId = &#39;audio-&#39; + id;
        mediaHtml = `
        &lt;div class=&quot;msg-audio-pill&quot; id=&quot;pill-${safeId}&quot;&gt;
            &lt;div class=&quot;audio-control-btn&quot; onclick=&quot;event.stopPropagation(); toggleAudio(&#39;${safeId}&#39;)&quot;&gt;
                &lt;svg id=&quot;icon-${safeId}&quot; viewBox=&quot;0 0 24 24&quot; style=&quot;width:18px; fill:#000;&quot;&gt;&lt;path d=&quot;M8 5v14l11-7z&quot;/&gt;&lt;/svg&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;audio-wave-container&quot; id=&quot;wave-${safeId}&quot;&gt;
                &lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;&lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;&lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;&lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;&lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;&lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;&lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;&lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;&lt;div class=&quot;wave-bar&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;audio-progress-track&quot;&gt;
                    &lt;div id=&quot;prog-${safeId}&quot; class=&quot;audio-real-progress&quot;&gt;&lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;audio id=&quot;${safeId}&quot; src=&quot;${m.fileUrl}&quot; ontimeupdate=&quot;updateAudioUI(&#39;${safeId}&#39;)&quot; onended=&quot;resetAudioUI(&#39;${safeId}&#39;)&quot;&gt;&lt;/audio&gt;
            &lt;div id=&quot;react-${id}&quot; class=&quot;reaction-badge&quot; style=&quot;position:absolute; bottom:-8px; right:10px; ${reactionDisplay ? &#39;display:block&#39; : &#39;&#39;}&quot; onclick=&quot;showReactionDetails(&#39;${id}&#39;, event)&quot;&gt;${reactionDisplay}&lt;/div&gt;
        &lt;/div&gt;`;
        // Audio usually doesn&#39;t have caption in this style, or it sits below
        bubbleClass = &quot;bubble has-media&quot;; 
        if(!m.text) bubbleStyle = &quot;display:none;&quot;;
    }
    // 4. DOCUMENT
    else if (m.fileUrl) {
        mediaHtml = `
        &lt;div class=&quot;msg-file-pill&quot; onclick=&quot;window.open(&#39;${m.fileUrl}&#39;, &#39;_blank&#39;)&quot;&gt;
            &lt;div class=&quot;file-icon&quot;&gt;üìÑ&lt;/div&gt;
            &lt;div class=&quot;file-details&quot;&gt;
                &lt;div class=&quot;file-name&quot;&gt;${m.fileMeta.name || &quot;File&quot;}&lt;/div&gt;
                &lt;div class=&quot;file-meta&quot;&gt;${(m.fileMeta.size / (1024*1024)).toFixed(2)} MB ‚Ä¢ ${m.fileMeta.type.toUpperCase()}&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;file-dl-btn&quot;&gt;‚¨á&lt;/div&gt;
            &lt;div id=&quot;react-${id}&quot; class=&quot;reaction-badge&quot; style=&quot;right:0; ${reactionDisplay ? &#39;display:block&#39; : &#39;&#39;}&quot; onclick=&quot;showReactionDetails(&#39;${id}&#39;, event)&quot;&gt;${reactionDisplay}&lt;/div&gt;
        &lt;/div&gt;`;
        bubbleClass = &quot;bubble has-media&quot;;
        if(!m.text) bubbleStyle = &quot;display:none;&quot;;
    }

    // --- HTML ASSEMBLY ---
    const safeText = linkify(m.text);
    let innerHTML = &#39;&#39;;
    
    // Base content block
    let contentHTML = `
        ${noteReplyHtml}
        ${replyHtml}
        ${mediaHtml}
        &lt;div class=&quot;${bubbleClass}&quot; id=&quot;bubble-${id}&quot; style=&quot;${bubbleStyle}&quot;&gt;
            &lt;span id=&quot;text-${id}&quot;&gt;${safeText} ${m.edited ? &#39;&lt;small style=&quot;opacity:0.4;font-size:0.6rem&quot;&gt; (edited)&lt;/small&gt;&#39; : &#39;&#39;}&lt;/span&gt;
            ${(!m.imageUrl &amp;&amp; !m.fileUrl) ? `&lt;div id=&quot;react-${id}&quot; class=&quot;reaction-badge&quot; onclick=&quot;showReactionDetails(&#39;${id}&#39;, event)&quot; style=&quot;${reactionDisplay ? &#39;display:block&#39; : &#39;&#39;}&quot;&gt;${reactionDisplay}&lt;/div&gt;` : &#39;&#39;}
        &lt;/div&gt;
    `;

    if (side === &#39;received&#39;) {
        const pfpUrl = chatTargetData ? chatTargetData.photoURL : &#39;[https://via.placeholder.com/30](https://via.placeholder.com/30)&#39;;
        const visibility = isLastInGroup ? &#39;visible&#39; : &#39;hidden&#39;;
        innerHTML = `
            &lt;div class=&quot;received-inner-row&quot;&gt;
                &lt;img src=&quot;${pfpUrl}&quot; class=&quot;msg-avatar&quot; style=&quot;visibility: ${visibility}&quot;&gt;
                &lt;div class=&quot;msg-bubble-box&quot; ${boxStyle}&gt;
                    ${contentHTML}
                &lt;/div&gt;
            &lt;/div&gt;`;
    } else {
        innerHTML = `
            &lt;div class=&quot;msg-bubble-box&quot; ${boxStyle}&gt;
                ${contentHTML}
            &lt;/div&gt;`;
    }

    rowDiv.innerHTML = `
        ${innerHTML}
        ${seenText ? `&lt;div class=&quot;seen-status&quot;&gt;${seenText}&lt;/div&gt;` : &#39;&#39;}
        &lt;div class=&quot;sliding-timestamp&quot;&gt;${formatTime12(date)}&lt;/div&gt;
    `;
    container.appendChild(rowDiv);

    // Listeners for text bubbles
    const bubbleEl = rowDiv.querySelector(`#bubble-${id}`);
    if(bubbleEl &amp;&amp; bubbleEl.style.display !== &#39;none&#39;) {
        attachMessageListeners(bubbleEl, id, m);
    }
    
    // Listeners for Wrappers (Media)
    if(m.imageUrl || (m.fileUrl &amp;&amp; m.fileMeta.type.includes(&#39;video&#39;))) {
         const mediaEl = rowDiv.querySelector(&#39;.msg-media-wrapper&#39;) || rowDiv.querySelector(&#39;.msg-video-container&#39;);
         if(mediaEl) attachMessageListeners(mediaEl, id, m);
    }
    // Listeners for Audio/File pills
    if(m.fileUrl &amp;&amp; (m.fileMeta.type.includes(&#39;audio&#39;) || m.fileMeta.type.includes(&#39;pdf&#39;) || m.fileMeta.type.includes(&#39;file&#39;))) {
         const pill = rowDiv.querySelector(&#39;.msg-audio-pill&#39;) || rowDiv.querySelector(&#39;.msg-file-pill&#39;);
         if(pill) attachMessageListeners(pill, id, m);
    }
}

// --- AUDIO PLAYER LOGIC (FIXED) ---
window.toggleAudio = function(id) {
    const audio = document.getElementById(id);
    const icon = document.getElementById(&#39;icon-&#39; + id);
    const wave = document.getElementById(&#39;wave-&#39; + id);
    
    if (!audio) return;

    // Pause all other audios
    document.querySelectorAll(&#39;audio&#39;).forEach(a =&gt; {
        if(a.id !== id) {
            a.pause();
            resetAudioUI(a.id);
        }
    });

    if (audio.paused) {
        audio.play().catch(e =&gt; console.log(&quot;Audio play error:&quot;, e));
        icon.innerHTML = &#39;&lt;path d=&quot;M6 19h4V5H6v14zm8-14v14h4V5h-4z&quot;/&gt;&#39;; // Pause Icon
        if(wave) wave.classList.add(&#39;audio-playing&#39;);
    } else {
        audio.pause();
        icon.innerHTML = &#39;&lt;path d=&quot;M8 5v14l11-7z&quot;/&gt;&#39;; // Play Icon
        if(wave) wave.classList.remove(&#39;audio-playing&#39;);
    }
};

window.updateAudioUI = function(id) {
    const audio = document.getElementById(id);
    const prog = document.getElementById(&#39;prog-&#39; + id);
    if(audio &amp;&amp; audio.duration) {
        const pct = (audio.currentTime / audio.duration) * 100;
        prog.style.width = pct + &#39;%&#39;;
    }
};

window.resetAudioUI = function(id) {
    const icon = document.getElementById(&#39;icon-&#39; + id);
    const prog = document.getElementById(&#39;prog-&#39; + id);
    const wave = document.getElementById(&#39;wave-&#39; + id);
    
    if(icon) icon.innerHTML = &#39;&lt;path d=&quot;M8 5v14l11-7z&quot;/&gt;&#39;;
    if(prog) prog.style.width = &#39;0%&#39;;
    if(wave) wave.classList.remove(&#39;audio-playing&#39;);
};

// Extracted Listener Logic for re-use on Text Bubble OR Image
function attachMessageListeners(element, id, m) {
        let reactionsList = [];
        let myReaction = null;
        if (m.reactions &amp;&amp; m.reactions[myUid]) myReaction = m.reactions[myUid].emoji;

        element.addEventListener(&#39;dblclick&#39;, (e) =&gt; {
            e.preventDefault(); e.stopPropagation(); vibrate(50); // Own Feature: Stronger vibration on like
            triggerHeartAnimation();
            applyReactionToId(id, myReaction === &#39;‚ù§Ô∏è&#39; ? &#39;&#39; : &#39;‚ù§Ô∏è&#39;);
        });

        let startX = 0, currentX = 0, menuTimer = null, isScrolling = false, swipeTriggered = false;

        element.addEventListener(&#39;touchstart&#39;, (e) =&gt; {
            startX = e.touches[0].clientX;
            isScrolling = false; 
            swipeTriggered = false;
            
            menuTimer = setTimeout(() =&gt; {
                if (!isScrolling) { vibrate(70); openMenu(id, m.sender, m.text); }
            }, 500);
        }, {passive: true});

        element.addEventListener(&#39;touchmove&#39;, (e) =&gt; {
            currentX = e.touches[0].clientX;
            
            if (Math.abs(currentX - startX) &gt; 10) { 
                  clearTimeout(menuTimer);
                  isScrolling = true;
            }
            
            let diff = currentX - startX;
            if (diff &gt; 0 &amp;&amp; diff &lt; 80) {
                element.style.transform = `translateX(${diff}px)`;
                element.style.transition = &quot;none&quot;;
                if (diff &gt; 50 &amp;&amp; !swipeTriggered) { vibrate(20); swipeTriggered = true; }
            }
        }, {passive: true});

        element.addEventListener(&#39;touchend&#39;, () =&gt; {
            clearTimeout(menuTimer);
            let diff = currentX - startX;
            element.style.transition = &quot;transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)&quot;;
            element.style.transform = `translateX(0px)`;
            if (diff &gt; 50 &amp;&amp; swipeTriggered) {
                // Logic to say &quot;Replying to Audio/Video&quot; correctly
                let replyText = m.text;
                if(!replyText) {
                    if(m.imageUrl) replyText = &quot;üì∑ Photo&quot;;
                    else if(m.fileMeta &amp;&amp; m.fileMeta.type.includes(&#39;video&#39;)) replyText = &quot;üé• Video&quot;;
                    else if(m.fileMeta &amp;&amp; m.fileMeta.type.includes(&#39;audio&#39;)) replyText = &quot;üéµ Audio&quot;;
                    else if(m.fileUrl) replyText = &quot;üìÑ File&quot;;
                    else replyText = &quot;Attachment&quot;;
                }
                triggerReply(replyText);
            }
            startX = 0; currentX = 0;
        });
}

function triggerReply(text) {
    replyingTo = text;
    document.getElementById(&#39;reply-text&#39;).innerText = &quot;Replying to: &quot; + (text.length &gt; 50 ? text.substring(0,50)+&quot;...&quot; : text);
    document.getElementById(&#39;reply-dock&#39;).style.display = &#39;flex&#39;;
    mInput.focus(); 
}

// NEW: Function to send image message immediately
async function sendImageMessage(imageUrl) {
    popSound.play().catch(e =&gt; {});
    scrollToBottom();

    let msgData = {
        text: &quot;&quot;, // No caption for direct send
        sender: myUid, 
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        replyTo: replyingTo, 
        seen: false, 
        reactions: {},
        imageUrl: imageUrl
    };
    
    // Reset reply state if any
    cancelInteraction();

    await db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;).add(msgData);
    updateLastMsg(&quot;üì∑ Image&quot;);
    scrollToBottom();
}

// NEW: Function to send File/Video/Audio
async function sendFileMessage(fileUrl, metadata) {
    popSound.play().catch(e =&gt; {});
    scrollToBottom();

    const caption = metadata.caption || &quot;&quot;;
    
    let msgData = {
        text: caption,
        sender: myUid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        replyTo: replyingTo,
        seen: false,
        reactions: {},
        fileUrl: fileUrl,
        fileMeta: metadata
    };

    cancelInteraction();

    await db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;).add(msgData);
    
    let type = metadata.type || &quot;&quot;;
    let label = &quot;üìÑ File&quot;;
    if(type.indexOf(&#39;video&#39;) !== -1) label = &quot;üé• Video&quot;;
    else if(type.indexOf(&#39;audio&#39;) !== -1) label = &quot;üéµ Audio&quot;;
    
    updateLastMsg(caption ? label + &quot; &quot; + caption : label);
    scrollToBottom();
}

async function updateLastMsg(msgText) {
    await db.collection(&quot;chats&quot;).doc(chatId).set({
        lastMessage: msgText, 
        lastSender: myUid,
        lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
        participants: [myUid, targetUid], seen: false,
        [`unreadCount.${targetUid}`]: firebase.firestore.FieldValue.increment(1)
    }, { merge: true });
}

async function sendMsg() {
    const text = mInput.value.trim();
    
    if (!text) {
        inputBox.classList.add(&#39;shake-anim&#39;);
        setTimeout(() =&gt; inputBox.classList.remove(&#39;shake-anim&#39;), 400);
        return;
    }

    popSound.play().catch(e =&gt; {});

    // KEYBOARD FIX: Clear value but DO NOT BLUR
    mInput.value = &quot;&quot;;
    mInput.style.height = &#39;auto&#39;; 
    
    sendBtnUI.classList.remove(&#39;active&#39;); 
    emojiTray.style.display = &#39;none&#39;;
    attachmentMenu.style.display = &#39;none&#39;;
    rdb.ref(`typing/${chatId}/${myUid}`).set(false);
    
    // FORCE FOCUS TO REMAIN
    mInput.focus(); 
    setTimeout(() =&gt; mInput.focus(), 10); 

    if (editModeId) {
        const idToEdit = editModeId; editModeId = null;
        cancelInteraction(); // Close the editing dock
        await db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;).doc(idToEdit).update({ text, edited: true });
    } else {
        const rText = replyingTo; cancelInteraction(); // Close reply dock
        scrollToBottom();
        
        let msgData = {
            text, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            replyTo: rText, seen: false, reactions: {}
        };

        await db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;).add(msgData);
        updateLastMsg(text);
    }
    scrollToBottom();
}

function scrollToBottom() { 
    chatFlow.scrollTop = chatFlow.scrollHeight; 
}

function openMenu(id, sender, text) {
    activeMenuId = id;
    const isMine = sender === myUid;
    document.getElementById(&#39;edit-btn&#39;).style.display = (isMine &amp;&amp; text) ? &#39;block&#39; : &#39;none&#39;; // Only allow edit if text exists
    document.getElementById(&#39;unsend-btn&#39;).style.display = isMine ? &#39;block&#39; : &#39;none&#39;;
    document.getElementById(&#39;menu-emoji-grid&#39;).style.display = &#39;none&#39;;
    document.getElementById(&#39;menu-overlay&#39;).style.display = &#39;flex&#39;;
}

async function copyMessageText() {
    if (!activeMenuId) return;
    const el = document.getElementById(&#39;text-&#39; + activeMenuId);
    if(!el) { closeMenu(); return; } // Might be image only
    
    const msgText = el.innerText.split(&#39;(edited)&#39;)[0].trim();
    try {
        await navigator.clipboard.writeText(msgText);
        closeMenu();
    } catch (err) {
        console.error(&#39;Failed to copy: &#39;, err);
    }
}

async function applyReaction(emoji) {
    if (!activeMenuId) return;
    const msgId = activeMenuId; closeMenu(); 
    await applyReactionToId(msgId, emoji);
}

async function applyReactionToId(id, emoji) {
    // --- 1. OPTIMISTIC UPDATE (Fix for old messages) ---
    if(messagesMap.has(id)) {
        let msg = messagesMap.get(id);
        if(!msg.reactions) msg.reactions = {};

        if(msg.reactions[myUid] &amp;&amp; msg.reactions[myUid].emoji === emoji) {
             delete msg.reactions[myUid];
        } else if (emoji !== &#39;&#39;) {
             msg.reactions[myUid] = { emoji: emoji, timestamp: Date.now() };
        }
        
        messagesMap.set(id, msg);
        renderAll(); // Refresh UI immediately
    }

    // --- 2. FIREBASE UPDATE ---
    const msgRef = db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;).doc(id);
    const doc = await msgRef.get();
    const data = doc.data();
    let currentReaction = (data.reactions &amp;&amp; data.reactions[myUid]) ? data.reactions[myUid].emoji : null;

    if (currentReaction === emoji) {
        await msgRef.update({ [`reactions.${myUid}`]: firebase.firestore.FieldValue.delete() });
    } else {
        await msgRef.update({ [`reactions.${myUid}`]: { emoji: emoji, timestamp: Date.now() } });
    }
}

function showReactionDetails(msgId, event) {
    event.stopPropagation();
    const msgData = messagesMap.get(msgId);
    if (!msgData || !msgData.reactions) return;

    const listContainer = document.getElementById(&#39;react-list-items&#39;);
    listContainer.innerHTML = &#39;&#39;;

    Object.entries(msgData.reactions).forEach(([uid, rData]) =&gt; {
        const isMe = uid === myUid;
        // FIX: Use stored myUserData for my PFP
        const pfpSrc = isMe ? (myUserData ? myUserData.photoURL : &#39;[https://via.placeholder.com/40](https://via.placeholder.com/40)&#39;) : chatTargetData.photoURL;
        const name = isMe ? &quot;You&quot; : (chatTargetData.name || chatTargetData.username);
        const timeStr = formatTime12(new Date(rData.timestamp));

        const el = document.createElement(&#39;div&#39;);
        el.className = &#39;reactor-item&#39;;
        el.innerHTML = `
            &lt;img src=&quot;${pfpSrc}&quot; class=&quot;reactor-pfp&quot;&gt;
            &lt;div class=&quot;reactor-info&quot;&gt;
                &lt;div class=&quot;reactor-name&quot;&gt;${name}&lt;/div&gt;
                &lt;div class=&quot;reactor-time&quot;&gt;${timeStr}&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;reactor-emoji&quot;&gt;${rData.emoji}&lt;/div&gt;
        `;
        listContainer.appendChild(el);
    });
    document.getElementById(&#39;reaction-details-overlay&#39;).style.display = &#39;flex&#39;;
}

function closeReactionDetails() { document.getElementById(&#39;reaction-details-overlay&#39;).style.display = &#39;none&#39;; }

// Note: The Grid function &#39;expandEmojiMenu&#39; was removed here to prevent conflict
// and ensure usage of the Full Component modal defined above.

function initReplyFromActive() {
    const el = document.getElementById(&#39;text-&#39;+activeMenuId);
    const text = el ? el.innerText.split(&#39;(edited)&#39;)[0].trim() : &quot;Image&quot;;
    triggerReply(text);
    closeMenu();
}

function closeMenu() { document.getElementById(&#39;menu-overlay&#39;).style.display = &#39;none&#39;; }

// Unified Cancel function for Replying AND Editing
// FIX: Properly clears edit mode ID to prevent overwriting
function cancelInteraction() { 
    // FIX: Clear input ONLY if we were editing. If replying, keep draft.
    if (editModeId) {
        mInput.value = &quot;&quot;;
        mInput.style.height = &#39;auto&#39;;
    }
    
    replyingTo = null; 
    editModeId = null;
    document.getElementById(&#39;reply-dock&#39;).style.display = &#39;none&#39;; 
    // REMOVED mInput.blur() to keep keyboard open
}

// NEW: Proper Edit Mode with UI Feedback
function initEdit() {
    const el = document.getElementById(&#39;text-&#39;+activeMenuId);
    if(!el) return; // Cannot edit image only messages
    
    const textToEdit = el.innerText.split(&#39;(edited)&#39;)[0].trim();
    mInput.value = textToEdit;
    mInput.style.height = &#39;auto&#39;; 
    mInput.style.height = mInput.scrollHeight + &#39;px&#39;;
    
    editModeId = activeMenuId; 
    closeMenu(); 
    
    // Show the dock as &quot;Editing&quot;
    document.getElementById(&#39;reply-text&#39;).innerHTML = &quot;&lt;strong style=&#39;color:#0095f6&#39;&gt;Editing Message:&lt;/strong&gt;<br> &quot; + textToEdit;
    document.getElementById(&#39;reply-dock&#39;).style.display = &#39;flex&#39;;
    
    mInput.focus();
}

async function unsendMsg() { 
    const idToDelete = activeMenuId; closeMenu();
    // Optimistic Remove
    if (messagesMap.has(idToDelete)) { messagesMap.delete(idToDelete); renderAll(); }
    
    await db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;).doc(idToDelete).delete();
    const snapshot = await db.collection(&quot;chats&quot;).doc(chatId).collection(&quot;messages&quot;).orderBy(&quot;timestamp&quot;, &quot;desc&quot;).limit(1).get();
    if (!snapshot.empty) {
        const lastMsg = snapshot.docs[0].data();
        let txt = lastMsg.text || &quot;&quot;;
        
        // Logic to determine type of the NEW last message
        if (lastMsg.imageUrl) {
            txt = txt ? &quot;üì∑ &quot; + txt : &quot;üì∑ Image&quot;;
        } else if (lastMsg.fileUrl) {
            const type = lastMsg.fileMeta ? lastMsg.fileMeta.type : &#39;file&#39;;
            let icon = &quot;üìÑ&quot;;
            let label = &quot;File&quot;;
            if(type.indexOf(&#39;video&#39;) !== -1) { icon = &quot;üé•&quot;; label = &quot;Video&quot;; }
            else if(type.indexOf(&#39;audio&#39;) !== -1) { icon = &quot;üéµ&quot;; label = &quot;Audio&quot;; }
            
            txt = txt ? `${icon} ${txt}` : `${icon} ${label}`;
        }
        
        await db.collection(&quot;chats&quot;).doc(chatId).update({ lastMessage: txt, lastSender: lastMsg.sender, lastTimestamp: lastMsg.timestamp });
    }
}

</script>
<script src="components/call-notifier.js" defer></script>
<call-notifier></call-notifier>
</body>
</html>
