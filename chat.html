<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000"> 
    <title>Chat</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="components/emojiPicker.js" defer></script>
    <script src="components/imagePicker.js" defer></script>
    <script src="components/filePicker.js" defer></script>
    <script src="components/viewMedia.js" defer></script>
    <script src="components/call-notifier.js" defer></script>

    <script type="module" src="components/chat/chat-header.js"></script>
    <script type="module" src="components/chat/chat-list.js"></script>
    <script type="module" src="components/chat/chat-input.js"></script>

    <style>
        :root { --bg: radial-gradient(circle at center, #0a0a0a 0%, #000000 100%); --header-bg: rgba(0,0,0,0.96); --accent: #0095f6; --border: #262626; --sent-bg: linear-gradient(135deg, #ff6b00 0%, #ff3b00 100%); --received-bg: #262626; --text: #ffffff; --text-secondary: #a8a8a8; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        html, body { height: 100%; width: 100%; overflow: hidden; background: var(--bg); font-family: sans-serif; color: var(--text); position: fixed; top: 0; left: 0; }
        
        #menu-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 4000; justify-content: center; align-items: center; }
        .menu-card { background: #1c1c1c; border-radius: 16px; width: 280px; overflow: hidden; }
        .menu-opt { padding: 16px; text-align: center; border-bottom: 1px solid #333; color: white; cursor: pointer; }
        
        #reaction-details-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 4000; justify-content: center; align-items: center; }
        .react-list-container { width: 85%; max-width: 340px; background: #1c1c1c; border-radius: 16px; }
        .reactor-item { display: flex; align-items: center; padding: 12px; gap: 12px; color: white; border-bottom: 1px solid #333; }
        .reactor-pfp { width: 30px; height: 30px; border-radius: 50%; }
        
        #heart-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 80px; pointer-events: none; z-index: 5000; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes heartPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(0); opacity: 0; } }
    </style>
</head>
<body>
    <chat-header id="main-header"></chat-header>
    <chat-list id="main-list"></chat-list>
    <chat-input id="main-input"></chat-input>

    <div id="menu-overlay"><div class="menu-card"><div class="menu-opt" id="copy-btn">Copy Text</div><div class="menu-opt" id="reply-btn">Reply</div><div class="menu-opt" id="edit-btn">Edit</div><div class="menu-opt" id="unsend-btn" style="color:red">Unsend</div><div class="menu-opt" onclick="document.getElementById('menu-overlay').style.display='none'" style="color:#888; border:none">Cancel</div></div></div>
    <div id="reaction-details-overlay"><div class="react-list-container" id="react-list-content"></div></div>
    <div id="heart-overlay">❤️</div>
    
    <image-picker id="img-picker"></image-picker>
    <file-picker id="file-picker"></file-picker>
    <view-media id="media-viewer"></view-media>
    <call-notifier></call-notifier>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE", authDomain: "goorac-c3b59.firebaseapp.com", projectId: "goorac-c3b59", storageBucket: "goorac-c3b59.firebasestorage.app", messagingSenderId: "746746595332", appId: "1:746746595332:web:d3f8527d27fe8ca2530d51", measurementId: "G-M46FEVRYSS", databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); const rdb = firebase.database(); const auth = firebase.auth();

    const header = document.getElementById('main-header');
    const list = document.getElementById('main-list');
    const input = document.getElementById('main-input');
    
    let myUid, targetUid, chatId, activeMenuId, activeMenuText;
    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');

    auth.onAuthStateChanged(user => {
        if (user) { myUid = user.uid; window.myUid = myUid; setupPresence(); initChat(); } 
        else window.location.href = 'login.html';
    });

    function setupPresence() {
        const ref = rdb.ref('/status/' + myUid);
        rdb.ref('.info/connected').on('value', s => { if(s.val()) ref.onDisconnect().set({state:'offline', last_changed: firebase.database.ServerValue.TIMESTAMP}).then(()=> ref.set({state:'online', last_changed: firebase.database.ServerValue.TIMESTAMP})); });
    }

    async function initChat() {
        if(!targetUsername) return;
        const snap = await db.collection("users").where("username", "==", targetUsername).get();
        if(snap.empty) return;
        targetUid = snap.docs[0].id;
        const targetData = snap.docs[0].data();
        chatId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
        
        header.setUserData(targetData);
        rdb.ref('/status/' + targetUid).on('value', s => header.setStatus(false, s.val()?.state === 'online', s.val()?.last_changed));
        rdb.ref(`typing/${chatId}/${targetUid}`).on('value', s => { list.setTyping(s.val()); if(s.val()) header.setStatus(true); });
        
        // Load Messages
        let lastVisible = null;
        db.collection("chats").doc(chatId).collection("messages").orderBy("timestamp", "desc").limit(20).onSnapshot(snap => {
            if(snap.empty) return;
            if(!lastVisible) lastVisible = snap.docs[snap.docs.length-1];
            
            list.clear();
            const msgs = [];
            snap.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
            msgs.sort((a,b) => a.timestamp - b.timestamp);
            
            let lastDate = "";
            msgs.forEach((m, i) => {
                const d = m.timestamp ? m.timestamp.toDate() : new Date();
                const dStr = d.toLocaleDateString();
                if(dStr !== lastDate) { list.addDateDivider(dStr); lastDate = dStr; }
                const isLast = (i === msgs.length - 1) || (msgs[i+1].sender !== m.sender);
                list.addMessage(m.id, m, m.sender === myUid, isLast, m.seen, targetData);
            });
            list.reveal();
            if(msgs.length > 0) list.scrollToBottom();
        });
    }

    // Events
    input.addEventListener('send-message', async (e) => {
        const { text, replyTo, isEdit } = e.detail;
        if(isEdit && activeMenuId) {
            await db.collection("chats").doc(chatId).collection("messages").doc(activeMenuId).update({ text, edited: true });
        } else {
            await db.collection("chats").doc(chatId).collection("messages").add({
                text, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(), replyTo, seen: false
            });
        }
    });
    input.addEventListener('typing-status', (e) => rdb.ref(`typing/${chatId}/${myUid}`).set(e.detail.isTyping));
    
    // List Interaction
    list.addEventListener('trigger-reply', (e) => input.setReply(e.detail.text));
    list.addEventListener('reaction', async (e) => {
        const { id, emoji } = e.detail;
        const ref = db.collection("chats").doc(chatId).collection("messages").doc(id);
        const doc = await ref.get();
        if(doc.exists && doc.data().reactions?.[myUid]?.emoji === emoji) {
            ref.update({ [`reactions.${myUid}`]: firebase.firestore.FieldValue.delete() });
        } else {
            ref.update({ [`reactions.${myUid}`]: { emoji, timestamp: Date.now() } });
            document.getElementById('heart-overlay').style.animation = 'heartPop 0.8s ease-out';
        }
    });
    
    // Menu
    list.addEventListener('open-msg-menu', (e) => {
        activeMenuId = e.detail.id; activeMenuText = e.detail.text;
        const isMine = e.detail.sender === myUid;
        document.getElementById('edit-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('unsend-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('menu-overlay').style.display = 'flex';
    });
    
    document.getElementById('copy-btn').onclick = () => { navigator.clipboard.writeText(activeMenuText); document.getElementById('menu-overlay').style.display='none'; };
    document.getElementById('reply-btn').onclick = () => { input.setReply(activeMenuText); document.getElementById('menu-overlay').style.display='none'; };
    document.getElementById('edit-btn').onclick = () => { input.setEdit(activeMenuText); document.getElementById('menu-overlay').style.display='none'; };
    document.getElementById('unsend-btn').onclick = async () => { 
        await db.collection("chats").doc(chatId).collection("messages").doc(activeMenuId).delete();
        document.getElementById('menu-overlay').style.display='none';
    };
    document.getElementById('reaction-details-overlay').onclick = function() { this.style.display='none'; };
    
    // Attachments
    const imgPicker = document.getElementById('img-picker');
    input.addEventListener('trigger-camera', () => imgPicker.openPicker());
    imgPicker.addEventListener('image-uploaded', (e) => db.collection("chats").doc(chatId).collection("messages").add({ imageUrl: e.detail.url, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }));
    
    const filePicker = document.getElementById('file-picker');
    input.addEventListener('trigger-file', () => filePicker.openPicker());
    filePicker.addEventListener('file-uploaded', (e) => db.collection("chats").doc(chatId).collection("messages").add({ fileUrl: e.detail.url, fileMeta: e.detail.metadata, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }));

</script>
</body>
</html>
