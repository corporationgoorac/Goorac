<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
Â  Â  <meta name="theme-color" content="#000000">Â 
Â  Â  <title>Goorac | Quantum</title>

Â  Â  <script src="config.js"></script>

Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

Â  Â  <script type="module">
Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
Â  Â  Â  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

Â  Â  Â  // Your web app's Firebase configuration
Â  Â  Â  export const firebaseConfig = {
Â  Â  Â  Â  Â  apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
Â  Â  Â  Â  Â  authDomain: "goorac-c3b59.firebaseapp.com",
Â  Â  Â  Â  Â  projectId: "goorac-c3b59",
Â  Â  Â  Â  Â  storageBucket: "goorac-c3b59.firebasestorage.app",
Â  Â  Â  Â  Â  messagingSenderId: "746746595332",
Â  Â  Â  Â  Â  appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
Â  Â  Â  Â  Â  measurementId: "G-M46FEVRYSS"
Â  Â  Â  };

Â  Â  Â  // Initialize Firebase
Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  const analytics = getAnalytics(app);
Â  Â  </script>

Â  Â  <script src="components/emojiPicker.js" defer></script>
Â  Â  <script src="components/imagePicker.js" defer></script>
Â  Â  <script src="components/filePicker.js" defer></script>
Â  Â  <script src="components/viewMedia.js" defer></script>

Â  Â  <style>
Â  Â  Â  Â  :root {Â 
Â  Â  Â  Â  Â  Â  /* Subtle radial background for depth */
Â  Â  Â  Â  Â  Â  --bg: radial-gradient(circle at center, #0a0a0a 0%, #000000 100%);Â 
Â  Â  Â  Â  Â  Â  --header-bg: rgba(0,0,0,0.96);
Â  Â  Â  Â  Â  Â  --accent: #0095f6;Â 
Â  Â  Â  Â  Â  Â  --border: #262626;Â 
Â  Â  Â  Â  Â  Â  --sent-bg: linear-gradient(135deg, #ff6b00 0%, #ff3b00 100%);
Â  Â  Â  Â  Â  Â  --received-bg: #262626;Â 
Â  Â  Â  Â  Â  Â  --text: #ffffff;Â 
Â  Â  Â  Â  Â  Â  --text-secondary: #a8a8a8;
Â  Â  Â  Â  Â  Â  --shimmer: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
Â  Â  Â  Â  }

Â  Â  Â  Â  * {Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box; -webkit-tap-highlight-color: transparent;Â 
Â  Â  Â  Â  Â  Â  margin: 0; padding: 0; -webkit-touch-callout: none;Â 
Â  Â  Â  Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  html, body {
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  background: var(--bg);
Â  Â  Â  Â  Â  Â  position: fixed;Â 
Â  Â  Â  Â  Â  Â  left: 0; top: 0;
Â  Â  Â  Â  Â  Â  margin: 0 !important;
Â  Â  Â  Â  Â  Â  padding: 0 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  -webkit-user-select: none; user-select: none;Â 
Â  Â  Â  Â  Â  Â  color: var(--text);Â 
Â  Â  Â  Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- STRICT COPY PASTE CONTROL --- */
Â  Â  Â  Â  div, span, p, img, svg { -webkit-user-select: none; user-select: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  input, textarea {Â 
Â  Â  Â  Â  Â  Â  -webkit-user-select: text !important;Â 
Â  Â  Â  Â  Â  Â  user-select: text !important;Â 
Â  Â  Â  Â  Â  Â  outline: none;Â 
Â  Â  Â  Â  Â  Â  font-family: inherit;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- ANIMATIONS --- */
Â  Â  Â  Â  @keyframes shimmer { 0% { background-position: -200px 0; } 100% { background-position: 200px 0; } }
Â  Â  Â  Â  @keyframes flashMessage { 0% { background-color: rgba(255, 165, 0, 0.3); transform: scale(1.02); } 100% { background-color: transparent; transform: scale(1); } }
Â  Â  Â  Â  @keyframes scaleIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
Â  Â  Â  Â  @keyframes fadeStatus { 0% { opacity: 0; transform: translateY(2px); } 100% { opacity: 1; transform: translateY(0); } }
Â  Â  Â  Â  @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); } 20%, 40%, 60%, 80% { transform: translateX(4px); } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* FEATURE: Pulse Animation for Online Dot */
Â  Â  Â  Â  @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); } 70% { box-shadow: 0 0 0 4px rgba(0, 230, 118, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* FEATURE: Smooth Image Fade In */
Â  Â  Â  Â  @keyframes imgFadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

Â  Â  Â  Â  /* Modal Slide Up Animation */
Â  Â  Â  Â  @keyframes slideUp {
Â  Â  Â  Â  Â  Â  from { transform: translateY(100%); }
Â  Â  Â  Â  Â  Â  to { transform: translateY(0); }
Â  Â  Â  Â  }

Â  Â  Â  Â  .shake-anim { animation: shake 0.4s ease-in-out; border-color: #ff3b00 !important; }

Â  Â  Â  Â  .loading-shimmer {
Â  Â  Â  Â  Â  Â  background: var(--shimmer); background-size: 400px 100%; animation: shimmer 1.2s ease-in-out infinite;
Â  Â  Â  Â  }

Â  Â  Â  Â  .app-container {Â 
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; height: 100vh; height: 100dvh; width: 100%; position: absolute; top: 0; left: 0; overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- HEADER ABSOLUTE (WEBVIEW FIX) --- */
Â  Â  Â  Â  header {Â 
Â  Â  Â  Â  Â  Â  position: absolute; /* Request: Absolute positioning */
Â  Â  Â  Â  Â  Â  top: 0; left: 0; right: 0;
Â  Â  Â  Â  Â  Â  padding: 0 16px;
Â  Â  Â  Â  Â  Â  padding-top: calc(env(safe-area-inset-top) + 10px);
Â  Â  Â  Â  Â  Â  height: calc(60px + env(safe-area-inset-top));
Â  Â  Â  Â  Â  Â  background: var(--header-bg);Â 
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border);Â 
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 12px;Â 
Â  Â  Â  Â  Â  Â  z-index: 2000;Â 
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
Â  Â  Â  Â  }

Â  Â  Â  Â  .back-btn { font-size: 1.8rem; color: var(--accent); cursor: pointer; display: flex; align-items: center; justify-content: center; height: 40px; width: 30px; }

Â  Â  Â  Â  .h-profile-group { display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1; overflow: hidden; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .pfp-container { position: relative; width: 38px; height: 38px; flex-shrink: 0; }
Â  Â  Â  Â  .h-pfp { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #121212; border: 1px solid #333; transition: opacity 0.3s ease; }
Â  Â  Â  Â  .online-dot { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #00e676; border-radius: 50%; border: 2px solid #000; display: none; box-shadow: 0 0 4px rgba(0,230,118,0.5); animation: pulseGreen 2s infinite; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .h-info { display: flex; flex-direction: column; justify-content: center; gap: 1px; min-width: 0; }
Â  Â  Â  Â  .h-name-wrapper { display: flex; align-items: center; gap: 4px; line-height: 1.1; }
Â  Â  Â  Â  .h-name { font-weight: 700; font-size: 1rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  Â  Â  Â  .h-name:empty { height: 16px; width: 120px; border-radius: 4px; background: var(--shimmer); background-size: 400px 100%; animation: shimmer 1.2s infinite; }
Â  Â  Â  Â  .h-username-sub { font-size: 0.75rem; color: var(--text-secondary); font-weight: 400; animation: fadeStatus 0.3s ease; }
Â  Â  Â  Â  .v-badge { width: 14px; height: 14px; display: none; }

Â  Â  Â  Â  .header-actions { display: flex; align-items: center; gap: 20px; margin-left: auto; padding-right: 5px; }
Â  Â  Â  Â  .header-icon { width: 26px; height: 26px; cursor: pointer; fill: #ffffff; opacity: 0.9; transition: transform 0.2s, opacity 0.2s; }
Â  Â  Â  Â  .header-icon:active { opacity: 0.6; transform: scale(0.9); }

Â  Â  Â  Â  /* --- CHAT AREA --- */
Â  Â  Â  Â  #chat-flow {Â 
Â  Â  Â  Â  Â  Â  flex: 1; overflow-y: auto; overflow-x: hidden; padding: 15px 0;Â 
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; -webkit-overflow-scrolling: touch;
Â  Â  Â  Â  Â  Â  background: transparent; overscroll-behavior-y: contain; position: relative;
Â  Â  Â  Â  Â  Â  /* PADDING TOP to clear absolute header */
Â  Â  Â  Â  Â  Â  padding-top: calc(75px + env(safe-area-inset-top));Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Hide Scrollbar */
Â  Â  Â  Â  Â  Â  -ms-overflow-style: none; scrollbar-width: none;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Initial State Hidden */
Â  Â  Â  Â  Â  Â  opacity: 0; transition: opacity 0.2s ease-in;
Â  Â  Â  Â  }
Â  Â  Â  Â  #chat-flow::-webkit-scrollbar { display: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #messages-container { display: flex; flex-direction: column; padding: 0 14px; will-change: transform; width: 100%; padding-bottom: 30px; }

Â  Â  Â  Â  #typing-indicator-bottom { display: none; margin-left: 56px; margin-bottom: 15px; background: #262626; width: 54px; height: 32px; border-radius: 16px; border-bottom-left-radius: 4px; align-items: center; justify-content: center; gap: 4px; padding: 0 12px; align-self: flex-start; }
Â  Â  Â  Â  .typing-dot { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: typingWave 1.3s linear infinite; }
Â  Â  Â  Â  .typing-dot:nth-child(2) { animation-delay: -1.1s; }
Â  Â  Â  Â  .typing-dot:nth-child(3) { animation-delay: -0.9s; }
Â  Â  Â  Â  @keyframes typingWave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }

Â  Â  Â  Â  #scroll-trigger { text-align: center; padding: 20px; color: #262626; font-size: 0.7rem; order: -1; }
Â  Â  Â  Â  .date-divider { text-align: center; margin: 10px 0; font-size: 0.75rem; color: #fff; font-weight: 600; text-transform: capitalize; background: rgba(40,40,40,0.6); padding: 4px 10px; border-radius: 12px; align-self: center; width: fit-content; position: sticky; top: 10px; z-index: 5; backdrop-filter: blur(4px); }

Â  Â  Â  Â  .msg-row { display: flex; width: 100%; margin-bottom: 6px; position: relative; flex-direction: column; }
Â  Â  Â  Â  .msg-row.sent { align-items: flex-end; padding-right: 0px; }
Â  Â  Â  Â  .msg-row.received { align-items: flex-start; }
Â  Â  Â  Â  .received-inner-row { display: flex; align-items: flex-end; gap: 8px; max-width: 100%; }
Â  Â  Â  Â  .msg-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; flex-shrink: 0; margin-bottom: 4px; background: #121212; border: 1px solid #222; }

Â  Â  Â  Â  .msg-bubble-box { position: relative; max-width: 78%; display: flex; flex-direction: column; transition: margin-bottom 0.2s; }
Â  Â  Â  Â  .sent .msg-bubble-box { align-items: flex-end; }
Â  Â  Â  Â  .received .msg-bubble-box { align-items: flex-start; }

Â  Â  Â  Â  .bubble { padding: 12px 16px; border-radius: 20px; font-size: 1rem; line-height: 1.45; position: relative; word-wrap: break-word; z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
Â  Â  Â  Â  .sent .bubble { background: var(--sent-bg); color: #fff; border-top-right-radius: 18px; border-top-left-radius: 18px; border-bottom-left-radius: 18px; border-bottom-right-radius: 4px; text-align: left; }
Â  Â  Â  Â  .received .bubble { background: var(--received-bg); color: #fff; border-top-left-radius: 18px; border-top-right-radius: 18px; border-bottom-right-radius: 18px; border-bottom-left-radius: 4px; text-align: left; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* OWN FEATURE: Link Styling */
Â  Â  Â  Â  .bubble a { color: #87ceeb; text-decoration: underline; cursor: pointer; }

Â  Â  Â  Â  .sliding-timestamp { position: absolute; top: 50%; transform: translateY(-50%); right: -65px; font-size: 0.7rem; color: #666; font-weight: 500; width: 50px; text-align: center; pointer-events: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* FIXED REACTION BADGE VISIBILITY */
Â  Â  Â  Â  .reaction-badge {Â 
Â  Â  Â  Â  Â  Â  position: absolute;Â 
Â  Â  Â  Â  Â  Â  bottom: -10px; /* Moves emoji slightly below the bubble/image */
Â  Â  Â  Â  Â  Â  background: #1a1a1a;Â 
Â  Â  Â  Â  Â  Â  border: 2px solid #000;Â 
Â  Â  Â  Â  Â  Â  border-radius: 20px;Â 
Â  Â  Â  Â  Â  Â  padding: 4px 7px;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.85rem;Â 
Â  Â  Â  Â  Â  Â  z-index: 20; /* Ensure it sits on top of images */
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.5);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .sent .reaction-badge { right: 0; }
Â  Â  Â  Â  .received .reaction-badge { left: 0; }

Â  Â  Â  Â  .seen-status { font-size: 0.65rem; color: var(--text-secondary); margin-top: 4px; margin-right: 2px; text-align: right; font-weight: 500; height: 14px; width: 100%; opacity: 0; animation: fadeIn 0.3s forwards; position: relative; z-index: 1; }
Â  Â  Â  Â  @keyframes fadeIn { to { opacity: 1; } }

Â  Â  Â  Â  .reply-box-ui { background: rgba(0, 0, 0, 0.25); padding: 10px 14px; border-radius: 12px; margin-bottom: 6px; font-size: 0.88rem; border-left: 4px solid rgba(255, 255, 255, 0.5); color: #e0e0e0; max-width: 100%; cursor: pointer; transition: opacity 0.2s; white-space: normal; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.35; }
Â  Â  Â  Â  .reply-box-ui:active { opacity: 0.7; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* === NEW: PROFESSIONAL INSTAGRAM NOTE REPLY UI === */
Â  Â  Â  Â  .note-reply-wrapper {
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; align-items: center;
Â  Â  Â  Â  Â  Â  max-width: 100%; cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .note-reply-pill {Â 
Â  Â  Â  Â  Â  Â  /* Fallback dark background if no color provided */
Â  Â  Â  Â  Â  Â  background: #262626;Â 
Â  Â  Â  Â  Â  Â  padding: 10px 16px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 22px;Â 
Â  Â  Â  Â  Â  Â  display: inline-flex; flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255,255,255,0.1);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  min-width: 120px; max-width: 220px; text-align: center;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  transition: transform 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .note-reply-pill:active { transform: scale(0.96); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .note-header-row {
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 5px;
Â  Â  Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .note-mini-pfp {
Â  Â  Â  Â  Â  Â  width: 16px; height: 16px; border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: #444; object-fit: cover;
Â  Â  Â  Â  }
Â  Â  Â  Â  .note-label {
Â  Â  Â  Â  Â  Â  font-size: 0.65rem; font-weight: 700;
Â  Â  Â  Â  Â  Â  text-transform: uppercase; letter-spacing: 0.5px;
Â  Â  Â  Â  Â  Â  color: rgba(255,255,255,0.7);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .note-content-text {
Â  Â  Â  Â  Â  Â  font-size: 0.9rem; font-weight: 600; color: #fff;
Â  Â  Â  Â  Â  Â  line-height: 1.3; margin-bottom: 2px;
Â  Â  Â  Â  Â  Â  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .note-song-tag {
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 4px;
Â  Â  Â  Â  Â  Â  font-size: 0.65rem; color: rgba(255,255,255,0.8);
Â  Â  Â  Â  Â  Â  margin-top: 4px; background: rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  padding: 2px 8px; border-radius: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* The little line connecting note to message */
Â  Â  Â  Â  .note-connector {
Â  Â  Â  Â  Â  Â  width: 2px; height: 8px; background: rgba(255,255,255,0.2);
Â  Â  Â  Â  Â  Â  margin-top: -1px; margin-bottom: -4px; z-index: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  #scroll-down-btn { position: fixed; bottom: 85px; right: 20px; width: 42px; height: 42px; background: #262626; border-radius: 50%; display: none; align-items: center; justify-content: center; color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #333; z-index: 900; cursor: pointer; font-size: 1.2rem; transition: all 0.3s ease; }
Â  Â  Â  Â  #scroll-down-btn.new-msg { background: var(--accent); color: #fff; animation: bounce 1s infinite; }
Â  Â  Â  Â  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

Â  Â  Â  Â  #heart-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 80px; pointer-events: none; z-index: 3000; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
Â  Â  Â  Â  @keyframes heartPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 70% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(0); opacity: 0; } }

Â  Â  Â  Â  .input-area-container { background: #000; border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom, 10px); flex-shrink: 0; width: 100%; z-index: 1000; }
Â  Â  Â  Â  .input-area { padding: 10px 12px; display: flex; align-items: flex-end; gap: 10px; }
Â  Â  Â  Â  .input-box { flex: 1; background: #121212; border-radius: 22px; padding: 4px 14px; border: 1px solid #333; display: flex; align-items: center; min-height: 42px; transition: border-color 0.2s; }
Â  Â  Â  Â  .msg-input { width: 100%; background: transparent; border: none; color: white; padding: 9px 0; font-size: 16px; resize: none; max-height: 120px; overflow-y: auto; line-height: 1.35; }
Â  Â  Â  Â  .plus-btn { font-size: 26px; color: var(--accent); cursor: pointer; padding: 0 5px; height: 44px; display: flex; align-items: center; transition: transform 0.2s; }
Â  Â  Â  Â  .plus-btn:active { transform: scale(0.9); }
Â  Â  Â  Â  .send-btn { background: transparent; border: none; font-weight: 600; font-size: 1rem; padding: 0 5px; height: 44px; display: flex; align-items: center; color: #444; pointer-events: none; transition: color 0.2s ease, text-shadow 0.2s ease; }
Â  Â  Â  Â  .send-btn.active { color: var(--accent); cursor: pointer; pointer-events: auto; text-shadow: 0 0 12px rgba(0, 149, 246, 0.6); }

Â  Â  Â  Â  #emoji-tray { display: none; background: #000; border-top: 1px solid var(--border); height: 280px; padding: 0; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* NEW: Attachment Menu (Popup for + Button) */
Â  Â  Â  Â  #attachment-menu {
Â  Â  Â  Â  Â  Â  display: none; position: absolute; bottom: 70px; left: 15px;
Â  Â  Â  Â  Â  Â  background: rgba(28, 28, 28, 0.95); backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  border-radius: 16px; padding: 10px; z-index: 1001;
Â  Â  Â  Â  Â  Â  box-shadow: 0 5px 20px rgba(0,0,0,0.5);
Â  Â  Â  Â  Â  Â  border: 1px solid #333;
Â  Â  Â  Â  Â  Â  animation: slideUpFade 0.2s ease-out;
Â  Â  Â  Â  Â  Â  flex-direction: column; gap: 5px; width: 150px;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes slideUpFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .attach-opt { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; cursor: pointer; color: white; font-size: 0.95rem; font-weight: 500; }
Â  Â  Â  Â  .attach-opt:active { background: rgba(255,255,255,0.1); }
Â  Â  Â  Â  .attach-opt svg { width: 22px; height: 22px; fill: white; }

Â  Â  Â  Â  #menu-overlay, #reaction-details-overlay {Â 
Â  Â  Â  Â  Â  Â  display: none; position: fixed; inset: 0;Â 
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.6); z-index: 2000;Â 
Â  Â  Â  Â  Â  Â  justify-content: center; align-items: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
Â  Â  Â  Â  }
Â  Â  Â  Â  .menu-card { background: #1c1c1c; border-radius: 16px; width: 280px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
Â  Â  Â  Â  .reaction-bar { display: flex; justify-content: space-evenly; padding: 16px 10px; border-bottom: 1px solid #333; }
Â  Â  Â  Â  .reaction-bar span { font-size: 2rem; cursor: pointer; transition: transform 0.1s; }
Â  Â  Â  Â  .reaction-bar span:active { transform: scale(1.3); }
Â  Â  Â  Â  .more-emoji-trigger { background: #333; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; cursor: pointer; }
Â  Â  Â  Â  .menu-opt { padding: 16px; text-align: center; font-size: 1rem; border-bottom: 1px solid #333; color: #fff; }
Â  Â  Â  Â  .menu-opt:active { background: #333; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #reply-dock { display: none; background: #111; padding: 12px 16px; border-top: 1px solid var(--border); justify-content: space-between; align-items: center; }

Â  Â  Â  Â  .react-list-container { width: 85%; max-width: 340px; background: #1c1c1c; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; max-height: 50vh; }
Â  Â  Â  Â  .react-list-header { padding: 16px; text-align: center; font-weight: 600; font-size: 1.1rem; border-bottom: 1px solid #333; position: relative; color: white;}
Â  Â  Â  Â  .react-list-close { position: absolute; right: 16px; top: 16px; cursor: pointer; color: #888; }
Â  Â  Â  Â  .reactor-item { display: flex; align-items: center; padding: 12px 16px; gap: 12px; border-bottom: 1px solid #2a2a2a; }
Â  Â  Â  Â  .reactor-pfp { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; background: #333; }
Â  Â  Â  Â  .reactor-info { flex: 1; }
Â  Â  Â  Â  .reactor-name { font-weight: 600; font-size: 0.9rem; color: #fff; }
Â  Â  Â  Â  .reactor-time { font-size: 0.7rem; color: #888; margin-top: 2px; }
Â  Â  Â  Â  .reactor-emoji { font-size: 1.4rem; }

Â  Â  Â  Â  /* REACTION HALF-SCREEN MODAL */
Â  Â  Â  Â  #reaction-picker-modal {
Â  Â  Â  Â  Â  Â  display: none; position: fixed; inset: 0; z-index: 3000;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
Â  Â  Â  Â  Â  Â  align-items: flex-end; /* Bottom alignment */
Â  Â  Â  Â  }
Â  Â  Â  Â  .picker-modal-content {
Â  Â  Â  Â  Â  Â  width: 100%; height: 55vh; /* Half screen */
Â  Â  Â  Â  Â  Â  background: #1c1c1c;
Â  Â  Â  Â  Â  Â  border-top-left-radius: 20px; border-top-right-radius: 20px;
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column;
Â  Â  Â  Â  Â  Â  animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .picker-header {
Â  Â  Â  Â  Â  Â  padding: 15px; display: flex; align-items: center; gap: 12px;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #333; color: white; font-weight: 600; font-size: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .picker-drag-handle {
Â  Â  Â  Â  Â  Â  width: 40px; height: 5px; background: #444; border-radius: 10px; margin: 0 auto;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* NEW: Styles for Media Messages - FIXED VISIBILITY */
Â  Â  Â  Â  .msg-media-wrapper {
Â  Â  Â  Â  Â  Â  position: relative; /* Allows absolute positioning of badge */
Â  Â  Â  Â  Â  Â  /* REMOVED overflow:hidden so reaction can stick out */
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .chat-media-img {
Â  Â  Â  Â  Â  Â  display: block; width: 100%; max-width: 280px; max-height: 350px;Â 
Â  Â  Â  Â  Â  Â  object-fit: cover;Â 
Â  Â  Â  Â  Â  Â  border-radius: 18px; /* Rounded corners handled here now */
Â  Â  Â  Â  Â  Â  animation: imgFadeIn 0.4s ease-out; /* Feature: Smooth Fade In */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Corner logic since parent no longer clips */
Â  Â  Â  Â  .received .chat-media-img { border-bottom-left-radius: 4px; }
Â  Â  Â  Â  .sent .chat-media-img { border-bottom-right-radius: 4px; }

Â  Â  Â  Â  /* When media is present, the caption bubble needs less padding at top or needs to be attached */
Â  Â  Â  Â  .bubble.has-media {
Â  Â  Â  Â  Â  Â  border-top-left-radius: 4px; border-top-right-radius: 4px;
Â  Â  Â  Â  Â  Â  margin-top: 2px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- NEW STYLES FOR FILES/VIDEO/AUDIO --- */
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Video Container with Overlay Play Button */
Â  Â  Â  Â  .msg-video-container {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  max-width: 280px; border-radius: 18px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .play-overlay {
Â  Â  Â  Â  Â  Â  position: absolute; top: 50%; left: 50%;
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  width: 45px; height: 45px;
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.6);
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(4px);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255,255,255,0.2);
Â  Â  Â  Â  Â  Â  pointer-events: none; /* Click goes through to wrapper */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Audio Pill (Instagram Style) */
Â  Â  Â  Â  .msg-audio-pill {
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 12px;
Â  Â  Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  Â  Â  background: #262626;
Â  Â  Â  Â  Â  Â  border-radius: 22px;
Â  Â  Â  Â  Â  Â  min-width: 220px;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255,255,255,0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .audio-control-btn {
Â  Â  Â  Â  Â  Â  width: 32px; height: 32px;
Â  Â  Â  Â  Â  Â  background: #fff; border-radius: 50%;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  color: #000; cursor: pointer; flex-shrink: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .audio-waveform {
Â  Â  Â  Â  Â  Â  flex: 1; height: 4px; background: #444; border-radius: 2px;
Â  Â  Â  Â  Â  Â  position: relative; overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .audio-progress { height: 100%; background: #fff; width: 0%; transition: width 0.1s linear; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* File Card */
Â  Â  Â  Â  .msg-file-pill {
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 12px;
Â  Â  Â  Â  Â  Â  padding: 12px 14px;
Â  Â  Â  Â  Â  Â  background: #262626;
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  min-width: 200px; max-width: 260px;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255,255,255,0.1);
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .file-icon {
Â  Â  Â  Â  Â  Â  width: 40px; height: 40px;
Â  Â  Â  Â  Â  Â  background: #333; border-radius: 10px;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  font-size: 1.4rem; flex-shrink: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .file-details { flex: 1; min-width: 0; }
Â  Â  Â  Â  .file-name {
Â  Â  Â  Â  Â  Â  font-size: 0.9rem; font-weight: 500; color: #fff;
Â  Â  Â  Â  Â  Â  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
Â  Â  Â  Â  Â  Â  margin-bottom: 2px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .file-meta { font-size: 0.75rem; color: #888; }
Â  Â  Â  Â  .file-dl-btn { color: #0095f6; font-size: 1.2rem; padding: 5px; }
Â  Â  Â  Â Â 
Â  Â  </style>
</head>
<body>

<image-picker id="img-picker"></image-picker>
<file-picker id="file-picker"></file-picker>
<view-media id="media-viewer"></view-media>

<div id="heart-overlay">â¤ï¸</div>

<div id="scroll-down-btn" onclick="scrollToBottom()">â¬‡</div>

<div id="reaction-details-overlay" onclick="closeReactionDetails()">
Â  Â  <div class="react-list-container" onclick="event.stopPropagation()">
Â  Â  Â  Â  <div class="react-list-header">
Â  Â  Â  Â  Â  Â  Reactions
Â  Â  Â  Â  Â  Â  <div class="react-list-close" onclick="closeReactionDetails()">âœ•</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="react-list-content" id="react-list-items"></div>
Â  Â  </div>
</div>

<div id="reaction-picker-modal" onclick="closeReactionPicker()">
Â  Â  <div class="picker-modal-content" onclick="event.stopPropagation()">
Â  Â  Â  Â  <div style="padding:10px 0 5px 0;"><div class="picker-drag-handle"></div></div>
Â  Â  Â  Â  <div class="picker-header">
Â  Â  Â  Â  Â  Â  <span onclick="closeReactionPicker()" style="font-size:1.2rem; cursor:pointer;">âœ•</span>
Â  Â  Â  Â  Â  Â  React
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="reaction-picker-container" style="flex:1; overflow:hidden;"></div>
Â  Â  </div>
</div>

<div id="menu-overlay" onclick="closeMenu()">
Â  Â  <div class="menu-card" id="main-menu-card" onclick="event.stopPropagation()">
Â  Â  Â  Â  <div class="reaction-bar">
Â  Â  Â  Â  Â  Â  <span onclick="applyReaction('â¤ï¸')">â¤ï¸</span>
Â  Â  Â  Â  Â  Â  <span onclick="applyReaction('ğŸ˜‚')">ğŸ˜‚</span>
Â  Â  Â  Â  Â  Â  <span onclick="applyReaction('ğŸ˜®')">ğŸ˜®</span>
Â  Â  Â  Â  Â  Â  <span onclick="applyReaction('ğŸ˜¢')">ğŸ˜¢</span>
Â  Â  Â  Â  Â  Â  <span onclick="applyReaction('ğŸ‘')">ğŸ‘</span>
Â  Â  Â  Â  Â  Â  <div class="more-emoji-trigger" onclick="expandEmojiMenu()">+</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="menu-emoji-grid"></div>
Â  Â  Â  Â  <div class="menu-opt" onclick="copyMessageText()">Copy Text</div>
Â  Â  Â  Â  <div class="menu-opt" onclick="initReplyFromActive()">Reply</div>
Â  Â  Â  Â  <div id="edit-btn" class="menu-opt" onclick="initEdit()">Edit</div>
Â  Â  Â  Â  <div id="unsend-btn" class="menu-opt" style="color:#ff3b30; font-weight: 600;" onclick="unsendMsg()">Unsend</div>
Â  Â  Â  Â  <div class="menu-opt" onclick="closeMenu()" style="border-bottom:none; color: #888">Cancel</div>
Â  Â  </div>
</div>

<div class="app-container" id="main-app">
Â  Â  <header id="chat-header">
Â  Â  Â  Â  <div class="back-btn" onclick="history.back()">â€¹</div>
Â  Â  Â  Â  <div class="h-profile-group" onclick="goToProfile()">
Â  Â  Â  Â  Â  Â  <div class="pfp-container">
Â  Â  Â  Â  Â  Â  Â  Â  <img id="h-pfp" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="h-pfp loading-shimmer">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="online-dot" id="h-online-dot"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="h-info">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-name-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-name" id="h-display-name"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="v-badge" src="https://img.icons8.com/color/48/verified-badge.png" class="v-badge">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-username-sub" id="h-username-label"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="header-actions">
Â  Â  Â  Â  Â  Â  <svg class="header-icon" onclick="window.location.href='calls.html'" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 0 0-1.01.24l-1.57 1.97c-2.83-1.44-5.15-3.75-6.59-6.59l1.97-1.57c.22-.22.3-.54.24-1.01a11.36 11.36 0 0 1-.56-3.53c0-.55-.45-1-1-1H4.39c-.55 0-1 .45-1 1c0 9.39 7.61 17 17 17c.55 0 1-.45 1-1v-3.56c0-.55-.45-1-1-1z"/>
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  <svg class="header-icon" onclick="window.location.href='calls.html'" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div id="chat-flow">
Â  Â  Â  Â  <div id="scroll-trigger"></div>
Â  Â  Â  Â  <div id="messages-container"></div>
Â  Â  Â  Â  <div id="typing-indicator-bottom">
Â  Â  Â  Â  Â  Â  <div class="typing-dot"></div>
Â  Â  Â  Â  Â  Â  <div class="typing-dot"></div>
Â  Â  Â  Â  Â  Â  <div class="typing-dot"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="input-area-container">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="reply-dock">
Â  Â  Â  Â  Â  Â  <div id="reply-text" style="font-size:0.8rem; color:#aaa; overflow:hidden; text-overflow:ellipsis;"></div>
Â  Â  Â  Â  Â  Â  <div onclick="cancelInteraction()" style="color:#fff; font-weight:bold; padding:5px; cursor:pointer;">âœ•</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="emoji-tray">
Â  Â  Â  Â  Â  Â  Â <emoji-picker id="main-picker" style="width:100%; height:100%;"></emoji-picker>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="attachment-menu">
Â  Â  Â  Â  Â  Â  <div class="attach-opt" onclick="openCameraPicker()">
Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  <span>Camera / Gallery</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="attach-opt" onclick="openFilePicker()">
Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24" style="fill:white;"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  <span>File / Video</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="attach-opt" onclick="toggleEmojiTray()">
Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  <span>Emoji</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="input-area">
Â  Â  Â  Â  Â  Â  <div class="plus-btn" onclick="toggleAttachmentMenu()">+</div>
Â  Â  Â  Â  Â  Â  <div class="input-box" id="msg-input-box">
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="m-input" class="msg-input" placeholder="Message..." rows="1"></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="send-btn" class="send-btn">Send</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
Â  Â  // --- FIREBASE INIT ---
Â  Â  let fbConfig = {
Â  Â  Â  Â  apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
Â  Â  Â  Â  authDomain: "goorac-c3b59.firebaseapp.com",
Â  Â  Â  Â  projectId: "goorac-c3b59",
Â  Â  Â  Â  storageBucket: "goorac-c3b59.firebasestorage.app",
Â  Â  Â  Â  messagingSenderId: "746746595332",
Â  Â  Â  Â  appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
Â  Â  Â  Â  measurementId: "G-M46FEVRYSS",
Â  Â  Â  Â  databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
Â  Â  };

Â  Â  if (typeof CONFIG !== 'undefined' && CONFIG.firebase) {
Â  Â  Â  Â  fbConfig = CONFIG.firebase;
Â  Â  }

Â  Â  if (!firebase.apps.length) {
Â  Â  Â  Â  firebase.initializeApp(fbConfig);
Â  Â  }
Â  Â  const db = firebase.firestore();
Â  Â  const rdb = firebase.database();
Â  Â  const auth = firebase.auth();

Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  const targetUsername = params.get('user');
Â  Â  let myUid, targetUid, chatId, replyingTo = null, editModeId = null;
Â  Â  let activeMenuId = null, unsubscribe = null, isLoadingMore = false;
Â  Â  let lastVisible = null;Â 
Â  Â  let messagesMap = new Map();Â 
Â  Â  let chatTargetData = null;Â 
Â  Â  let myUserData = null;
Â  Â  let isFirstLoad = true;
Â  Â  let statusTimeout = null;
Â  Â Â 
Â  Â  // NEW: Variables for periodic status update
Â  Â  let lastStatusData = null;
Â  Â  let statusUpdateInterval = null;
Â  Â Â 
Â  Â  // NEW: First load flag for header logic
Â  Â  let isFirstStatusLoad = true;

Â  Â  // Custom Feature: Sound Effect (Base64 Pop & Like)
Â  Â  const popSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");Â 
Â  Â  const likeSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");Â 

Â  Â  const mInput = document.getElementById('m-input');
Â  Â  const inputBox = document.getElementById('msg-input-box');
Â  Â  const chatFlow = document.getElementById('chat-flow');
Â  Â  const container = document.getElementById('messages-container');
Â  Â  const bottomTyping = document.getElementById('typing-indicator-bottom');
Â  Â  const emojiTray = document.getElementById('emoji-tray');
Â  Â  const scrollBtn = document.getElementById('scroll-down-btn');
Â  Â  const sendBtnUI = document.getElementById('send-btn');
Â  Â  const onlineDot = document.getElementById('h-online-dot');
Â  Â  const headerSubLabel = document.getElementById('h-username-label');
Â  Â  const attachmentMenu = document.getElementById('attachment-menu');

Â  Â  // UNWANTED EMOJIS REMOVED HERE

Â  Â  // NEW: Double Tap on Background to Scroll Down
Â  Â  document.addEventListener('dblclick', (e) => {
Â  Â  Â  Â  if (e.target.id === 'chat-flow' || e.target.id === 'messages-container') {
Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â  vibrate(30);
Â  Â  Â  Â  }
Â  Â  });
Â  Â Â 
Â  Â  // NEW: Global Ripple Effect
Â  Â  document.addEventListener('click', function(e) {
Â  Â  Â  Â  // Close attachment menu if clicking elsewhere
Â  Â  Â  Â  if (!e.target.closest('#attachment-menu') && !e.target.closest('.plus-btn')) {
Â  Â  Â  Â  Â  Â  attachmentMenu.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.closest('emoji-picker')) return;
Â  Â  Â  Â  const circle = document.createElement('div');
Â  Â  Â  Â  circle.style.width = circle.style.height = '15px';
Â  Â  Â  Â  circle.style.left = `${e.clientX}px`;
Â  Â  Â  Â  circle.style.top = `${e.clientY}px`;
Â  Â  Â  Â  circle.classList.add('ripple');
Â  Â  Â  Â  document.body.appendChild(circle);
Â  Â  Â  Â  setTimeout(() => circle.remove(), 600);
Â  Â  });
Â  Â Â 
Â  Â  // === KEYBOARD FIX: Prevent focus loss on Send Button ===
Â  Â  const handleSendClick = (e) => {
Â  Â  Â  Â  e.preventDefault(); // Stop button from stealing focus
Â  Â  Â  Â  sendMsg();
Â  Â  };

Â  Â  sendBtnUI.addEventListener('mousedown', handleSendClick);
Â  Â  sendBtnUI.addEventListener('touchstart', handleSendClick);

Â  Â  function formatTime12(date) {
Â  Â  Â  Â  let hours = date.getHours();
Â  Â  Â  Â  let minutes = date.getMinutes();
Â  Â  Â  Â  let ampm = hours >= 12 ? 'PM' : 'AM';
Â  Â  Â  Â  hours = hours % 12;
Â  Â  Â  Â  hours = hours ? hours : 12;
Â  Â  Â  Â  minutes = minutes < 10 ? '0'+minutes : minutes;
Â  Â  Â  Â  return hours + ':' + minutes + ' ' + ampm;
Â  Â  }

Â  Â  // Helper for "Seen 1m ago" & Active status
Â  Â  function timeAgo(date) {
Â  Â  Â  Â  const seconds = Math.floor((new Date() - date) / 1000);
Â  Â  Â  Â  let interval = seconds / 31536000;
Â  Â  Â  Â  if (interval > 1) return Math.floor(interval) + "y ago";
Â  Â  Â  Â  interval = seconds / 2592000;
Â  Â  Â  Â  if (interval > 1) return Math.floor(interval) + "mo ago";
Â  Â  Â  Â  interval = seconds / 86400;
Â  Â  Â  Â  if (interval > 1) return Math.floor(interval) + "d ago";
Â  Â  Â  Â  interval = seconds / 3600;
Â  Â  Â  Â  if (interval > 1) return Math.floor(interval) + "h ago";
Â  Â  Â  Â  interval = seconds / 60;
Â  Â  Â  Â  if (interval > 1) return Math.floor(interval) + "m ago";
Â  Â  Â  Â  return "Just now";
Â  Â  }

Â  Â  function formatActiveTime(timestamp) {
Â  Â  Â  Â  if (!timestamp) return "";
Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  const diff = now - timestamp;
Â  Â  Â  Â  if (diff < 60000) return "Active now";
Â  Â  Â  Â  return "Active " + timeAgo(new Date(timestamp));
Â  Â  }

Â  Â  function getDateDivider(date) {
Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  const yesterday = new Date();
Â  Â  Â  Â  yesterday.setDate(today.getDate() - 1);
Â  Â  Â  Â  if (date.toDateString() === today.toDateString()) return "Today";
Â  Â  Â  Â  if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
Â  Â  Â  Â  return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
Â  Â  }

Â  Â  // Auto-resize textarea & Send Button Animation
Â  Â  mInput.addEventListener('input', function() {
Â  Â  Â  Â  this.style.height = 'auto';Â 
Â  Â  Â  Â  this.style.height = (this.scrollHeight) + 'px';
Â  Â  Â  Â  if(this.value === '') this.style.height = 'auto';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(this.value.trim().length > 0) {
Â  Â  Â  Â  Â  Â  sendBtnUI.classList.add('active');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  sendBtnUI.classList.remove('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  rdb.ref(`typing/${chatId}/${myUid}`).set(this.value.trim().length > 0);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Own Feature: Auto-Scroll on Typing
Â  Â  Â  Â  if(chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight < 100) {
Â  Â  Â  Â  Â  Â  Â scrollToBottom();
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // Handle Enter key - Modified as per request
Â  Â  mInput.addEventListener('keydown', (e) => {
Â  Â  Â  Â  // Enter creates new line, so we do nothing here (default behavior)
Â  Â  Â  Â  // Only explicitly shift+enter might be useful, but standard Enter = Next Line
Â  Â  });
Â  Â Â 
Â  Â  // --- SCROLL BUTTON VISIBILITY LOGIC ---
Â  Â  chatFlow.addEventListener('scroll', () => {
Â  Â  Â  Â  const diff = chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight;
Â  Â  Â  Â  if (diff > 250) {
Â  Â  Â  Â  Â  Â  scrollBtn.style.display = 'flex';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  scrollBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  scrollBtn.classList.remove('new-msg');
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- FIX: ALLOW PASTE BUT DISABLE RIGHT CLICK ELSEWHERE ---
Â  Â  window.oncontextmenu = (e) => {Â 
Â  Â  Â  Â  if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return true;
Â  Â  Â  Â  e.preventDefault();Â 
Â  Â  Â  Â  return false;Â 
Â  Â  };
Â  Â Â 
Â  Â  // --- COMPONENT INTEGRATION ---
Â  Â  const mainPicker = document.getElementById('main-picker');
Â  Â  const imagePickerComponent = document.getElementById('img-picker');
Â  Â  const filePickerComponent = document.getElementById('file-picker');
Â  Â  const mediaViewerComponent = document.getElementById('media-viewer');

Â  Â  if(mainPicker) {
Â  Â  Â  Â  mainPicker.addEventListener('emoji-click', event => {
Â  Â  Â  Â  Â  Â  const emoji = event.detail.emoji || event.detail.unicode;Â 
Â  Â  Â  Â  Â  Â  mInput.value += emoji;
Â  Â  Â  Â  Â  Â  mInput.focus();
Â  Â  Â  Â  Â  Â  mInput.dispatchEvent(new Event('input'));
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // NEW: Image Picker Listener - DIRECT SEND
Â  Â  if (imagePickerComponent) {
Â  Â  Â  Â  imagePickerComponent.addEventListener('image-uploaded', (e) => {
Â  Â  Â  Â  Â  Â  const url = e.detail.url;
Â  Â  Â  Â  Â  Â  if (url) {
Â  Â  Â  Â  Â  Â  Â  Â  // Immediately send the message with the image
Â  Â  Â  Â  Â  Â  Â  Â  sendImageMessage(url);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // NEW: File Picker Listener
Â  Â  if (filePickerComponent) {
Â  Â  Â  Â  filePickerComponent.addEventListener('file-uploaded', (e) => {
Â  Â  Â  Â  Â  Â  const { url, metadata } = e.detail;
Â  Â  Â  Â  Â  Â  if (url) {
Â  Â  Â  Â  Â  Â  Â  Â  sendFileMessage(url, metadata);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function toggleAttachmentMenu() {
Â  Â  Â  Â  if (attachmentMenu.style.display === 'flex') {
Â  Â  Â  Â  Â  Â  attachmentMenu.style.display = 'none';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  emojiTray.style.display = 'none'; // Close emoji if open
Â  Â  Â  Â  Â  Â  attachmentMenu.style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function openCameraPicker() {
Â  Â  Â  Â  attachmentMenu.style.display = 'none';
Â  Â  Â  Â  if (imagePickerComponent) {
Â  Â  Â  Â  Â  Â  imagePickerComponent.openPicker();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function openFilePicker() {
Â  Â  Â  Â  attachmentMenu.style.display = 'none';
Â  Â  Â  Â  if (filePickerComponent) {
Â  Â  Â  Â  Â  Â  filePickerComponent.openPicker();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function toggleEmojiTray() {
Â  Â  Â  Â  attachmentMenu.style.display = 'none'; // Close menu if open
Â  Â  Â  Â  if (emojiTray.style.display === 'block') {
Â  Â  Â  Â  Â  Â  emojiTray.style.display = 'none';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  emojiTray.style.display = 'block';
Â  Â  Â  Â  }
Â  Â  Â  Â  scrollToBottom();
Â  Â  }
Â  Â Â 
Â  Â  // Reaction Picker Logic (Half Screen Modal Component)
Â  Â  // Updated to ensure component usage for reactions
Â  Â  function expandEmojiMenu() {
Â  Â  Â  Â  closeMenu();
Â  Â  Â  Â  const reactionModal = document.getElementById('reaction-picker-modal');
Â  Â  Â  Â  const container = document.getElementById('reaction-picker-container');
Â  Â  Â  Â  container.innerHTML = '';Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Dynamically create the component
Â  Â  Â  Â  const reactionPicker = document.createElement('emoji-picker');
Â  Â  Â  Â  reactionPicker.style.width = "100%";
Â  Â  Â  Â  reactionPicker.style.height = "100%";
Â  Â  Â  Â  reactionPicker.addEventListener('emoji-click', event => {
Â  Â  Â  Â  Â  Â  Â const emoji = event.detail.emoji || event.detail.unicode;
Â  Â  Â  Â  Â  Â  Â applyReaction(emoji);
Â  Â  Â  Â  Â  Â  Â closeReactionPicker(); // Auto-close on selection (Fast Interaction)
Â  Â  Â  Â  });
Â  Â  Â  Â  container.appendChild(reactionPicker);
Â  Â  Â  Â  reactionModal.style.display = 'flex';
Â  Â  }

Â  Â  function closeReactionPicker() {
Â  Â  Â  Â  document.getElementById('reaction-picker-modal').style.display = 'none';
Â  Â  }

Â  Â  if (window.visualViewport) {
Â  Â  Â  Â  window.visualViewport.addEventListener('resize', () => {
Â  Â  Â  Â  Â  Â  const viewportHeight = window.visualViewport.height;
Â  Â  Â  Â  Â  Â  document.getElementById('main-app').style.height = viewportHeight + 'px';
Â  Â  Â  Â  Â  Â  document.body.style.top = window.visualViewport.offsetTop + 'px';
Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function vibrate(ms = 50) { if (navigator.vibrate) navigator.vibrate(ms); }

Â  Â  function goToProfile() {
Â  Â  Â  Â  if(targetUsername) window.location.href = `userProfile.html?user=${targetUsername}`;
Â  Â  }
Â  Â Â 
Â  Â  mInput.addEventListener("focus", () => { emojiTray.style.display = 'none'; attachmentMenu.style.display = 'none'; });

Â  Â  // --- REALTIME PRESENCE SYSTEM ---
Â  Â  function setupMyPresence() {
Â  Â  Â  Â  const userStatusDatabaseRef = rdb.ref('/status/' + myUid);
Â  Â  Â  Â  rdb.ref('.info/connected').on('value', (snapshot) => {
Â  Â  Â  Â  Â  Â  if (snapshot.val() == false) return;
Â  Â  Â  Â  Â  Â  userStatusDatabaseRef.onDisconnect().set({
Â  Â  Â  Â  Â  Â  Â  Â  state: 'offline',
Â  Â  Â  Â  Â  Â  Â  Â  last_changed: firebase.database.ServerValue.TIMESTAMP
Â  Â  Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  userStatusDatabaseRef.set({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state: 'online',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_changed: firebase.database.ServerValue.TIMESTAMP
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // === UPDATED: Function to update header UI based on latest data ===
Â  Â  function updateHeaderStatus() {
Â  Â  Â  Â  if (!lastStatusData) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Check typing status first (priority)
Â  Â  Â  Â  const isTyping = bottomTyping.style.display === 'flex';
Â  Â  Â  Â  if (isTyping) return; // Don't overwrite "Typing..."

Â  Â  Â  Â  if (lastStatusData.state === 'online') {
Â  Â  Â  Â  Â  Â  onlineDot.style.display = 'block';
Â  Â  Â  Â  Â  Â  headerSubLabel.innerText = "Active now";
Â  Â  Â  Â  Â  Â  headerSubLabel.style.color = "#00e676";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  onlineDot.style.display = 'none';
Â  Â  Â  Â  Â  Â  headerSubLabel.innerText = formatActiveTime(lastStatusData.last_changed);
Â  Â  Â  Â  Â  Â  headerSubLabel.style.color = "var(--text-secondary)";
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function monitorTargetStatus() {
Â  Â  Â  Â  if (!targetUid) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Clear any existing interval
Â  Â  Â  Â  if (statusUpdateInterval) clearInterval(statusUpdateInterval);

Â  Â  Â  Â  // Start interval to refresh time every 60s
Â  Â  Â  Â  statusUpdateInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  if (!isFirstStatusLoad) {
Â  Â  Â  Â  Â  Â  Â  Â  updateHeaderStatus();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 60000);

Â  Â  Â  Â  rdb.ref('/status/' + targetUid).on('value', (snapshot) => {
Â  Â  Â  Â  Â  Â  lastStatusData = snapshot.val();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Only update immediately if not typing
Â  Â  Â  Â  Â  Â  if (statusTimeout) clearTimeout(statusTimeout);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Initial simple state
Â  Â  Â  Â  Â  Â  if (!lastStatusData) {
Â  Â  Â  Â  Â  Â  Â  Â headerSubLabel.innerText = `@${chatTargetData.username}`;
Â  Â  Â  Â  Â  Â  Â  Â headerSubLabel.style.color = "var(--text-secondary)";
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // === NEW LOGIC: SHOW USERNAME FIRST 3 SECONDS ===
Â  Â  Â  Â  Â  Â  if (isFirstStatusLoad) {
Â  Â  Â  Â  Â  Â  Â  Â  // Force show username
Â  Â  Â  Â  Â  Â  Â  Â  headerSubLabel.innerText = `@${chatTargetData.username}`;
Â  Â  Â  Â  Â  Â  Â  Â  headerSubLabel.style.color = "var(--text-secondary)";
Â  Â  Â  Â  Â  Â  Â  Â  onlineDot.style.display = 'none';

Â  Â  Â  Â  Â  Â  Â  Â  // Wait 3 seconds, then switch to live status
Â  Â  Â  Â  Â  Â  Â  Â  statusTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isFirstStatusLoad = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateHeaderStatus();Â 
Â  Â  Â  Â  Â  Â  Â  Â  }, 3000);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Normal live update
Â  Â  Â  Â  Â  Â  Â  Â  if(bottomTyping.style.display !== 'flex') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Small delay to prevent jitter
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateHeaderStatus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 500);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  auth.onAuthStateChanged(user => {
Â  Â  Â  Â  if (user) {Â 
Â  Â  Â  Â  Â  Â  myUid = user.uid;Â 
Â  Â  Â  Â  Â  Â  db.collection('users').doc(myUid).get().then(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (doc.exists) myUserData = doc.data();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  setupMyPresence();
Â  Â  Â  Â  Â  Â  initChat();Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  else { window.location.href = 'login.html'; }
Â  Â  });

Â  Â  async function initChat() {
Â  Â  Â  Â  if(!targetUsername) return;
Â  Â  Â  Â  const snap = await db.collection("users").where("username", "==", targetUsername).get();
Â  Â  Â  Â  if (snap.empty) return;
Â  Â  Â  Â  targetUid = snap.docs[0].id;
Â  Â  Â  Â  chatId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  chatTargetData = snap.docs[0].data();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const pfp = document.getElementById('h-pfp');
Â  Â  Â  Â  pfp.classList.remove('loading-shimmer');
Â  Â  Â  Â  pfp.src = chatTargetData.photoURL || 'https://via.placeholder.com/150';
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('h-display-name').innerText = chatTargetData.name || chatTargetData.username;
Â  Â  Â  Â  document.getElementById('h-username-label').innerText = `@${chatTargetData.username}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(chatTargetData.verified === true) document.getElementById('v-badge').style.display = 'block';

Â  Â  Â  Â  monitorTargetStatus();

Â  Â  Â  Â  db.collection("chats").doc(chatId).update({Â 
Â  Â  Â  Â  Â  Â  [`unreadCount.${myUid}`]: 0,Â 
Â  Â  Â  Â  Â  Â  seen: trueÂ 
Â  Â  Â  Â  }).catch(e => {});

Â  Â  Â  Â  rdb.ref(`typing/${chatId}/${targetUid}`).on('value', (s) => {
Â  Â  Â  Â  Â  Â  const isTyping = s.val();
Â  Â  Â  Â  Â  Â  bottomTyping.style.display = isTyping ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  if(isTyping) {
Â  Â  Â  Â  Â  Â  Â  Â  if (statusTimeout) clearTimeout(statusTimeout);
Â  Â  Â  Â  Â  Â  Â  Â  headerSubLabel.innerText = "Typing...";
Â  Â  Â  Â  Â  Â  Â  Â  headerSubLabel.style.color = "#00e676";
Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  updateHeaderStatus(); // Revert to status
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  startListener();Â 
Â  Â  Â  Â  setupObserver();
Â  Â  Â  Â  setupGlobalSlide();Â 
Â  Â  }

Â  Â  // --- INSTAGRAM STYLE TIME REVEAL LOGIC ---
Â  Â  function setupGlobalSlide() {
Â  Â  Â  Â  let startX = 0, currentX = 0, isDragging = false;
Â  Â  Â  Â  const container = document.getElementById('messages-container');

Â  Â  Â  Â  chatFlow.addEventListener('touchstart', (e) => {
Â  Â  Â  Â  Â  Â  startX = e.touches[0].clientX;
Â  Â  Â  Â  Â  Â  isDragging = false;
Â  Â  Â  Â  }, {passive: true});

Â  Â  Â  Â  chatFlow.addEventListener('touchmove', (e) => {
Â  Â  Â  Â  Â  Â  currentX = e.touches[0].clientX;
Â  Â  Â  Â  Â  Â  const diff = currentX - startX;
Â  Â  Â  Â  Â  Â  if (diff < -10) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  isDragging = true;
Â  Â  Â  Â  Â  Â  Â  Â  const translate = Math.max(diff, -70);
Â  Â  Â  Â  Â  Â  Â  Â  container.style.transform = `translateX(${translate}px)`;
Â  Â  Â  Â  Â  Â  Â  Â  container.style.transition = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, {passive: true});

Â  Â  Â  Â  chatFlow.addEventListener('touchend', (e) => {
Â  Â  Â  Â  Â  Â  if (isDragging) {
Â  Â  Â  Â  Â  Â  Â  Â  container.style.transition = 'transform 0.2s cubic-bezier(0.215, 0.610, 0.355, 1.000)';
Â  Â  Â  Â  Â  Â  Â  Â  container.style.transform = `translateX(0px)`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  startX = 0; currentX = 0; isDragging = false;
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function setupObserver() {
Â  Â  Â  Â  const observer = new IntersectionObserver((entries) => {
Â  Â  Â  Â  Â  Â  if (entries[0].isIntersecting && !isLoadingMore && lastVisible) {
Â  Â  Â  Â  Â  Â  Â  Â  loadMoreMessages();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, { root: chatFlow, threshold: 0.5 });
Â  Â  Â  Â  observer.observe(document.getElementById('scroll-trigger'));
Â  Â  }

Â  Â  function startListener() {
Â  Â  Â  Â  if (unsubscribe) unsubscribe();
Â  Â  Â  Â Â 
Â  Â  Â  Â  unsubscribe = db.collection("chats").doc(chatId).collection("messages")
Â  Â  Â  Â  Â  Â  .orderBy("timestamp", "desc")
Â  Â  Â  Â  Â  Â  .limit(20)
Â  Â  Â  Â  Â  Â  .onSnapshot(snapshot => {
Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!lastVisible) lastVisible = snapshot.docs[snapshot.docs.length - 1];
Â  Â  Â  Â  Â  Â  Â  Â  let isNewIncoming = false;

Â  Â  Â  Â  Â  Â  Â  Â  snapshot.docChanges().forEach(change => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const msgData = change.doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const msgId = change.doc.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (change.type === "added") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messagesMap.set(msgId, msgData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(msgData.sender !== myUid) isNewIncoming = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (change.type === "modified") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messagesMap.set(msgId, msgData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (change.type === "removed") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messagesMap.delete(msgId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(msgData.sender !== myUid && !msgData.seen) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db.collection("chats").doc(chatId).collection("messages").doc(msgId).update({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  seen: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  seenAt: firebase.firestore.FieldValue.serverTimestamp()Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if(isNewIncoming) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vibrate(20);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight > 250) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scrollBtn.classList.add('new-msg');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Initial Load Instant Jump
Â  Â  Â  Â  Â  Â  Â  Â  if (isFirstLoad) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatFlow.scrollTop = chatFlow.scrollHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatFlow.style.opacity = '1';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isFirstLoad = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 50);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isNearBottom = chatFlow.scrollHeight - chatFlow.scrollTop - chatFlow.clientHeight < 300;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isNearBottom || isNewIncoming && isNearBottom) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  }

Â  Â  async function loadMoreMessages() {
Â  Â  Â  Â  if (isLoadingMore || !lastVisible) return;
Â  Â  Â  Â  isLoadingMore = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // CAPTURE SCROLL POS
Â  Â  Â  Â  chatFlow.style.scrollBehavior = 'auto'; // Disable smooth for instant jump
Â  Â  Â  Â  const oldScrollHeight = chatFlow.scrollHeight;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const snapshot = await db.collection("chats").doc(chatId).collection("messages")
Â  Â  Â  Â  Â  Â  .orderBy("timestamp", "desc")
Â  Â  Â  Â  Â  Â  .startAfter(lastVisible)
Â  Â  Â  Â  Â  Â  .limit(15)
Â  Â  Â  Â  Â  Â  .get();

Â  Â  Â  Â  if (!snapshot.empty) {
Â  Â  Â  Â  Â  Â  snapshot.forEach(doc => { messagesMap.set(doc.id, doc.data()); });
Â  Â  Â  Â  Â  Â  lastVisible = snapshot.docs[snapshot.docs.length - 1];
Â  Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ADJUST SCROLL POSITION INSTANTLY
Â  Â  Â  Â  Â  Â  chatFlow.scrollTop = chatFlow.scrollHeight - oldScrollHeight;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Re-enable smooth after a tick
Â  Â  Â  Â  Â  Â  setTimeout(() => { chatFlow.style.scrollBehavior = 'smooth'; }, 50);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  isLoadingMore = false;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  isLoadingMore = false;
Â  Â  Â  Â  Â  Â  lastVisible = null;Â 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function renderAll() {
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  const sorted = Array.from(messagesMap.entries())
Â  Â  Â  Â  Â  Â  .filter(([id, data]) => data.timestamp)Â 
Â  Â  Â  Â  Â  Â  .sort((a, b) => a[1].timestamp.toMillis() - b[1].timestamp.toMillis());

Â  Â  Â  Â  let lastDateLabel = "";

Â  Â  Â  Â  // Logic for Last Seen
Â  Â  Â  Â  let lastSeenMsgId = null;
Â  Â  Â  Â  for (let i = sorted.length - 1; i >= 0; i--) {
Â  Â  Â  Â  Â  Â  const [id, data] = sorted[i];
Â  Â  Â  Â  Â  Â  if (data.sender === myUid && data.seen === true) {
Â  Â  Â  Â  Â  Â  Â  Â  lastSeenMsgId = id;
Â  Â  Â  Â  Â  Â  Â  Â  break;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  sorted.forEach(([id, data], index) => {Â 
Â  Â  Â  Â  Â  Â  const msgDate = data.timestamp.toDate();
Â  Â  Â  Â  Â  Â  const dateLabel = getDateDivider(msgDate);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (dateLabel !== lastDateLabel) {
Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  div.className = "date-divider";
Â  Â  Â  Â  Â  Â  Â  Â  div.innerText = dateLabel;
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  Â  lastDateLabel = dateLabel;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- SMART PROFILE PICTURE LOGIC ---
Â  Â  Â  Â  Â  Â  let isLastInGroup = true;
Â  Â  Â  Â  Â  Â  if (index + 1 < sorted.length) {
Â  Â  Â  Â  Â  Â  Â  Â  const nextMsg = sorted[index + 1][1];
Â  Â  Â  Â  Â  Â  Â  Â  if (nextMsg.sender === data.sender) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLastInGroup = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  renderMessage(data, id, id === lastSeenMsgId, isLastInGroup);Â 
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function triggerHeartAnimation() {
Â  Â  Â  Â  const h = document.getElementById('heart-overlay');
Â  Â  Â  Â  h.style.animation = 'none';
Â  Â  Â  Â  h.offsetHeight;Â 
Â  Â  Â  Â  h.style.animation = 'heartPop 0.8s ease-out';
Â  Â  Â  Â  likeSound.play().catch(e => {});Â 
Â  Â  }

Â  Â  // Own Feature: Link Detection
Â  Â  function linkify(text) {
Â  Â  Â  Â  if (!text) return "";
Â  Â  Â  Â  const urlRegex = /(https?:\/\/[^\s]+)/g;
Â  Â  Â  Â  return text.replace(urlRegex, function(url) {
Â  Â  Â  Â  Â  Â  return `<a onclick="event.stopPropagation(); window.open('${url}', '_blank')">${url}</a>`;
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function scrollToAndFlash(textSnippet) {
Â  Â  Â  Â  const bubbles = document.querySelectorAll('.bubble span');
Â  Â  Â  Â  let targetId = null;
Â  Â  Â  Â  for(let span of bubbles) {
Â  Â  Â  Â  Â  Â  if(span.innerText.includes(textSnippet)) {
Â  Â  Â  Â  Â  Â  Â  Â  targetId = span.id.replace('text-', '');
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if(targetId) {
Â  Â  Â  Â  Â  Â  const el = document.getElementById(targetId);
Â  Â  Â  Â  Â  Â  if(el) {
Â  Â  Â  Â  Â  Â  Â  Â  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  const bubble = el.querySelector('.bubble') || el.closest('.bubble');
Â  Â  Â  Â  Â  Â  Â  Â  if(bubble) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bubble.style.animation = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bubble.offsetHeight;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bubble.style.animation = 'flashMessage 1s ease';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function renderMessage(m, id, isLastSeen, isLastInGroup) {
Â  Â  Â  Â  const side = m.sender === myUid ? 'sent' : 'received';
Â  Â  Â  Â  const date = m.timestamp ? m.timestamp.toDate() : new Date();

Â  Â  Â  Â  const rowDiv = document.createElement('div');
Â  Â  Â  Â  rowDiv.id = id;
Â  Â  Â  Â  rowDiv.className = `msg-row ${side}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let reactionsList = [];
Â  Â  Â  Â  let myReaction = null;
Â  Â  Â  Â  if (m.reactions) {
Â  Â  Â  Â  Â  Â  reactionsList = Object.values(m.reactions);
Â  Â  Â  Â  Â  Â  if (m.reactions[myUid]) myReaction = m.reactions[myUid].emoji;
Â  Â  Â  Â  }
Â  Â  Â  Â  const reactionDisplay = reactionsList.map(r => r.emoji).join(' ');

Â  Â  Â  Â  let seenText = "";
Â  Â  Â  Â  if (isLastSeen && side === 'sent') {
Â  Â  Â  Â  Â  Â  if (m.seenAt) {
Â  Â  Â  Â  Â  Â  Â  Â  seenText = "Seen " + timeAgo(m.seenAt.toDate());
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  seenText = "Seen";Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const boxStyle = reactionDisplay ? 'style="margin-bottom: 14px"' : '';
Â  Â  Â  Â  const replyHtml = m.replyTo ? `<div class="reply-box-ui" onclick="event.stopPropagation(); scrollToAndFlash('${m.replyTo}')">â¤´ ${m.replyTo}</div>` : '';

Â  Â  Â  Â  // NEW: Unique Instagram-like Note Reply UI
Â  Â  Â  Â  const noteReplyHtml = m.replyToNote ? `
Â  Â  Â  Â  Â  Â  <div class="note-reply-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="note-reply-pill" style="background: ${m.noteMetadata ? (m.noteMetadata.bgColor || '#262626') : '#262626'}; color: ${m.noteMetadata ? (m.noteMetadata.textColor || '#fff') : '#fff'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="note-header-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${m.noteMetadata && m.noteMetadata.pfp ? m.noteMetadata.pfp : (chatTargetData ? chatTargetData.photoURL : 'https://via.placeholder.com/20')}" class="note-mini-pfp">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="note-label">Replied to note</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="note-content-text">"${m.replyToNote}"</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${m.noteMetadata && m.noteMetadata.songName ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="note-song-tag">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24" style="width:10px; fill:currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${m.noteMetadata.songName}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="note-connector"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  ` : '';

Â  Â  Â  Â  // --- MEDIA TYPES LOGIC ---
Â  Â  Â  Â  let mediaHtml = '';
Â  Â  Â  Â  let bubbleClass = 'bubble';
Â  Â  Â  Â  let bubbleStyle = '';

Â  Â  Â  Â  // 1. IMAGE (Existing)
Â  Â  Â  Â  if (m.imageUrl) {
Â  Â  Â  Â  Â  Â  const imgClass = side === 'sent' ? 'sent-media-img' : 'received-media-img';
Â  Â  Â  Â  Â  Â  mediaHtml = `
Â  Â  Â  Â  Â  Â  <div class="msg-media-wrapper" onclick="document.getElementById('media-viewer').open('${m.imageUrl}')">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${m.imageUrl}" class="chat-media-img ${imgClass}">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="react-${id}" class="reaction-badge" onclick="showReactionDetails('${id}', event)" style="${reactionDisplay ? 'display:block' : ''}">${reactionDisplay}</div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  bubbleClass = "bubble has-media";
Â  Â  Â  Â  Â  Â  if(!m.text) bubbleStyle = "display:none;";
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  // 2. VIDEO
Â  Â  Â  Â  else if (m.fileUrl && m.fileMeta && m.fileMeta.type === 'video') {
Â  Â  Â  Â  Â  Â  mediaHtml = `
Â  Â  Â  Â  Â  Â  <div class="msg-video-container" onclick="document.getElementById('media-viewer').open('${m.fileUrl}', 'video')">
Â  Â  Â  Â  Â  Â  Â  Â  <video src="${m.fileUrl}#t=0.5" class="chat-media-img" style="object-fit:cover; width:100%; height:200px; background:#000;" preload="metadata"></video>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="play-overlay"><svg viewBox="0 0 24 24" fill="white" style="width:24px; height:24px;"><path d="M8 5v14l11-7z"/></svg></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="react-${id}" class="reaction-badge" onclick="showReactionDetails('${id}', event)" style="${reactionDisplay ? 'display:block' : ''}">${reactionDisplay}</div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  bubbleClass = "bubble has-media";
Â  Â  Â  Â  Â  Â  if(!m.text) bubbleStyle = "display:none;";
Â  Â  Â  Â  }
Â  Â  Â  Â  // 3. AUDIO (Instagram Style)
Â  Â  Â  Â  else if (m.fileUrl && m.fileMeta && m.fileMeta.type === 'audio') {
Â  Â  Â  Â  Â  Â  const safeId = 'audio-' + id;
Â  Â  Â  Â  Â  Â  mediaHtml = `
Â  Â  Â  Â  Â  Â  <div class="msg-audio-pill">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="audio-control-btn" onclick="toggleAudio('${safeId}', '${m.fileUrl}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="icon-${safeId}" viewBox="0 0 24 24" style="width:18px; fill:#000;"><path d="M8 5v14l11-7z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="audio-waveform">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="prog-${safeId}" class="audio-progress"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <audio id="${safeId}" src="${m.fileUrl}" ontimeupdate="updateAudioUI('${safeId}')" onended="resetAudioUI('${safeId}')"></audio>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="react-${id}" class="reaction-badge" style="position:absolute; bottom:-8px; right:10px; ${reactionDisplay ? 'display:block' : ''}" onclick="showReactionDetails('${id}', event)">${reactionDisplay}</div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  // Audio usually doesn't have caption in this style, or it sits below
Â  Â  Â  Â  Â  Â  bubbleClass = "bubble has-media";Â 
Â  Â  Â  Â  Â  Â  if(!m.text) bubbleStyle = "display:none;";
Â  Â  Â  Â  }
Â  Â  Â  Â  // 4. DOCUMENT
Â  Â  Â  Â  else if (m.fileUrl) {
Â  Â  Â  Â  Â  Â  mediaHtml = `
Â  Â  Â  Â  Â  Â  <div class="msg-file-pill" onclick="window.open('${m.fileUrl}', '_blank')">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-icon">ğŸ“„</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-name">${m.fileMeta.name || "File"}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-meta">${(m.fileMeta.size / (1024*1024)).toFixed(2)} MB â€¢ ${m.fileMeta.type.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-dl-btn">â¬‡</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="react-${id}" class="reaction-badge" style="right:0; ${reactionDisplay ? 'display:block' : ''}" onclick="showReactionDetails('${id}', event)">${reactionDisplay}</div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  bubbleClass = "bubble has-media";
Â  Â  Â  Â  Â  Â  if(!m.text) bubbleStyle = "display:none;";
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- HTML ASSEMBLY ---
Â  Â  Â  Â  const safeText = linkify(m.text);
Â  Â  Â  Â  let innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Base content block
Â  Â  Â  Â  let contentHTML = `
Â  Â  Â  Â  Â  Â  ${noteReplyHtml}
Â  Â  Â  Â  Â  Â  ${replyHtml}
Â  Â  Â  Â  Â  Â  ${mediaHtml}
Â  Â  Â  Â  Â  Â  <div class="${bubbleClass}" id="bubble-${id}" style="${bubbleStyle}">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="text-${id}">${safeText} ${m.edited ? '<small style="opacity:0.4;font-size:0.6rem"> (edited)</small>' : ''}</span>
Â  Â  Â  Â  Â  Â  Â  Â  ${(!m.imageUrl && !m.fileUrl) ? `<div id="react-${id}" class="reaction-badge" onclick="showReactionDetails('${id}', event)" style="${reactionDisplay ? 'display:block' : ''}">${reactionDisplay}</div>` : ''}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;

Â  Â  Â  Â  if (side === 'received') {
Â  Â  Â  Â  Â  Â  const pfpUrl = chatTargetData ? chatTargetData.photoURL : 'https://via.placeholder.com/30';
Â  Â  Â  Â  Â  Â  const visibility = isLastInGroup ? 'visible' : 'hidden';
Â  Â  Â  Â  Â  Â  innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="received-inner-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${pfpUrl}" class="msg-avatar" style="visibility: ${visibility}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="msg-bubble-box" ${boxStyle}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${contentHTML}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="msg-bubble-box" ${boxStyle}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${contentHTML}
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  rowDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  ${innerHTML}
Â  Â  Â  Â  Â  Â  ${seenText ? `<div class="seen-status">${seenText}</div>` : ''}
Â  Â  Â  Â  Â  Â  <div class="sliding-timestamp">${formatTime12(date)}</div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  container.appendChild(rowDiv);

Â  Â  Â  Â  // Listeners for text bubbles
Â  Â  Â  Â  const bubbleEl = rowDiv.querySelector(`#bubble-${id}`);
Â  Â  Â  Â  if(bubbleEl && bubbleEl.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  attachMessageListeners(bubbleEl, id, m);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Listeners for Wrappers (Media)
Â  Â  Â  Â  if(m.imageUrl || (m.fileUrl && m.fileMeta.type === 'video')) {
Â  Â  Â  Â  Â  Â  Â const mediaEl = rowDiv.querySelector('.msg-media-wrapper') || rowDiv.querySelector('.msg-video-container');
Â  Â  Â  Â  Â  Â  Â if(mediaEl) attachMessageListeners(mediaEl, id, m);
Â  Â  Â  Â  }
Â  Â  Â  Â  // Listeners for Audio/File pills
Â  Â  Â  Â  if(m.fileUrl && (m.fileMeta.type === 'audio' || m.fileMeta.type === 'pdf' || m.fileMeta.type === 'file')) {
Â  Â  Â  Â  Â  Â  Â const pill = rowDiv.querySelector('.msg-audio-pill') || rowDiv.querySelector('.msg-file-pill');
Â  Â  Â  Â  Â  Â  Â if(pill) attachMessageListeners(pill, id, m);
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // --- AUDIO PLAYER LOGIC ---
Â  Â  window.toggleAudio = function(id, url) {
Â  Â  Â  Â  const audio = document.getElementById(id);
Â  Â  Â  Â  const icon = document.getElementById('icon-' + id);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Pause all other audios
Â  Â  Â  Â  document.querySelectorAll('audio').forEach(a => {
Â  Â  Â  Â  Â  Â  if(a.id !== id) {
Â  Â  Â  Â  Â  Â  Â  Â  a.pause();
Â  Â  Â  Â  Â  Â  Â  Â  resetAudioUI(a.id);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (audio.paused) {
Â  Â  Â  Â  Â  Â  audio.play();
Â  Â  Â  Â  Â  Â  icon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; // Pause Icon
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  audio.pause();
Â  Â  Â  Â  Â  Â  icon.innerHTML = '<path d="M8 5v14l11-7z"/>'; // Play Icon
Â  Â  Â  Â  }
Â  Â  };

Â  Â  window.updateAudioUI = function(id) {
Â  Â  Â  Â  const audio = document.getElementById(id);
Â  Â  Â  Â  const prog = document.getElementById('prog-' + id);
Â  Â  Â  Â  const pct = (audio.currentTime / audio.duration) * 100;
Â  Â  Â  Â  prog.style.width = pct + '%';
Â  Â  };

Â  Â  window.resetAudioUI = function(id) {
Â  Â  Â  Â  const icon = document.getElementById('icon-' + id);
Â  Â  Â  Â  const prog = document.getElementById('prog-' + id);
Â  Â  Â  Â  icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
Â  Â  Â  Â  prog.style.width = '0%';
Â  Â  };

Â  Â  // Extracted Listener Logic for re-use on Text Bubble OR Image
Â  Â  function attachMessageListeners(element, id, m) {
Â  Â  Â  Â  Â  Â  let reactionsList = [];
Â  Â  Â  Â  Â  Â  let myReaction = null;
Â  Â  Â  Â  Â  Â  if (m.reactions && m.reactions[myUid]) myReaction = m.reactions[myUid].emoji;

Â  Â  Â  Â  Â  Â  element.addEventListener('dblclick', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault(); e.stopPropagation(); vibrate(40);
Â  Â  Â  Â  Â  Â  Â  Â  triggerHeartAnimation();
Â  Â  Â  Â  Â  Â  Â  Â  applyReactionToId(id, myReaction === 'â¤ï¸' ? '' : 'â¤ï¸');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  let startX = 0, currentX = 0, menuTimer = null, isScrolling = false, swipeTriggered = false;

Â  Â  Â  Â  Â  Â  element.addEventListener('touchstart', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  startX = e.touches[0].clientX;
Â  Â  Â  Â  Â  Â  Â  Â  isScrolling = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  swipeTriggered = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  menuTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isScrolling) { vibrate(70); openMenu(id, m.sender, m.text); }
Â  Â  Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  Â  }, {passive: true});

Â  Â  Â  Â  Â  Â  element.addEventListener('touchmove', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  currentX = e.touches[0].clientX;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (Math.abs(currentX - startX) > 10) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â clearTimeout(menuTimer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isScrolling = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let diff = currentX - startX;
Â  Â  Â  Â  Â  Â  Â  Â  if (diff > 0 && diff < 80) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  element.style.transform = `translateX(${diff}px)`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  element.style.transition = "none";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (diff > 50 && !swipeTriggered) { vibrate(20); swipeTriggered = true; }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, {passive: true});

Â  Â  Â  Â  Â  Â  element.addEventListener('touchend', () => {
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(menuTimer);
Â  Â  Â  Â  Â  Â  Â  Â  let diff = currentX - startX;
Â  Â  Â  Â  Â  Â  Â  Â  element.style.transition = "transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
Â  Â  Â  Â  Â  Â  Â  Â  element.style.transform = `translateX(0px)`;
Â  Â  Â  Â  Â  Â  Â  Â  if (diff > 50 && swipeTriggered) triggerReply(m.text || "Image");
Â  Â  Â  Â  Â  Â  Â  Â  startX = 0; currentX = 0;
Â  Â  Â  Â  Â  Â  });
Â  Â  }

Â  Â  function triggerReply(text) {
Â  Â  Â  Â  replyingTo = text;
Â  Â  Â  Â  document.getElementById('reply-text').innerText = "Replying to: " + (text.length > 50 ? text.substring(0,50)+"..." : text);
Â  Â  Â  Â  document.getElementById('reply-dock').style.display = 'flex';
Â  Â  Â  Â  mInput.focus();Â 
Â  Â  }

Â  Â  // NEW: Function to send image message immediately
Â  Â  async function sendImageMessage(imageUrl) {
Â  Â  Â  Â  popSound.play().catch(e => {});
Â  Â  Â  Â  scrollToBottom();

Â  Â  Â  Â  let msgData = {
Â  Â  Â  Â  Â  Â  text: "", // No caption for direct send
Â  Â  Â  Â  Â  Â  sender: myUid,Â 
Â  Â  Â  Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  Â  Â  replyTo: replyingTo,Â 
Â  Â  Â  Â  Â  Â  seen: false,Â 
Â  Â  Â  Â  Â  Â  reactions: {},
Â  Â  Â  Â  Â  Â  imageUrl: imageUrl
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reset reply state if any
Â  Â  Â  Â  cancelInteraction();

Â  Â  Â  Â  await db.collection("chats").doc(chatId).collection("messages").add(msgData);
Â  Â  Â  Â  updateLastMsg("ğŸ“· Image");
Â  Â  Â  Â  scrollToBottom();
Â  Â  }

Â  Â  // NEW: Function to send File/Video/Audio
Â  Â  async function sendFileMessage(fileUrl, metadata) {
Â  Â  Â  Â  popSound.play().catch(e => {});
Â  Â  Â  Â  scrollToBottom();

Â  Â  Â  Â  const caption = metadata.caption || "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  let msgData = {
Â  Â  Â  Â  Â  Â  text: caption,
Â  Â  Â  Â  Â  Â  sender: myUid,
Â  Â  Â  Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  Â  Â  replyTo: replyingTo,
Â  Â  Â  Â  Â  Â  seen: false,
Â  Â  Â  Â  Â  Â  reactions: {},
Â  Â  Â  Â  Â  Â  fileUrl: fileUrl,
Â  Â  Â  Â  Â  Â  fileMeta: metadata
Â  Â  Â  Â  };

Â  Â  Â  Â  cancelInteraction();

Â  Â  Â  Â  await db.collection("chats").doc(chatId).collection("messages").add(msgData);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let label = "ğŸ“„ File";
Â  Â  Â  Â  if(metadata.type === 'video') label = "ğŸ¥ Video";
Â  Â  Â  Â  if(metadata.type === 'audio') label = "ğŸµ Audio";
Â  Â  Â  Â Â 
Â  Â  Â  Â  updateLastMsg(caption ? label + " " + caption : label);
Â  Â  Â  Â  scrollToBottom();
Â  Â  }

Â  Â  async function updateLastMsg(msgText) {
Â  Â  Â  Â  await db.collection("chats").doc(chatId).set({
Â  Â  Â  Â  Â  Â  lastMessage: msgText,Â 
Â  Â  Â  Â  Â  Â  lastSender: myUid,
Â  Â  Â  Â  Â  Â  lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  Â  Â  participants: [myUid, targetUid], seen: false,
Â  Â  Â  Â  Â  Â  [`unreadCount.${targetUid}`]: firebase.firestore.FieldValue.increment(1)
Â  Â  Â  Â  }, { merge: true });
Â  Â  }

Â  Â  async function sendMsg() {
Â  Â  Â  Â  const text = mInput.value.trim();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!text) {
Â  Â  Â  Â  Â  Â  inputBox.classList.add('shake-anim');
Â  Â  Â  Â  Â  Â  setTimeout(() => inputBox.classList.remove('shake-anim'), 400);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  popSound.play().catch(e => {});

Â  Â  Â  Â  // KEYBOARD FIX: Clear value but DO NOT BLUR
Â  Â  Â  Â  mInput.value = "";
Â  Â  Â  Â  mInput.style.height = 'auto';Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  sendBtnUI.classList.remove('active');Â 
Â  Â  Â  Â  emojiTray.style.display = 'none';
Â  Â  Â  Â  attachmentMenu.style.display = 'none';
Â  Â  Â  Â  rdb.ref(`typing/${chatId}/${myUid}`).set(false);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FORCE FOCUS TO REMAIN
Â  Â  Â  Â  mInput.focus();Â 
Â  Â  Â  Â  setTimeout(() => mInput.focus(), 10);Â 

Â  Â  Â  Â  if (editModeId) {
Â  Â  Â  Â  Â  Â  const idToEdit = editModeId; editModeId = null;
Â  Â  Â  Â  Â  Â  cancelInteraction(); // Close the editing dock
Â  Â  Â  Â  Â  Â  await db.collection("chats").doc(chatId).collection("messages").doc(idToEdit).update({ text, edited: true });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const rText = replyingTo; cancelInteraction(); // Close reply dock
Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let msgData = {
Â  Â  Â  Â  Â  Â  Â  Â  text, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  replyTo: rText, seen: false, reactions: {}
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  await db.collection("chats").doc(chatId).collection("messages").add(msgData);
Â  Â  Â  Â  Â  Â  updateLastMsg(text);
Â  Â  Â  Â  }
Â  Â  Â  Â  scrollToBottom();
Â  Â  }

Â  Â  function scrollToBottom() {Â 
Â  Â  Â  Â  chatFlow.scrollTop = chatFlow.scrollHeight;Â 
Â  Â  }

Â  Â  function openMenu(id, sender, text) {
Â  Â  Â  Â  activeMenuId = id;
Â  Â  Â  Â  const isMine = sender === myUid;
Â  Â  Â  Â  document.getElementById('edit-btn').style.display = (isMine && text) ? 'block' : 'none'; // Only allow edit if text exists
Â  Â  Â  Â  document.getElementById('unsend-btn').style.display = isMine ? 'block' : 'none';
Â  Â  Â  Â  document.getElementById('menu-emoji-grid').style.display = 'none';
Â  Â  Â  Â  document.getElementById('menu-overlay').style.display = 'flex';
Â  Â  }

Â  Â  async function copyMessageText() {
Â  Â  Â  Â  if (!activeMenuId) return;
Â  Â  Â  Â  const el = document.getElementById('text-' + activeMenuId);
Â  Â  Â  Â  if(!el) { closeMenu(); return; } // Might be image only
Â  Â  Â  Â Â 
Â  Â  Â  Â  const msgText = el.innerText.split('(edited)')[0].trim();
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await navigator.clipboard.writeText(msgText);
Â  Â  Â  Â  Â  Â  closeMenu();
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error('Failed to copy: ', err);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function applyReaction(emoji) {
Â  Â  Â  Â  if (!activeMenuId) return;
Â  Â  Â  Â  const msgId = activeMenuId; closeMenu();Â 
Â  Â  Â  Â  await applyReactionToId(msgId, emoji);
Â  Â  }

Â  Â  async function applyReactionToId(id, emoji) {
Â  Â  Â  Â  // --- 1. OPTIMISTIC UPDATE (Fix for old messages) ---
Â  Â  Â  Â  if(messagesMap.has(id)) {
Â  Â  Â  Â  Â  Â  let msg = messagesMap.get(id);
Â  Â  Â  Â  Â  Â  if(!msg.reactions) msg.reactions = {};

Â  Â  Â  Â  Â  Â  if(msg.reactions[myUid] && msg.reactions[myUid].emoji === emoji) {
Â  Â  Â  Â  Â  Â  Â  Â  Â delete msg.reactions[myUid];
Â  Â  Â  Â  Â  Â  } else if (emoji !== '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â msg.reactions[myUid] = { emoji: emoji, timestamp: Date.now() };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  messagesMap.set(id, msg);
Â  Â  Â  Â  Â  Â  renderAll(); // Refresh UI immediately
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 2. FIREBASE UPDATE ---
Â  Â  Â  Â  const msgRef = db.collection("chats").doc(chatId).collection("messages").doc(id);
Â  Â  Â  Â  const doc = await msgRef.get();
Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  let currentReaction = (data.reactions && data.reactions[myUid]) ? data.reactions[myUid].emoji : null;

Â  Â  Â  Â  if (currentReaction === emoji) {
Â  Â  Â  Â  Â  Â  await msgRef.update({ [`reactions.${myUid}`]: firebase.firestore.FieldValue.delete() });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  await msgRef.update({ [`reactions.${myUid}`]: { emoji: emoji, timestamp: Date.now() } });
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function showReactionDetails(msgId, event) {
Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  const msgData = messagesMap.get(msgId);
Â  Â  Â  Â  if (!msgData || !msgData.reactions) return;

Â  Â  Â  Â  const listContainer = document.getElementById('react-list-items');
Â  Â  Â  Â  listContainer.innerHTML = '';

Â  Â  Â  Â  Object.entries(msgData.reactions).forEach(([uid, rData]) => {
Â  Â  Â  Â  Â  Â  const isMe = uid === myUid;
Â  Â  Â  Â  Â  Â  // FIX: Use stored myUserData for my PFP
Â  Â  Â  Â  Â  Â  const pfpSrc = isMe ? (myUserData ? myUserData.photoURL : 'https://via.placeholder.com/40') : chatTargetData.photoURL;
Â  Â  Â  Â  Â  Â  const name = isMe ? "You" : (chatTargetData.name || chatTargetData.username);
Â  Â  Â  Â  Â  Â  const timeStr = formatTime12(new Date(rData.timestamp));

Â  Â  Â  Â  Â  Â  const el = document.createElement('div');
Â  Â  Â  Â  Â  Â  el.className = 'reactor-item';
Â  Â  Â  Â  Â  Â  el.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${pfpSrc}" class="reactor-pfp">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="reactor-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="reactor-name">${name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="reactor-time">${timeStr}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="reactor-emoji">${rData.emoji}</div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  listContainer.appendChild(el);
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById('reaction-details-overlay').style.display = 'flex';
Â  Â  }

Â  Â  function closeReactionDetails() { document.getElementById('reaction-details-overlay').style.display = 'none'; }
Â  Â Â 
Â  Â  // Note: The Grid function 'expandEmojiMenu' was removed here to prevent conflict
Â  Â  // and ensure usage of the Full Component modal defined above.

Â  Â  function initReplyFromActive() {
Â  Â  Â  Â  const el = document.getElementById('text-'+activeMenuId);
Â  Â  Â  Â  const text = el ? el.innerText.split('(edited)')[0].trim() : "Image";
Â  Â  Â  Â  triggerReply(text);
Â  Â  Â  Â  closeMenu();
Â  Â  }

Â  Â  function closeMenu() { document.getElementById('menu-overlay').style.display = 'none'; }
Â  Â Â 
Â  Â  // Unified Cancel function for Replying AND Editing
Â  Â  // FIX: Properly clears edit mode ID to prevent overwriting
Â  Â  function cancelInteraction() {Â 
Â  Â  Â  Â  // FIX: Clear input ONLY if we were editing. If replying, keep draft.
Â  Â  Â  Â  if (editModeId) {
Â  Â  Â  Â  Â  Â  mInput.value = "";
Â  Â  Â  Â  Â  Â  mInput.style.height = 'auto';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  replyingTo = null;Â 
Â  Â  Â  Â  editModeId = null;
Â  Â  Â  Â  document.getElementById('reply-dock').style.display = 'none';Â 
Â  Â  Â  Â  // REMOVED mInput.blur() to keep keyboard open
Â  Â  }
Â  Â Â 
Â  Â  // NEW: Proper Edit Mode with UI Feedback
Â  Â  function initEdit() {
Â  Â  Â  Â  const el = document.getElementById('text-'+activeMenuId);
Â  Â  Â  Â  if(!el) return; // Cannot edit image only messages
Â  Â  Â  Â Â 
Â  Â  Â  Â  const textToEdit = el.innerText.split('(edited)')[0].trim();
Â  Â  Â  Â  mInput.value = textToEdit;
Â  Â  Â  Â  mInput.style.height = 'auto';Â 
Â  Â  Â  Â  mInput.style.height = mInput.scrollHeight + 'px';
Â  Â  Â  Â Â 
Â  Â  Â  Â  editModeId = activeMenuId;Â 
Â  Â  Â  Â  closeMenu();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Show the dock as "Editing"
Â  Â  Â  Â  document.getElementById('reply-text').innerHTML = "<strong style='color:#0095f6'>Editing Message:</strong><br> " + textToEdit;
Â  Â  Â  Â  document.getElementById('reply-dock').style.display = 'flex';
Â  Â  Â  Â Â 
Â  Â  Â  Â  mInput.focus();
Â  Â  }

Â  Â  async function unsendMsg() {Â 
Â  Â  Â  Â  const idToDelete = activeMenuId; closeMenu();
Â  Â  Â  Â  // Optimistic Remove
Â  Â  Â  Â  if (messagesMap.has(idToDelete)) { messagesMap.delete(idToDelete); renderAll(); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  await db.collection("chats").doc(chatId).collection("messages").doc(idToDelete).delete();
Â  Â  Â  Â  const snapshot = await db.collection("chats").doc(chatId).collection("messages").orderBy("timestamp", "desc").limit(1).get();
Â  Â  Â  Â  if (!snapshot.empty) {
Â  Â  Â  Â  Â  Â  const lastMsg = snapshot.docs[0].data();
Â  Â  Â  Â  Â  Â  const txt = lastMsg.imageUrl ? (lastMsg.text ? "ğŸ“· "+lastMsg.text : "ğŸ“· Image") : lastMsg.text;
Â  Â  Â  Â  Â  Â  await db.collection("chats").doc(chatId).update({ lastMessage: txt, lastSender: lastMsg.sender, lastTimestamp: lastMsg.timestamp });
Â  Â  Â  Â  }
Â  Â  }
</script>

<script src="components/call-notifier.js" defer></script>
<call-notifier></call-notifier>

</body>
</html>
