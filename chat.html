<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Goorac | Quantum Chat</title>

    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

      // Initialize Main App Instance
      export const firebaseConfig = {
          apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
          authDomain: "goorac-c3b59.firebaseapp.com",
          projectId: "goorac-c3b59",
          storageBucket: "goorac-c3b59.firebasestorage.app",
          messagingSenderId: "746746595332",
          appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
          measurementId: "G-M46FEVRYSS"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
    </script>

    <script type="module" src="components/presence.js"></script>
    <script src="components/emojiPicker.js" defer></script>
    <script src="components/imagePicker.js" defer></script>
    <script src="components/filePicker.js" defer></script>
    <script src="components/viewMedia.js" defer></script>
    <script src="components/call-notifier.js" defer></script>

    <style>
        /* --- CORE VARIABLES & THEME CONFIGURATION --- */
        :root { 
            /* Backgrounds */
            --bg-deep: #000000;
            --bg-radial: radial-gradient(circle at 50% 30%, #121212 0%, #000000 80%); 
            --header-bg: rgba(10, 10, 10, 0.92);
            --header-blur: blur(20px);
            
            /* Accents */
            --accent: #0095f6; 
            --accent-gradient: linear-gradient(135deg, #0095f6 0%, #0077c2 100%);
            --border: #1f1f1f; 
            
            /* Message Bubbles */
            --sent-bg: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%); /* Modern Blue Cyan */
            --sent-bg-solid: #0095f6;
            --received-bg: #262626; 
            
            /* Text */
            --text: #ffffff; 
            --text-secondary: #a8a8a8;
            --text-tertiary: #666666;

            /* Effects */
            --shimmer: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-hard: 0 8px 24px rgba(0,0,0,0.4);
        }

        /* --- RESET & BASE STYLES --- */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0; 
            -webkit-touch-callout: none; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        html, body {
            height: 100%; width: 100%;
            overflow: hidden;
            background: var(--bg-deep);
            background-image: var(--bg-radial);
            position: fixed; 
            left: 0; top: 0;
            margin: 0 !important; padding: 0 !important;
        }

        body { 
            -webkit-user-select: none; user-select: none; 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            font-size: 16px; /* Base size prevents iOS zoom */
        }

        /* --- UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { display: flex; flex-direction: column; }
        .center { display: flex; align-items: center; justify-content: center; }
        
        /* Selectable Text Areas */
        input, textarea { 
            -webkit-user-select: text !important; 
            user-select: text !important; 
            outline: none; 
            font-family: inherit;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes shimmer { 0% { background-position: -400px 0; } 100% { background-position: 400px 0; } }
        @keyframes flashMessage { 0% { background-color: rgba(255, 255, 255, 0.2); transform: scale(1.02); } 100% { background-color: transparent; transform: scale(1); } }
        @keyframes scaleIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUpFade { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeStatus { 0% { opacity: 0; transform: translateY(-2px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); } 20%, 40%, 60%, 80% { transform: translateX(4px); } }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); } 70% { box-shadow: 0 0 0 5px rgba(0, 230, 118, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); } }
        @keyframes imgFadeIn { from { opacity: 0; transform: scale(0.98); filter: blur(4px); } to { opacity: 1; transform: scale(1); filter: blur(0); } }
        @keyframes rippleEffect { to { transform: scale(4); opacity: 0; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

        /* --- LAYOUT STRUCTURE --- */
        .app-container { 
            display: flex; flex-direction: column; 
            height: 100vh; height: 100dvh; width: 100%; 
            position: absolute; top: 0; left: 0; overflow: hidden;
        }

        /* --- HEADER --- */
        header { 
            position: absolute; 
            top: 0; left: 0; right: 0;
            padding: 0 16px;
            padding-top: calc(env(safe-area-inset-top) + 8px);
            height: calc(64px + env(safe-area-inset-top));
            background: var(--header-bg); 
            border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; gap: 12px; 
            z-index: 2000; 
            backdrop-filter: var(--header-blur); 
            -webkit-backdrop-filter: var(--header-blur);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .back-btn { 
            font-size: 2rem; color: var(--accent); 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            height: 44px; width: 34px; margin-left: -8px;
            transition: opacity 0.2s;
        }
        .back-btn:active { opacity: 0.6; }

        .h-profile-group { 
            display: flex; align-items: center; gap: 12px; 
            cursor: pointer; flex: 1; overflow: hidden; 
            padding: 4px 0;
        }
        
        .pfp-container { position: relative; width: 40px; height: 40px; flex-shrink: 0; }
        .h-pfp { 
            width: 100%; height: 100%; border-radius: 50%; 
            object-fit: cover; background: #1a1a1a; 
            border: 1px solid #333; transition: opacity 0.3s ease; 
        }
        .online-dot { 
            position: absolute; bottom: 1px; right: 1px; 
            width: 11px; height: 11px; 
            background: #00e676; border-radius: 50%; 
            border: 2px solid #000; display: none; 
            box-shadow: 0 0 6px rgba(0,230,118,0.6); 
        }
        .online-dot.active { display: block; animation: pulseGreen 2.5s infinite; }
        
        .h-info { display: flex; flex-direction: column; justify-content: center; gap: 2px; min-width: 0; }
        .h-name-wrapper { display: flex; align-items: center; gap: 5px; line-height: 1.1; }
        .h-name { 
            font-weight: 700; font-size: 1.05rem; color: #fff; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            letter-spacing: 0.3px;
        }
        .h-name:empty { height: 16px; width: 120px; border-radius: 4px; background: var(--shimmer); background-size: 800px 100%; animation: shimmer 1.5s infinite linear; }
        
        .h-username-sub { 
            font-size: 0.8rem; color: var(--text-secondary); 
            font-weight: 400; transition: color 0.3s ease;
        }
        .v-badge { width: 15px; height: 15px; display: none; filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); }

        .header-actions { display: flex; align-items: center; gap: 22px; margin-left: auto; padding-right: 4px; }
        .header-icon { 
            width: 26px; height: 26px; cursor: pointer; 
            fill: #ffffff; opacity: 0.95; 
            transition: transform 0.2s, opacity 0.2s; 
        }
        .header-icon:active { opacity: 0.6; transform: scale(0.92); }

        /* --- CHAT SCROLL AREA --- */
        #chat-flow { 
            flex: 1; overflow-y: scroll; overflow-x: hidden; 
            padding: 15px 0; 
            display: flex; flex-direction: column; 
            -webkit-overflow-scrolling: touch;
            background: transparent; 
            overscroll-behavior-y: contain; 
            position: relative;
            padding-top: calc(70px + env(safe-area-inset-top)); 
            padding-bottom: 20px;
            
            /* Scrollbar Hiding */
            -ms-overflow-style: none; scrollbar-width: none;
            opacity: 0; transition: opacity 0.25s ease-out;
        }
        #chat-flow::-webkit-scrollbar { display: none; }
        
        #messages-container { 
            display: flex; flex-direction: column; 
            padding: 0 14px; 
            will-change: transform; width: 100%; 
            padding-bottom: 10px; 
        }

        /* --- TYPING INDICATOR --- */
        .typing-row { 
            display: none; /* Toggled by JS */
            align-items: flex-end; 
            margin-bottom: 20px; 
            padding-left: 16px; 
            width: 100%;
            animation: slideUpFade 0.3s ease-out;
        }
        .typing-avatar { 
            width: 30px; height: 30px; 
            border-radius: 50%; 
            margin-right: 10px; 
            object-fit: cover; 
            background: #121212; 
            border: 1px solid #222;
        }
        .typing-bubble { 
            background: var(--received-bg); 
            padding: 12px 18px; 
            border-radius: 20px; 
            border-bottom-left-radius: 4px; 
            display: flex; 
            gap: 5px; 
            align-items: center; 
            width: fit-content; 
            height: 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .typing-dot { 
            width: 7px; height: 7px; 
            background: #bbb; 
            border-radius: 50%; 
            animation: typingWave 1.4s ease-in-out infinite both; 
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingWave { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); background: #fff; } }

        /* --- INFINITE SCROLL LOADER --- */
        #scroll-trigger { text-align: center; padding: 20px; opacity: 0; pointer-events: none; order: -1; }
        
        /* --- DATE DIVIDERS --- */
        .date-divider { 
            text-align: center; 
            margin: 24px 0 16px 0; 
            align-self: center; 
            width: fit-content; 
            position: sticky; 
            top: 10px; 
            z-index: 100; 
            
            font-size: 0.72rem; 
            color: #ccc; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            
            background: rgba(30, 30, 30, 0.65); 
            padding: 6px 14px; 
            border-radius: 14px; 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* --- MESSAGE ROWS & GROUPING --- */
        .msg-row { 
            display: flex; width: 100%; 
            margin-bottom: 2px; 
            position: relative; 
            flex-direction: column; 
            animation: slideUpFade 0.3s cubic-bezier(0.2, 0.6, 0.2, 1) forwards;
        }
        
        /* Spacing for groups */
        .msg-row.group-bottom, .msg-row.single { margin-bottom: 14px; }

        /* Alignment */
        .msg-row.sent { align-items: flex-end; padding-right: 0px; }
        .msg-row.received { align-items: flex-start; }
        
        .received-inner-row { display: flex; align-items: flex-end; gap: 8px; max-width: 100%; }
        
        /* Avatar Visibility Logic */
        .msg-avatar { 
            width: 30px; height: 30px; 
            border-radius: 50%; 
            object-fit: cover; 
            flex-shrink: 0; 
            margin-bottom: 2px; 
            background: #121212; 
            border: 1px solid #222; 
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s;
        }
        .msg-avatar.visible { opacity: 1; }

        /* Bubble Containers */
        .msg-bubble-box { 
            position: relative; 
            max-width: 78%; 
            display: flex; 
            flex-direction: column; 
            transition: margin-bottom 0.2s; 
        }
        .sent .msg-bubble-box { align-items: flex-end; }
        .received .msg-bubble-box { align-items: flex-start; }

        /* --- BUBBLE STYLING --- */
        .bubble { 
            padding: 10px 16px; 
            border-radius: 20px; 
            font-size: 1.02rem; 
            line-height: 1.45; 
            position: relative; 
            word-wrap: break-word; 
            z-index: 2; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        
        /* SENT BUBBLES - GRADIENT */
        .sent .bubble { 
            background: var(--sent-bg-solid); /* Fallback */
            background: var(--sent-bg); 
            color: #fff; 
            text-align: left; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        
        /* SENT GROUPING - Smart Corners */
        .sent .bubble.single { border-radius: 20px; border-bottom-right-radius: 4px; }
        .sent .bubble.group-top { border-radius: 20px; border-bottom-right-radius: 4px; }
        .sent .bubble.group-mid { border-radius: 20px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        .sent .bubble.group-bottom { border-radius: 20px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; } 

        /* RECEIVED BUBBLES - DARK */
        .received .bubble { 
            background: var(--received-bg); 
            color: #fff; 
            text-align: left; 
            border: 1px solid #333; 
        }
        
        /* RECEIVED GROUPING */
        .received .bubble.single { border-radius: 20px; border-bottom-left-radius: 4px; }
        .received .bubble.group-top { border-radius: 20px; border-bottom-left-radius: 4px; }
        .received .bubble.group-mid { border-radius: 20px; border-top-left-radius: 4px; border-bottom-left-radius: 4px; }
        .received .bubble.group-bottom { border-radius: 20px; border-top-left-radius: 4px; border-bottom-left-radius: 4px; }

        /* Links */
        .bubble a { color: #b3e5fc; text-decoration: underline; cursor: pointer; word-break: break-all; }

        /* Timestamps (Sliding) */
        .sliding-timestamp { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            right: -70px; 
            font-size: 0.7rem; color: #666; font-weight: 500; 
            width: 60px; text-align: left; 
            pointer-events: none; opacity: 0;
            transition: opacity 0.2s;
        }
        /* Show timestamp on active slide */
        .msg-row.sliding .sliding-timestamp { opacity: 1; }
        
        /* Reactions */
        .reaction-badge { 
            position: absolute; 
            bottom: -10px; 
            background: #1a1a1a; 
            border: 2px solid #000; 
            border-radius: 20px; 
            padding: 3px 6px; 
            min-width: 24px;
            font-size: 0.85rem; 
            z-index: 20; 
            display: none; 
            cursor: pointer; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.4); 
            animation: scaleIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .sent .reaction-badge { right: 0; }
        .received .reaction-badge { left: 0; }

        /* Seen Status */
        .seen-status { 
            font-size: 0.65rem; color: var(--text-secondary); 
            margin-top: 4px; margin-right: 2px; 
            text-align: right; font-weight: 600; 
            height: 14px; width: 100%; 
            opacity: 0; animation: fadeStatus 0.4s forwards; 
            position: relative; z-index: 1; 
        }
        
        /* --- MEDIA STYLES --- */
        .msg-media-wrapper {
            position: relative; cursor: pointer; 
            margin-bottom: 2px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border-radius: 20px;
            overflow: hidden; /* Clips the image to the border radius */
            transition: transform 0.1s;
        }
        .msg-media-wrapper:active { transform: scale(0.98); }

        .chat-media-img {
            display: block; width: 100%; max-width: 280px; max-height: 380px; 
            object-fit: cover; 
            animation: imgFadeIn 0.5s ease-out;
        }

        /* Grouping Logic for Media Corners */
        .sent .msg-media-wrapper.group-top { border-bottom-right-radius: 4px; }
        .sent .msg-media-wrapper.group-mid { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        .sent .msg-media-wrapper.group-bottom { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        
        .received .msg-media-wrapper.group-top { border-bottom-left-radius: 4px; }
        .received .msg-media-wrapper.group-mid { border-top-left-radius: 4px; border-bottom-left-radius: 4px; }
        .received .msg-media-wrapper.group-bottom { border-top-left-radius: 4px; border-bottom-left-radius: 4px; }

        /* Audio & Files */
        .msg-audio-pill, .msg-file-pill {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px;
            background: #262626;
            border-radius: 22px;
            min-width: 240px;
            border: 1px solid rgba(255,255,255,0.08);
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 2px;
        }
        .audio-control-btn {
            width: 36px; height: 36px;
            background: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #000; cursor: pointer; flex-shrink: 0;
            z-index: 5;
            transition: transform 0.1s;
        }
        .audio-control-btn:active { transform: scale(0.9); }
        
        /* Fake Visualizer */
        .audio-wave-container {
            flex: 1; display: flex; align-items: center; gap: 3px; height: 18px; overflow: hidden;
            position: relative;
        }
        .wave-bar {
            width: 3px; background: #555; border-radius: 2px;
            height: 100%; transition: height 0.1s, background 0.2s;
        }
        .audio-playing .wave-bar {
            background: var(--accent);
            animation: waveAnim 0.8s ease-in-out infinite;
        }
        .audio-playing .wave-bar:nth-child(odd) { animation-duration: 0.6s; }
        .audio-playing .wave-bar:nth-child(2n) { animation-duration: 1.0s; }
        .audio-playing .wave-bar:nth-child(3n) { animation-duration: 0.8s; }
        @keyframes waveAnim { 0% { height: 30%; } 50% { height: 100%; } 100% { height: 30%; } }

        /* --- INPUT AREA --- */
        .input-area-container { 
            background: #000000; 
            border-top: 1px solid var(--border); 
            padding-bottom: env(safe-area-inset-bottom, 10px); 
            flex-shrink: 0; width: 100%; z-index: 1000; 
            transition: transform 0.2s;
        }
        .input-area { padding: 10px 12px; display: flex; align-items: flex-end; gap: 10px; }
        
        .plus-btn { 
            font-size: 28px; color: var(--accent); cursor: pointer; 
            padding: 0 4px; height: 44px; 
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s; 
        }
        .plus-btn:active { transform: rotate(90deg) scale(0.9); }

        .input-box { 
            flex: 1; background: #1c1c1c; 
            border-radius: 24px; 
            padding: 5px 16px; 
            border: 1px solid #333; 
            display: flex; align-items: center; 
            min-height: 44px; 
            transition: border-color 0.2s, background-color 0.2s; 
        }
        .input-box:focus-within { border-color: var(--accent); background: #121212; }
        
        .msg-input { 
            width: 100%; background: transparent; 
            border: none; color: white; 
            padding: 10px 0; font-size: 16px; 
            resize: none; max-height: 140px; overflow-y: auto; 
            line-height: 1.4; 
        }
        
        .send-btn { 
            background: transparent; border: none; 
            font-weight: 700; font-size: 1rem; 
            padding: 0 8px; height: 44px; 
            display: flex; align-items: center; 
            color: #444; pointer-events: none; 
            transition: all 0.2s ease; 
        }
        .send-btn.active { 
            color: var(--accent); cursor: pointer; pointer-events: auto; 
            transform: scale(1.05);
        }

        /* --- OVERLAYS & MENUS --- */
        #scroll-down-btn { 
            position: fixed; bottom: 85px; right: 20px; 
            width: 44px; height: 44px; 
            background: rgba(38, 38, 38, 0.9); 
            border-radius: 50%; display: none; 
            align-items: center; justify-content: center; 
            color: var(--accent); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            border: 1px solid #333; z-index: 900; 
            cursor: pointer; font-size: 1.4rem; 
            backdrop-filter: blur(5px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        #scroll-down-btn.new-msg { background: var(--accent); color: #fff; animation: bounce 1.5s infinite; }

        #heart-overlay { 
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0); 
            font-size: 100px; pointer-events: none; 
            z-index: 3000; 
            text-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            filter: drop-shadow(0 0 15px rgba(255,0,0,0.5));
        }
        @keyframes heartPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(0); opacity: 0; } }

        /* Attachment Menu */
        #attachment-menu {
            display: none; position: absolute; bottom: 75px; left: 15px;
            background: rgba(28, 28, 28, 0.95); backdrop-filter: blur(15px);
            border-radius: 18px; padding: 8px; z-index: 1001;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            animation: slideUpFade 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            flex-direction: column; gap: 4px; width: 170px;
        }
        .attach-opt { 
            display: flex; align-items: center; gap: 12px; 
            padding: 12px 14px; border-radius: 12px; 
            cursor: pointer; color: white; 
            font-size: 0.95rem; font-weight: 500; 
            transition: background 0.2s;
        }
        .attach-opt:active { background: rgba(255,255,255,0.15); }
        .attach-opt svg { width: 22px; height: 22px; fill: white; }

        /* Reply Dock */
        #reply-dock { 
            display: none; background: #111; 
            padding: 12px 16px; border-top: 1px solid var(--border); 
            justify-content: space-between; align-items: center; 
            border-left: 4px solid var(--accent);
        }

        /* --- LOADING SHIMMER EFFECTS --- */
        .loading-shimmer { background: var(--shimmer); background-size: 600px 100%; animation: shimmer 1.5s ease-in-out infinite; }
        .instant-load .loading-shimmer { animation: none; background: transparent; }
        .instant-load #chat-flow { opacity: 1 !important; transition: none !important; }

        /* --- RIPPLE EFFECT --- */
        .ripple {
            position: fixed; border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0);
            animation: rippleEffect 0.6s linear;
            pointer-events: none; z-index: 9999;
        }

        /* --- CONTEXT MENUS --- */
        #menu-overlay, #reaction-details-overlay { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0, 0, 0, 0.65); z-index: 2100; 
            justify-content: center; align-items: center; 
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .menu-card { 
            background: #1e1e1e; border-radius: 20px; 
            width: 260px; overflow: hidden; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); 
            transform: scale(0.95);
            animation: scaleIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .reaction-bar { 
            display: flex; justify-content: space-around; 
            padding: 16px 10px; border-bottom: 1px solid #333; 
            background: #252525;
        }
        .reaction-bar span { font-size: 2.2rem; cursor: pointer; transition: transform 0.1s; }
        .reaction-bar span:active { transform: scale(1.4); }
        
        .menu-opt { 
            padding: 16px; text-align: center; 
            font-size: 1.05rem; border-bottom: 1px solid #333; 
            color: #fff; cursor: pointer; transition: background 0.2s;
        }
        .menu-opt:active { background: #333; }
        
        /* --- REACTION PICKER --- */
        #reaction-picker-modal {
            display: none; position: fixed; inset: 0; z-index: 3000;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            align-items: flex-end; 
        }
        .picker-modal-content {
            width: 100%; height: 50vh; 
            background: #1c1c1c;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            display: flex; flex-direction: column;
            animation: slideUpFade 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden; border-top: 1px solid #333;
        }
    </style>
</head>
<body>

<image-picker id="img-picker"></image-picker>
<file-picker id="file-picker"></file-picker>
<view-media id="media-viewer"></view-media>
<call-notifier></call-notifier>

<div id="heart-overlay">‚ù§Ô∏è</div>
<div id="scroll-down-btn" onclick="scrollToBottom()">‚¨á</div>

<div id="reaction-details-overlay" onclick="closeReactionDetails()">
    <div class="menu-card" style="width: 85%; max-width: 340px; max-height: 60vh; display:flex; flex-direction:column;" onclick="event.stopPropagation()">
        <div style="padding: 16px; text-align: center; font-weight: 700; border-bottom: 1px solid #333; display:flex; justify-content:space-between; align-items:center;">
            <span>Reactions</span>
            <span onclick="closeReactionDetails()" style="font-size:1.2rem; color:#888; cursor:pointer;">‚úï</span>
        </div>
        <div id="react-list-items" style="overflow-y:auto; flex:1;"></div>
    </div>
</div>

<div id="reaction-picker-modal" onclick="closeReactionPicker()">
    <div class="picker-modal-content" onclick="event.stopPropagation()">
        <div style="padding:10px 0 5px 0; display:flex; justify-content:center;">
            <div style="width:40px; height:5px; background:#444; border-radius:10px;"></div>
        </div>
        <div style="padding: 15px; border-bottom: 1px solid #333; color: white; font-weight: 700;">
            Select Reaction
        </div>
        <div id="reaction-picker-container" style="flex:1; overflow:hidden;"></div>
    </div>
</div>

<div id="menu-overlay" onclick="closeMenu()">
    <div class="menu-card" id="main-menu-card" onclick="event.stopPropagation()">
        <div class="reaction-bar">
            <span onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="applyReaction('üòÇ')">üòÇ</span>
            <span onclick="applyReaction('üòÆ')">üòÆ</span>
            <span onclick="applyReaction('üò¢')">üò¢</span>
            <span onclick="applyReaction('üëç')">üëç</span>
            <div style="background:#333; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:24px; color:#fff;" onclick="expandEmojiMenu()">+</div>
        </div>
        <div class="menu-opt" onclick="copyMessageText()">Copy Text</div>
        <div class="menu-opt" onclick="initReplyFromActive()">Reply</div>
        <div id="edit-btn" class="menu-opt" onclick="initEdit()">Edit Message</div>
        <div id="unsend-btn" class="menu-opt" style="color:#ff453a; font-weight: 600;" onclick="unsendMsg()">Unsend</div>
        <div class="menu-opt" onclick="closeMenu()" style="border-bottom:none; color: #888">Cancel</div>
    </div>
</div>

<div class="app-container" id="main-app">
    
    <header id="chat-header">
        <div class="back-btn" onclick="history.back()">
            <svg viewBox="0 0 24 24" style="width:28px; height:28px; fill:currentColor;"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </div>
        
        <div class="h-profile-group" onclick="goToProfile()">
            <div class="pfp-container">
                <img id="h-pfp" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="h-pfp loading-shimmer">
                <div class="online-dot" id="h-online-dot"></div>
            </div>
            <div class="h-info">
                <div class="h-name-wrapper">
                    <div class="h-name" id="h-display-name"></div>
                    <img id="v-badge" src="https://img.icons8.com/color/48/verified-badge.png" class="v-badge">
                </div>
                <div class="h-username-sub" id="h-username-label"></div>
            </div>
        </div>
        
        <div class="header-actions">
            <svg class="header-icon" onclick="window.location.href='calls.html'" viewBox="0 0 24 24">
                <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 0 0-1.01.24l-1.57 1.97c-2.83-1.44-5.15-3.75-6.59-6.59l1.97-1.57c.22-.22.3-.54.24-1.01a11.36 11.36 0 0 1-.56-3.53c0-.55-.45-1-1-1H4.39c-.55 0-1 .45-1 1c0 9.39 7.61 17 17 17c.55 0 1-.45 1-1v-3.56c0-.55-.45-1-1-1z"/>
            </svg>
            <svg class="header-icon" onclick="window.location.href='calls.html'" viewBox="0 0 24 24">
                <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
            </svg>
        </div>
    </header>

    <div id="chat-flow">
        <div id="scroll-trigger"></div>
        <div id="messages-container"></div>
        
        <div class="typing-row" id="typing-row">
             <img src="" class="typing-avatar" id="typing-pfp">
             <div class="typing-bubble">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
             </div>
        </div>
    </div>

    <div class="input-area-container">
        
        <div id="reply-dock">
            <div style="flex:1;">
                <div style="font-size:0.75rem; color:var(--accent); font-weight:700; margin-bottom:2px;" id="reply-dock-label">Replying to</div>
                <div id="reply-text" style="font-size:0.85rem; color:#ddd; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:80vw;"></div>
            </div>
            <div onclick="cancelInteraction()" style="color:#fff; font-weight:bold; padding:8px; cursor:pointer;">‚úï</div>
        </div>

        <div id="emoji-tray" style="display:none; height:280px; border-top:1px solid #222;">
             <emoji-picker id="main-picker" style="width:100%; height:100%;"></emoji-picker>
        </div>

        <div id="attachment-menu">
            <div class="attach-opt" onclick="openCameraPicker()">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <span>Camera / Gallery</span>
            </div>
            <div class="attach-opt" onclick="openFilePicker()">
                <svg viewBox="0 0 24 24" style="fill:white;"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                <span>File / Video</span>
            </div>
            <div class="attach-opt" onclick="toggleEmojiTray()">
                <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
                <span>Emoji</span>
            </div>
        </div>

        <div class="input-area">
            <div class="plus-btn" onclick="toggleAttachmentMenu()">+</div>
            <div class="input-box" id="msg-input-box">
                <textarea id="m-input" class="msg-input" placeholder="Message..." rows="1"></textarea>
            </div>
            <button id="send-btn" class="send-btn">Send</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    //  GOORAC QUANTUM CHAT ENGINE - V3.5
    // ==========================================
    
    // --- 1. FIREBASE CONFIGURATION & INITIALIZATION ---
    let fbConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        measurementId: "G-M46FEVRYSS",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };

    if (typeof CONFIG !== 'undefined' && CONFIG.firebase) {
        fbConfig = CONFIG.firebase;
    }

    if (!firebase.apps.length) {
        firebase.initializeApp(fbConfig);
    }
    const db = firebase.firestore();
    const rdb = firebase.database();
    const auth = firebase.auth();

    // Enable offline persistence for speed
    db.enablePersistence({ synchronizeTabs: true }).catch(err => {
        if (err.code == 'failed-precondition') console.log('Multiple tabs open');
        else if (err.code == 'unimplemented') console.log('Browser not supported');
    });

    // --- 2. STATE MANAGEMENT ---
    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');
    
    let state = {
        myUid: null,
        targetUid: null,
        chatId: null,
        replyingTo: null,
        editModeId: null,
        isLoadingMore: false,
        isFirstLoad: true,
        isFirstStatusLoad: true,
        lastVisibleDoc: null,
        myUserData: null,
        targetUserData: null,
        unsubscribeMsg: null,
        statusInterval: null,
        activeMenuId: null
    };

    // Cache Map for O(1) Access
    let messagesMap = new Map(); 

    // --- 3. DOM ELEMENTS ---
    const UI = {
        input: document.getElementById('m-input'),
        inputBox: document.getElementById('msg-input-box'),
        chatFlow: document.getElementById('chat-flow'),
        container: document.getElementById('messages-container'),
        typingRow: document.getElementById('typing-row'),
        typingPfp: document.getElementById('typing-pfp'),
        emojiTray: document.getElementById('emoji-tray'),
        scrollBtn: document.getElementById('scroll-down-btn'),
        sendBtn: document.getElementById('send-btn'),
        onlineDot: document.getElementById('h-online-dot'),
        headerName: document.getElementById('h-display-name'),
        headerSub: document.getElementById('h-username-label'),
        headerPfp: document.getElementById('h-pfp'),
        attachMenu: document.getElementById('attachment-menu'),
        replyDock: document.getElementById('reply-dock'),
        replyText: document.getElementById('reply-text'),
        replyLabel: document.getElementById('reply-dock-label')
    };

    // Sounds
    const AudioFX = {
        pop: new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"),
        like: new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU") // Shortened base64 for brevity
    };

    // --- 4. INSTANT LOAD SYSTEM (0ms Latency) ---
    (function instantRender() {
        if (!targetUsername) return;
        const storedMyUid = localStorage.getItem('goorac_my_uid');
        const userCacheKey = `goorac_user_${targetUsername}`;
        const storedUser = localStorage.getItem(userCacheKey);

        if (storedUser && storedMyUid) {
            try {
                // Render Header
                state.targetUserData = JSON.parse(storedUser);
                UI.headerPfp.classList.remove('loading-shimmer');
                UI.headerPfp.src = state.targetUserData.photoURL || 'assets/default_avatar.png';
                UI.headerName.innerText = state.targetUserData.name || state.targetUserData.username;
                UI.headerSub.innerText = `@${state.targetUserData.username}`;
                if(state.targetUserData.verified) document.getElementById('v-badge').style.display = 'block';

                // Render Messages
                state.myUid = storedMyUid;
                state.targetUid = state.targetUserData.uid;
                state.chatId = getChatId(state.myUid, state.targetUid);

                const msgCacheKey = `goorac_msgs_${state.chatId}`;
                const storedMsgs = localStorage.getItem(msgCacheKey);
                
                if (storedMsgs) {
                    const msgs = JSON.parse(storedMsgs);
                    msgs.forEach(m => {
                        m.timestamp = { toDate: () => new Date(m.timestampIso) };
                        if(m.seenAtIso) m.seenAt = { toDate: () => new Date(m.seenAtIso) };
                        messagesMap.set(m.id || m.timestampIso, m);
                    });
                    
                    document.body.classList.add('instant-load');
                    renderMessagesEngine();
                    
                    // Instant Scroll
                    UI.chatFlow.style.opacity = '1';
                    UI.chatFlow.scrollTop = UI.chatFlow.scrollHeight;
                    state.isFirstLoad = false;
                }
            } catch(e) { console.error("Instant Load Failed:", e); }
        }
    })();

    // --- 5. AUTHENTICATION & BOOTSTRAP ---
    auth.onAuthStateChanged(async (user) => {
        if (user) { 
            state.myUid = user.uid; 
            localStorage.setItem('goorac_my_uid', state.myUid);
            
            // Parallel Fetch: My Data + Target Data
            const myDataPromise = db.collection('users').doc(state.myUid).get();
            
            if(!targetUsername) return; // Should handle error or redirect
            
            // Check cache vs network for target
            if (!state.targetUserData) {
                const snap = await db.collection("users").where("username", "==", targetUsername).limit(1).get();
                if (!snap.empty) {
                    const doc = snap.docs[0];
                    state.targetUserData = doc.data();
                    state.targetUid = doc.id;
                    state.targetUserData.uid = state.targetUid;
                    localStorage.setItem(`goorac_user_${targetUsername}`, JSON.stringify(state.targetUserData));
                    updateHeaderUI();
                }
            }

            const myDoc = await myDataPromise;
            if(myDoc.exists) state.myUserData = myDoc.data();

            if (state.targetUid) {
                state.chatId = getChatId(state.myUid, state.targetUid);
                initializeChat();
            }
        } else {
            window.location.href = 'login.html';
        }
    });

    function getChatId(uid1, uid2) {
        return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
    }

    // --- 6. CORE CHAT INITIALIZATION ---
    function initializeChat() {
        // A. Reset Seen Count
        db.collection("chats").doc(state.chatId).update({ 
            [`unreadCount.${state.myUid}`]: 0, 
            seen: true 
        }).catch(() => {}); // Create doc if missing logic handled elsewhere usually

        // B. Start Presence Monitor (Instant Status Logic)
        monitorTargetStatus();

        // C. Start Typing Listener
        rdb.ref(`typing/${state.chatId}/${state.targetUid}`).on('value', (s) => {
            const isTyping = s.val();
            UI.typingRow.style.display = isTyping ? 'flex' : 'none';
            if(isTyping) {
                UI.typingPfp.src = state.targetUserData.photoURL;
                scrollToBottom(true); // Smooth scroll when typing appears
            }
        });

        // D. Start Message Listener
        startMessageListener();

        // E. Observers
        setupScrollObserver();
        setupGestureListeners();
    }

    // --- 7. FAST STATUS MONITORING (FIXED) ---
    function monitorTargetStatus() {
        if (!state.targetUid) return;

        // Privacy Check
        const amIHidden = state.myUserData?.showActivityStatus === false;
        const isTargetHidden = state.targetUserData?.showActivityStatus === false;

        if (amIHidden || isTargetHidden) {
            UI.onlineDot.style.display = 'none';
            UI.headerSub.innerText = `@${state.targetUserData.username}`;
            return;
        }

        // Realtime Listener
        rdb.ref('/status/' + state.targetUid).on('value', (snapshot) => {
            const statusData = snapshot.val();
            
            // === CRITICAL FIX: IMMEDIATE UPDATE ===
            // No setTimeout. No Delay.
            
            if (!statusData) {
                // Fallback if no data
                UI.onlineDot.style.display = 'none';
                return;
            }

            const isOnline = statusData.state === 'online';
            
            if (isOnline) {
                UI.onlineDot.classList.add('active');
                UI.onlineDot.style.display = 'block';
                UI.headerSub.innerText = "Active now";
                UI.headerSub.style.color = "#00e676";
            } else {
                UI.onlineDot.classList.remove('active');
                UI.onlineDot.style.display = 'none';
                UI.headerSub.innerText = "Active " + timeAgo(new Date(statusData.last_changed));
                UI.headerSub.style.color = "var(--text-secondary)";
            }

            // Start an interval to update "Xm ago" every minute without DB hits
            if (state.statusInterval) clearInterval(state.statusInterval);
            if (!isOnline) {
                state.statusInterval = setInterval(() => {
                    UI.headerSub.innerText = "Active " + timeAgo(new Date(statusData.last_changed));
                }, 60000);
            }
        });
    }

    // --- 8. MESSAGE LISTENER & RENDER ENGINE ---
    function startMessageListener() {
        if (state.unsubscribeMsg) state.unsubscribeMsg();

        state.unsubscribeMsg = db.collection("chats").doc(state.chatId).collection("messages")
            .orderBy("timestamp", "desc")
            .limit(25)
            .onSnapshot(snapshot => {
                if (snapshot.empty) {
                    if (state.isFirstLoad) UI.chatFlow.style.opacity = '1'; 
                    return;
                }

                if (!state.lastVisibleDoc) state.lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];

                let isNewIncoming = false;
                
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    data.id = change.doc.id;

                    if (change.type === "added") {
                        messagesMap.set(data.id, data);
                        if(data.sender !== state.myUid) {
                            isNewIncoming = true;
                            // Mark as read immediately
                            if(!data.seen) markMessageSeen(data.id);
                        }
                    } else if (change.type === "modified") {
                        messagesMap.set(data.id, data);
                    } else if (change.type === "removed") {
                        messagesMap.delete(data.id);
                    }
                });

                renderMessagesEngine();

                // Scroll Logic
                if (state.isFirstLoad) {
                    UI.chatFlow.scrollTop = UI.chatFlow.scrollHeight;
                    setTimeout(() => { UI.chatFlow.style.opacity = '1'; }, 50);
                    state.isFirstLoad = false;
                } else if (isNewIncoming) {
                    // Only auto-scroll if user is near bottom
                    const isNearBottom = UI.chatFlow.scrollHeight - UI.chatFlow.scrollTop - UI.chatFlow.clientHeight < 300;
                    if (isNearBottom) {
                        scrollToBottom(true);
                        AudioFX.pop.play().catch(()=>{});
                    } else {
                        UI.scrollBtn.classList.add('new-msg');
                        UI.scrollBtn.style.display = 'flex';
                    }
                }

                saveToCache();
            });
    }

    // The Brain: Rendering Logic with Smart Grouping
    function renderMessagesEngine() {
        UI.container.innerHTML = '';
        
        const sortedMessages = Array.from(messagesMap.values())
            .filter(m => m.timestamp) // Filter out pending without server timestamp yet if needed
            .sort((a, b) => {
                const tA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestampIso);
                const tB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestampIso);
                return tA - tB;
            });

        let lastDateLabel = '';
        let lastSenderId = null;
        let lastTimestamp = 0;
        let lastSeenId = null;

        // Find last seen message for "Seen" status placement
        for (let i = sortedMessages.length - 1; i >= 0; i--) {
            if (sortedMessages[i].sender === state.myUid && sortedMessages[i].seen) {
                lastSeenId = sortedMessages[i].id;
                break;
            }
        }

        sortedMessages.forEach((msg, index) => {
            const msgDate = msg.timestamp.toDate ? msg.timestamp.toDate() : new Date(msg.timestampIso);
            const dateLabel = getDateDivider(msgDate);
            
            // 1. Date Divider
            if (dateLabel !== lastDateLabel) {
                const div = document.createElement('div');
                div.className = "date-divider";
                div.innerText = dateLabel;
                UI.container.appendChild(div);
                lastDateLabel = dateLabel;
                lastSenderId = null; // Reset grouping on new day
            }

            // 2. Smart Grouping Logic
            // Group if same sender AND less than 2 minutes apart
            const timeDiff = msgDate.getTime() - lastTimestamp;
            const isSameSender = msg.sender === lastSenderId;
            const isGrouped = isSameSender && timeDiff < 120000; // 2 minutes

            // Calculate position in group for CSS
            // Look ahead to see if next message continues group
            const nextMsg = sortedMessages[index + 1];
            let nextIsGrouped = false;
            if (nextMsg) {
                const nextDate = nextMsg.timestamp.toDate ? nextMsg.timestamp.toDate() : new Date(nextMsg.timestampIso);
                nextIsGrouped = (nextMsg.sender === msg.sender) && (nextDate.getTime() - msgDate.getTime() < 120000);
            }

            let groupPosition = 'single';
            if (isGrouped && nextIsGrouped) groupPosition = 'group-mid';
            else if (isGrouped && !nextIsGrouped) groupPosition = 'group-bottom';
            else if (!isGrouped && nextIsGrouped) groupPosition = 'group-top';

            // 3. Render Individual Message
            const msgEl = createMessageElement(msg, groupPosition, msg.id === lastSeenId);
            UI.container.appendChild(msgEl);

            // Update trackers
            lastSenderId = msg.sender;
            lastTimestamp = msgDate.getTime();
        });
    }

    function createMessageElement(msg, groupPos, isSeenMarker) {
        const isMe = msg.sender === state.myUid;
        const side = isMe ? 'sent' : 'received';
        const row = document.createElement('div');
        row.className = `msg-row ${side} ${groupPos}`;
        row.id = `row-${msg.id}`;

        // --- Content Builders ---
        const replyHTML = buildReplyUI(msg);
        const mediaHTML = buildMediaUI(msg, groupPos);
        const textHTML = buildTextUI(msg, groupPos, !mediaHTML); // Only hide bubbles if no text AND media exists
        const reactionHTML = buildReactionUI(msg);
        const seenHTML = isSeenMarker ? buildSeenStatus(msg) : '';

        // --- Avatar Logic (Only show on bottom of received group) ---
        let avatarHTML = '';
        if (side === 'received') {
            const showAvatar = groupPos === 'single' || groupPos === 'group-bottom';
            const pfpUrl = state.targetUserData.photoURL;
            avatarHTML = `<img src="${pfpUrl}" class="msg-avatar ${showAvatar ? 'visible' : ''}">`;
        }

        const contentWrapper = `
            <div class="msg-bubble-box" style="${reactionHTML.hasReactions ? 'margin-bottom:12px' : ''}">
                ${replyHTML}
                ${mediaHTML}
                ${textHTML}
            </div>
        `;

        row.innerHTML = `
            ${side === 'received' ? `<div class="received-inner-row">${avatarHTML}${contentWrapper}</div>` : contentWrapper}
            ${seenHTML}
            <div class="sliding-timestamp">${formatTime(msg.timestamp.toDate())}</div>
        `;

        // --- Attach Interaction Listeners ---
        const interactiveEl = row.querySelector('.bubble') || row.querySelector('.msg-media-wrapper') || row.querySelector('.msg-file-pill');
        if (interactiveEl) attachInteractions(interactiveEl, msg);

        return row;
    }

    // --- 9. UI COMPONENT BUILDERS (Modular) ---

    function buildReplyUI(msg) {
        if (!msg.replyTo) return '';
        // Truncate text
        const txt = msg.replyTo.length > 60 ? msg.replyTo.substring(0,60)+'...' : msg.replyTo;
        return `
            <div class="reply-box-ui" onclick="scrollToOriginal('${msg.replyTo}')" style="background:rgba(0,0,0,0.3); border-left: 3px solid #888; padding:8px 12px; margin-bottom:4px; border-radius:8px; font-size:0.85rem; color:#ccc; cursor:pointer;">
                <div style="font-size:0.7rem; color:var(--accent); font-weight:700; margin-bottom:2px;">Replying to</div>
                "${escapeHtml(txt)}"
            </div>
        `;
    }

    function buildMediaUI(msg, groupPos) {
        if (msg.imageUrl) {
            return `
            <div class="msg-media-wrapper ${groupPos}" onclick="document.getElementById('media-viewer').open('${msg.imageUrl}')">
                <img src="${msg.imageUrl}" class="chat-media-img" loading="lazy">
                ${buildBadge(msg)}
            </div>`;
        }
        if (msg.fileUrl && msg.fileMeta?.type.includes('audio')) {
            const id = `audio-${msg.id}`;
            return `
            <div class="msg-audio-pill">
                <div class="audio-control-btn" onclick="toggleAudio('${id}')">
                     <svg id="icon-${id}" viewBox="0 0 24 24" style="width:20px; fill:#000"><path d="M8 5v14l11-7z"/></svg>
                </div>
                <div class="audio-wave-container" id="wave-${id}">
                     ${Array(12).fill('<div class="wave-bar"></div>').join('')}
                </div>
                <audio id="${id}" src="${msg.fileUrl}" onended="resetAudio('${id}')"></audio>
                ${buildBadge(msg, 'right:10px; bottom:-8px;')}
            </div>`;
        }
        if (msg.fileUrl) {
            // Generic File or Video
            const isVideo = msg.fileMeta?.type.includes('video');
            const icon = isVideo ? 'üé•' : 'üìÑ';
            return `
            <div class="msg-file-pill" onclick="window.open('${msg.fileUrl}')">
                <div style="font-size:1.5rem;">${icon}</div>
                <div style="flex:1; overflow:hidden;">
                    <div style="font-weight:600; white-space:nowrap; text-overflow:ellipsis;">${msg.fileMeta?.name || 'Attachment'}</div>
                    <div style="font-size:0.75rem; color:#888;">${(msg.fileMeta?.size/1024/1024).toFixed(1)} MB</div>
                </div>
                ${buildBadge(msg, 'right:0; bottom:-8px;')}
            </div>`;
        }
        return '';
    }

    function buildTextUI(msg, groupPos, showBubble) {
        if (!showBubble && !msg.text) return '';
        const safeText = linkify(escapeHtml(msg.text || ''));
        const display = (!msg.text && !showBubble) ? 'none' : 'block';
        return `
            <div class="bubble ${groupPos}" style="display:${display}">
                <span id="text-${msg.id}">${safeText}</span>
                ${msg.edited ? '<span style="font-size:0.7em; opacity:0.6; margin-left:4px;">(edited)</span>' : ''}
                ${!msg.imageUrl && !msg.fileUrl ? buildBadge(msg) : ''}
            </div>
        `;
    }

    function buildBadge(msg, styleOverride='') {
        const reactions = msg.reactions ? Object.values(msg.reactions).map(r => r.emoji).join('') : '';
        if (!reactions) return '';
        return `<div class="reaction-badge" style="display:block; ${styleOverride}" onclick="showReactionDetails('${msg.id}')">${reactions}</div>`;
    }

    function buildReactionUI(msg) {
        return { hasReactions: !!(msg.reactions && Object.keys(msg.reactions).length > 0) };
    }

    function buildSeenStatus(msg) {
        const text = msg.seenAt ? `Seen ${timeAgo(msg.seenAt.toDate())}` : 'Seen';
        return `<div class="seen-status">${text}</div>`;
    }

    // --- 10. INTERACTION HANDLERS ---
    
    // Double Tap & Long Press
    function attachInteractions(el, msg) {
        let tapTimeout, isDouble = false;
        let pressTimer;
        let startX = 0, currentX = 0;

        // Double Tap Like
        el.addEventListener('click', (e) => {
            if (!tapTimeout) {
                tapTimeout = setTimeout(() => { tapTimeout = null; if(!isDouble) { /* Single Click Logic handled by bubbles natively (links) */ } }, 250);
            } else {
                clearTimeout(tapTimeout);
                tapTimeout = null;
                isDouble = true;
                handleDoubleTap(msg);
                setTimeout(() => isDouble = false, 300);
            }
        });

        // Swipe & Long Press
        el.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            pressTimer = setTimeout(() => openMenu(msg.id, msg.sender === state.myUid, msg.text), 500);
        }, {passive: true});

        el.addEventListener('touchmove', (e) => {
            currentX = e.touches[0].clientX;
            if (Math.abs(currentX - startX) > 10) clearTimeout(pressTimer);
            
            // Swipe visual feedback
            if (currentX - startX > 0 && currentX - startX < 100) {
                el.style.transform = `translateX(${currentX - startX}px)`;
            }
        }, {passive: true});

        el.addEventListener('touchend', (e) => {
            clearTimeout(pressTimer);
            el.style.transition = 'transform 0.2s';
            el.style.transform = 'translateX(0)';
            
            if (currentX - startX > 60) {
                triggerReply(msg);
            }
            startX = 0; currentX = 0;
        });
    }

    function handleDoubleTap(msg) {
        AudioFX.like.play();
        const overlay = document.getElementById('heart-overlay');
        overlay.style.animation = 'none';
        overlay.offsetHeight; /* Trigger reflow */
        overlay.style.animation = 'heartPop 0.8s ease-out';
        
        // Toggle Heart
        const myReact = msg.reactions?.[state.myUid]?.emoji;
        const newEmoji = myReact === '‚ù§Ô∏è' ? null : '‚ù§Ô∏è';
        updateReaction(msg.id, newEmoji);
    }

    // --- 11. MESSAGING FUNCTIONS ---
    
    async function sendMessage() {
        const text = UI.input.value.trim();
        if (!text) return;

        // Optimistic UI updates
        UI.input.value = '';
        UI.input.style.height = 'auto';
        UI.sendBtn.classList.remove('active');
        UI.emojiTray.style.display = 'none';
        
        AudioFX.pop.play().catch(()=>{});

        if (state.editModeId) {
            await db.collection("chats").doc(state.chatId).collection("messages").doc(state.editModeId).update({
                text: text,
                edited: true
            });
            cancelInteraction();
        } else {
            const payload = {
                text: text,
                sender: state.myUid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                seen: false,
                reactions: {},
                replyTo: state.replyingTo || null
            };
            
            cancelInteraction();
            await db.collection("chats").doc(state.chatId).collection("messages").add(payload);
            updateChatMeta(text);
        }
        
        scrollToBottom();
    }

    async function updateReaction(msgId, emoji) {
        // Optimistic Local Update
        const msg = messagesMap.get(msgId);
        if (msg) {
            if (!msg.reactions) msg.reactions = {};
            if (emoji) msg.reactions[state.myUid] = { emoji, timestamp: Date.now() };
            else delete msg.reactions[state.myUid];
            renderMessagesEngine(); // Re-render immediately
        }

        // Firebase Update
        const ref = db.collection("chats").doc(state.chatId).collection("messages").doc(msgId);
        if (emoji) {
            await ref.update({ [`reactions.${state.myUid}`]: { emoji, timestamp: Date.now() } });
        } else {
            await ref.update({ [`reactions.${state.myUid}`]: firebase.firestore.FieldValue.delete() });
        }
    }

    function markMessageSeen(msgId) {
        db.collection("chats").doc(state.chatId).collection("messages").doc(msgId).update({
            seen: true,
            seenAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        db.collection("chats").doc(state.chatId).update({
            [`unreadCount.${state.myUid}`]: 0
        });
    }

    async function updateChatMeta(lastText) {
        await db.collection("chats").doc(state.chatId).set({
            lastMessage: lastText,
            lastSender: state.myUid,
            lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
            participants: [state.myUid, state.targetUid],
            [`unreadCount.${state.targetUid}`]: firebase.firestore.FieldValue.increment(1)
        }, { merge: true });
    }

    // --- 12. UTILITIES ---

    function scrollToBottom(smooth = false) {
        const opt = smooth ? { behavior: 'smooth' } : { behavior: 'auto' };
        UI.chatFlow.scrollTo({ top: UI.chatFlow.scrollHeight, ...opt });
    }

    function timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return "Just now";
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        return `${Math.floor(hours / 24)}d ago`;
    }

    function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function getDateDivider(date) {
        const today = new Date();
        if (date.toDateString() === today.toDateString()) return "Today";
        const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
        if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function linkify(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, url => `<a onclick="event.stopPropagation(); window.open('${url}', '_blank')">${url}</a>`);
    }

    function saveToCache() {
        const msgs = Array.from(messagesMap.values()).slice(-50).map(m => {
            let copy = {...m};
            // Convert Timestamps to ISO string for JSON
            if(copy.timestamp?.toDate) copy.timestampIso = copy.timestamp.toDate().toISOString();
            if(copy.seenAt?.toDate) copy.seenAtIso = copy.seenAt.toDate().toISOString();
            delete copy.timestamp; delete copy.seenAt;
            return copy;
        });
        localStorage.setItem(`goorac_msgs_${state.chatId}`, JSON.stringify(msgs));
    }

    // --- 13. UI EVENT LISTENERS ---
    
    // Auto-Resize Input
    UI.input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        
        const hasText = this.value.trim().length > 0;
        if(hasText) UI.sendBtn.classList.add('active');
        else UI.sendBtn.classList.remove('active');

        // Typing Status to RDB
        rdb.ref(`typing/${state.chatId}/${state.myUid}`).set(hasText);
    });

    // Send Button
    UI.sendBtn.addEventListener('mousedown', (e) => { e.preventDefault(); sendMessage(); });
    UI.sendBtn.addEventListener('touchstart', (e) => { e.preventDefault(); sendMessage(); });

    // Menu Actions
    window.toggleAttachmentMenu = () => {
        const isHidden = UI.attachMenu.style.display === 'none' || UI.attachMenu.style.display === '';
        UI.attachMenu.style.display = isHidden ? 'flex' : 'none';
        if(isHidden) UI.emojiTray.style.display = 'none';
    };

    window.toggleEmojiTray = () => {
        UI.attachMenu.style.display = 'none';
        const isHidden = UI.emojiTray.style.display === 'none';
        UI.emojiTray.style.display = isHidden ? 'block' : 'none';
        if(isHidden) scrollToBottom(true);
    };

    // Component Events
    document.getElementById('img-picker').addEventListener('image-uploaded', (e) => sendMediaMessage(e.detail.url, 'image'));
    document.getElementById('file-picker').addEventListener('file-uploaded', (e) => sendMediaMessage(e.detail.url, 'file', e.detail.metadata));
    document.getElementById('main-picker').addEventListener('emoji-click', (e) => {
        UI.input.value += e.detail.unicode;
        UI.input.dispatchEvent(new Event('input'));
    });

    async function sendMediaMessage(url, type, meta={}) {
        const payload = {
            sender: state.myUid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            seen: false,
            reactions: {}
        };
        
        if(type === 'image') {
            payload.imageUrl = url;
            payload.text = "";
            updateChatMeta("üì∑ Image");
        } else {
            payload.fileUrl = url;
            payload.fileMeta = meta;
            payload.text = meta.caption || "";
            updateChatMeta("üìÑ Attachment");
        }

        await db.collection("chats").doc(state.chatId).collection("messages").add(payload);
        scrollToBottom();
        AudioFX.pop.play().catch(()=>{});
    }

    // --- 14. MENU LOGIC ---
    window.openMenu = (id, isMine, text) => {
        state.activeMenuId = id;
        document.getElementById('edit-btn').style.display = (isMine && text) ? 'block' : 'none';
        document.getElementById('unsend-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('menu-overlay').style.display = 'flex';
        // Haptic feedback if available
        if (navigator.vibrate) navigator.vibrate(50);
    };

    window.closeMenu = () => document.getElementById('menu-overlay').style.display = 'none';
    
    window.triggerReply = (msg) => {
        state.replyingTo = msg.text || (msg.imageUrl ? "Photo" : "Attachment");
        UI.replyText.innerText = state.replyingTo;
        UI.replyLabel.innerText = "Replying to";
        UI.replyDock.style.display = 'flex';
        UI.input.focus();
    };
    
    window.initReplyFromActive = () => {
        const msg = messagesMap.get(state.activeMenuId);
        if(msg) triggerReply(msg);
        closeMenu();
    };

    window.initEdit = () => {
        const msg = messagesMap.get(state.activeMenuId);
        if(!msg || !msg.text) return;
        state.editModeId = msg.id;
        UI.input.value = msg.text;
        UI.input.focus();
        UI.replyLabel.innerText = "Editing";
        UI.replyText.innerText = msg.text;
        UI.replyDock.style.display = 'flex';
        closeMenu();
    };

    window.cancelInteraction = () => {
        state.replyingTo = null;
        state.editModeId = null;
        UI.replyDock.style.display = 'none';
        if (state.editModeId) UI.input.value = ''; // Only clear if was editing
    };
    
    window.copyMessageText = async () => {
        const msg = messagesMap.get(state.activeMenuId);
        if (msg && msg.text) {
            await navigator.clipboard.writeText(msg.text);
        }
        closeMenu();
    };

    window.unsendMsg = async () => {
        const id = state.activeMenuId;
        closeMenu();
        if (id) {
            await db.collection("chats").doc(state.chatId).collection("messages").doc(id).delete();
            // Optimistic removal handled by listener "removed" event
        }
    };

    // --- 15. REACTION DETAILS LOGIC ---
    window.showReactionDetails = (id) => {
        const msg = messagesMap.get(id);
        const container = document.getElementById('react-list-items');
        container.innerHTML = '';
        if(msg && msg.reactions) {
            Object.entries(msg.reactions).forEach(([uid, data]) => {
                const div = document.createElement('div');
                div.style.padding = '10px';
                div.style.borderBottom = '1px solid #333';
                div.style.color = '#fff';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '10px';
                
                // We'd ideally need a user map here, simplifying for speed
                const isMe = uid === state.myUid;
                const name = isMe ? "You" : (state.targetUserData.name || "User");
                const img = isMe ? state.myUserData?.photoURL : state.targetUserData.photoURL;
                
                div.innerHTML = `
                    <img src="${img || 'assets/default_avatar.png'}" style="width:32px; height:32px; border-radius:50%;">
                    <div style="flex:1;">${name}</div>
                    <div style="font-size:1.5rem;">${data.emoji}</div>
                `;
                container.appendChild(div);
            });
            document.getElementById('reaction-details-overlay').style.display = 'flex';
        }
    };
    window.closeReactionDetails = () => document.getElementById('reaction-details-overlay').style.display = 'none';

    window.applyReaction = (emoji) => {
        if(state.activeMenuId) updateReaction(state.activeMenuId, emoji);
        closeMenu();
    };
    
    // Expand reaction menu
    window.expandEmojiMenu = () => {
        closeMenu();
        const container = document.getElementById('reaction-picker-container');
        container.innerHTML = '';
        const picker = document.createElement('emoji-picker');
        picker.style.width = '100%';
        picker.style.height = '100%';
        picker.addEventListener('emoji-click', (e) => {
            applyReaction(e.detail.unicode);
            document.getElementById('reaction-picker-modal').style.display = 'none';
        });
        container.appendChild(picker);
        document.getElementById('reaction-picker-modal').style.display = 'flex';
    };
    window.closeReactionPicker = () => document.getElementById('reaction-picker-modal').style.display = 'none';

    // --- 16. AUDIO LOGIC ---
    window.toggleAudio = (id) => {
        const audio = document.getElementById(id);
        const wave = document.getElementById('wave-'+id);
        const icon = document.getElementById('icon-'+id);
        
        document.querySelectorAll('audio').forEach(a => { if(a.id !== id) { a.pause(); a.currentTime=0; resetAudio(a.id); } });

        if (audio.paused) {
            audio.play();
            wave.classList.add('audio-playing');
            icon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; // Pause
        } else {
            audio.pause();
            wave.classList.remove('audio-playing');
            icon.innerHTML = '<path d="M8 5v14l11-7z"/>'; // Play
        }
    };
    
    window.resetAudio = (id) => {
        const wave = document.getElementById('wave-'+id);
        const icon = document.getElementById('icon-'+id);
        if(wave) wave.classList.remove('audio-playing');
        if(icon) icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
    };

    // --- 17. SCROLL OBSERVER ---
    function setupScrollObserver() {
        const obs = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !state.isLoadingMore && state.lastVisibleDoc) {
                loadMoreMessages();
            }
        }, { threshold: 0.1 });
        obs.observe(document.getElementById('scroll-trigger'));
    }

    async function loadMoreMessages() {
        state.isLoadingMore = true;
        const snapshot = await db.collection("chats").doc(state.chatId).collection("messages")
            .orderBy("timestamp", "desc")
            .startAfter(state.lastVisibleDoc)
            .limit(20)
            .get();
        
        if (!snapshot.empty) {
            state.lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
            snapshot.forEach(d => {
                const data = d.data();
                data.id = d.id;
                messagesMap.set(d.id, data);
            });
            
            const oldHeight = UI.chatFlow.scrollHeight;
            renderMessagesEngine();
            UI.chatFlow.scrollTop = UI.chatFlow.scrollHeight - oldHeight;
        }
        state.isLoadingMore = false;
    }

    // --- 18. GESTURE & NAVIGATION ---
    function setupGestureListeners() {
        // Slide to reveal timestamps globally
        let startX = 0;
        let isSliding = false;
        
        UI.chatFlow.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isSliding = false;
        }, {passive:true});

        UI.chatFlow.addEventListener('touchmove', (e) => {
            const x = e.touches[0].clientX;
            if (startX - x > 50) { // Slide Left
                isSliding = true;
                UI.container.style.transform = `translateX(${x - startX}px)`;
                document.querySelectorAll('.msg-row').forEach(r => r.classList.add('sliding'));
            }
        }, {passive:true});

        UI.chatFlow.addEventListener('touchend', () => {
             UI.container.style.transform = `translateX(0px)`;
             document.querySelectorAll('.msg-row').forEach(r => r.classList.remove('sliding'));
        });
    }

    window.goToProfile = () => {
        window.location.href = `userProfile.html?user=${targetUsername}`;
    };

</script>
</body>
</html>
