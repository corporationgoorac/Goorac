<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Goorac | Inbox</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg: #000000;
            --accent: #00d2ff;
            --seen-color: #00d2ff; 
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-dim: #999999;
            --danger: #ff4444;
            --glass: rgba(255, 255, 255, 0.05);
            --sheet-bg: #121212;
            --online: #00ff41;
        }

        body {
            background: var(--bg); color: var(--text-main); margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 90px; overflow-x: hidden;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER */
        header {
            position: sticky; top: 0; background: rgba(0,0,0,0.95);
            padding: 15px 20px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--border); z-index: 1000;
            backdrop-filter: blur(20px);
            padding-top: max(15px, env(safe-area-inset-top));
        }
        .header-logo { 
            font-weight: 900; font-size: 1.4rem; letter-spacing: -0.5px; 
            background: linear-gradient(to right, #fff, var(--accent)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }

        /* SEARCH */
        .search-wrap { padding: 12px 20px; }
        .search-input {
            width: 100%; background: #111; border: 1px solid var(--border);
            padding: 12px 15px; border-radius: 14px; color: white; outline: none; box-sizing: border-box;
            font-size: 16px !important; transition: all 0.3s ease;
        }
        .search-input:focus { border-color: var(--accent); background: #1a1a1a; }

        /* CHAT LIST */
        .chat-item { 
            display: flex; align-items: center; padding: 16px 20px; 
            cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.2s; position: relative;
        }
        .chat-item:active { background: var(--glass); }

        /* AVATAR AREA */
        .pfp-container { position: relative; margin-right: 15px; flex-shrink: 0; }
        .chat-pfp { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); display: block; background: #222; }
        
        .online-indicator {
            position: absolute; bottom: 2px; right: 2px;
            width: 13px; height: 13px; background: var(--online);
            border-radius: 50%; border: 2px solid #000;
            display: none; z-index: 2;
        }
        .online-indicator.active { display: block; }

        /* INFO AREA */
        .chat-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 3px; }
        
        .chat-top { display: flex; justify-content: space-between; align-items: center; }
        .u-name { font-weight: 700; font-size: 1rem; color: #fff; display: flex; align-items: center; gap: 4px; }
        .chat-time { font-size: 0.75rem; color: var(--text-dim); white-space: nowrap; font-weight: 500; }
        
        .chat-bottom { display: flex; justify-content: space-between; align-items: center; }
        
        /* MESSAGE PREVIEW STYLES */
        .last-msg { 
            font-size: 0.95rem; color: var(--text-dim); 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            max-width: 80%;
        }
        
        /* Incoming Unread */
        .last-msg.unread { color: #fff; font-weight: 800; }
        
        /* Outgoing Seen */
        .last-msg.seen { color: var(--seen-color); font-weight: 500; font-size: 0.85rem; }
        
        .typing-text { color: var(--accent); font-weight: 600; font-style: italic; font-size: 0.9rem; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        .v-badge { width: 14px; height: 14px; vertical-align: middle; }
        .pin-icon { width: 12px; height: 12px; background: var(--accent); clip-path: polygon(0 0, 100% 0, 50% 100%); margin-left: 6px; }

        /* BADGES & BUTTONS */
        .unread-count { 
            background: var(--accent); color: #000; 
            min-width: 22px; height: 22px; border-radius: 11px; 
            font-size: 0.75rem; font-weight: 800;
            display: flex; align-items: center; justify-content: center;
            padding: 0 6px; box-shadow: 0 0 10px rgba(0, 210, 255, 0.3);
        }
        
        .follow-btn { 
            background: rgba(0, 210, 255, 0.15); color: var(--accent); border: none;
            padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
        }

        /* MENU & OVERLAY */
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; backdrop-filter: blur(5px); }
        #delete-menu {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: var(--sheet-bg); border-radius: 24px 24px 0 0;
            padding: 25px; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2001; box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            box-sizing: border-box; border-top: 1px solid var(--border);
        }
        #delete-menu.active { bottom: 0; }

        .menu-header { text-align: center; margin-bottom: 20px; }
        .menu-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid var(--border); }
        .menu-name { font-weight: 700; font-size: 1.1rem; }
        
        .menu-btn { width: 100%; padding: 16px; border-radius: 14px; font-weight: 600; font-size: 1rem; border: none; margin-bottom: 10px; cursor: pointer; }
        .btn-pin { background: #222; color: white; }
        .btn-del { background: rgba(255, 68, 68, 0.15); color: var(--danger); }
        .btn-cancel { background: transparent; color: #777; }

        /* SKELETONS */
        .skeleton { display: flex; align-items: center; padding: 16px 20px; opacity: 0.6; }
        .sk-img { width: 56px; height: 56px; background: #222; border-radius: 50%; margin-right: 15px; }
        .sk-lines { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .sk-line { height: 12px; background: #222; border-radius: 4px; }
    </style>
</head>
<body oncontextmenu="return false;">

<header>
    <div class="header-logo">GOORAC</div>
</header>

<div class="search-wrap">
    <input type="text" class="search-input" id="main-search" placeholder="Search messages..." oninput="handleSearch(this.value)">
</div>

<div id="search-results" style="display:none; min-height:80vh;"></div>

<div id="chats-list">
    <div class="skeleton"><div class="sk-img"></div><div class="sk-lines"><div class="sk-line" style="width:40%"></div><div class="sk-line" style="width:70%"></div></div></div>
    <div class="skeleton"><div class="sk-img"></div><div class="sk-lines"><div class="sk-line" style="width:30%"></div><div class="sk-line" style="width:60%"></div></div></div>
</div>

<div class="menu-overlay" id="overlay" onclick="closeMenu()"></div>
<div id="delete-menu">
    <div class="menu-header">
        <img src="" class="menu-avatar" id="m-pfp">
        <div class="menu-name" id="m-name">User</div>
    </div>
    <button class="menu-btn btn-pin" id="btn-pin">Pin Chat</button>
    <button class="menu-btn btn-del" id="btn-del">Delete Chat</button>
    <button class="menu-btn btn-cancel" onclick="closeMenu()">Cancel</button>
</div>

<script src="components/navbar.js"></script>
<main-navbar></main-navbar>
<script src="components/call-notifier.js"></script>
<call-notifier></call-notifier>

<script>
    /* --- CONFIG & INIT --- */
    const firebaseConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const rdb = firebase.database();
    const auth = firebase.auth();
    const V_ICON = "https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg";

    let myUid = null;
    let following = [], followers = [], pinned = [];
    let userCache = JSON.parse(localStorage.getItem('goorac_u_cache')) || {};
    let inboxUnsub;

    /* --- AUTH & PRESENCE --- */
    auth.onAuthStateChanged(user => {
        if (user) {
            myUid = user.uid;
            initPresence();
            loadUserData();
        } else {
            window.location.href = 'login.html';
        }
    });

    function initPresence() {
        const myStatusRef = rdb.ref('/status/' + myUid);
        const onlineData = { state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP };
        const offlineData = { state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP };

        rdb.ref('.info/connected').on('value', snap => {
            if (snap.val() === false) return;
            myStatusRef.onDisconnect().set(offlineData).then(() => {
                myStatusRef.set(onlineData);
            });
        });
    }

    /* --- DATA LOADING --- */
    function loadUserData() {
        db.collection("users").doc(myUid).onSnapshot(doc => {
            const d = doc.data() || {};
            following = d.following || [];
            followers = d.followers || [];
            pinned = d.pinnedChats || [];
            startInboxListener();
        });
    }

    function startInboxListener() {
        if(inboxUnsub) inboxUnsub();

        inboxUnsub = db.collection("chats")
            .where("participants", "array-contains", myUid)
            .onSnapshot(handleInboxSnapshot);
    }

    async function handleInboxSnapshot(snap) {
        const container = document.getElementById('chats-list');
        if(snap.empty) {
            container.innerHTML = `<div style="text-align:center; padding:50px; color:#555;">No messages yet</div>`;
            return;
        }

        const chats = await Promise.all(snap.docs.map(async doc => {
            const data = doc.data();
            const otherUid = data.participants.find(id => id !== myUid);
            
            // Resolve User
            let u = userCache[otherUid];
            if(!u) {
                const uDoc = await db.collection("users").doc(otherUid).get();
                u = uDoc.data();
                if(u) {
                    userCache[otherUid] = u;
                    localStorage.setItem('goorac_u_cache', JSON.stringify(userCache));
                }
            }

            return {
                id: doc.id,
                data: data,
                user: u || { name: 'Unknown', photoURL: '' },
                otherUid: otherUid,
                isPinned: pinned.includes(doc.id)
            };
        }));

        // Sort: Pinned first, then by timestamp
        chats.sort((a,b) => {
            if(a.isPinned !== b.isPinned) return b.isPinned - a.isPinned;
            const tA = a.data.lastTimestamp?.seconds || 0;
            const tB = b.data.lastTimestamp?.seconds || 0;
            return tB - tA;
        });

        renderChats(chats, container);
    }

    function renderChats(chats, container) {
        container.innerHTML = '';
        chats.forEach(c => {
            const { id, data, user, otherUid, isPinned } = c;
            
            // --- CRITICAL FIX: SEEN / UNREAD LOGIC ---
            const amISender = data.lastSender === myUid;
            
            // "Seen" logic: If I am sender, check if they saw it. If I am receiver, check if I saw it.
            // Note: In Firestore, 'seen' is a boolean often updated by the receiver.
            
            let msgText = data.lastMessage || "Media";
            let msgClass = "last-msg";
            let timeStr = data.lastTimestamp ? formatTime(data.lastTimestamp.toDate()) : "";

            if (amISender) {
                // I sent the last message
                if (data.seen === true) {
                    // They read it -> Blue "Seen"
                    // If your chat logic saves a 'seenAt', we calculate relative time. 
                    // Since 'seenAt' might not be in the Chat doc (often only in Message doc), we use "Seen".
                    // You can add seenAt to chat doc for better precision.
                    msgText = `Seen ${timeStr} ago`; // Approximate using last msg time
                    msgClass = "last-msg seen";
                } else {
                    // They haven't read it -> "You: Message"
                    msgText = `You: ${msgText}`;
                }
            } else {
                // I received the message
                if (data.seen === false || (data.unreadCount && data.unreadCount[myUid] > 0)) {
                    // I haven't read it -> Bold White
                    msgClass = "last-msg unread";
                } else {
                    // I read it -> Grey normal text
                    // msgText remains as is
                }
            }

            // Unread Count Badge (Only if I am NOT sender and haven't read)
            let badge = "";
            if (!amISender && (data.unreadCount && data.unreadCount[myUid] > 0)) {
                const count = data.unreadCount[myUid];
                badge = `<div class="unread-count">${count > 99 ? '99+' : count}</div>`;
            }

            const isFollowing = following.some(f => (typeof f === 'string' ? f : f.uid) === otherUid);
            const verified = user.verified ? `<img src="${V_ICON}" class="v-badge">` : '';
            
            // Element Construction
            const el = document.createElement('div');
            el.className = 'chat-item';
            
            // Events
            el.onclick = () => window.location.href = `chat.html?user=${user.username}`;
            el.addEventListener('touchstart', (e) => startLongPress(e, id, user, isPinned));
            el.addEventListener('touchend', endLongPress);
            el.addEventListener('touchmove', endLongPress);

            el.innerHTML = `
                <div class="pfp-container">
                    <img src="${user.photoURL || 'https://via.placeholder.com/150'}" class="chat-pfp">
                    <div class="online-indicator" id="status-${otherUid}"></div>
                </div>
                <div class="chat-info">
                    <div class="chat-top">
                        <span class="u-name">
                            ${user.name} ${verified}
                            ${isPinned ? '<div class="pin-icon"></div>' : ''}
                        </span>
                        <span class="chat-time">${timeStr}</span>
                    </div>
                    <div class="chat-bottom">
                        <div class="${msgClass}" id="preview-${id}">${msgText}</div>
                        <div class="chat-meta">
                            ${badge}
                            ${!isFollowing && !badge ? `<button class="follow-btn" onclick="openProfile(event, '${user.username}')">Profile</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(el);

            // Realtime Typing & Status
            setupRealtimeFeatures(id, otherUid);
        });
    }

    function setupRealtimeFeatures(chatId, uid) {
        // Typing
        rdb.ref(`typing/${chatId}/${uid}`).on('value', s => {
            const el = document.getElementById(`preview-${chatId}`);
            if(!el) return;
            if(s.val()) el.innerHTML = `<span class="typing-text">typing...</span>`;
            // Reverting logic handled by next snapshot update
        });

        // Online Status
        rdb.ref(`status/${uid}/state`).on('value', s => {
            const el = document.getElementById(`status-${uid}`);
            if(el) {
                if(s.val() === 'online') el.classList.add('active');
                else el.classList.remove('active');
            }
        });
    }

    /* --- HELPERS --- */
    function formatTime(date) {
        const now = new Date();
        const diff = (now - date) / 1000;
        if(diff < 60) return "Just now";
        if(diff < 3600) return `${Math.floor(diff/60)}m`;
        if(diff < 86400) return `${Math.floor(diff/3600)}h`;
        return `${Math.floor(diff/86400)}d`;
    }

    function openProfile(e, username) {
        e.stopPropagation();
        window.location.href = `profile.html?user=${username}`;
    }

    /* --- SEARCH --- */
    let searchTimer;
    function handleSearch(val) {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
            const res = document.getElementById('search-results');
            const list = document.getElementById('inbox-content');
            
            if(!val.trim()) {
                res.style.display = 'none';
                list.style.display = 'block';
                return;
            }

            res.style.display = 'block';
            list.style.display = 'none';
            // Simple filter of loaded cache for speed, or implement DB search
            res.innerHTML = '<div style="text-align:center; padding:30px; color:#555;">Searching...</div>';
            
            // Basic Implementation: Search Friends DB
            db.collection("users")
                .where("username", ">=", val.toLowerCase())
                .where("username", "<=", val.toLowerCase() + "\uf8ff")
                .limit(5)
                .get().then(snap => {
                    res.innerHTML = '';
                    if(snap.empty) res.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">No user found</div>';
                    snap.forEach(doc => {
                        const u = doc.data();
                        const d = document.createElement('div');
                        d.className = 'chat-item';
                        d.onclick = () => window.location.href = `chat.html?user=${u.username}`;
                        d.innerHTML = `
                            <img src="${u.photoURL}" class="chat-pfp">
                            <div class="chat-info">
                                <div class="u-name">${u.name} ${u.verified ? `<img src="${V_ICON}" class="v-badge">` : ''}</div>
                                <div style="font-size:0.8rem; color:#666;">@${u.username}</div>
                            </div>
                        `;
                        res.appendChild(d);
                    });
                });
        }, 500);
    }

    /* --- LONG PRESS MENU --- */
    let pressTimer;
    let selectedChat = null;

    function startLongPress(e, id, user, isPinned) {
        selectedChat = { id, user, isPinned };
        pressTimer = setTimeout(() => {
            if(navigator.vibrate) navigator.vibrate(40);
            openMenu();
        }, 600);
    }

    function endLongPress() { clearTimeout(pressTimer); }

    function openMenu() {
        if(!selectedChat) return;
        document.getElementById('m-pfp').src = selectedChat.user.photoURL;
        document.getElementById('m-name').innerText = selectedChat.user.name;
        document.getElementById('btn-pin').innerText = selectedChat.isPinned ? "Unpin Chat" : "Pin Chat";
        
        document.getElementById('delete-menu').classList.add('active');
        document.getElementById('overlay').style.display = 'block';
        
        // Handlers
        document.getElementById('btn-pin').onclick = () => {
            const ref = db.collection("users").doc(myUid);
            if(selectedChat.isPinned) ref.update({ pinnedChats: firebase.firestore.FieldValue.arrayRemove(selectedChat.id) });
            else ref.update({ pinnedChats: firebase.firestore.FieldValue.arrayUnion(selectedChat.id) });
            closeMenu();
        };

        document.getElementById('btn-del').onclick = () => {
            if(confirm("Delete this conversation permanently?")) {
                db.collection("chats").doc(selectedChat.id).delete(); 
                closeMenu();
            }
        };
    }

    function closeMenu() {
        document.getElementById('delete-menu').classList.remove('active');
        document.getElementById('overlay').style.display = 'none';
        selectedChat = null;
    }
</script>
</body>
</html>
