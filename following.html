<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Following | Goorac</title>
    
    <script src="config.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script type="module" src="components/presence.js"></script>
    <script src="components/chatLoader.js" defer></script>
    <chat-loader></chat-loader>

    <style>
        :root {
            --bg: #000;
            --surface: #0a0a0a;
            --surface-light: #161618;
            --accent: #00d2ff;
            --text: #ffffff;
            --dim: #71717a;
            --border: #1f1f22;
            --glass: rgba(0, 0, 0, 0.75);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg); 
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; 
            padding-top: 135px; 
            padding-bottom: 40px;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- PREMIUM HEADER --- */
        .header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: var(--glass); 
            z-index: 100; padding-top: env(safe-area-inset-top);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-bottom: 1px solid var(--border);
        }

        .header-top { 
            height: 60px; display: flex; align-items: center; padding: 0 12px; 
            justify-content: space-between;
        }
        
        .back-btn { 
            background: rgba(255,255,255,0.05); border: none; color: var(--text); 
            width: 38px; height: 38px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; line-height: 0; transition: background 0.2s;
        }
        .back-btn:active { background: rgba(255,255,255,0.15); transform: scale(0.9); }
        
        .header-title-box { text-align: center; flex: 1; display: flex; flex-direction: column; }
        .header h1 { font-size: 1rem; font-weight: 800; margin: 0; letter-spacing: -0.2px; }
        .header-count { font-size: 0.8rem; color: var(--dim); margin-top: 1px; font-weight: 400; }

        /* --- MODERN SEARCHBAR --- */
        .search-container { padding: 4px 16px 12px; }
        .search-wrapper { position: relative; width: 100%; }
        .search-icon {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px; fill: var(--dim); opacity: 0.7;
        }
        .search-input {
            width: 100%; background: var(--surface-light); border: 1px solid transparent; 
            border-radius: 14px; padding: 12px 14px 12px 42px; color: white; outline: none; 
            font-size: 0.95rem; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-input:focus { border-color: var(--accent); background: #000; box-shadow: 0 0 0 4px rgba(0, 210, 255, 0.1); }

        /* --- LIST REFINEMENT --- */
        .list-container { padding: 0 16px; max-width: 600px; margin: 0 auto; }
        
        .user-item { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .user-item.is-me { 
            background: linear-gradient(90deg, rgba(0, 210, 255, 0.08), transparent); 
            margin: 0 -16px; padding: 12px 16px; 
            border-left: 3px solid var(--accent);
        }

        .user-info { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; flex: 1; min-width: 0; }
        
        .user-pfp { 
            width: 52px; height: 52px; border-radius: 50%; object-fit: cover; 
            background: var(--surface-light); flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        .name-container { display: flex; flex-direction: column; min-width: 0; gap: 2px; }
        
        .display-name { 
            font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 4px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff;
        }
        .user-handle { 
            color: var(--dim); font-size: 0.85rem; font-weight: 400;
        }

        .you-badge {
            font-size: 0.75rem; background: var(--surface-light); padding: 4px 10px;
            border-radius: 8px; color: var(--accent); font-weight: 600; 
            letter-spacing: 0.5px; border: 1px solid rgba(0,210,255,0.2);
        }

        /* --- BUTTON STATES --- */
        .action-btn {
            background: var(--text); color: #000; border: none; padding: 8px 16px;
            border-radius: 12px; font-size: 0.85rem; font-weight: 700; cursor: pointer;
            min-width: 95px; transition: all 0.2s ease;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .action-btn:active { transform: scale(0.94); opacity: 0.8; }
        
        .action-btn.following { 
            background: transparent; border: 1.5px solid var(--border); color: #fff;
        }
        .action-btn.remove {
            background: rgba(255, 59, 48, 0.1); color: #ff453a; 
            border: 1.5px solid rgba(255, 59, 48, 0.2);
        }

        /* --- BUTTON LOADER --- */
        .btn-loader {
            width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }
        @keyframes btn-spin { to { transform: rotate(360deg); } }

        .v-badge { width: 15px; height: 15px; }

        /* Skeletons */
        .skeleton-item { display: flex; align-items: center; padding: 14px 0; }
        .skeleton-pfp { width: 52px; height: 52px; border-radius: 50%; background: var(--surface-light); margin-right: 14px; }
        .skeleton-line { height: 12px; background: var(--surface-light); border-radius: 10px; margin-bottom: 8px; }
        
        .pulse { animation: pulse-bg 1.8s infinite ease-in-out; }
        @keyframes pulse-bg { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .empty-state { text-align: center; padding: 100px 30px; color: var(--dim); opacity: 0; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .empty-icon { font-size: 4rem; margin-bottom: 20px; display: block; filter: drop-shadow(0 0 10px rgba(0,210,255,0.2)); }
        
        .lock-msg { 
            background: var(--surface-light); padding: 30px 20px; border-radius: 20px; 
            margin-top: 40px; border: 1px solid var(--border);
        }

    </style>
</head>
<body>

<div class="header">
    <div class="header-top">
        <button class="back-btn" onclick="window.history.back()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <div class="header-title-box">
            <h1 id="header-title">Following</h1>
            <div id="header-count" class="header-count">Loading...</div>
        </div>
        <div style="width: 38px;"></div> </div>
    <div class="search-container">
        <div class="search-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="following-search" class="search-input" placeholder="Search people..." oninput="filterList()" autocomplete="off">
        </div>
    </div>
</div>

<div id="content" class="list-container">
    <div id="following-list">
        <div class="skeleton-item"><div class="skeleton-pfp pulse"></div><div class="skeleton-info" style="flex:1"><div class="skeleton-line pulse" style="width:40%"></div><div class="skeleton-line pulse" style="width:25%"></div></div></div>
        <div class="skeleton-item"><div class="skeleton-pfp pulse"></div><div class="skeleton-info" style="flex:1"><div class="skeleton-line pulse" style="width:50%"></div><div class="skeleton-line pulse" style="width:30%"></div></div></div>
        <div class="skeleton-item"><div class="skeleton-pfp pulse"></div><div class="skeleton-info" style="flex:1"><div class="skeleton-line pulse" style="width:35%"></div><div class="skeleton-line pulse" style="width:20%"></div></div></div>
    </div>
    <div id="load-more-trigger"></div>
</div>

<script>
    // --- FIREBASE INIT ---
    if (typeof window.initFirebaseCore === 'function') {
        window.initFirebaseCore();
    } else if (!firebase.apps.length && window.firebaseConfig) {
        firebase.initializeApp(window.firebaseConfig);
    }
    
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const targetUsername = urlParams.get('user');
    
    // State Management
    let allUsersData = [];
    let isOwnProfile = false;
    let currentUserFollowing = []; 
    let followingIds = []; 
    let processingIds = new Set(); 
    // --- NOTIFICATION STATE ---
    let currentUserData = null; 
    
    // Pagination
    let lastFetchedIndex = 0;
    const limit = 20;
    let isLoadingMore = false;

    // --- AUTH & INIT ---
    auth.onAuthStateChanged(user => {
        if (user) { 
            db.collection("users").doc(user.uid).onSnapshot(doc => {
                const data = doc.data();
                // --- CAPTURE USER DATA FOR NOTIFICATIONS ---
                currentUserData = data;
                if(data && data.following) {
                    currentUserFollowing = data.following.map(f => typeof f === 'string' ? f : f.uid);
                    if (allUsersData.length > 0) {
                        updateButtons();
                    }
                }
            });
            initPage(user); 
        } else { 
            window.location.href = 'login.html'; 
        }
    });

    async function initPage(currentUser) {
        const list = document.getElementById('following-list');
        try {
            let targetUID = currentUser.uid;
            
            if (targetUsername) {
                const userQuery = await db.collection("users").where("username", "==", targetUsername).get();
                if (userQuery.empty) {
                    list.innerHTML = "<div class='empty-state'><div class='empty-icon'>üîç</div><p>User not found</p></div>";
                    document.getElementById('header-title').innerText = "Error";
                    return;
                }
                const targetDoc = userQuery.docs[0];
                const targetData = targetDoc.data();
                targetUID = targetDoc.id;
                isOwnProfile = (targetUID === currentUser.uid);
                document.getElementById('header-title').innerText = `@${targetData.username}`;

                // --- MUTUAL PRIVACY CHECK ---
                if (!isOwnProfile) {
                    const myDoc = await db.collection("users").doc(currentUser.uid).get();
                    const myFollowing = (myDoc.data()?.following || []).map(f => typeof f === 'string' ? f : f.uid);
                    const theirFollowers = (targetData.followers || []).map(f => typeof f === 'string' ? f : f.uid);
                    
                    const iFollowThem = myFollowing.includes(targetUID);
                    const theyFollowMe = theirFollowers.includes(currentUser.uid);

                    if (!iFollowThem || !theyFollowMe) {
                        list.innerHTML = `
                            <div class="empty-state lock-msg">
                                <div class="empty-icon">üîí</div>
                                <h3>Private Relationship</h3>
                                <p>Following lists are only visible to mutual friends.</p>
                            </div>`;
                        document.getElementById('header-count').innerText = "Private";
                        return;
                    }
                }
            } else {
                isOwnProfile = true;
                document.getElementById('header-title').innerText = "Following";
            }

            db.collection("users").doc(targetUID).onSnapshot(async doc => {
                const rawFollowing = doc.data()?.following || [];
                document.getElementById('header-count').innerText = `${rawFollowing.length} following`;
                followingIds = rawFollowing.map(item => typeof item === 'string' ? item : item.uid).reverse();
                
                if (followingIds.length === 0) {
                    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üë•</div><p>Not following anyone yet.</p></div>`;
                    return;
                }
                
                allUsersData = [];
                lastFetchedIndex = 0;
                list.innerHTML = '';
                await loadMoreUsers();
            });

        } catch (e) {
            console.error(e);
            list.innerHTML = "<div class='empty-state'><p>Something went wrong.</p></div>";
        }
    }

    async function loadMoreUsers() {
        if (isLoadingMore || lastFetchedIndex >= followingIds.length) return;
        isLoadingMore = true;

        const nextBatchIds = followingIds.slice(lastFetchedIndex, lastFetchedIndex + limit);
        
        try {
            const profilePromises = nextBatchIds.map(id => db.collection("users").doc(id).get());
            const snapshots = await Promise.all(profilePromises);
            const newUsers = snapshots.filter(p => p.exists).map(p => ({...p.data(), uid: p.id}));
            allUsersData = [...allUsersData, ...newUsers];
            lastFetchedIndex += limit;
            renderList(allUsersData);
        } catch (e) {
            console.error("Batch load error:", e);
        } finally {
            isLoadingMore = false;
        }
    }

    window.onscroll = () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
            loadMoreUsers();
        }
    };

    function renderList(users) {
        const list = document.getElementById('following-list');
        list.innerHTML = "";
        const myUid = auth.currentUser.uid;

        const sortedUsers = [...users].sort((a, b) => {
            if (a.uid === myUid) return -1;
            if (b.uid === myUid) return 1;
            return 0;
        });

        sortedUsers.forEach(u => {
            const isMe = u.uid === myUid;
            const isFollowing = currentUserFollowing.includes(u.uid);
            const item = document.createElement('div');
            item.className = `user-item ${isMe ? 'is-me' : ''}`;
            
            let actionHtml = '';
            if (isMe) {
                actionHtml = `<div class="you-badge">YOU</div>`;
            } else {
                let btnText = isOwnProfile ? 'Following' : (isFollowing ? 'Following' : 'Follow');
                let btnClass = isFollowing ? 'action-btn following' : 'action-btn';
                actionHtml = `<button id="btn-${u.uid}" class="${btnClass}" onclick="handleAction('${u.uid}', '${u.username}')"><span>${btnText}</span></button>`;
            }

            item.innerHTML = `
                <a href="userProfile.html?user=${u.username}" class="user-info">
                    <img src="${u.photoURL || 'https://via.placeholder.com/150'}" class="user-pfp" loading="lazy">
                    <div class="name-container">
                        <div class="display-name">
                            ${u.name || u.username} 
                            ${u.verified ? '<img src="https://img.icons8.com/color/48/verified-badge.png" class="v-badge">' : ''}
                        </div>
                        <div class="user-handle">@${u.username}</div>
                    </div>
                </a>
                ${actionHtml}
            `;
            list.appendChild(item);
        });
    }

    function updateButtons() {
        const buttons = document.querySelectorAll('.action-btn');
        buttons.forEach(btn => {
            const uid = btn.id.replace('btn-', '');
            if (processingIds.has(uid)) return;

            if(currentUserFollowing.includes(uid)) {
                btn.className = "action-btn following";
                btn.innerHTML = `<span>Following</span>`; 
            } else {
                btn.className = "action-btn";
                btn.innerHTML = `<span>Follow</span>`; 
            }
            btn.style.pointerEvents = 'auto'; 
        });
    }

    // --- REPLACED ACTION HANDLER WITH ADVANCED NOTIFICATION LOGIC ---
    async function handleAction(targetUid, username) {
        if (processingIds.has(targetUid)) return;
        processingIds.add(targetUid);

        const btn = document.getElementById(`btn-${targetUid}`);
        if (btn) {
            btn.innerHTML = '<div class="btn-loader"></div>';
            btn.style.pointerEvents = 'none';
        }

        if (window.navigator && window.navigator.vibrate) {
            window.navigator.vibrate(10);
        }

        const myUid = auth.currentUser.uid;
        const timestamp = firebase.firestore.Timestamp.now();
        const dateStr = new Date().toISOString();
        const myFollowData = { uid: targetUid, timestamp: timestamp, date: dateStr, type: 'following' };
        const theirFollowerData = { uid: myUid, timestamp: timestamp, date: dateStr, type: 'follower' };

        try {
            if (isOwnProfile) {
                // Own Profile: "Following" list implies "Unfollow" action
                if(btn) {
                    const parentItem = btn.closest('.user-item');
                    parentItem.style.opacity = '0.3';
                    parentItem.style.transform = 'translateX(-10px)';
                }
                
                // 1. Unfollow
                await removeFromList(myUid, 'following', targetUid);
                await removeFromList(targetUid, 'followers', myUid);
                
                // 2. Cleanup Notification
                await cleanupNotification(myUid, targetUid);

                if(btn) btn.closest('.user-item').remove();
            } else {
                const isFollowing = currentUserFollowing.includes(targetUid);

                if (isFollowing) {
                    // 1. Unfollow
                    await removeFromList(myUid, 'following', targetUid);
                    await removeFromList(targetUid, 'followers', myUid);
                    
                    // 2. Cleanup Notification
                    await cleanupNotification(myUid, targetUid);
                } else {
                    // 1. Follow (Advanced)
                    const batch = db.batch();
                    
                    // Update Me
                    batch.update(db.collection("users").doc(myUid), {
                        following: firebase.firestore.FieldValue.arrayUnion(myFollowData),
                        followingCount: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Update Them (Inc Badge)
                    batch.update(db.collection("users").doc(targetUid), {
                        followers: firebase.firestore.FieldValue.arrayUnion(theirFollowerData),
                        followerCount: firebase.firestore.FieldValue.increment(1),
                        unreadCount: firebase.firestore.FieldValue.increment(1) // Badge
                    });

                    // Notification (Full Payload)
                    if (currentUserData) {
                        const notifRef = db.collection("users").doc(targetUid).collection("notifications").doc();
                        batch.set(notifRef, {
                            type: 'follow',
                            fromUid: myUid,
                            fromUsername: currentUserData.username,
                            fromName: currentUserData.name || currentUserData.username,
                            fromPhoto: currentUserData.photoURL || 'https://via.placeholder.com/150',
                            content: `started following you.`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            isRead: false,
                            link: `userProfile.html?user=${currentUserData.username}`
                        });
                    }

                    await batch.commit();
                }
            }
        } catch (e) {
            console.error(e);
        } finally {
            setTimeout(() => {
                processingIds.delete(targetUid);
                updateButtons();
            }, 500); // Slight delay for Firestore sync
        }
    }

    // New Helper function for cleaner code
    async function cleanupNotification(senderUid, receiverUid) {
        try {
            const notifQuery = await db.collection("users").doc(receiverUid)
                .collection("notifications")
                .where("fromUid", "==", senderUid)
                .where("type", "==", "follow")
                .limit(1)
                .get();

            if (!notifQuery.empty) {
                const notifDoc = notifQuery.docs[0];
                const notifData = notifDoc.data();
                await notifDoc.ref.delete();

                if (notifData.isRead === false) {
                    await db.collection("users").doc(receiverUid).update({
                        unreadCount: firebase.firestore.FieldValue.increment(-1)
                    });
                }
            }
        } catch (err) {
            console.error("Cleanup notification error:", err);
        }
    }

    async function removeFromList(docUid, field, targetUid) {
        const docRef = db.collection("users").doc(docUid);
        try {
            await db.runTransaction(async (t) => {
                const doc = await t.get(docRef);
                if (!doc.exists) return;
                const currentArray = doc.data()[field] || [];
                const newArray = currentArray.filter(item => {
                    const id = typeof item === 'string' ? item : item.uid;
                    return id !== targetUid;
                });
                if (newArray.length !== currentArray.length) {
                    const countField = field === 'followers' ? 'followerCount' : 'followingCount';
                    t.update(docRef, { [field]: newArray, [countField]: newArray.length });
                }
            });
        } catch (e) { console.error("Remove failed", e); throw e; }
    }

    function filterList() {
        const val = document.getElementById('following-search').value.toLowerCase();
        const filtered = allUsersData.filter(u => 
            u.username.toLowerCase().includes(val) || (u.name && u.name.toLowerCase().includes(val))
        );
        renderList(filtered);
    }
</script>

<script src="components/navbar.js" defer></script>
</body>
</html>
