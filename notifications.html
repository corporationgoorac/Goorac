<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Notifications | Goorac</title>
    
    <script src="config.js"></script>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script type="module" src="components/presence.js"></script>

    <style>
        :root {
            --bg: #000000;
            --surface: #121212;
            --surface-elevated: #1e1e1e;
            --accent: #0a84ff; /* iOS Blue */
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --border: #2c2c2e;
            --unread-tint: rgba(10, 132, 255, 0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg); color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            margin: 0; 
            padding-top: 110px; /* Header (54) + Filters (56) */
            padding-bottom: 40px;
            overflow-x: hidden;
            overscroll-behavior-y: none;
            user-select: none; /* Disable Copy */
            -webkit-user-select: none;
        }

        /* --- HEADER --- */
        .header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.92); 
            z-index: 100; padding: 0 16px; height: 54px;
            border-bottom: 0.5px solid var(--border);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: space-between;
        }

        .header-left { display: flex; align-items: center; gap: 8px; }

        .back-btn {
            background: transparent; border: none; color: white;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; padding: 0; margin-left: -8px;
        }
        .back-btn svg { width: 24px; height: 24px; }

        .header h1 { font-size: 1.3rem; font-weight: 700; margin: 0; letter-spacing: -0.4px; }
        
        .mark-read-btn {
            font-size: 0.85rem; color: var(--accent); font-weight: 600;
            cursor: pointer; background: transparent; padding: 8px 4px;
        }

        /* --- FILTER CHIPS (New Tab Design) --- */
        .filters-container {
            position: fixed; top: 54px; left: 0; width: 100%;
            background: var(--bg); z-index: 99;
            display: flex; align-items: center; gap: 10px;
            padding: 10px 16px; overflow-x: auto;
            border-bottom: 0.5px solid var(--border);
            scrollbar-width: none; /* Hide scrollbar */
        }
        .filters-container::-webkit-scrollbar { display: none; }

        .filter-chip {
            padding: 8px 20px; border-radius: 20px;
            font-size: 0.9rem; font-weight: 600;
            border: 1px solid var(--border);
            background: transparent; color: var(--text-secondary);
            cursor: pointer; white-space: nowrap;
            transition: all 0.2s ease;
        }
        .filter-chip.active {
            background: var(--text-primary);
            color: var(--bg);
            border-color: var(--text-primary);
        }

        /* --- NOTIFICATION LIST --- */
        .notif-list { width: 100%; max-width: 600px; margin: 0 auto; min-height: 60vh; }

        .notif-item {
            display: flex; flex-direction: row; 
            align-items: flex-start; 
            gap: 14px; padding: 16px; position: relative;
            background: transparent; transition: background 0.2s;
            border-bottom: 1px solid var(--border); /* Distinct Border */
            cursor: pointer;
        }
        .notif-item:active { background: rgba(255,255,255,0.03); }
        .notif-item.unread { background: var(--unread-tint); }
        .notif-item.unread::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0;
            width: 3px; background: var(--accent);
        }

        /* PFP */
        .notif-pfp-wrapper { position: relative; flex-shrink: 0; padding-top: 2px; }
        .notif-pfp {
            width: 44px; height: 44px; border-radius: 50%; 
            object-fit: cover; background: #222; border: 1px solid rgba(255,255,255,0.1);
        }
        
        .type-badge {
            position: absolute; bottom: -2px; right: -2px;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #000; color: #fff;
        }
        .icon-like { background: #ff2d55; }
        .icon-follow { background: #5856d6; }
        .type-badge svg { width: 10px; height: 10px; fill: white; }

        /* TEXT CONTENT */
        .notif-content { flex: 1; display: flex; flex-direction: column; min-width: 0; padding-top: 2px; }
        
        .text-line {
            font-size: 0.95rem; line-height: 1.4; color: var(--text-primary);
        }

        /* PERFECT ALIGNMENT: Name + Badge */
        .username-container {
            display: inline-flex; align-items: center; gap: 4px; 
            font-weight: 700; color: #fff; vertical-align: top;
            margin-right: 4px;
        }
        .v-badge { width: 14px; height: 14px; display: block; }

        .time-ago { font-size: 0.8rem; color: var(--text-secondary); margin-left: 4px; }

        /* NOTE PREVIEW (Goorac Style) */
        .note-preview {
            margin-top: 10px; padding: 12px 16px; border-radius: 14px;
            background: linear-gradient(145deg, #1c1c1e, #121212);
            border: 1px solid rgba(255,255,255,0.1);
            width: fit-content; max-width: 100%;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .note-text {
            font-family: system-ui; text-align: center; font-weight: 600; font-size: 0.9rem;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
            line-height: 1.35; color: rgba(255,255,255,0.95);
        }
        .song-badge {
            display: flex; align-items: center; gap: 5px; margin-top: 8px;
            background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 100px;
            font-size: 0.75rem; color: rgba(255,255,255,0.8);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* VIEW BUTTON */
        .action-col {
            display: flex; align-items: center; justify-content: center;
            margin-left: 10px; align-self: center;
        }
        .view-btn {
            background: var(--surface-elevated); border: 1px solid var(--border);
            color: #fff; font-size: 0.85rem; font-weight: 600;
            padding: 6px 16px; border-radius: 10px;
            cursor: pointer; white-space: nowrap; transition: 0.2s;
        }
        .view-btn:active { background: #333; transform: scale(0.96); }

        /* SKELETONS */
        .skeleton-wrapper { padding: 16px; display: flex; gap: 14px; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .skeleton { animation: pulse 1.5s infinite; background: rgba(255,255,255,0.08); }
        .sk-pfp { width: 44px; height: 44px; border-radius: 50%; }
        .sk-line { height: 12px; border-radius: 6px; width: 60%; margin-bottom: 6px; }
        .sk-line.short { width: 40%; }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 0.5; } 100% { opacity: 0.3; } }

        .empty-state { text-align: center; padding: 100px 20px; color: var(--text-secondary); }
        .empty-icon { font-size: 40px; margin-bottom: 15px; opacity: 0.3; filter: grayscale(1); }
        
        #scroll-spinner {
            height: 50px; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #scroll-spinner.show { opacity: 1; }
        .spinner {
            width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #error-toast {
            position: fixed; top: 16px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #ff3b30; color: white; padding: 12px 24px; border-radius: 50px;
            font-weight: 600; font-size: 0.9rem; z-index: 2000; box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            transition: transform 0.4s;
        }
        #error-toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="error-toast">Error fetching data</div>

<div class="header">
    <div class="header-left">
        <button class="back-btn" onclick="window.history.back()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <h1>Notifications</h1>
    </div>
    <div class="mark-read-btn" onclick="markAllAsRead()">Mark all read</div>
</div>

<div class="filters-container">
    <button class="filter-chip active" onclick="switchTab('all')" id="tab-all">All</button>
    <button class="filter-chip" onclick="switchTab('likes')" id="tab-likes">Likes</button>
    <button class="filter-chip" onclick="switchTab('follows')" id="tab-follows">Follows</button>
</div>

<div class="notif-list" id="notif-list">
    <div class="skeleton-wrapper">
        <div class="skeleton sk-pfp"></div>
        <div style="flex:1">
            <div class="skeleton sk-line"></div>
            <div class="skeleton sk-line short"></div>
        </div>
    </div>
    <div class="skeleton-wrapper">
        <div class="skeleton sk-pfp"></div>
        <div style="flex:1">
            <div class="skeleton sk-line"></div>
            <div class="skeleton sk-line short"></div>
        </div>
    </div>
</div>

<div id="scroll-spinner">
    <div class="spinner"></div>
</div>

<script>
    // --- 1. CONFIG & UTILS ---
    function showError(msg) {
        const t = document.getElementById('error-toast');
        t.innerText = msg; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    if (!firebase.apps.length && window.firebaseConfig) firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- 2. STATE ---
    let currentUser = null;
    let rawNotifications = [];
    let userCache = {}; // { uid: { name, username, verified, pfp } }
    let currentTab = 'all';
    let limitCount = 10;
    let isLoading = false;
    let followsUnsub, likesUnsub;

    const ICONS = {
        verified: `https://img.icons8.com/color/48/verified-badge.png`,
        music: `<svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>`,
        heart: `<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`,
        user: `<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`
    };

    // --- 3. AUTH & INIT ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            setupListeners(limitCount);
            setupScrollObserver();
            // Clear unread badge on profile immediately
            db.collection("users").doc(user.uid).update({ unreadCount: 0 }).catch(()=>{});
        } else {
            window.location.href = 'login.html';
        }
    });

    // --- 4. LISTENERS ---
    function setupListeners(limit) {
        if (!currentUser) return;
        isLoading = true;

        if (followsUnsub) followsUnsub();
        if (likesUnsub) likesUnsub();

        let followsTemp = [];
        let likesTemp = [];

        // Follows
        followsUnsub = db.collection("users").doc(currentUser.uid).collection("notifications")
            .orderBy("timestamp", "desc").limit(limit)
            .onSnapshot(snap => {
                followsTemp = snap.docs.map(d => ({ ...d.data(), id: d.id, _collection: 'sub' }));
                mergeAndFetchProfiles(followsTemp, likesTemp);
            });

        // Likes
        likesUnsub = db.collection("notifications")
            .where("toUid", "==", currentUser.uid)
            .orderBy("timestamp", "desc").limit(limit)
            .onSnapshot(snap => {
                likesTemp = snap.docs.map(d => ({ ...d.data(), id: d.id, _collection: 'root' }));
                mergeAndFetchProfiles(followsTemp, likesTemp);
            });
    }

    // --- 5. DATA FETCHING (REALTIME PROFILE SYNC) ---
    async function mergeAndFetchProfiles(follows, likes) {
        // 1. Merge & Sort
        rawNotifications = [...follows, ...likes].sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

        // 2. Identify UIDs needing fetch (CHECK ALL POSSIBLE KEYS)
        const uidsToFetch = new Set();
        rawNotifications.forEach(n => {
            // Robust UID detection: fromUid, senderId, uid, senderUid
            const uid = n.fromUid || n.senderId || n.uid || n.senderUid;
            if (uid && !userCache[uid]) uidsToFetch.add(uid);
        });

        // 3. Fetch Missing Profiles
        if (uidsToFetch.size > 0) {
            const promises = Array.from(uidsToFetch).map(uid => 
                db.collection('users').doc(uid).get().then(doc => {
                    if (doc.exists) userCache[uid] = doc.data();
                    else userCache[uid] = { name: 'Unknown User', username: 'unknown' };
                }).catch(() => userCache[uid] = { name: 'Unknown User', username: 'unknown' })
            );
            await Promise.all(promises);
        }

        isLoading = false;
        render();
        // AUTO-MARK LOADED ITEMS AS READ
        autoMarkLoadedAsRead();
    }

    // --- 6. RENDER LOGIC ---
    function render() {
        const list = document.getElementById('notif-list');
        
        let filtered = rawNotifications;
        if (currentTab === 'likes') filtered = rawNotifications.filter(n => n.type === 'like');
        else if (currentTab === 'follows') filtered = rawNotifications.filter(n => n.type === 'follow');

        if (filtered.length === 0) {
            list.innerHTML = `<div class="empty-state"><div class="empty-icon">ðŸ’¤</div><h3>No activity</h3><p>It's quiet in here.</p></div>`;
            return;
        }

        list.innerHTML = '';

        filtered.forEach(n => {
            const isRead = n.isRead === true || n.isSeen === true;
            const type = n.type || 'unknown';
            
            // --- DATA EXTRACTION ---
            // 1. Resolve UID
            const uid = n.fromUid || n.senderId || n.uid || n.senderUid;
            const profile = userCache[uid] || {};
            
            // 2. DISPLAY NAME: Realtime > Notification Snapshot
            // Prefer: Real Name > Username > Snapshot > 'User'
            const displayName = profile.name || profile.displayName || profile.username || n.senderName || 'User';
            
            // 3. HANDLE: Used for Redirects
            const handle = profile.username || n.fromUsername || 'user'; 
            
            // 4. VERIFICATION: Realtime check
            const isVerified = profile.verified === true; 
            
            // 5. PFP
            const pfp = profile.photoURL || n.senderPfp || 'https://via.placeholder.com/150';

            const item = document.createElement('div');
            item.className = `notif-item ${!isRead ? 'unread' : ''}`;
            
            let iconBadge = '';
            let contentHtml = '';
            let actionHtml = '';

            // --- LIKE NOTIFICATION ---
            if (type === 'like') {
                iconBadge = `<div class="type-badge icon-like">${ICONS.heart}</div>`;
                
                contentHtml = `
                    <div class="text-line">
                        <span class="username-container">
                            ${escapeHtml(displayName)} 
                            ${isVerified ? `<img src="${ICONS.verified}" class="v-badge">` : ''}
                        </span>
                        <span style="color:var(--text-secondary);">liked your note.</span>
                        <span class="time-ago">${timeAgo(n.timestamp)}</span>
                    </div>
                    ${n.noteText ? `
                        <div class="note-preview" style="background:${n.noteBgColor || '#1c1c1e'}; color:${n.noteTextColor || '#fff'}">
                            <div class="note-text" style="font-family:${n.noteFont || 'system-ui'}">${escapeHtml(n.noteText)}</div>
                            ${n.noteSongName ? `<div class="song-badge">${ICONS.music} ${escapeHtml(n.noteSongName)}</div>` : ''}
                        </div>
                    ` : ''}
                `;
            } 
            // --- FOLLOW NOTIFICATION ---
            else if (type === 'follow') {
                iconBadge = `<div class="type-badge icon-follow">${ICONS.user}</div>`;
                
                contentHtml = `
                    <div class="text-line">
                        <span class="username-container">
                            ${escapeHtml(displayName)} 
                            ${isVerified ? `<img src="${ICONS.verified}" class="v-badge">` : ''}
                        </span>
                        <span style="color:var(--text-secondary);">started following you.</span>
                        <span class="time-ago">${timeAgo(n.timestamp)}</span>
                    </div>
                `;
                
                actionHtml = `<div class="action-col"><button class="view-btn">View</button></div>`;
            }

            item.innerHTML = `
                <div class="notif-pfp-wrapper">
                    <img src="${pfp}" class="notif-pfp">
                    ${iconBadge}
                </div>
                <div class="notif-content">${contentHtml}</div>
                ${actionHtml}
            `;

            // Click Handlers
            item.onclick = (e) => {
                if (e.target.classList.contains('view-btn')) e.stopPropagation();
                handleRedirect(n, handle);
            };
            if(actionHtml) {
                item.querySelector('.view-btn').onclick = (e) => {
                    e.stopPropagation();
                    handleRedirect(n, handle);
                };
            }

            list.appendChild(item);
        });
    }

    // --- 7. REDIRECT ---
    function handleRedirect(n, username) {
        // Mark Read (Redundant check if auto-marked, but good for click feedback)
        if (n.isRead !== true && n.isSeen !== true) {
            const ref = n._collection === 'root' 
                ? db.collection('notifications').doc(n.id)
                : db.collection('users').doc(currentUser.uid).collection('notifications').doc(n.id);
            ref.update(n._collection === 'root' ? {isSeen:true} : {isRead:true}).catch(()=>{});
        }

        if (username) {
            window.location.href = `userProfile.html?user=${username}`;
        } else {
            showError("User not found");
        }
    }

    // --- 8. HELPERS & AUTO-READ ---
    function autoMarkLoadedAsRead() {
        const batch = db.batch();
        let count = 0;
        
        // Filter loaded notifications that are unread
        rawNotifications.forEach(n => {
            if (n.isRead !== true && n.isSeen !== true) {
                const ref = n._collection === 'root' 
                    ? db.collection('notifications').doc(n.id)
                    : db.collection('users').doc(currentUser.uid).collection('notifications').doc(n.id);
                batch.update(ref, n._collection === 'root' ? {isSeen:true} : {isRead:true});
                count++;
            }
        });

        if(count > 0) {
            // Commit batch without waiting to keep UI snappy
            batch.commit().catch(e => console.log("Auto-read sync failed", e));
        }
    }

    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${t}`).classList.add('active');
        render();
    }

    function setupScrollObserver() {
        const spinner = document.getElementById('scroll-spinner');
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isLoading) {
                spinner.classList.add('show');
                limitCount += 10;
                setupListeners(limitCount);
                setTimeout(() => spinner.classList.remove('show'), 800);
            }
        }, { threshold: 0.1 });
        observer.observe(spinner);
    }

    function markAllAsRead() {
        const batch = db.batch();
        let count = 0;
        rawNotifications.forEach(n => {
            if (n.isRead !== true && n.isSeen !== true) {
                const ref = n._collection === 'root' 
                    ? db.collection('notifications').doc(n.id)
                    : db.collection('users').doc(currentUser.uid).collection('notifications').doc(n.id);
                batch.update(ref, n._collection === 'root' ? {isSeen:true} : {isRead:true});
                count++;
            }
        });
        if(count > 0) batch.commit().catch(()=>showError("Failed to update"));
    }

    function timeAgo(ts) {
        if (!ts) return '';
        const s = Math.floor((new Date() - ts.toDate())/1000);
        if(s<60) return 'Just now';
        const m=Math.floor(s/60); if(m<60) return `${m}m`;
        const h=Math.floor(m/60); if(h<24) return `${h}h`;
        const d=Math.floor(h/24); if(d<7) return `${d}d`;
        return `${Math.floor(d/7)}w`;
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
</script>

<script src="components/navbar.js" defer></script>
</body>
</html>
